{"version":3,"file":"fetchWithRetry.js","names":["_utils","require","asyncGeneratorStep","n","t","e","r","o","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","isRetirableStatus","status","test","concat","exports","backoffDelay","retries","Math","pow","fetchWithRetry","_ref","regeneratorRuntime","mark","_callee","url","args","maxRetries","delay","response","error","isMatched","retryAfter","wrap","_callee$","_context","prev","next","fetch","sent","headers","get","parseInt","abrupt","t0","sleep","stop","_x","_x2"],"sources":["lib/fetchWithRetry.ts"],"sourcesContent":["import { sleep } from '../utils';\n\n// regex to match 429, 500...599\nexport const isRetirableStatus = (status: number) =>\n  /(?:5\\d{2}|429)/.test(`${status}`);\n\nexport const backoffDelay = (retries: number) =>\n  1 * Math.pow(2, retries) * 1000;\n/**\n * Fetches a resource from the network with retry logic for handling timeouts and server errors.\n *\n * This function will retry the fetch operation up to a maximum of 2 times with exponential backoff\n * for timeouts or 5XX responses. If the retries fail, it will retry after a specified polling interval.\n * It also respects the `Retry-After` header for 429 (Too Many Requests) or 503 (Service Unavailable) responses.\n *\n * @param url - The URL to fetch.\n * @param args - The options for the fetch request.\n * @returns The response from the fetch request.\n * @throws Will throw an error if the fetch operation fails after the maximum number of retries.\n */\nexport const fetchWithRetry = async (url: string, args: RequestInit) => {\n  const maxRetries = 2;\n  let retries = 0;\n  let delay = 0;\n  let response: any;\n  let error: Error | null = null;\n  while (retries <= maxRetries) {\n    try {\n      error = null;\n      response = await fetch(url, args);\n      // now only retry on those status\n      const isMatched = isRetirableStatus(response.status);\n      if (isMatched) {\n        const retryAfter = response.headers.get('Retry-After');\n        if (retryAfter) {\n          delay = parseInt(retryAfter) * 1000;\n        } else {\n          delay = backoffDelay(retries);\n        }\n      } else {\n        break;\n      }\n    } catch (e) {\n      // timeout etc.\n      error = e as Error;\n      delay = backoffDelay(retries);\n    }\n    retries++;\n\n    if (retries > maxRetries) {\n      break;\n    }\n    await sleep(delay);\n  }\n  if (error) {\n    throw error;\n  }\n  return response;\n};\n"],"mappings":"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","ignoreList":[]}
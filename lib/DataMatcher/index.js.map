{"version":3,"sources":["lib/DataMatcher/index.ts"],"names":["checkName","name","Error","DEFAULT_TTL","DEFAULT_NO_MATCH_TTL","DataMatcher","deps","dep","optional","storage","ttl","noMatchTtl","disableCache","actionTypes","ObjectMap","prefixKeys","keys","baseActionTypes","storageKey","getReducer","getDefaultReducer","getDataReducer","getDefaultDataReducer","options","_querySources","Map","_searchProviders","_matchPromises","_matchQueues","_storage","_ttl","_noMatchTtl","_storageKey","_reducer","registerReducer","key","reducer","data","_lastCleanUp","store","subscribe","_onStateChange","output","Set","forEach","readyCheckFn","getQueriesFn","query","add","now","Date","dispatch","type","cleanUp","queries","_getQueries","timestamp","_shouldInit","init","initSuccess","_shouldReset","reset","resetSuccess","pending","ready","searchProvidersReady","searchFn","constructor","has","set","ignoreCache","ignoreQueue","_cleanUp","match","Promise","all","map","_matchSource","provider","get","promise","resolve","matchSuccess","matchError","error","queuedItems","promises","matching","push","item","queue","newQueries","_t","length","_fetchMatchResult","concat","insertMatchEntries","values","state","status","moduleStatuses","_data","_dataMapping","RcModule","proxify","selector","getItem","Array","from","prividers","dataMap","queryResult","matchesList","_providerValue","providerName","Object"],"mappings":"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","sourcesContent":["import { all, filter, forEach } from 'ramda';\n\nimport { ObjectMap } from '@ringcentral-integration/core/lib/ObjectMap';\n\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { Library } from '../di';\nimport proxify from '../proxy/proxify';\nimport RcModule from '../RcModule';\nimport { selector } from '../selector';\nimport { baseActionTypes } from './baseActionTypes';\nimport getDefaultDataReducer from './getDefaultDataReducer';\nimport getDefaultReducer from './getDefaultReducer';\n\nexport function checkName(name) {\n  if (!name) {\n    throw new Error('DataMatcher: \"name\" is required.');\n  }\n  if (typeof name !== 'string') {\n    throw new Error('DataMatcher: \"name\" must be a string.');\n  }\n}\n\nconst DEFAULT_TTL = 30 * 60 * 1000;\nconst DEFAULT_NO_MATCH_TTL = 30 * 1000;\n\n@Library({\n  deps: [\n    { dep: 'Storage', optional: true },\n    { dep: 'DataMatcherOptions', optional: true },\n  ],\n})\nexport default class DataMatcher extends RcModule {\n  constructor({\n    name,\n    storage,\n    ttl = DEFAULT_TTL,\n    noMatchTtl = DEFAULT_NO_MATCH_TTL,\n    disableCache = false,\n    actionTypes = ObjectMap.prefixKeys(\n      [...ObjectMap.keys(baseActionTypes)],\n      name,\n    ),\n    storageKey = `${name}Data`,\n    getReducer = getDefaultReducer,\n    getDataReducer = getDefaultDataReducer,\n    ...options\n  } = {}) {\n    checkName(name);\n    super({\n      ...options,\n      actionTypes,\n    });\n\n    this._querySources = new Map();\n    this._searchProviders = new Map();\n    this._matchPromises = new Map();\n    this._matchQueues = new Map();\n    if (!disableCache) {\n      this._storage = storage;\n    }\n    this._ttl = ttl;\n    this._noMatchTtl = noMatchTtl;\n\n    this._storageKey = storageKey;\n\n    if (this._storage) {\n      this._reducer = getReducer(this.actionTypes);\n      this._storage.registerReducer({\n        key: this._storageKey,\n        reducer: getDataReducer(this.actionTypes),\n      });\n    } else {\n      this._reducer = getReducer(this.actionTypes, {\n        data: getDataReducer(this.actionTypes),\n      });\n    }\n\n    this._lastCleanUp = 0;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _getQueries() {\n    const output = new Set();\n    this._querySources.forEach((readyCheckFn, getQueriesFn) => {\n      if (readyCheckFn()) {\n        getQueriesFn().forEach((query) => {\n          output.add(query);\n        });\n      }\n    });\n    return [...output];\n  }\n\n  _cleanUp() {\n    // throttle clean up to only run once every 100ms\n    const now = Date.now();\n    if (now - this._lastCleanUp > 100) {\n      this._lastCleanUp = now;\n      this.store.dispatch({\n        type: this.actionTypes.cleanUp,\n        queries: this._getQueries(),\n        timestamp: Date.now(),\n        ttl: this._ttl,\n      });\n    }\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      // this._cleanUp();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this._lastCleanUp = 0;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    }\n  }\n\n  _shouldInit() {\n    return !!(\n      this.pending &&\n      (!this._storage || this._storage.ready) &&\n      this.searchProvidersReady\n    );\n  }\n\n  _shouldReset() {\n    return !!(\n      this.ready &&\n      ((!!this._storage && !this._storage.ready) || !this.searchProvidersReady)\n    );\n  }\n\n  get searchProvidersReady() {\n    return all(\n      ({ readyCheckFn }) => readyCheckFn(),\n      [...this._searchProviders.values()],\n    );\n  }\n\n  addSearchProvider({ name, searchFn, readyCheckFn }) {\n    if (!name) {\n      throw new Error(`${this.constructor.name}: \"name\" is required.`);\n    }\n    if (this._searchProviders.has(name)) {\n      throw new Error(\n        `${this.constructor.name}: A provider named \"${name}\" already exists.`,\n      );\n    }\n    if (typeof searchFn !== 'function') {\n      throw new Error(\n        `${this.constructor.name}: \"searchFn\" must be a function.`,\n      );\n    }\n    if (typeof readyCheckFn !== 'function') {\n      throw new Error(\n        `${this.constructor.name}: \"readyCheckFn\" must be a function.`,\n      );\n    }\n    this._searchProviders.set(name, {\n      searchFn,\n      readyCheckFn,\n    });\n  }\n\n  addQuerySource({ getQueriesFn, readyCheckFn }) {\n    if (typeof getQueriesFn !== 'function') {\n      throw new Error(\n        `${this.constructor.name}: \"getQueriesFn\" must be a function.`,\n      );\n    }\n    if (typeof readyCheckFn !== 'function') {\n      throw new Error(\n        `${this.constructor.name}: \"readyCheckFn\" must be a function.`,\n      );\n    }\n    if (this._querySources.has(getQueriesFn)) {\n      throw new Error(\n        `${this.constructor.name}: this getQueryFn has already been added.`,\n      );\n    }\n    this._querySources.set(getQueriesFn, readyCheckFn);\n  }\n\n  @proxify\n  async triggerMatch({ ignoreCache = false, ignoreQueue = false } = {}) {\n    if (this.ready) {\n      this._cleanUp();\n      await this.match({\n        queries: this._getQueries(),\n        ignoreCache,\n        ignoreQueue,\n      });\n    }\n  }\n\n  @proxify\n  async match({ queries, ignoreCache = false, ignoreQueue = false }) {\n    await Promise.all(\n      [...this._searchProviders.keys()].map((name) =>\n        this._matchSource({\n          name,\n          queries,\n          ignoreCache,\n          ignoreQueue,\n        }),\n      ),\n    );\n  }\n\n  async _fetchMatchResult({ name, queries }) {\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.match,\n        queries,\n        name,\n      });\n      const provider = this._searchProviders.get(name);\n      if (!provider) {\n        throw new Error(\n          `${this.constructor.name}: provider named \"${name} does not exist`,\n        );\n      }\n      const promise = Promise.resolve(\n        provider.searchFn({\n          queries,\n        }),\n      );\n      this._matchPromises.set(name, {\n        promise,\n        queries,\n      });\n      const data = await promise;\n      this._matchPromises.delete(name);\n      this.store.dispatch({\n        type: this.actionTypes.matchSuccess,\n        name,\n        queries,\n        data,\n        timestamp: Date.now(),\n      });\n    } catch (error) {\n      this._matchPromises.delete(name);\n      this.store.dispatch({\n        type: this.actionTypes.matchError,\n        name,\n        queries,\n        error,\n        timestamp: Date.now(),\n      });\n      throw error;\n    }\n  }\n\n  @proxify\n  async _matchSource({ name, queries, ignoreCache, ignoreQueue }) {\n    const now = Date.now();\n    const data = this.data;\n    const queuedItems = {};\n    const promises = [];\n\n    let matching;\n    if (!ignoreQueue && this._matchPromises.has(name)) {\n      matching = this._matchPromises.get(name);\n      promises.push(matching.promise);\n      matching.queries.forEach((item) => {\n        queuedItems[item] = true;\n      });\n    }\n\n    let queue;\n    if (!ignoreQueue && this._matchQueues.has(name)) {\n      queue = this._matchQueues.get(name);\n      promises.push(queue.promise);\n      queue.queries.forEach((item) => {\n        queuedItems[item] = true;\n      });\n    }\n\n    const newQueries = ignoreCache\n      ? queries\n      : filter(\n          (query) =>\n            !queuedItems[query] &&\n            (!data[query] ||\n              !data[query][name] ||\n              now - data[query][name]._t > this._noMatchTtl),\n          queries,\n        );\n\n    if (newQueries.length) {\n      if (ignoreQueue) {\n        promises.push(\n          this._fetchMatchResult({\n            name,\n            queries: newQueries,\n          }),\n        );\n      } else if (!matching) {\n        matching = this._fetchMatchResult({\n          name,\n          queries: newQueries,\n        });\n        promises.push(matching);\n      } else if (!queue) {\n        queue = {\n          queries: newQueries,\n        };\n        queue.promise = (async () => {\n          await matching.promise;\n          const promise = this._fetchMatchResult({\n            name,\n            queries: queue.queries,\n          });\n          this._matchQueues.delete(name);\n          await promise;\n        })();\n        this._matchQueues.set(name, queue);\n        promises.push(queue.promise);\n      } else {\n        queue.queries = queue.queries.concat(newQueries);\n      }\n    }\n    await Promise.all(promises);\n  }\n\n  /**\n   * insert matching result directly\n   */\n  @proxify\n  insertMatching({ name, data, queries }) {\n    this.store.dispatch({\n      type: this.actionTypes.insertMatchEntries,\n      data,\n      queries,\n      name,\n      timestamp: Date.now(),\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get data() {\n    return this._data;\n  }\n\n  @selector\n  _data = [\n    () =>\n      this._storage ? this._storage.getItem(this._storageKey) : this.state.data,\n    (data) => data || {},\n  ];\n\n  get dataMapping() {\n    return this._dataMapping;\n  }\n\n  @selector\n  _dataMapping = [\n    () => this.data,\n    () => this.ready,\n    () => Array.from(this._searchProviders.keys()).length,\n    (data, ready, prividers) => {\n      if (!ready || !prividers) return {};\n      const dataMap = {};\n      forEach((query) => {\n        const queryResult = data[query];\n        if (!queryResult) {\n          return;\n        }\n        let matchesList = [];\n        forEach((_providerValue, providerName) => {\n          if (\n            queryResult[providerName] &&\n            queryResult[providerName].data.length > 0\n          ) {\n            matchesList = matchesList.concat(queryResult[providerName].data);\n          }\n        }, this._searchProviders);\n        if (matchesList.length > 0) {\n          dataMap[query] = matchesList;\n        }\n      }, Object.keys(data));\n      return dataMap;\n    },\n  ];\n}\n"],"file":"index.js"}
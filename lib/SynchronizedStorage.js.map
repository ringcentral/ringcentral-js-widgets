{"version":3,"sources":["lib/SynchronizedStorage.js"],"names":["SynchronizedStorage","storageKey","Error","_storageKey","_id","v4","localStorage","window","_storageHandler","event","key","substring","length","JSON","parse","newValue","setter","id","setTimeout","emit","value","getItem","error","_localStorage","addEventListener","len","keys","i","push","output","getLocalStorageKeys","forEach","dataKey","undefined","setItem","removeItem","removeEventListener","prototype"],"mappings":"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","file":"SynchronizedStorage.js","sourcesContent":["import uuid from 'uuid';\nimport emitter from 'event-emitter';\nimport MemoryStorage from './MemoryStorage';\n\n// TODO: experiment with a managed list of keys to watch rather than matching every event with\n// storageKey might provide better performance\n\nexport default class SynchronizedStorage {\n  constructor({\n    storageKey,\n  }) {\n    if (!storageKey) {\n      throw Error('SynchronizedStorage must be created with a storage key');\n    }\n    this._storageKey = storageKey;\n    this._id = uuid.v4();\n    if (typeof localStorage !== 'undefined' && typeof window !== 'undefined') {\n      this._storageHandler = (event) => {\n        if (event.key.substring(0, this._storageKey.length) === this._storageKey) {\n          try {\n            const {\n              setter,\n            } = JSON.parse(event.newValue);\n            if (setter && setter !== this.id) {\n              const key = event.key.substring(this._storageKey.length + 1);\n              // It seems that IE11 does not update the actual localStorage object\n              // in the same event cycle...\n              setTimeout(() => {\n                this.emit('storage', {\n                  key,\n                  value: this.getItem(key),\n                });\n              }, 0);\n            }\n          } catch (error) {\n            /* ignore error */\n          }\n        }\n      };\n      this._localStorage = localStorage;\n      window.addEventListener('storage', this._storageHandler);\n    } else {\n      this._localStorage = new MemoryStorage();\n    }\n  }\n  getLocalStorageKeys() {\n    const len = this._localStorage.length;\n    const keys = [];\n    for (let i = 0; i < len; i += 1) {\n      const key = this._localStorage.key(i);\n      if (key && key !== '') {\n        keys.push(key);\n      }\n    }\n    return keys;\n  }\n  getData() {\n    const output = {};\n    this.getLocalStorageKeys().forEach((key) => {\n      if (key.substring(0, this._storageKey.length) === this._storageKey) {\n        const dataKey = key.substring(this._storageKey.length + 1);\n        output[dataKey] = this.getItem(dataKey);\n      }\n    });\n    return output;\n  }\n  getItem(key) {\n    try {\n      const {\n        value,\n      } = JSON.parse(this._localStorage.getItem(`${this._storageKey}-${key}`));\n      return value;\n    } catch (error) {\n      return undefined;\n    }\n  }\n  setItem(key, value) {\n    this._localStorage.setItem(\n      `${this._storageKey}-${key}`,\n      JSON.stringify({\n        value,\n        setter: this.id,\n      }),\n    );\n  }\n  removeItem(key) {\n    this._localStorage.removeItem(\n      `${this._storageKey}-${key}`,\n    );\n  }\n  destroy() {\n    if (this._storageHandler) {\n      window.removeEventListener('storage', this._storageHandler);\n    }\n  }\n  get id() {\n    return this._id;\n  }\n}\n\nemitter(SynchronizedStorage.prototype);\n"]}
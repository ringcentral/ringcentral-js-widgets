{"version":3,"file":"fetchWithJsonp.js","names":["RUNTIME","fetchWithJsonp","url","key","lastPromise","runtime","promise","_asyncToGenerator","regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","t0","abrupt","Promise","resolve","reject","script","document","createElement","src","onerror","body","removeChild","window","Error","concat","data","appendChild","stop","exports"],"sources":["lib/fetchWithJsonp.ts"],"sourcesContent":["const RUNTIME: Record<\n  string,\n  {\n    lastPromise: Promise<any> | null;\n  }\n> = {};\n\nexport const fetchWithJsonp = <T>(url: string, key: string) => {\n  if (!RUNTIME[key]) {\n    RUNTIME[key] = {\n      lastPromise: null,\n    };\n  }\n  const runtime = RUNTIME[key];\n  const lastPromise = runtime?.lastPromise;\n  const promise = (async () => {\n    try {\n      // if there is already ongoing request, wait for it to be done\n      // before replacing the window.[key] function\n      await lastPromise;\n    } catch (error: any /** TODO: confirm with instanceof */) {\n      // ignore last error\n    }\n    return new Promise<T>((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = url;\n      script.onerror = () => {\n        document.body.removeChild(script);\n        (window as any)[key] = null;\n        if (runtime.lastPromise === promise) {\n          runtime.lastPromise = null;\n        }\n        reject(new Error(`'${url}' jsonp fetch failed`));\n      };\n      (window as any)[key] = (data: T) => {\n        document.body.removeChild(script);\n        (window as any)[key] = null;\n        if (runtime.lastPromise === promise) {\n          runtime.lastPromise = null;\n        }\n        resolve(data);\n      };\n      document.body.appendChild(script);\n    });\n  })();\n  runtime.lastPromise = promise;\n  return promise;\n};\n"],"mappings":";;;;;;;;;;;AAAA,IAAMA,OAKL,GAAG,CAAC,CAAC;AAEC,IAAMC,cAAc,GAAG,SAAjBA,cAAcA,CAAOC,GAAW,EAAEC,GAAW,EAAK;EAC7D,IAAI,CAACH,OAAO,CAACG,GAAG,CAAC,EAAE;IACjBH,OAAO,CAACG,GAAG,CAAC,GAAG;MACbC,WAAW,EAAE;IACf,CAAC;EACH;EACA,IAAMC,OAAO,GAAGL,OAAO,CAACG,GAAG,CAAC;EAC5B,IAAMC,WAAW,GAAGC,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAED,WAAW;EACxC,IAAME,OAAO,GAAGC,iBAAA,eAAAC,kBAAA,CAAAC,IAAA,CAAC,SAAAC,QAAA;IAAA,OAAAF,kBAAA,CAAAG,IAAA,UAAAC,SAAAC,QAAA;MAAA;QAAA,QAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;UAAA;YAAAF,QAAA,CAAAC,IAAA;YAAAD,QAAA,CAAAE,IAAA;YAAA,OAIPX,WAAW;UAAA;YAAAS,QAAA,CAAAE,IAAA;YAAA;UAAA;YAAAF,QAAA,CAAAC,IAAA;YAAAD,QAAA,CAAAG,EAAA,GAAAH,QAAA;UAAA;YAAA,OAAAA,QAAA,CAAAI,MAAA,WAIZ,IAAIC,OAAO,CAAI,UAACC,OAAO,EAAEC,MAAM,EAAK;cACzC,IAAMC,MAAM,GAAGC,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;cAC/CF,MAAM,CAACG,GAAG,GAAGtB,GAAG;cAChBmB,MAAM,CAACI,OAAO,GAAG,YAAM;gBACrBH,QAAQ,CAACI,IAAI,CAACC,WAAW,CAACN,MAAM,CAAC;gBAChCO,MAAM,CAASzB,GAAG,CAAC,GAAG,IAAI;gBAC3B,IAAIE,OAAO,CAACD,WAAW,KAAKE,OAAO,EAAE;kBACnCD,OAAO,CAACD,WAAW,GAAG,IAAI;gBAC5B;gBACAgB,MAAM,CAAC,IAAIS,KAAK,KAAAC,MAAA,CAAK5B,GAAG,yBAAsB,CAAC,CAAC;cAClD,CAAC;cACA0B,MAAM,CAASzB,GAAG,CAAC,GAAG,UAAC4B,IAAO,EAAK;gBAClCT,QAAQ,CAACI,IAAI,CAACC,WAAW,CAACN,MAAM,CAAC;gBAChCO,MAAM,CAASzB,GAAG,CAAC,GAAG,IAAI;gBAC3B,IAAIE,OAAO,CAACD,WAAW,KAAKE,OAAO,EAAE;kBACnCD,OAAO,CAACD,WAAW,GAAG,IAAI;gBAC5B;gBACAe,OAAO,CAACY,IAAI,CAAC;cACf,CAAC;cACDT,QAAQ,CAACI,IAAI,CAACM,WAAW,CAACX,MAAM,CAAC;YACnC,CAAC,CAAC;UAAA;UAAA;YAAA,OAAAR,QAAA,CAAAoB,IAAA;QAAA;MAAA;IAAA,GAAAvB,OAAA;EAAA,CACH,GAAE,CAAC;EACJL,OAAO,CAACD,WAAW,GAAGE,OAAO;EAC7B,OAAOA,OAAO;AAChB,CAAC;AAAC4B,OAAA,CAAAjC,cAAA,GAAAA,cAAA"}
{"version":3,"file":"RcModule.js","names":["setAutoFreeze","setPatchesToggle","process","env","DISABLE_PATCHES","enablePatches","ModuleStatus","onceKey","Symbol","onInitOnceKey","notReadyModulesKey","checkStatusChangeKey","enableCacheKey","enableGlobalCacheKey","storageKey","storageStateKey","globalStorageStateKey","spawnReducersKey","spawnStorageReducersKey","ignoreReadyModulesKey","RcModuleV2","deps","enableCache","enableGlobalCache","options","_transport","Set","_deps","_modulePath","_initialized","_suppressInit","_reducers","_getStateV2","state","key","subscribe","onStateChange","storage","forEach","stateKey","globalStorage","status","onInitOnce","_shouldInit","_setStatus","Initializing","onInit","Ready","onInitSuccess","_shouldReset","Resetting","onReset","Pending","dep","add","lastState","__state","storeKey","getState","identifierKey","__identifier","data","storageReducerKey","Object","assign","areAllReady","length","pending","areNotReady","ready","checkedModules","pickedModules","values","module","notReadyModules","filter","item","includes","push","_depsCheck","callback","descriptors","descriptor","getOwnPropertyDescriptor","initialState","value","registerReducer","reducer","action","_usm","usmAction","type","hasOwnProperty","call","_state","enumerable","configurable","get","stagedState","getStagedState","set","Error","defineProperties","_initModule","keys","reduce","serviceReducersMapObject","stateDescriptor","parentModule","subscriptionsKey","subModule","subRcModule","name","prototype","defineProperty","modulePath","modules","has","store","combineReducers"],"sources":["lib/RcModule/RcModule.ts"],"sourcesContent":["import { combineReducers, Reducer, ReducersMapObject } from 'redux';\nimport {\n  action,\n  Action,\n  applyPatches,\n  computed,\n  createStore,\n  enableES5,\n  enablePatches,\n  getStagedState,\n  identifierKey,\n  Service,\n  setAutoFreeze,\n  setPatchesToggle,\n  state,\n  stateKey,\n  Store,\n  storeKey,\n  subscribe,\n  Subscription,\n  subscriptionsKey,\n  usm as usmAction,\n  watch,\n} from '../usm-redux';\n\nsetAutoFreeze(false);\n\nsetPatchesToggle(!process.env.DISABLE_PATCHES);\nif (!process.env.DISABLE_PATCHES) {\n  enablePatches();\n}\n\nexport const enum ModuleStatus {\n  Pending = 'PENDING',\n  Initializing = 'INITIALIZING',\n  Ready = 'READY',\n  Resetting = 'RESETTING',\n}\n\nexport const onceKey: unique symbol = Symbol('once');\nexport const onInitOnceKey: unique symbol = Symbol('onInitOnce');\nexport const notReadyModulesKey: unique symbol = Symbol('notReadyModules');\nexport const checkStatusChangeKey: unique symbol = Symbol('checkStatusChange');\nexport const enableCacheKey: unique symbol = Symbol('enableCache');\nexport const enableGlobalCacheKey: unique symbol = Symbol('enableGlobalCache');\nexport const storageKey: unique symbol = Symbol('storage');\nexport const storageStateKey: unique symbol = Symbol('storageState');\nexport const globalStorageStateKey: unique symbol =\n  Symbol('globalStorageState');\nexport const spawnReducersKey: unique symbol = Symbol('spawnReducers');\nexport const spawnStorageReducersKey: unique symbol = Symbol(\n  'spawnStorageReducers',\n);\nexport const ignoreReadyModulesKey: unique symbol =\n  Symbol('ignoreReadyModules');\n\nexport interface RcModuleOptions<T> {\n  deps?: T & {\n    storage?: any;\n    globalStorage?: any;\n  };\n  enableCache?: boolean;\n  enableGlobalCache?: boolean;\n  storageKey?: string;\n}\n\ninterface RcModuleV2 {\n  parentModule: RcModuleV2;\n  [storageStateKey]: string[];\n  [globalStorageStateKey]: string[];\n  [stateKey]: Record<string, any>;\n  [identifierKey]: string;\n  [subscriptionsKey]: Subscription[];\n  [storeKey]: Store;\n}\n\ninterface IStorage extends RcModuleV2 {\n  registerReducer(options: {\n    key: string;\n    reducer: Reducer<any, Action>;\n  }): void;\n  data: Record<string, any>;\n}\n\n/**\n * Module system based on Dependency Injection and Redux\n *\n * life cycle:\n * - `constructor`\n * - `onInitOnce`: when deps are ready, only run once in whole life cycle\n * - `onInit`: when module init, module status will be set to `ready` after that event.\n * - `onInitSuccess`: when onInit be passed successfully, this event will be triggered.\n * - `onReset`: when one of deps be reset, this event will be triggered.\n */\nabstract class RcModuleV2<\n  T extends Record<string, any> & {\n    storage?: IStorage;\n    globalStorage?: IStorage;\n  } = {},\n> {\n  private [onceKey] = false;\n\n  private [storageKey]?: string;\n\n  private [enableCacheKey]: boolean;\n\n  private [enableGlobalCacheKey]: boolean;\n\n  /**\n   * background/client transport for browser extension\n   */\n  protected _transport?: any; // TODO: add transport type\n  private [ignoreReadyModulesKey] = new Set<RcModuleV2>();\n\n  protected initializeProxy?(): Promise<void> | void;\n  /**\n   * `onInit` life cycle for current initialization before all deps modules are all ready.\n   */\n  protected onInit?(): Promise<void> | void;\n  /**\n   * `onInitOnce` once life cycle for current initialization before all deps modules are all ready.\n   */\n  protected onInitOnce?(): Promise<void> | void;\n  /**\n   * `onInitSuccess` life cycle for current initialization after this module is ready.\n   */\n  protected onInitSuccess?(): Promise<void> | void;\n  /**\n   * `onReset` life cycle for current reset before one of deps modules is not ready.\n   */\n  protected onReset?(): Promise<void> | void;\n  /**\n   * Each Redux dispatch action will trigger `onStateChange` once.\n   */\n  protected onStateChange?(): Promise<void> | void;\n\n  protected _deps: T;\n\n  constructor({\n    deps,\n    enableCache = false,\n    enableGlobalCache = false,\n    ...options\n  }: RcModuleOptions<T> = {}) {\n    this._deps = deps! ?? {};\n    this[storageKey] = options.storageKey;\n    this[enableCacheKey] = enableCache;\n    this[enableGlobalCacheKey] = enableGlobalCache;\n    subscribe(this, () => {\n      if (typeof this.onStateChange === 'function') {\n        this.onStateChange();\n      }\n      this[checkStatusChangeKey]();\n    });\n    if (\n      !this[storageStateKey] ||\n      !this[enableCacheKey] ||\n      !this._deps.storage\n    ) {\n      this[storageStateKey] = [];\n    }\n    this[storageStateKey].forEach((key) => delete this[stateKey][key]);\n    if (\n      !this[globalStorageStateKey] ||\n      !this[enableGlobalCacheKey] ||\n      !this._deps.globalStorage\n    ) {\n      this[globalStorageStateKey] = [];\n    }\n    this[globalStorageStateKey].forEach((key) => delete this[stateKey][key]);\n  }\n\n  @state\n  status = ModuleStatus.Pending;\n\n  @action\n  private _setStatus(status: ModuleStatus) {\n    this.status = status;\n  }\n\n  private async [onInitOnceKey]() {\n    if (!this[onceKey]) {\n      this[onceKey] = true;\n      if (typeof this.onInitOnce === 'function') {\n        await this.onInitOnce();\n      }\n    }\n  }\n\n  private async [checkStatusChangeKey]() {\n    if (this._shouldInit()) {\n      this._setStatus(ModuleStatus.Initializing);\n      await this[onInitOnceKey]();\n      if (typeof this.onInit === 'function') {\n        await this.onInit();\n      }\n      this._setStatus(ModuleStatus.Ready);\n      if (typeof this.onInitSuccess === 'function') {\n        await this.onInitSuccess();\n      }\n    } else if (this._shouldReset()) {\n      this._setStatus(ModuleStatus.Resetting);\n      if (typeof this.onReset === 'function') {\n        await this.onReset();\n      }\n      this._setStatus(ModuleStatus.Pending);\n    }\n  }\n\n  protected _ignoreModuleReadiness(dep: RcModuleV2) {\n    this[ignoreReadyModulesKey].add(dep);\n  }\n\n  private get [notReadyModulesKey](): RcModuleV2[] {\n    const modules = Object.values(this._deps || {}).filter(\n      // In order to be compatible with RcModuleV1\n      (module: RcModuleV2) => module && typeof module.ready !== 'undefined',\n    );\n    return modules.filter(\n      (module: RcModuleV2) =>\n        !module.ready && !this[ignoreReadyModulesKey].has(module),\n    );\n  }\n\n  private _getLastState() {\n    const lastState: Record<string, any> = {\n      // for combineReducers check state with reducers\n      __state: this._getStateV2(this[storeKey].getState(), this[identifierKey]),\n      __identifier: this[identifierKey],\n    };\n    if (this._deps.storage?.data) {\n      this[storageStateKey].forEach((key: string) => {\n        const storageReducerKey = `${this[storageKey]}-${key}`;\n        lastState[key] = this._deps.storage!.data[storageReducerKey];\n      });\n    }\n    if (this._deps.globalStorage?.data) {\n      this[globalStorageStateKey].forEach((key: string) => {\n        const storageReducerKey = `${this[storageKey]}-${key}`;\n        lastState[key] = this._deps.globalStorage!.data[storageReducerKey];\n      });\n    }\n    return lastState;\n  }\n\n  private _handleState(state: {\n    __state?: Record<string, any>;\n    __identifier?: string;\n    [key: string]: any;\n  }) {\n    Object.assign(state, state.__state);\n    delete state.__state;\n    delete state.__identifier;\n  }\n\n  _shouldInit() {\n    const areAllReady = this[notReadyModulesKey].length === 0;\n    return areAllReady && this.pending;\n  }\n\n  _shouldReset() {\n    const areNotReady = this[notReadyModulesKey].length > 0;\n    return areNotReady && this.ready;\n  }\n\n  _depsCheck(\n    checkedModules: RcModuleV2[] = [this],\n    pickedModules: RcModuleV2[] = [],\n  ) {\n    Object.values(this._deps ?? {}).forEach((module) => {\n      if (module instanceof RcModuleV2 && !module.ready) {\n        const notReadyModules = Object.values(module._deps ?? {}).filter(\n          (item) => item instanceof RcModuleV2 && !item.ready,\n        );\n        if (notReadyModules.length > 0 && !checkedModules.includes(module)) {\n          checkedModules.push(module);\n          module._depsCheck(checkedModules, pickedModules);\n        } else if (\n          !pickedModules.includes(module) &&\n          notReadyModules.length === 0\n        ) {\n          pickedModules.push(module);\n        }\n      }\n    });\n    // please check `_shouldInit()` or `onInit()`.\n    return pickedModules;\n  }\n\n  @action\n  _changeState(callback: () => void) {\n    callback();\n  }\n\n  get pending() {\n    return this.status === ModuleStatus.Pending;\n  }\n\n  get ready() {\n    return this.status === ModuleStatus.Ready;\n  }\n\n  get resetting() {\n    return this.status === ModuleStatus.Resetting;\n  }\n\n  get initializing() {\n    return this.status === ModuleStatus.Initializing;\n  }\n\n  get store() {\n    return this[storeKey];\n  }\n\n  private [spawnStorageReducersKey]() {\n    const descriptors: PropertyDescriptorMap = {};\n    /**\n     * make storage reducer and state\n     */\n    this[storageStateKey].forEach((key) => {\n      const descriptor = Object.getOwnPropertyDescriptor(this, key);\n      if (typeof descriptor === 'undefined') return;\n      const initialState = descriptor.value;\n      const storageReducerKey = `${this[storageKey]}-${key}`;\n      this._deps.storage!.registerReducer({\n        key: storageReducerKey,\n        reducer: (state = initialState, action: Action) =>\n          action._usm === usmAction &&\n          action.type === this[identifierKey] &&\n          Object.hasOwnProperty.call(action._state, key)\n            ? action._state[key]\n            : state,\n      });\n      Object.assign(descriptors, {\n        [key]: {\n          enumerable: true,\n          configurable: false,\n          get(this: Service) {\n            const stagedState: any = getStagedState();\n            return stagedState?.__identifier === this[identifierKey]\n              ? stagedState[key]\n              : this._deps.storage.data![storageReducerKey];\n          },\n          set(this: Service, value: unknown) {\n            const stagedState = getStagedState();\n            if (\n              stagedState &&\n              stagedState.__identifier !== this[identifierKey]\n            ) {\n              throw new Error(\n                `RcModule does not support cross-module execution of the methods decorated by action`,\n              );\n            }\n            if (stagedState) {\n              stagedState[key] = value;\n              return;\n            }\n            this._deps.storage.data![storageReducerKey] = value;\n          },\n        },\n      });\n    });\n\n    /**\n     * make global storage reducer and state\n     */\n    this[globalStorageStateKey].forEach((key) => {\n      const descriptor = Object.getOwnPropertyDescriptor(this, key);\n      if (typeof descriptor === 'undefined') return;\n      const initialState = descriptor.value;\n      const storageReducerKey = `${this[storageKey]}-${key}`;\n      this._deps.globalStorage!.registerReducer({\n        key: storageReducerKey,\n        reducer: (state = initialState, action: Action) =>\n          action._usm === usmAction &&\n          action.type === this[identifierKey] &&\n          Object.hasOwnProperty.call(action._state, key)\n            ? action._state[key]\n            : state,\n      });\n      Object.assign(descriptors, {\n        [key]: {\n          enumerable: true,\n          configurable: false,\n          get(this: Service) {\n            const stagedState = getStagedState();\n            return stagedState?.__identifier === this[identifierKey]\n              ? stagedState[key]\n              : this._deps.globalStorage.data![storageReducerKey];\n          },\n          set(this: Service, value: unknown) {\n            const stagedState = getStagedState();\n            if (\n              stagedState &&\n              stagedState.__identifier !== this[identifierKey]\n            ) {\n              throw new Error(\n                `RcModule does not support cross-module execution of the methods decorated by action`,\n              );\n            }\n            if (stagedState) {\n              stagedState[key] = value;\n              return;\n            }\n            this._deps.globalStorage.data![storageReducerKey] = value;\n          },\n        },\n      });\n    });\n\n    Object.defineProperties(this, descriptors);\n  }\n\n  // TODO: Refactor without RcModuleV1\n  // harmony with RcModule V1 for modules initialization\n\n  private _modulePath = 'root';\n\n  private _initialized = false;\n\n  private _suppressInit?: boolean;\n\n  protected _reducers?: ReducersMapObject;\n\n  protected _getStateV2 = (state: Record<string, any>, key: string) =>\n    state[key];\n\n  private _setStore() {\n    return this._initModule();\n  }\n\n  get _store() {\n    return this.store;\n  }\n\n  private [spawnReducersKey]() {\n    const descriptors: PropertyDescriptorMap = {\n      [stateKey]: {\n        enumerable: false,\n        configurable: false,\n        get(this: Service) {\n          const stagedState = getStagedState();\n          return stagedState?.__identifier === this[identifierKey]\n            ? stagedState.__state\n            : this._getStateV2(this[storeKey]?.getState(), this[identifierKey]);\n        },\n      },\n    };\n    this._reducers = Object.keys(this[stateKey] ?? {}).reduce(\n      (serviceReducersMapObject: ReducersMapObject, key) => {\n        const descriptor = Object.getOwnPropertyDescriptor(this, key);\n        if (typeof descriptor === 'undefined') return serviceReducersMapObject;\n        const initialState = descriptor.value;\n        Object.assign(descriptors, {\n          [key]: {\n            enumerable: true,\n            configurable: false,\n            get(this: Service) {\n              return this[stateKey][key];\n            },\n            set(this: Service, value: unknown) {\n              this[stateKey][key] = value;\n            },\n          },\n        });\n        return Object.assign(serviceReducersMapObject, {\n          [key]: (state = initialState, action: Action) =>\n            action._usm === usmAction &&\n            this[identifierKey] === action.type &&\n            Object.hasOwnProperty.call(action._state, key)\n              ? action._state[key]\n              : state,\n        });\n      },\n      {},\n    );\n    const stateDescriptor = Object.getOwnPropertyDescriptor(this, stateKey);\n    if (stateDescriptor && typeof stateDescriptor.get === 'function') return;\n    Object.defineProperties(this, descriptors);\n  }\n\n  get reducer(): Reducer<any, Action<any>> {\n    if (this._reducers) return combineReducers(this._reducers);\n    this[spawnStorageReducersKey]();\n    this[spawnReducersKey]();\n    if (!this._reducers) {\n      throw new Error(`Combine reducers error`);\n    }\n    return combineReducers(this._reducers!);\n  }\n\n  async _initModule() {\n    this._initialized = true;\n    if (\n      (this.parentModule && !(this.parentModule instanceof RcModuleV2)) ||\n      (!this.parentModule && !(this instanceof RcModuleV2))\n    ) {\n      for (const subscribe of this[subscriptionsKey] ?? []) {\n        subscribe();\n      }\n      this[subscriptionsKey] = [];\n    }\n    await this[checkStatusChangeKey]();\n    // eslint-disable-next-line guard-for-in\n    for (const subModule in this) {\n      const subRcModule = this[subModule] as any;\n      if (\n        subRcModule &&\n        typeof subRcModule._initModule === 'function' &&\n        !subRcModule._initialized &&\n        !subRcModule._suppressInit\n      ) {\n        subRcModule._initModule();\n      }\n    }\n  }\n\n  private get proxyReady() {\n    return this.ready;\n  }\n\n  private get modulePath() {\n    return this._modulePath;\n  }\n\n  private addModule(name: string, module: unknown) {\n    if (Object.prototype.hasOwnProperty.call(this, name)) {\n      throw new Error(`Property '${name}' already exists...`);\n    }\n    Object.defineProperty(this, name, {\n      get() {\n        return module;\n      },\n      enumerable: true,\n    });\n    if ((this as any)[name]._modulePath === 'root') {\n      (this as any)[name]._modulePath = `${this.modulePath}.${name}`;\n    }\n  }\n\n  private get state() {\n    return this[stateKey];\n  }\n\n  private actionTypes() {\n    return {};\n  }\n}\n\nexport {\n  RcModuleV2,\n  state,\n  action,\n  subscribe,\n  computed,\n  createStore,\n  watch,\n  stateKey,\n  storeKey,\n  identifierKey,\n  applyPatches,\n  usmAction,\n  enableES5,\n  setAutoFreeze,\n};\n"],"mappings":"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"}
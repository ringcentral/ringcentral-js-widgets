{"version":3,"file":"SleepDetection.js","names":["_ObjectMap","require","_events","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","e","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","DEFAULT_INTERVAL","DEFAULT_THRESHOLD","DEFAULT_MAX_LISTENERS","EVENTS","ObjectMap","fromKeys","exports","SleepDetection","_ref","arguments","undefined","_ref$detectionInterva","detectionInterval","_ref$detectionThresho","detectionThreshold","_ref$maxListeners","maxListeners","_ref$startImmediately","startImmediately","_detectionInterval","_detectionThreshold","_timeoutId","_emitter","EventEmitter","setMaxListeners","start","value","on","event","handler","off","_detect","_this","stop","startTime","Date","now","emit","events","heartbeat","global","setTimeout","endTime","sleepTime","console","log","detected","clearTimeout","get"],"sources":["lib/SleepDetection/SleepDetection.ts"],"sourcesContent":["import type { ObjectMapValue } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { ObjectMap } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { EventEmitter } from 'events';\n\nconst DEFAULT_INTERVAL = 20 * 1000;\n// For chrome 88 timer-throttling https://developer.chrome.com/blog/timer-throttling-in-chrome-88/\n// need to make sure time diff is more than 1 min\nconst DEFAULT_THRESHOLD = 75 * 1000;\nconst DEFAULT_MAX_LISTENERS = 30;\n\nexport const EVENTS = ObjectMap.fromKeys(['heartbeat', 'detected']);\n\nexport interface SleepDetectionOptions {\n  detectionInterval?: number;\n  detectionThreshold?: number;\n  startImmediately?: boolean;\n  maxListeners?: number;\n}\n\nexport class SleepDetection {\n  protected _detectionInterval: number;\n  protected _detectionThreshold: number;\n  protected _timeoutId: NodeJS.Timeout | null = null;\n  protected _emitter = new EventEmitter();\n\n  constructor({\n    detectionInterval = DEFAULT_INTERVAL,\n    detectionThreshold = DEFAULT_THRESHOLD,\n    maxListeners = DEFAULT_MAX_LISTENERS,\n    startImmediately = true,\n  }: SleepDetectionOptions = {}) {\n    this._detectionInterval = detectionInterval;\n    this._detectionThreshold = detectionThreshold;\n    this._emitter.setMaxListeners(maxListeners);\n    if (startImmediately) {\n      this.start();\n    }\n  }\n\n  get events() {\n    return EVENTS;\n  }\n\n  on(event: ObjectMapValue<typeof EVENTS>, handler: (...args: any[]) => any) {\n    this._emitter.on(event, handler);\n  }\n\n  off(event: ObjectMapValue<typeof EVENTS>, handler: (...args: any[]) => any) {\n    this._emitter.off(event, handler);\n  }\n\n  protected _detect() {\n    this.stop();\n    const startTime = Date.now();\n    this._emitter.emit(this.events.heartbeat, startTime);\n    this._timeoutId = global.setTimeout(() => {\n      const endTime = Date.now();\n      const sleepTime = endTime - startTime - this._detectionInterval;\n      if (sleepTime > this._detectionThreshold) {\n        console.log('==== Sleep Detected =====');\n        this._emitter.emit(this.events.detected, startTime, endTime, sleepTime);\n      }\n      this._timeoutId = null;\n      this._detect();\n    }, this._detectionInterval);\n  }\n\n  start() {\n    this._detect();\n  }\n\n  stop() {\n    if (this._timeoutId) {\n      global.clearTimeout(this._timeoutId);\n      this._timeoutId = null;\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}
{"version":3,"file":"SleepDetection.js","names":["_events","require","_ObjectMap","_typeof","obj","Symbol","iterator","constructor","prototype","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","protoProps","staticProps","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","call","Number","DEFAULT_INTERVAL","DEFAULT_THRESHOLD","DEFAULT_MAX_LISTENERS","EVENTS","ObjectMap","fromKeys","exports","SleepDetection","_ref","arguments","_ref$detectionInterva","detectionInterval","_ref$detectionThresho","detectionThreshold","_ref$maxListeners","maxListeners","_ref$startImmediately","startImmediately","_detectionInterval","_detectionThreshold","_timeoutId","_emitter","EventEmitter","setMaxListeners","start","value","on","event","handler","off","_detect","_this","stop","startTime","Date","now","emit","events","heartbeat","global","setTimeout","endTime","sleepTime","console","log","detected","clearTimeout","get"],"sources":["lib/SleepDetection/SleepDetection.ts"],"sourcesContent":["import { EventEmitter } from 'events';\n\nimport type { ObjectMapValue } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { ObjectMap } from '@ringcentral-integration/core/lib/ObjectMap';\n\nconst DEFAULT_INTERVAL = 20 * 1000;\n// For chrome 88 timer-throttling https://developer.chrome.com/blog/timer-throttling-in-chrome-88/\n// need to make sure time diff is more than 1 min\nconst DEFAULT_THRESHOLD = 75 * 1000;\nconst DEFAULT_MAX_LISTENERS = 30;\n\nexport const EVENTS = ObjectMap.fromKeys(['heartbeat', 'detected']);\n\nexport interface SleepDetectionOptions {\n  detectionInterval?: number;\n  detectionThreshold?: number;\n  startImmediately?: boolean;\n  maxListeners?: number;\n}\n\nexport class SleepDetection {\n  protected _detectionInterval: number;\n  protected _detectionThreshold: number;\n  protected _timeoutId: NodeJS.Timeout | null = null;\n  protected _emitter = new EventEmitter();\n\n  constructor({\n    detectionInterval = DEFAULT_INTERVAL,\n    detectionThreshold = DEFAULT_THRESHOLD,\n    maxListeners = DEFAULT_MAX_LISTENERS,\n    startImmediately = true,\n  }: SleepDetectionOptions = {}) {\n    this._detectionInterval = detectionInterval;\n    this._detectionThreshold = detectionThreshold;\n    this._emitter.setMaxListeners(maxListeners);\n    if (startImmediately) {\n      this.start();\n    }\n  }\n\n  get events() {\n    return EVENTS;\n  }\n\n  on(event: ObjectMapValue<typeof EVENTS>, handler: (...args: any[]) => any) {\n    this._emitter.on(event, handler);\n  }\n\n  off(event: ObjectMapValue<typeof EVENTS>, handler: (...args: any[]) => any) {\n    this._emitter.off(event, handler);\n  }\n\n  protected _detect() {\n    this.stop();\n    const startTime = Date.now();\n    this._emitter.emit(this.events.heartbeat, startTime);\n    this._timeoutId = global.setTimeout(() => {\n      const endTime = Date.now();\n      const sleepTime = endTime - startTime - this._detectionInterval;\n      if (sleepTime > this._detectionThreshold) {\n        console.log('==== Sleep Detected =====');\n        this._emitter.emit(this.events.detected, startTime, endTime, sleepTime);\n      }\n      this._timeoutId = null;\n      this._detect();\n    }, this._detectionInterval);\n  }\n\n  start() {\n    this._detect();\n  }\n\n  stop() {\n    if (this._timeoutId) {\n      global.clearTimeout(this._timeoutId);\n      this._timeoutId = null;\n    }\n  }\n}\n"],"mappings":"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"}
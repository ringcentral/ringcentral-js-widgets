{"version":3,"sources":["lib/ProxyFrameController/index.ts"],"names":["ProxyFrameController","prefix","url","parse","window","location","href","query","uuid","oAuthCallback","callbackUri","parent","postMessage","addEventListener","data","oAuthUri","parsedUri","uri","format","state","search","undefined","key","e","newValue","localStorage","removeItem","proxyLoaded"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAEA;;;;;;;;;;;;;;;;IAMqBA,oB,GACnB,gCAAyD;AAAA,iFAAJ,EAAI;AAAA,MAA3CC,MAA2C,QAA3CA,MAA2C;;AAAA;;AAAA,mBAGnDC,gBAAIC,KAAJ,CAAUC,MAAM,CAACC,QAAP,CAAgBC,IAA1B,EAAgC,IAAhC,CAHmD;AAAA,yCAErDC,KAFqD,CAE5CC,IAF4C;AAAA,MAE5CA,IAF4C,sCAErC,EAFqC,0BAKvD;;;AACAJ,EAAAA,MAAM,CAACK,aAAP,GAAuB,UAACC,WAAD,EAAyB;AAC9CN,IAAAA,MAAM,CAACO,MAAP,CAAcC,WAAd,CACE;AACEF,MAAAA,WAAW,EAAXA;AADF,KADF,EAIE,GAJF;AAMD,GAPD;;AASAN,EAAAA,MAAM,CAACS,gBAAP,CAAwB,SAAxB,EAAmC,iBAAc;AAAA,QAAXC,IAAW,SAAXA,IAAW;;AAC/C,QAAIA,IAAJ,EAAU;AAAA,UACAC,QADA,GACaD,IADb,CACAC,QADA;;AAGR,UAAIA,QAAQ,IAAI,IAAhB,EAAsB;AAAA,0BACYb,gBAAIC,KAAJ,CAAUY,QAAV,EAAoB,IAApB,CADZ;AAAA,YACZR,KADY,eACZA,KADY;AAAA,YACFS,SADE;;AAEpB,YAAMC,GAAG,GAAGf,gBAAIgB,MAAJ,iCACPF,SADO;AAEVT,UAAAA,KAAK,kCACAA,KADA;AAEHY,YAAAA,KAAK,YAAKZ,KAAK,CAACY,KAAX,cAAoBX,IAApB;AAFF,YAFK;AAMVY,UAAAA,MAAM,EAAEC;AANE,WAAZ;;AAQA,mCAAUJ,GAAV,YAAkBhB,MAAlB,aAAkC,GAAlC,EAAuC,GAAvC;AACD;AACF;AACF,GAjBD;AAmBA,MAAMqB,GAAG,aAAMrB,MAAN,cAAgBO,IAAhB,iBAAT;AACAJ,EAAAA,MAAM,CAACS,gBAAP,CAAwB,SAAxB,EAAmC,UAACU,CAAD,EAAO;AACxC,QAAIA,CAAC,CAACD,GAAF,KAAUA,GAAV,IAAiBC,CAAC,CAACC,QAAnB,IAA+BD,CAAC,CAACC,QAAF,KAAe,EAAlD,EAAsD;AACpD,UAAMd,WAAW,GAAGa,CAAC,CAACC,QAAtB;AACApB,MAAAA,MAAM,CAACO,MAAP,CAAcC,WAAd,CACE;AACEF,QAAAA,WAAW,EAAXA;AADF,OADF,EAIE,GAJF;AAMAe,MAAAA,YAAY,CAACC,UAAb,CAAwBJ,GAAxB;AACD;AACF,GAXD,EAnCuD,CAgDvD;;AACAlB,EAAAA,MAAM,CAACO,MAAP,CAAcC,WAAd,CACE;AACEe,IAAAA,WAAW,EAAE;AADf,GADF,EAIE,GAJF;AAMD,C","sourcesContent":["import url from 'url';\n\nimport popWindow from '../popWindow';\n\ntype ProxyFrameControllerParams = {\n  prefix?: string;\n};\n\nexport default class ProxyFrameController {\n  constructor({ prefix }: ProxyFrameControllerParams = {}) {\n    const {\n      query: { uuid = '' },\n    } = url.parse(window.location.href, true);\n\n    // TODO: should find where to call that\n    window.oAuthCallback = (callbackUri: string) => {\n      window.parent.postMessage(\n        {\n          callbackUri,\n        },\n        '*',\n      );\n    };\n\n    window.addEventListener('message', ({ data }) => {\n      if (data) {\n        const { oAuthUri } = data;\n\n        if (oAuthUri != null) {\n          const { query, ...parsedUri } = url.parse(oAuthUri, true);\n          const uri = url.format({\n            ...parsedUri,\n            query: {\n              ...query,\n              state: `${query.state}-${uuid}`,\n            },\n            search: undefined,\n          });\n          popWindow(uri, `${prefix}-oauth`, 600, 600);\n        }\n      }\n    });\n\n    const key = `${prefix}-${uuid}-callbackUri`;\n    window.addEventListener('storage', (e) => {\n      if (e.key === key && e.newValue && e.newValue !== '') {\n        const callbackUri = e.newValue;\n        window.parent.postMessage(\n          {\n            callbackUri,\n          },\n          '*',\n        );\n        localStorage.removeItem(key);\n      }\n    });\n\n    // loaded\n    window.parent.postMessage(\n      {\n        proxyLoaded: true,\n      },\n      '*',\n    );\n  }\n}\n"],"file":"index.js"}
{"version":3,"sources":["lib/Tabbie.js"],"names":["HEART_BEAT_INTERVAL","HEART_BEAT_EXPIRE","GC_INTERVAL","FIGHT_TIMEOUT","Tabbie","prefix","heartBeatInterval","heartBeatExpire","gcInterval","fightTimeout","options","_heartBeat","localStorage","setItem","_heartBeatKey","Date","now","_gc","expiredCut","_heartBeatExpire","_getHeartBeatKeys","forEach","key","getItem","removeItem","replace","_heartBeatRegExp","getMainTabId","_fightForMainTab","_setAsVisibleTab","currentMainTabId","_mainTabKey","document","hidden","id","_setAsMainTab","_prefix","_enabled","window","visibilityState","_id","uuid","v4","RegExp","_eventRegExp","_heartBeatInterval","_gcInterval","_fightTimeout","enabled","_heartBeatIntervalId","setInterval","_gcIntervalId","addEventListener","e","emit","test","newValue","payload","JSON","parse","event","args","clearInterval","length","keys","Set","i","add","originalMainTabId","mainTabId","Promise","resolve","once","stringify","EventEmitter"],"mappings":"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","sourcesContent":["import uuid from 'uuid';\nimport EventEmitter from 'events';\nimport sleep from './sleep';\n\nconst HEART_BEAT_INTERVAL = 1000;\n// heatbeat older than HEART_BEAT_EXPIRE will be gc'ed\n// chrome and firefox throttles intervals when inactive expire time of 2000\n// sometimes would kill live heartbeats and cause the mainTabId to change\nconst HEART_BEAT_EXPIRE = 3000;\nconst GC_INTERVAL = 5000;\n\nconst FIGHT_TIMEOUT = 20;\n\n/**\n * @class\n * @description The base active tab and cross tab event handling class.\n */\nexport default class Tabbie extends EventEmitter {\n  constructor({\n    prefix = '',\n    heartBeatInterval = HEART_BEAT_INTERVAL,\n    heartBeatExpire = HEART_BEAT_EXPIRE,\n    gcInterval = GC_INTERVAL,\n    fightTimeout = FIGHT_TIMEOUT,\n    ...options\n  }) {\n    super(options);\n    this._prefix = (prefix && prefix !== '') ? `${prefix}-` : '';\n    this._enabled = typeof window !== 'undefined' &&\n      typeof document.visibilityState !== 'undefined' &&\n      typeof localStorage !== 'undefined';\n    this._id = uuid.v4();\n    this._heartBeatKey = `${this.prefix}tabbie-heartBeat-${this.id}`;\n    this._heartBeatRegExp = new RegExp(`^${this.prefix}tabbie-heartBeat-`);\n    this._mainTabKey = `${this.prefix}tabbie-mainTab-id`;\n    this._eventRegExp = new RegExp(`^${this.prefix}tabbie-event-`);\n    this._heartBeatExpire = heartBeatExpire;\n    this._heartBeatInterval = heartBeatInterval;\n    this._gcInterval = gcInterval;\n    this._fightTimeout = fightTimeout;\n\n    if (this.enabled) {\n      this._heartBeatIntervalId = setInterval(this._heartBeat, heartBeatInterval);\n      this._heartBeat();\n\n      this._gcIntervalId = setInterval(this._gc, gcInterval);\n\n      document.addEventListener('visibilitychange', this._setAsVisibleTab);\n\n      window.addEventListener('focus', this._setAsVisibleTab);\n\n      window.addEventListener('storage', async (e) => {\n        if (e.key === this._mainTabKey) {\n          // use the newest main tab id from localhost instead of from the event\n          // to avoid race conditions\n          this.emit('mainTabIdChanged', await this.getMainTabId());\n        } else if (\n          this._heartBeatRegExp.test(e.key) &&\n          (!e.newValue || e.newValue === '')\n        ) {\n          if (e.key.replace(this._heartBeatRegExp, '') === await this.getMainTabId()) {\n            // main tab closed itself, fight to be the main tab\n            // or someone gc'ed the main tab\n            localStorage.removeItem(this._mainTabKey);\n            await this._fightForMainTab();\n          }\n        } else if (\n          this._eventRegExp.test(e.key) &&\n          e.newValue && e.newValue !== ''\n        ) {\n          const payload = JSON.parse(e.newValue);\n          const [id, event, ...args] = payload;\n          if (id !== this.id) { // ie fires storage event on original\n            this.emit('event', event, ...args);\n          }\n        }\n      });\n      window.addEventListener('unload', () => {\n        clearInterval(this._gcIntervalId);\n        clearInterval(this._heartBeatIntervalId);\n        if (localStorage.getItem(this._mainTabKey) === this.id) {\n          localStorage.removeItem(this._mainTabKey);\n        }\n        localStorage.removeItem(this._heartBeatKey);\n      });\n      if (!document.hidden) {\n        this._setAsMainTab();\n      } else if (!localStorage.getItem(this._mainTabKey)) {\n        this._fightForMainTab();\n      }\n    }\n  }\n\n  _heartBeat = () => {\n    localStorage.setItem(this._heartBeatKey, Date.now());\n  }\n\n  _gc = () => {\n    const expiredCut = Date.now() - this._heartBeatExpire;\n    this._getHeartBeatKeys().forEach(async (key) => {\n      if (localStorage.getItem(key) < expiredCut) {\n        localStorage.removeItem(key);\n        if (key.replace(this._heartBeatRegExp, '') === await this.getMainTabId()) {\n          // the tab that gc's the main tab will not receive the storage event\n          this._fightForMainTab();\n        }\n      }\n    });\n  }\n\n  _getHeartBeatKeys() {\n    const { length } = localStorage;\n    const keys = new Set();\n    for (let i = 0; i < length; i += 1) {\n      const key = localStorage.key(i);\n      if (key && key !== '' && this._heartBeatRegExp.test(key)) keys.add(key);\n    }\n    return [...keys];\n  }\n\n  _setAsMainTab() {\n    localStorage.setItem(this._mainTabKey, this.id);\n    this.emit('mainTabIdChanged', this.id);\n  }\n\n  _setAsVisibleTab = () => {\n    // avoid setting mainTabId repeatedly which may result in forced rendering\n    const currentMainTabId = localStorage.getItem(this._mainTabKey);\n    if (!document.hidden && currentMainTabId !== this.id) this._setAsMainTab();\n  }\n\n  async _fightForMainTab() {\n    const originalMainTabId = localStorage.getItem(this._mainTabKey);\n    // if a tab becomes visible during the delay, it can just assume the main tab role\n    await sleep(this._fightTimeout);\n    if (localStorage.getItem(this._mainTabKey) === originalMainTabId) {\n      this._setAsMainTab();\n    }\n  }\n\n  /**\n   * @function\n   * @return {Promise} - Resolves to current main tab id\n   */\n  async getMainTabId() {\n    const mainTabId = localStorage.getItem(this._mainTabKey);\n    if (mainTabId) return mainTabId;\n\n    return new Promise((resolve) => {\n      this.once('mainTabIdChanged', resolve);\n    });\n  }\n\n  async checkIsMain() {\n    // assume main if not enabled\n    // this is to ensure that modules depending on this would function\n    // in node like environments\n    return !this.enabled || (await this.getMainTabId() === this.id);\n  }\n\n  get id() {\n    return this._id;\n  }\n\n  get enabled() {\n    return this._enabled;\n  }\n\n  get prefix() {\n    return this._prefix;\n  }\n\n  send(event, ...args) {\n    if (this.enabled) {\n      const id = uuid.v4();\n      const key = `${this.prefix}tabbie-event-${id}`;\n      const payload = [this.id, event, ...args];\n      localStorage.setItem(key, JSON.stringify(payload));\n      localStorage.removeItem(key);\n    }\n  }\n}\n"],"file":"Tabbie.js"}
{"version":3,"file":"fromWatch.js","names":["_rxjs","require","_usmRedux","_typeof","o","Symbol","iterator","constructor","prototype","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","i","_toPrimitive","toPrimitive","call","TypeError","String","Number","fromWatch","exports","target","cb","options","destroy","obs$","Observable","observer","watch","newValue","next","pipe","share","finalize","fromWatchValue","watch$","defer","startWith","shareReplay","bufferSize","refCount"],"sources":["lib/rxjs/fromWatch.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport {\n  defer,\n  finalize,\n  Observable,\n  share,\n  shareReplay,\n  startWith,\n} from 'rxjs';\n\nimport { watch } from '../usm-redux';\n\ntype FromWatchOptions<\n  P extends boolean,\n  T extends P extends true ? [...any] | readonly [...any] : any,\n> = {\n  multiple?: P;\n  isEqual?: (x: T, y: T) => boolean;\n};\n\n/**\n * `watch` redux state change notifications to `Observable` flow, let you can control that in rxjs flow.\n *\n * that flow will get value when watch redux state change, if you also want get init state, can use `startWith` operator, that will provide you init state when subscribe.\n *\n * @example\n * ```ts\n * const obs$ = fromWatch(this, () => this.enable)\n *   .pipe(\n *     tap((e) => console.log(e)), // that will be triggered when enable be changed\n *   );\n *\n * obs$.subscribe();\n *\n * setEnable(false);\n * ```\n *\n * options same as `watch`, but not support `awaitPromise`, if you need wait one by one, can use `concatMap` to control flow by yourself.\n *\n * ### !!! if you want to use any `storage` value, must wait `target.ready$`, otherwise you will got default value\n */\nexport const fromWatch = <\n  P extends boolean,\n  T extends P extends true ? [...any] | readonly [...any] : any,\n>(\n  target: any,\n  cb: () => T,\n  options?: FromWatchOptions<P, T>,\n) => {\n  let destroy: () => void;\n\n  const obs$ = new Observable<T>((observer) => {\n    destroy = watch(\n      target,\n      cb as never,\n      (newValue) => observer.next(newValue),\n      {\n        ...options,\n      } as never,\n    );\n  });\n\n  return obs$.pipe(\n    share(),\n    finalize(() => destroy()),\n  );\n};\n\n/**\n * same logic with `fromWatch`, but give us the initial value when subscribe.\n *\n * ### !!! if you want to use any `storage` value, must wait `target.ready$`, otherwise you will got default value\n */\nexport const fromWatchValue = <\n  P extends boolean,\n  T extends P extends true ? [...any] | readonly [...any] : any,\n>(\n  target: any,\n  cb: () => T,\n  options?: FromWatchOptions<P, T>,\n) => {\n  const watch$ = fromWatch(target, cb, options);\n\n  // use defer to make suer startWith value be correctly\n  return defer(() =>\n    watch$.pipe(\n      // emit init value to subscription\n      startWith(cb()),\n    ),\n  ).pipe(shareReplay({ bufferSize: 1, refCount: true }));\n};\n"],"mappings":"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","ignoreList":[]}
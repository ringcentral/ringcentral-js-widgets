{"version":3,"file":"SipInstanceManager.js","names":["uuid","_interopRequireWildcard","require","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","Symbol","iterator","constructor","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","_toPropertyKey","_createClass","protoProps","staticProps","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","Number","SipInstanceManager","prefix","_prefix","value","getInstanceId","endpointId","_this","allInstances","_getAllInActiveInstancesData","currentTime","Date","now","forEach","inactiveAt","_removeInstanceData","id","inactiveInstance","filter","sort","inst1","inst2","v4","setInstanceInactive","instanceId","instanceData","_saveInstanceData","keys","_getAllKeys","instances","rawData","localStorage","getItem","push","JSON","parse","setItem","concat","stringify","removeItem","indexOf","exports"],"sources":["lib/SipInstanceManager/SipInstanceManager.ts"],"sourcesContent":["import * as uuid from 'uuid';\n\ninterface SipInactiveInstanceData {\n  id: string;\n  endpointId: string;\n  inactiveAt: number;\n}\n\nexport class SipInstanceManager {\n  protected _prefix: string;\n\n  constructor(prefix: string) {\n    this._prefix = prefix;\n  }\n\n  getInstanceId(endpointId: string): string {\n    const allInstances = this._getAllInActiveInstancesData();\n    const currentTime = Date.now();\n    // clean expired data;\n    allInstances.forEach((instance) => {\n      if (\n        instance.endpointId !== endpointId ||\n        currentTime - instance.inactiveAt >= 180000\n      ) {\n        // clean instance not in current endpoint id\n        // clean instance if inactive before 3 min\n        this._removeInstanceData(instance.id);\n      }\n    });\n    // find inactive instance that inactive in 3 min\n    const inactiveInstance = allInstances\n      .filter((instance) => {\n        return (\n          instance.endpointId === endpointId &&\n          currentTime - instance.inactiveAt < 180000\n        );\n      })\n      .sort((inst1, inst2) => inst2.inactiveAt - inst1.inactiveAt)[0];\n    // reuse inactive instance\n    if (inactiveInstance) {\n      // remove it from localStorage, so it can only be used in current tab\n      this._removeInstanceData(inactiveInstance.id);\n      return inactiveInstance.id;\n    }\n    return uuid.v4();\n  }\n\n  setInstanceInactive(instanceId: string, endpointId: string): void {\n    const instanceData: SipInactiveInstanceData = {\n      id: instanceId,\n      endpointId,\n      inactiveAt: Date.now(),\n    };\n    this._saveInstanceData(instanceData);\n  }\n\n  _getAllInActiveInstancesData() {\n    const keys = this._getAllKeys();\n    const instances: SipInactiveInstanceData[] = [];\n    keys.forEach((key) => {\n      const rawData = localStorage.getItem(key);\n      if (rawData) {\n        instances.push(JSON.parse(rawData) as SipInactiveInstanceData);\n      }\n    });\n    return instances;\n  }\n\n  _saveInstanceData(instanceData: SipInactiveInstanceData) {\n    localStorage.setItem(\n      `${this._prefix}-${instanceData.id}`,\n      JSON.stringify(instanceData),\n    );\n  }\n\n  _removeInstanceData(instanceId: string) {\n    localStorage.removeItem(`${this._prefix}-${instanceId}`);\n  }\n\n  _getAllKeys(): string[] {\n    const keys = [];\n    for (let i = 0; i < localStorage.length; i += 1) {\n      const key = localStorage.key(i);\n      if (key && key !== '' && key.indexOf(this._prefix) === 0) {\n        keys.push(key);\n      }\n    }\n    return keys;\n  }\n}\n"],"mappings":"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"}
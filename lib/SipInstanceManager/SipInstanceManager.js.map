{"version":3,"file":"SipInstanceManager.js","names":["_uuid","require","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","e","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","SipInstanceManager","prefix","_prefix","value","getInstanceId","endpointId","_this","allInstances","_getAllInActiveInstancesData","currentTime","Date","now","forEach","instance","inactiveAt","_removeInstanceData","id","inactiveInstance","filter","sort","inst1","inst2","v4","setInstanceInactive","instanceId","instanceData","_saveInstanceData","keys","_getAllKeys","instances","rawData","localStorage","getItem","push","JSON","parse","setItem","concat","stringify","removeItem","indexOf","exports"],"sources":["lib/SipInstanceManager/SipInstanceManager.ts"],"sourcesContent":["import { v4 } from 'uuid';\n\ninterface SipInactiveInstanceData {\n  id: string;\n  endpointId: string;\n  inactiveAt: number;\n}\n\nexport class SipInstanceManager {\n  protected _prefix: string;\n\n  constructor(prefix: string) {\n    this._prefix = prefix;\n  }\n\n  getInstanceId(endpointId: string): string {\n    const allInstances = this._getAllInActiveInstancesData();\n    const currentTime = Date.now();\n    // clean expired data;\n    allInstances.forEach((instance) => {\n      if (\n        instance.endpointId !== endpointId ||\n        currentTime - instance.inactiveAt >= 180000\n      ) {\n        // clean instance not in current endpoint id\n        // clean instance if inactive before 3 min\n        this._removeInstanceData(instance.id);\n      }\n    });\n    // find inactive instance that inactive in 3 min\n    const inactiveInstance = allInstances\n      .filter((instance) => {\n        return (\n          instance.endpointId === endpointId &&\n          currentTime - instance.inactiveAt < 180000\n        );\n      })\n      .sort((inst1, inst2) => inst2.inactiveAt - inst1.inactiveAt)[0];\n    // reuse inactive instance\n    if (inactiveInstance) {\n      // remove it from localStorage, so it can only be used in current tab\n      this._removeInstanceData(inactiveInstance.id);\n      return inactiveInstance.id;\n    }\n    return v4();\n  }\n\n  setInstanceInactive(instanceId: string, endpointId: string): void {\n    const instanceData: SipInactiveInstanceData = {\n      id: instanceId,\n      endpointId,\n      inactiveAt: Date.now(),\n    };\n    this._saveInstanceData(instanceData);\n  }\n\n  _getAllInActiveInstancesData() {\n    const keys = this._getAllKeys();\n    const instances: SipInactiveInstanceData[] = [];\n    keys.forEach((key) => {\n      const rawData = localStorage.getItem(key);\n      if (rawData) {\n        instances.push(JSON.parse(rawData) as SipInactiveInstanceData);\n      }\n    });\n    return instances;\n  }\n\n  _saveInstanceData(instanceData: SipInactiveInstanceData) {\n    localStorage.setItem(\n      `${this._prefix}-${instanceData.id}`,\n      JSON.stringify(instanceData),\n    );\n  }\n\n  _removeInstanceData(instanceId: string) {\n    localStorage.removeItem(`${this._prefix}-${instanceId}`);\n  }\n\n  _getAllKeys(): string[] {\n    const keys = [];\n    for (let i = 0; i < localStorage.length; i += 1) {\n      const key = localStorage.key(i);\n      if (key && key !== '' && key.indexOf(this._prefix) === 0) {\n        keys.push(key);\n      }\n    }\n    return keys;\n  }\n}\n"],"mappings":"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","ignoreList":[]}
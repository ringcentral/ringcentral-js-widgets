{"version":3,"file":"index.js","names":["_utils","require","_regenerator","e","t","r","Symbol","n","iterator","o","toStringTag","i","c","prototype","Generator","u","Object","create","_regeneratorDefine2","f","p","y","G","v","a","d","bind","length","l","TypeError","call","done","value","GeneratorFunction","GeneratorFunctionPrototype","getPrototypeOf","setPrototypeOf","__proto__","displayName","w","m","defineProperty","_regeneratorDefine","_invoke","enumerable","configurable","writable","_toConsumableArray","_arrayWithoutHoles","_iterableToArray","_unsupportedIterableToArray","_nonIterableSpread","_arrayLikeToArray","toString","slice","constructor","name","Array","from","test","isArray","asyncGeneratorStep","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","concurrentExecute","_x","_x2","_concurrentExecute","_callee2","promiseFnThunks","concurrency","options","delay","totalThunk","finalResults","_args2","_context2","undefined","process","env","NODE_ENV","Error","polling","_callee","promiseFnThunksBatch","result","_context","splice","all","map","promiseFnThunk","concat"],"sources":["lib/concurrentExecute/index.ts"],"sourcesContent":["import { polling } from '@ringcentral-integration/utils';\n\nexport type ConcurrentExecuteOptions = {\n  /**\n   * delay between each thunk `Promise.all` execution\n   */\n  delay?: number;\n  // TODO: implement that for export result with fail item after Promise.allSettled\n  /**\n   * onFinalize callback\n   */\n  //  onFinalize\n};\n\n// type all<T extends readonly unknown[] | []>(values: T): ;\n/**\n * Provide you to control the concurrency and delay of your `Promise.all` execution.\n * @param options Specify your own delay function and custom promise instance\n *\n * @example\n * ```\n * const result = await concurrentExecute(\n *   [\n *     () => Promise.resolve('123' as const),\n *     () => Promise.resolve(1),\n *     () => Promise.resolve('456'),\n *     () => Promise.resolve(2),\n *     () => Promise.resolve('789'),\n *   ],\n *   2, // in that example that will split into 3 `Promise.all` executions, run each thunk one by one\n *   {\n *      delay: 100, // that will be delay 100ms between each thunk `Promise.all` execution\n *   }\n * );\n *\n * console.log(a); // [ '123', 1, '456', 2, '789' ]\n * ```\n */\nexport default async function concurrentExecute<\n  T extends (() => unknown)[] | [],\n>(\n  /**\n   * A set of thunk functions of Promise\n   */\n  promiseFnThunks: T,\n  /**\n   * concurrency Concurrent granularity\n   */\n  concurrency: number,\n  /**\n   * custom options\n   */\n  options: ConcurrentExecuteOptions = {},\n): Promise<{\n  [P in keyof T]: Awaited<T[P] extends () => infer R ? R : any>;\n}> {\n  const { delay } = options;\n\n  if (!Array.isArray(promiseFnThunks) || promiseFnThunks.length <= 0) {\n    return [] as any;\n  }\n\n  if (\n    process.env.NODE_ENV !== 'production' &&\n    typeof promiseFnThunks[0] !== 'function'\n  ) {\n    throw new Error('concurrentExecute needs promise thunk');\n  }\n\n  let totalThunk = promiseFnThunks.length;\n\n  let finalResults: any = [];\n\n  await polling(async () => {\n    const promiseFnThunksBatch = promiseFnThunks.splice(0, concurrency);\n\n    // TODO: should switch to Promise.allSettled\n    // TODO: if any one error, should still keep all the results and output error items\n    const result = await Promise.all(\n      promiseFnThunksBatch.map((promiseFnThunk) => promiseFnThunk()),\n    );\n\n    finalResults = [...finalResults, ...result];\n\n    totalThunk -= result.length;\n\n    // when all thunks are executed, leave polling\n    return totalThunk <= 0;\n  }, delay);\n\n  return finalResults;\n}\n"],"mappings":"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","ignoreList":[]}
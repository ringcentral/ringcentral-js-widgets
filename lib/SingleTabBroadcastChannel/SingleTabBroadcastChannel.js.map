{"version":3,"file":"SingleTabBroadcastChannel.js","names":["_utils","require","_typeof","o","Symbol","iterator","constructor","prototype","asyncGeneratorStep","n","t","e","r","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","_classCallCheck","TypeError","_defineProperties","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","_toPrimitive","toPrimitive","call","String","Number","SingleTabBroadcastChannel","get","sessionStorage","getItem","option","checkTime","undefined","_req","_res","onTabIdExist","_this","intervalId","setInterval","tabId","clearInterval","init","BroadcastChannel","_createKey","from","to","_request","regeneratorRuntime","mark","_callee","message","_this2","_resolve","listener","result","wrap","_callee$","_context","prev","next","_ref","data","waitUntilTo","addEventListener","_makeRequest","timeout","sent","abrupt","t0","removeEventListener","finish","stop","request","_x","send","cb","onmessage","postMessage","concat","exports"],"sources":["lib/SingleTabBroadcastChannel/SingleTabBroadcastChannel.ts"],"sourcesContent":["import { waitUntilTo } from '../../utils';\n\ntype BroadcastChannelMessage = (ev: MessageEvent) => any;\n\nexport class SingleTabBroadcastChannel {\n  // @ts-expect-error TS(2564): Property '_req' has no initializer and is not defi... Remove this comment to see the full error message\n  private _req: BroadcastChannel;\n  // @ts-expect-error TS(2564): Property '_res' has no initializer and is not defi... Remove this comment to see the full error message\n  private _res: BroadcastChannel;\n\n  get tabId() {\n    return sessionStorage.getItem(this.key) || '';\n  }\n\n  constructor(\n    private key: string,\n    private option: { from: string; to: string },\n    private checkTime: number = 3000,\n  ) {}\n\n  onTabIdExist() {\n    return new Promise<SingleTabBroadcastChannel>((resolve) => {\n      const intervalId = setInterval(() => {\n        if (this.tabId) {\n          clearInterval(intervalId);\n          this.init();\n          resolve(this);\n        }\n      }, 300);\n    });\n  }\n\n  init() {\n    this._req = new BroadcastChannel(this._createKey(this.option.from));\n    this._res = new BroadcastChannel(this._createKey(this.option.to));\n\n    return this;\n  }\n\n  async request(message: { key: string; [key: string]: any }) {\n    let _resolve: (value?: any) => void;\n\n    const listener = ({ data }: MessageEvent) => {\n      const { key, value } = data;\n      switch (key) {\n        case message.key:\n          _resolve(value);\n          break;\n        default:\n          break;\n      }\n    };\n\n    try {\n      const result = await waitUntilTo(\n        () =>\n          new Promise((resolve) => {\n            _resolve = resolve;\n\n            this._res.addEventListener('message', listener);\n            this._makeRequest(message);\n          }),\n        {\n          timeout: this.checkTime,\n        },\n      );\n\n      return result;\n    } catch (error: any /** TODO: confirm with instanceof */) {\n      return null;\n    } finally {\n      // @ts-expect-error TS(2454): Variable '_resolve' is used before being assigned.\n      _resolve();\n      this._res.removeEventListener('message', listener);\n    }\n  }\n\n  send(message: any) {\n    this._makeRequest(message);\n  }\n\n  addEventListener(cb: BroadcastChannelMessage) {\n    this._res.onmessage = cb;\n    return this;\n  }\n\n  private _makeRequest(message: any) {\n    this._req.postMessage(message);\n  }\n\n  private _createKey(key: string) {\n    return `${this.key}_${key}_channel$$_${this.tabId}`;\n  }\n}\n"],"mappings":"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","ignoreList":[]}
{"version":3,"file":"SingleTabBroadcastChannel.js","names":["_utils","require","_typeof","obj","Symbol","iterator","constructor","prototype","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","_createClass","protoProps","staticProps","_toPrimitive","String","input","hint","prim","toPrimitive","res","call","Number","SingleTabBroadcastChannel","get","sessionStorage","getItem","option","checkTime","_req","_res","onTabIdExist","_this","intervalId","setInterval","tabId","clearInterval","init","BroadcastChannel","_createKey","from","to","_request","regeneratorRuntime","mark","_callee","message","_this2","_resolve","listener","result","wrap","_callee$","_context","prev","next","_ref","data","waitUntilTo","addEventListener","_makeRequest","timeout","sent","abrupt","t0","removeEventListener","finish","stop","request","_x","send","cb","onmessage","postMessage","concat","exports"],"sources":["lib/SingleTabBroadcastChannel/SingleTabBroadcastChannel.ts"],"sourcesContent":["import { waitUntilTo } from '../../utils';\n\ntype BroadcastChannelMessage = (ev: MessageEvent) => any;\n\nexport class SingleTabBroadcastChannel {\n  private _req: BroadcastChannel;\n  private _res: BroadcastChannel;\n\n  get tabId() {\n    return sessionStorage.getItem(this.key) || '';\n  }\n\n  constructor(\n    private key: string,\n    private option: { from: string; to: string },\n    private checkTime: number = 3000,\n  ) {}\n\n  onTabIdExist() {\n    return new Promise<SingleTabBroadcastChannel>((resolve) => {\n      const intervalId = setInterval(() => {\n        if (this.tabId) {\n          clearInterval(intervalId);\n          this.init();\n          resolve(this);\n        }\n      }, 300);\n    });\n  }\n\n  init() {\n    this._req = new BroadcastChannel(this._createKey(this.option.from));\n    this._res = new BroadcastChannel(this._createKey(this.option.to));\n\n    return this;\n  }\n\n  async request(message: { key: string; [key: string]: any }) {\n    let _resolve: (value?: any) => void;\n\n    const listener = ({ data }: MessageEvent) => {\n      const { key, value } = data;\n      switch (key) {\n        case message.key:\n          _resolve(value);\n          break;\n        default:\n          break;\n      }\n    };\n\n    try {\n      const result = await waitUntilTo(\n        () =>\n          new Promise((resolve) => {\n            _resolve = resolve;\n\n            this._res.addEventListener('message', listener);\n            this._makeRequest(message);\n          }),\n        {\n          timeout: this.checkTime,\n        },\n      );\n\n      return result;\n    } catch (error: any /** TODO: confirm with instanceof */) {\n      return null;\n    } finally {\n      _resolve();\n      this._res.removeEventListener('message', listener);\n    }\n  }\n\n  send(message: any) {\n    this._makeRequest(message);\n  }\n\n  addEventListener(cb: BroadcastChannelMessage) {\n    this._res.onmessage = cb;\n    return this;\n  }\n\n  private _makeRequest(message: any) {\n    this._req.postMessage(message);\n  }\n\n  private _createKey(key: string) {\n    return `${this.key}_${key}_channel$$_${this.tabId}`;\n  }\n}\n"],"mappings":"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"}
{"version":3,"file":"subscribe.js","names":["_constant","require","_index","_defineProperty","e","r","t","_toPropertyKey","Object","defineProperty","value","enumerable","configurable","writable","i","_toPrimitive","_typeof","Symbol","toPrimitive","call","TypeError","String","Number","o","iterator","constructor","prototype","subscribe","exports","module","listener","Error","concat","service","className","getPrototypeOf","name","unsubscribe","storeKey","subscriptions","subscriptionsKey","_unsubscribe","push","assign","watch","selector","watcher","_ref","arguments","length","undefined","_ref$multiple","multiple","_ref$isEqual","isEqual","defaultIsEqual","oldValue","Array","isArray","newValue","lastValues","lastValue"],"sources":["lib/usm-redux/subscribe.ts"],"sourcesContent":["import { storeKey, subscriptionsKey } from './constant';\nimport type {\n  Subscribe,\n  Watch,\n  Unsubscribe,\n  Subscription,\n  Service,\n} from './interface';\nimport { isEqual as defaultIsEqual } from './utils/index';\n\nconst subscribe: Subscribe = (module, listener) => {\n  if (typeof module !== 'object') {\n    throw new Error(`The subscription target '${module}' is not an object.`);\n  }\n  const service: Service = module;\n  const className = Object.getPrototypeOf(service).constructor.name;\n  if (typeof listener !== 'function') {\n    throw new Error(\n      `The 'listener' should be a function in the class '${className}'.`,\n    );\n  }\n  let unsubscribe: Unsubscribe;\n  if (service[storeKey]) {\n    unsubscribe = service[storeKey].subscribe(listener);\n  } else {\n    // When constructing\n    const subscriptions: Subscription[] = service[subscriptionsKey] || [];\n    let _unsubscribe: Unsubscribe;\n    subscriptions.push(() => {\n      if (typeof service[storeKey] !== 'object') {\n        throw new Error(\n          `The subscription target class '${className}' should be created via 'createStore()'.`,\n        );\n      }\n      _unsubscribe = service[storeKey].subscribe(listener);\n    });\n    unsubscribe = () => _unsubscribe();\n    Object.assign(service, {\n      [subscriptionsKey]: subscriptions,\n    });\n  }\n  return unsubscribe;\n};\n\n/**\n * watch value change in the store\n *\n * @param module binding module instance\n * @param selector that selector you want to watch\n * @param watcher callback function\n * @param options options for that watcher\n * @returns unsubscribe method\n *\n * @example\n * ```ts\n *\n    // watch one variable\n    watch(\n      this,\n      () => this._deps.auth.loggedIn,\n      (newValue, oldValue) => {\n        // do something\n      },\n    );\n\n    // watch many variables\n    watch(\n      this,\n      () => [\n        this._deps.auth.loggedIn,\n        this._deps.routerInteraction.currentPath,\n      ],\n      (newValue, oldValue) => {\n        // do something\n      },\n      { multiple: true },\n    );\n * ```\n * custom equality function\n * ```ts\n    export const customEqual = (newValue: unknown, oldValue: unknown) => {\n      return x !== y;\n    };\n\n    watch(\n      this,\n      () => this._deps.auth.loggedIn,\n      (newValue, oldValue) => {\n        // do something\n      },\n      { isEqual: customEqual },\n    );\n    ```\n */\nconst watch: Watch = (\n  module,\n  selector,\n  watcher,\n  { multiple = false, isEqual = defaultIsEqual } = {},\n) => {\n  if (typeof watcher !== 'function') {\n    const className = Object.getPrototypeOf(module).constructor.name;\n    throw new Error(\n      `The 'watcher' should be a function in the class '${className}'.`,\n    );\n  }\n  let oldValue = selector();\n  if (multiple) {\n    if (!Array.isArray(oldValue)) {\n      const className = Object.getPrototypeOf(module).constructor.name;\n      throw new Error(\n        `The 'selector' should be a function that returns an array in the class '${className}'.`,\n      );\n    }\n    return subscribe(module, () => {\n      const newValue = selector();\n      const length = oldValue.length;\n      for (let i = 0; i < length; i++) {\n        if (!isEqual(newValue[i], oldValue[i])) {\n          const lastValues = oldValue;\n          oldValue = newValue;\n          watcher(newValue, lastValues);\n          break;\n        }\n      }\n    });\n  }\n  return subscribe(module, () => {\n    const newValue = selector();\n    if (!isEqual(newValue, oldValue)) {\n      const lastValue = oldValue;\n      oldValue = newValue;\n      watcher(newValue, lastValue);\n    }\n  });\n};\n\nexport { subscribe, watch };\n"],"mappings":"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","ignoreList":[]}
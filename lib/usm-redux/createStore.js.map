{"version":3,"file":"createStore.js","names":["enablePatches","getPatchesToggle","setPatchesToggle","toggle","createStore","options","preloadedState","config","reduxEnhancer","handleReducers","reducers","combineReducers","Array","isArray","modules","Error","enableAutoFreeze","strict","process","env","NODE_ENV","enablePatchesWithImmer","setAutoFreeze","identifiers","Set","subscriptions","store","forEach","module","index","service","className","Object","getPrototypeOf","constructor","name","stateKey","bootstrappedKey","console","warn","identifier","identifierKey","Math","random","toString","error","has","add","descriptors","enumerable","configurable","value","key","descriptor","getOwnPropertyDescriptor","assign","get","set","initState","produce","serviceReducers","entries","reduce","serviceReducersMapObject","reducer","state","action","_usm","usm","_getLastState","_state","type","hasOwnProperty","call","_reducers","stagedState","getStagedState","__identifier","__state","currentState","storeKey","getState","isFrozen","freeze","defineProperties","subscriptionsKey","prototype","push","apply","storeWithRedux","createStoreWithRedux","dispatch","subscribe"],"sources":["lib/usm-redux/createStore.ts"],"sourcesContent":["import produce, {\n  setAutoFreeze,\n  enablePatches as enablePatchesWithImmer,\n} from 'immer';\nimport {\n  createStore as createStoreWithRedux,\n  combineReducers,\n  ReducersMapObject,\n  PreloadedState,\n  Store as ReduxStore,\n} from 'redux';\nimport {\n  stateKey,\n  storeKey,\n  bootstrappedKey,\n  identifierKey,\n  subscriptionsKey,\n  usm,\n} from './constant';\nimport { getStagedState } from './utils/index';\nimport {\n  Action,\n  StoreOptions,\n  Store,\n  Subscription,\n  Config,\n  Service,\n} from './interface';\n\nlet enablePatches: boolean;\n\nexport const getPatchesToggle = () => enablePatches;\n\nexport const setPatchesToggle = (toggle: boolean) => {\n  enablePatches = toggle;\n};\n\nexport const createStore = (\n  options: StoreOptions,\n  preloadedState?: PreloadedState<any>,\n  config: Config = {},\n) => {\n  const {\n    reduxEnhancer,\n    handleReducers = (reducers) => combineReducers(reducers),\n  } = config;\n  if (typeof options !== 'object' || !Array.isArray(options.modules)) {\n    throw new Error(\n      `'createStore' options should be a object with a property 'modules'`,\n    );\n  }\n  const enableAutoFreeze =\n    options.strict ?? process.env.NODE_ENV === 'development';\n  enablePatches = config.enablePatches ?? false;\n  if (enablePatches) enablePatchesWithImmer();\n  setAutoFreeze(enableAutoFreeze);\n  const identifiers = new Set<string>();\n  const reducers: ReducersMapObject = {};\n  const subscriptions: Subscription[] = [];\n  let store: Store;\n  options.modules.forEach((module, index) => {\n    if (typeof module !== 'object' || module === null) return;\n    const service: Service = module;\n    const className = Object.getPrototypeOf(service).constructor.name;\n    if (typeof service[stateKey] === 'undefined' || service[bootstrappedKey]) {\n      if (process.env.NODE_ENV === 'development') {\n        if (service[bootstrappedKey]) {\n          console.warn(\n            `The module with an index of ${index} and a name of ${className} in the module list is a duplicate module.`,\n          );\n        }\n      }\n    }\n    let identifier = service[identifierKey] ?? service.name;\n    if (identifier === null || typeof identifier === 'undefined') {\n      identifier = `@@usm-redux/${className}/${Math.random().toString(36)}`;\n    }\n    if (typeof identifier !== 'string') {\n      if (process.env.NODE_ENV === 'development') {\n        console.error(`\n          Since '${className}' module has set the module state, '${className}' module must set a unique and valid class property 'name' to be used as the module index.\n          Example:\n            class FooBar {\n              name = 'FooBar'; // <- add the 'name' property.\n            }\n        `);\n      } else {\n        throw new Error(\n          `'${className}' module 'name' property should be defined as a valid 'string'.`,\n        );\n      }\n    }\n    if (identifiers.has(identifier)) {\n      identifier += `${index}`;\n    }\n    identifiers.add(identifier);\n    const descriptors: Record<string, PropertyDescriptor> = {\n      [bootstrappedKey]: {\n        enumerable: false,\n        configurable: false,\n        value: true,\n      },\n    };\n    if (service[stateKey]) {\n      // eslint-disable-next-line guard-for-in\n      for (const key in service[stateKey]) {\n        const descriptor = Object.getOwnPropertyDescriptor(service, key);\n        // eslint-disable-next-line no-continue\n        if (typeof descriptor === 'undefined') continue;\n        Object.assign(service[stateKey], {\n          [key]: descriptor.value,\n        });\n        Object.assign(descriptors, {\n          [key]: {\n            enumerable: true,\n            configurable: false,\n            get(this: typeof service) {\n              return this[stateKey][key];\n            },\n            set(this: typeof service, value: unknown) {\n              this[stateKey][key] = value;\n            },\n          },\n        });\n      }\n      const initState = enableAutoFreeze\n        ? produce({ ...service[stateKey] }, () => {})\n        : service[stateKey];\n\n      const serviceReducers = Object.entries(initState).reduce(\n        (serviceReducersMapObject: ReducersMapObject, [key, value]) => {\n          // support pure reducer\n          if (typeof value === 'function') {\n            return Object.assign(serviceReducersMapObject, {\n              [key]: value,\n            });\n          }\n          const reducer = (state = value, action: Action) => {\n            if (action._usm !== usm) return state;\n            if (!service._getLastState) return action._state[identifier][key];\n            return identifier === action.type &&\n              Object.hasOwnProperty.call(action._state, key)\n              ? action._state[key]\n              : state;\n          };\n          return Object.assign(serviceReducersMapObject, {\n            [key]: reducer,\n          });\n        },\n        {},\n      );\n      // support custom reducers\n      service._reducers = serviceReducers;\n      const reducer = combineReducers(serviceReducers);\n      Object.assign(reducers, {\n        [identifier]: reducer,\n      });\n\n      Object.assign(descriptors, {\n        [stateKey]: {\n          enumerable: false,\n          configurable: false,\n          get(this: typeof service) {\n            const stagedState = getStagedState();\n            if (stagedState)\n              return this._getLastState &&\n                stagedState?.__identifier === identifier\n                ? stagedState.__state\n                : stagedState[identifier];\n            const currentState = this[storeKey]?.getState()[identifier];\n            if (enableAutoFreeze && !Object.isFrozen(currentState)) {\n              return Object.freeze(currentState);\n            }\n            return currentState;\n          },\n        },\n      });\n    }\n    Object.assign(descriptors, {\n      [identifierKey]: {\n        configurable: false,\n        enumerable: false,\n        value: identifier,\n      },\n      [storeKey]: {\n        configurable: false,\n        enumerable: false,\n        get() {\n          return store;\n        },\n      },\n    });\n    Object.defineProperties(service, descriptors);\n    if (Array.isArray(service[subscriptionsKey])) {\n      Array.prototype.push.apply(subscriptions, service[subscriptionsKey]);\n    }\n  });\n  const storeWithRedux = createStoreWithRedux(\n    handleReducers(reducers),\n    preloadedState,\n    reduxEnhancer,\n  );\n  store = {\n    dispatch: storeWithRedux.dispatch,\n    getState: storeWithRedux.getState,\n    subscribe: storeWithRedux.subscribe,\n  };\n  for (const subscribe of subscriptions) {\n    subscribe();\n  }\n  return store as ReduxStore;\n};\n"],"mappings":"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"}
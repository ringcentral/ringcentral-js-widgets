{"version":3,"file":"index.js","names":["_url","_interopRequireDefault","require","obj","__esModule","_classCallCheck","instance","Constructor","TypeError","RedirectController","_ref","arguments","length","undefined","prefix","appOrigin","window","addEventListener","callbackUri","location","href","opener","oAuthCallback","close","e","postMessage","error","_url$parse","url","parse","state","query","uuid","split","slice","join","key","concat","localStorage","removeItem","newValue","setItem","exports"],"sources":["lib/RedirectController/index.ts"],"sourcesContent":["import url from 'url';\n\ntype RedirectControllerParams = {\n  prefix?: string;\n  appOrigin?: string;\n};\n\nexport default class RedirectController {\n  constructor({ prefix, appOrigin }: RedirectControllerParams = {}) {\n    window.addEventListener('load', () => {\n      const callbackUri = window.location.href;\n      // RCINT-3477 some devices will have reference to opener, but will throw exception\n      // when try to access opener\n      try {\n        if (window.opener && window.opener.oAuthCallback) {\n          window.opener.oAuthCallback(callbackUri);\n          window.close();\n          return;\n        }\n      } catch (e) {\n        /* ignore error */\n      }\n\n      // Use this when redirect page is different domain with app\n      // appOrigin: app's origin\n      try {\n        if (appOrigin && window.opener && window.opener.postMessage) {\n          window.opener.postMessage({ callbackUri }, appOrigin);\n          window.close();\n          return;\n        }\n      } catch (error) {\n        /* ignore error */\n      }\n\n      // fall back to use localStorage as a vessel to avoid opener is null bug\n\n      const {\n        query: { state },\n      } = url.parse(callbackUri, true);\n      // @ts-expect-error TS(2532): Object is possibly 'undefined'.\n      const uuid = state.split('-').slice(1).join('-');\n      const key = `${prefix}-${uuid}-callbackUri`;\n      localStorage.removeItem(key);\n      window.addEventListener('storage', (e) => {\n        if (e.key === key && (!e.newValue || e.newValue === '')) {\n          window.close();\n        }\n      });\n      localStorage.setItem(key, callbackUri);\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;AAAA,IAAAA,IAAA,GAAAC,sBAAA,CAAAC,OAAA;AAAsB,SAAAD,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,gBAAAA,GAAA;AAAA,SAAAE,gBAAAC,QAAA,EAAAC,WAAA,UAAAD,QAAA,YAAAC,WAAA,eAAAC,SAAA;AAAA,IAODC,kBAAkB,GACrC,SAAAA,mBAAA,EAAkE;EAAA,IAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAJ,CAAC,CAAC;IAAlDG,MAAM,GAAAJ,IAAA,CAANI,MAAM;IAAEC,SAAS,GAAAL,IAAA,CAATK,SAAS;EAAAV,eAAA,OAAAI,kBAAA;EAC7BO,MAAM,CAACC,gBAAgB,CAAC,MAAM,EAAE,YAAM;IACpC,IAAMC,WAAW,GAAGF,MAAM,CAACG,QAAQ,CAACC,IAAI;IACxC;IACA;IACA,IAAI;MACF,IAAIJ,MAAM,CAACK,MAAM,IAAIL,MAAM,CAACK,MAAM,CAACC,aAAa,EAAE;QAChDN,MAAM,CAACK,MAAM,CAACC,aAAa,CAACJ,WAAW,CAAC;QACxCF,MAAM,CAACO,KAAK,CAAC,CAAC;QACd;MACF;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE;MACV;IAAA;;IAGF;IACA;IACA,IAAI;MACF,IAAIT,SAAS,IAAIC,MAAM,CAACK,MAAM,IAAIL,MAAM,CAACK,MAAM,CAACI,WAAW,EAAE;QAC3DT,MAAM,CAACK,MAAM,CAACI,WAAW,CAAC;UAAEP,WAAW,EAAXA;QAAY,CAAC,EAAEH,SAAS,CAAC;QACrDC,MAAM,CAACO,KAAK,CAAC,CAAC;QACd;MACF;IACF,CAAC,CAAC,OAAOG,KAAK,EAAE;MACd;IAAA;;IAGF;IAAA,IAAAC,UAAA,GAIIC,eAAG,CAACC,KAAK,CAACX,WAAW,EAAE,IAAI,CAAC;MADrBY,KAAK,GAAAH,UAAA,CAAdI,KAAK,CAAID,KAAK,EAEhB;IACA,IAAME,IAAI,GAAGF,KAAK,CAACG,KAAK,CAAC,GAAG,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;IAChD,IAAMC,GAAG,MAAAC,MAAA,CAAMvB,MAAM,OAAAuB,MAAA,CAAIL,IAAI,iBAAc;IAC3CM,YAAY,CAACC,UAAU,CAACH,GAAG,CAAC;IAC5BpB,MAAM,CAACC,gBAAgB,CAAC,SAAS,EAAE,UAACO,CAAC,EAAK;MACxC,IAAIA,CAAC,CAACY,GAAG,KAAKA,GAAG,KAAK,CAACZ,CAAC,CAACgB,QAAQ,IAAIhB,CAAC,CAACgB,QAAQ,KAAK,EAAE,CAAC,EAAE;QACvDxB,MAAM,CAACO,KAAK,CAAC,CAAC;MAChB;IACF,CAAC,CAAC;IACFe,YAAY,CAACG,OAAO,CAACL,GAAG,EAAElB,WAAW,CAAC;EACxC,CAAC,CAAC;AACJ,CAAC;AAAAwB,OAAA,cAAAjC,kBAAA"}
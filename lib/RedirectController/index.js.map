{"version":3,"file":"index.js","names":["RedirectController","_ref","arguments","length","undefined","prefix","appOrigin","_classCallCheck","window","addEventListener","callbackUri","location","href","opener","oAuthCallback","close","e","postMessage","error","searchParams","URLSearchParams","state","get","uuid","split","slice","join","key","concat","localStorage","removeItem","newValue","setItem","exports"],"sources":["lib/RedirectController/index.ts"],"sourcesContent":["type RedirectControllerParams = {\n  prefix?: string;\n  appOrigin?: string;\n};\n\nexport default class RedirectController {\n  constructor({ prefix, appOrigin }: RedirectControllerParams = {}) {\n    window.addEventListener('load', () => {\n      const callbackUri = window.location.href;\n      // RCINT-3477 some devices will have reference to opener, but will throw exception\n      // when try to access opener\n      try {\n        if (window.opener && window.opener.oAuthCallback) {\n          window.opener.oAuthCallback(callbackUri);\n          window.close();\n          return;\n        }\n      } catch (e) {\n        /* ignore error */\n      }\n\n      // Use this when redirect page is different domain with app\n      // appOrigin: app's origin\n      try {\n        if (appOrigin && window.opener && window.opener.postMessage) {\n          window.opener.postMessage({ callbackUri }, appOrigin);\n          window.close();\n          return;\n        }\n      } catch (error) {\n        /* ignore error */\n      }\n\n      // fall back to use localStorage as a vessel to avoid opener is null bug\n\n      const searchParams = new URLSearchParams(callbackUri);\n      const state = searchParams.get('state');\n\n      if (!state) {\n        return;\n      }\n      const uuid = state.split('-').slice(1).join('-');\n      const key = `${prefix}-${uuid}-callbackUri`;\n      localStorage.removeItem(key);\n      window.addEventListener('storage', (e) => {\n        if (e.key === key && (!e.newValue || e.newValue === '')) {\n          window.close();\n        }\n      });\n      localStorage.setItem(key, callbackUri);\n    });\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;IAKqBA,kBAAkB,GACrC,SAAAA,mBAAA,EAAkE;EAAA,IAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAJ,CAAC,CAAC;IAAlDG,MAAM,GAAAJ,IAAA,CAANI,MAAM;IAAEC,SAAS,GAAAL,IAAA,CAATK,SAAS;EAAAC,eAAA,OAAAP,kBAAA;EAC7BQ,MAAM,CAACC,gBAAgB,CAAC,MAAM,EAAE,YAAM;IACpC,IAAMC,WAAW,GAAGF,MAAM,CAACG,QAAQ,CAACC,IAAI;IACxC;IACA;IACA,IAAI;MACF,IAAIJ,MAAM,CAACK,MAAM,IAAIL,MAAM,CAACK,MAAM,CAACC,aAAa,EAAE;QAChDN,MAAM,CAACK,MAAM,CAACC,aAAa,CAACJ,WAAW,CAAC;QACxCF,MAAM,CAACO,KAAK,CAAC,CAAC;QACd;MACF;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE;MACV;IAAA;;IAGF;IACA;IACA,IAAI;MACF,IAAIV,SAAS,IAAIE,MAAM,CAACK,MAAM,IAAIL,MAAM,CAACK,MAAM,CAACI,WAAW,EAAE;QAC3DT,MAAM,CAACK,MAAM,CAACI,WAAW,CAAC;UAAEP,WAAW,EAAXA;QAAY,CAAC,EAAEJ,SAAS,CAAC;QACrDE,MAAM,CAACO,KAAK,CAAC,CAAC;QACd;MACF;IACF,CAAC,CAAC,OAAOG,KAAK,EAAE;MACd;IAAA;;IAGF;;IAEA,IAAMC,YAAY,GAAG,IAAIC,eAAe,CAACV,WAAW,CAAC;IACrD,IAAMW,KAAK,GAAGF,YAAY,CAACG,GAAG,CAAC,OAAO,CAAC;IAEvC,IAAI,CAACD,KAAK,EAAE;MACV;IACF;IACA,IAAME,IAAI,GAAGF,KAAK,CAACG,KAAK,CAAC,GAAG,CAAC,CAACC,KAAK,CAAC,CAAC,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;IAChD,IAAMC,GAAG,MAAAC,MAAA,CAAMvB,MAAM,OAAAuB,MAAA,CAAIL,IAAI,iBAAc;IAC3CM,YAAY,CAACC,UAAU,CAACH,GAAG,CAAC;IAC5BnB,MAAM,CAACC,gBAAgB,CAAC,SAAS,EAAE,UAACO,CAAC,EAAK;MACxC,IAAIA,CAAC,CAACW,GAAG,KAAKA,GAAG,KAAK,CAACX,CAAC,CAACe,QAAQ,IAAIf,CAAC,CAACe,QAAQ,KAAK,EAAE,CAAC,EAAE;QACvDvB,MAAM,CAACO,KAAK,CAAC,CAAC;MAChB;IACF,CAAC,CAAC;IACFc,YAAY,CAACG,OAAO,CAACL,GAAG,EAAEjB,WAAW,CAAC;EACxC,CAAC,CAAC;AACJ,CAAC;AAAAuB,OAAA,cAAAjC,kBAAA","ignoreList":[]}
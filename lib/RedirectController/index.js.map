{"version":3,"sources":["lib/RedirectController/index.ts"],"names":["RedirectController","prefix","appOrigin","window","addEventListener","callbackUri","location","href","opener","oAuthCallback","close","e","postMessage","error","url","parse","state","query","uuid","split","slice","join","key","localStorage","removeItem","newValue","setItem"],"mappings":";;;;;;;;;;;;;AAAA;;;;;;IAOqBA,kB,GACnB,8BAAkE;AAAA,iFAAJ,EAAI;AAAA,MAApDC,MAAoD,QAApDA,MAAoD;AAAA,MAA5CC,SAA4C,QAA5CA,SAA4C;;AAAA;;AAChEC,EAAAA,MAAM,CAACC,gBAAP,CAAwB,MAAxB,EAAgC,YAAM;AACpC,QAAMC,WAAW,GAAGF,MAAM,CAACG,QAAP,CAAgBC,IAApC,CADoC,CAEpC;AACA;;AACA,QAAI;AACF,UAAIJ,MAAM,CAACK,MAAP,IAAiBL,MAAM,CAACK,MAAP,CAAcC,aAAnC,EAAkD;AAChDN,QAAAA,MAAM,CAACK,MAAP,CAAcC,aAAd,CAA4BJ,WAA5B;AACAF,QAAAA,MAAM,CAACO,KAAP;AACA;AACD;AACF,KAND,CAME,OAAOC,CAAP,EAAU;AACV;AACD,KAZmC,CAcpC;AACA;;;AACA,QAAI;AACF,UAAIT,SAAS,IAAIC,MAAM,CAACK,MAApB,IAA8BL,MAAM,CAACK,MAAP,CAAcI,WAAhD,EAA6D;AAC3DT,QAAAA,MAAM,CAACK,MAAP,CAAcI,WAAd,CAA0B;AAAEP,UAAAA,WAAW,EAAXA;AAAF,SAA1B,EAA2CH,SAA3C;AACAC,QAAAA,MAAM,CAACO,KAAP;AACA;AACD;AACF,KAND,CAME,OAAOG,KAAP,EAAc;AACd;AACD,KAxBmC,CA0BpC;;;AA1BoC,qBA8BhCC,gBAAIC,KAAJ,CAAUV,WAAV,EAAuB,IAAvB,CA9BgC;AAAA,QA6BzBW,KA7ByB,cA6BlCC,KA7BkC,CA6BzBD,KA7ByB;;AA+BpC,QAAME,IAAI,GAAGF,KAAK,CAACG,KAAN,CAAY,GAAZ,EAAiBC,KAAjB,CAAuB,CAAvB,EAA0BC,IAA1B,CAA+B,GAA/B,CAAb;AACA,QAAMC,GAAG,aAAMrB,MAAN,cAAgBiB,IAAhB,iBAAT;AACAK,IAAAA,YAAY,CAACC,UAAb,CAAwBF,GAAxB;AACAnB,IAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmC,UAACO,CAAD,EAAO;AACxC,UAAIA,CAAC,CAACW,GAAF,KAAUA,GAAV,KAAkB,CAACX,CAAC,CAACc,QAAH,IAAed,CAAC,CAACc,QAAF,KAAe,EAAhD,CAAJ,EAAyD;AACvDtB,QAAAA,MAAM,CAACO,KAAP;AACD;AACF,KAJD;AAKAa,IAAAA,YAAY,CAACG,OAAb,CAAqBJ,GAArB,EAA0BjB,WAA1B;AACD,GAxCD;AAyCD,C","sourcesContent":["import url from 'url';\n\ntype RedirectControllerParams = {\n  prefix?: string;\n  appOrigin?: string;\n};\n\nexport default class RedirectController {\n  constructor({ prefix, appOrigin }: RedirectControllerParams = {}) {\n    window.addEventListener('load', () => {\n      const callbackUri = window.location.href;\n      // RCINT-3477 some devices will have reference to opener, but will throw exception\n      // when try to access opener\n      try {\n        if (window.opener && window.opener.oAuthCallback) {\n          window.opener.oAuthCallback(callbackUri);\n          window.close();\n          return;\n        }\n      } catch (e) {\n        /* ignore error */\n      }\n\n      // Use this when redirect page is different domain with app\n      // appOrigin: app's origin\n      try {\n        if (appOrigin && window.opener && window.opener.postMessage) {\n          window.opener.postMessage({ callbackUri }, appOrigin);\n          window.close();\n          return;\n        }\n      } catch (error) {\n        /* ignore error */\n      }\n\n      // fall back to use localStorage as a vessel to avoid opener is null bug\n\n      const {\n        query: { state },\n      } = url.parse(callbackUri, true);\n      const uuid = state.split('-').slice(1).join('-');\n      const key = `${prefix}-${uuid}-callbackUri`;\n      localStorage.removeItem(key);\n      window.addEventListener('storage', (e) => {\n        if (e.key === key && (!e.newValue || e.newValue === '')) {\n          window.close();\n        }\n      });\n      localStorage.setItem(key, callbackUri);\n    });\n  }\n}\n"],"file":"index.js"}
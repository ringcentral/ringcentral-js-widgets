{"version":3,"sources":["lib/callLogHelpers.js"],"names":["isInbound","isOutbound","isRinging","isMissed","hasRingingCalls","isEnded","hasEndedCalls","isOnHold","isIntermediateCall","isSelfCall","sortBySessionId","sortByStartTime","normalizeStartTime","normalizeFromTo","areTwoLegs","removeInboundRingOutLegs","removeDuplicateIntermediateCalls","removeDuplicateSelfCalls","call","direction","callDirections","inbound","outbound","telephonyStatus","telephonyStatuses","ringing","callResultsToMissedMap","HashMap","fromSet","set","callResults","map","key","getValue","missed","hangUp","busy","voicemail","rejected","indexOf","result","calls","find","noCall","terminationType","terminationTypes","final","onHold","intermediate","to","from","phoneNumber","a","b","sessionId","startTime","Date","getTime","Math","abs","action","callActions","phoneCall","ringOutWeb","ringOutPC","ringOutMobile","extensionNumber","output","outbounds","filter","forEach","outboundIndex","findIndex","splice","outboundLeg","inboundLeg","push","concat","resultCalls","indexMap","isIntermediate","sessionid","index","length","isSelf"],"mappings":"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","file":"callLogHelpers.js","sourcesContent":["import 'core-js/fn/array/find';\nimport { isValidNumber, isSameLocalNumber } from '@ringcentral-integration/phone-number';\n\nimport HashMap from './HashMap';\nimport callActions from '../enums/callActions';\nimport callDirections from '../enums/callDirections';\nimport callResults from '../enums/callResults';\nimport telephonyStatuses from '../enums/telephonyStatuses';\nimport terminationTypes from '../enums/terminationTypes';\n\n/* call direction helpers */\nexport function isInbound(call = {}) {\n  return call.direction === callDirections.inbound;\n}\n\nexport function isOutbound(call = {}) {\n  return call.direction === callDirections.outbound;\n}\n\n/* status helpers */\nexport function isRinging(call = {}) {\n  return call.telephonyStatus === telephonyStatuses.ringing;\n}\n\nconst callResultsToMissedMap = HashMap.fromSet({\n  set: Object.keys(callResults).map(key => callResults[key]),\n  getValue: result => (\n    [\n      callResults.missed,\n      callResults.hangUp,\n      callResults.busy,\n      callResults.voicemail,\n      callResults.rejected,\n    ].indexOf(result) > -1\n  ),\n});\nexport function isMissed(call = {}) {\n  return !!callResultsToMissedMap[call.result];\n}\n\nexport function hasRingingCalls(calls = []) {\n  return !!calls.find(isRinging);\n}\n\nexport function isEnded(call = {}) {\n  return call.telephonyStatus === telephonyStatuses.noCall &&\n    call.terminationType === terminationTypes.final;\n}\n\nexport function hasEndedCalls(calls) {\n  return !!calls.find(isEnded);\n}\n\nexport function isOnHold(call = {}) {\n  return call.telephonyStatus === telephonyStatuses.onHold;\n}\n\nexport function isIntermediateCall(call = {}) {\n  return call.terminationType === terminationTypes.intermediate;\n}\n\nexport function isSelfCall(call = {}) {\n  if (call.to && call.from) {\n    return call.to.phoneNumber === call.from.phoneNumber;\n  }\n  return false;\n}\n\n/* sort functions */\n\nexport function sortBySessionId(a, b) {\n  if (a.sessionId === b.sessionId) return 0;\n  return a.sessionId > b.sessionId ?\n    1 :\n    -1;\n}\nexport function sortByStartTime(a, b) {\n  if (a.startTime === b.startTime) return 0;\n  return a.startTime > b.startTime ?\n    -1 :\n    1;\n}\n\nexport function normalizeStartTime(call) {\n  const result = {\n    ...call,\n  };\n  if (call.startTime) {\n    result.startTime = (new Date(call.startTime)).getTime();\n  }\n  return result;\n}\n\nexport function normalizeFromTo(call) {\n  return {\n    ...call,\n    from: typeof call.from === 'object' ?\n      call.from :\n      { phoneNumber: call.from },\n    to: typeof call.to === 'object' ?\n      call.to :\n      { phoneNumber: call.to },\n  };\n}\n\n/* ringout leg helpers */\nexport function areTwoLegs(inbound, outbound) {\n  if (isInbound(inbound) && isOutbound(outbound)) {\n    switch (Math.abs(inbound.sessionId - outbound.sessionId)) {\n      case 1000:\n      case 2000:\n      case 3000:\n      case 4000: {\n        // presence\n        if (\n          inbound.from && inbound.to &&\n          outbound.from && outbound.to &&\n          isSameLocalNumber(inbound.from.phoneNumber, outbound.to.phoneNumber) &&\n          isSameLocalNumber(inbound.to.phoneNumber, outbound.from.phoneNumber)\n        ) {\n          return true;\n        }\n        // call-log\n        if (\n          inbound.from && inbound.to &&\n          outbound.from && outbound.to &&\n          inbound.action === callActions.phoneCall &&\n          (\n            outbound.action === callActions.ringOutWeb ||\n            outbound.action === callActions.ringOutPC ||\n            outbound.action === callActions.ringOutMobile\n          ) &&\n          (\n            inbound.from.phoneNumber === outbound.from.phoneNumber ||\n            inbound.from.extensionNumber === outbound.from.extensionNumber\n          ) &&\n          inbound.to.phoneNumber === outbound.to.phoneNumber\n        ) {\n          return true;\n        }\n        break;\n      }\n      default:\n        return false;\n    }\n  }\n  return false;\n}\n\nexport function removeInboundRingOutLegs(calls) {\n  const output = [];\n  const outbounds = calls.filter(isOutbound);\n  calls.filter(isInbound).forEach((inbound) => {\n    const outboundIndex = outbounds.findIndex(call => areTwoLegs(inbound, call));\n    if (outboundIndex > -1) {\n      const outbound = outbounds.splice(outboundIndex, 1)[0];\n\n      if (inbound.action && outbound.action) {\n        // from call-log\n        const call = {\n          ...outbound,\n          outboundLeg: outbound,\n          inboundLeg: inbound,\n          from: {\n            ...inbound.from,\n          },\n          to: {\n            ...inbound.to,\n          },\n          result: inbound.result,\n        };\n        output.push(call);\n      } else {\n        const call = {\n          ...outbound,\n          outboundLeg: outbound,\n          inboundLeg: inbound,\n        };\n        // Handle inboundLeg.from is '+19072028624', but outboundLeg.to is '9072028624'\n        // https://jira.ringcentral.com/browse/RCINT-3127\n        if (\n          isValidNumber(inbound.from && inbound.from.phoneNumber) &&\n          isSameLocalNumber(inbound.from.phoneNumber, outbound.to && outbound.to.phoneNumber)\n        ) {\n          call.to = {\n            ...outbound.to,\n            phoneNumber: inbound.from.phoneNumber,\n          };\n          outbound.to.phoneNumber = inbound.from.phoneNumber;\n        }\n        if (isOnHold(inbound)) {\n          call.telephonyStatus = telephonyStatuses.onHold;\n        }\n        output.push(call);\n      }\n\n      // output.push(outbound);\n    } else {\n      output.push(inbound);\n    }\n  });\n  return output.concat(outbounds);\n}\n\n\nexport function removeDuplicateIntermediateCalls(calls) {\n  const resultCalls = [];\n  const indexMap = {};\n  calls.forEach((call) => {\n    const isIntermediate = isIntermediateCall(call);\n    if (!indexMap[call.sessionId]) {\n      indexMap[call.sessionid] = {\n        index: resultCalls.length,\n        isIntermediate,\n      };\n      resultCalls.push(call);\n    } else if (!isIntermediate) {\n      indexMap[call.sessionId].isIntermediate = false;\n      resultCalls[indexMap[call.sessionId].index] = call;\n    }\n  });\n  return resultCalls;\n}\n\n// there are two active calls with same sessionId when user call self.\nexport function removeDuplicateSelfCalls(calls) {\n  const resultCalls = [];\n  const indexMap = {};\n  calls.forEach((call) => {\n    const isSelf = isSelfCall(call);\n    if (!indexMap[call.sessionId]) {\n      indexMap[call.sessionid] = {\n        index: resultCalls.length,\n        isSelf,\n      };\n      resultCalls.push(call);\n    } else if (!isSelf) {\n      indexMap[call.sessionId].isSelf = false;\n      resultCalls[indexMap[call.sessionId].index] = call;\n    }\n  });\n  return resultCalls;\n}\n"]}
{"version":3,"sources":["lib/proxy/getProxyClient.ts"],"names":["defaultVerifyModuleFunc","module","RcModule","getProxyClient","createTarget","verifyModuleFunc","transport","options","actionTypes","baseActionTypes","_id","uuid","v4","_target","_getState","state","target","_getProxyState","proxy","_transport","ensureExist","call","_setTransport","subModule","Object","prototype","hasOwnProperty","defineProperty","configurable","enumerable","get","_getStateV2","key","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":"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","sourcesContent":["import * as uuid from 'uuid';\nimport RcModule from '../RcModule';\nimport getProxyClientReducer from './getProxyClientReducer';\nimport baseActionTypes from './baseActionTypes';\nimport ensureExist from '../ensureExist';\nimport { pushStates } from './handleProxyAction';\n\nconst defaultVerifyModuleFunc = (module) => module instanceof RcModule;\n\nexport default function getProxyClient(\n  createTarget,\n  verifyModuleFunc = defaultVerifyModuleFunc,\n) {\n  return class extends RcModule {\n    constructor({ transport, ...options }) {\n      super({\n        ...options,\n        actionTypes: baseActionTypes,\n      });\n      this._id = uuid.v4();\n      this._target = createTarget({\n        ...options,\n      });\n      // Used by client to dispatch action.\n      // this._target.__proxyAction__ = this.actionTypes.action;\n      this._target._getState = () => this.state.target;\n      this._target._getProxyState = () => this.state.proxy;\n      // this._target = new Target({\n      //   ...options,\n      //   getState: () => this.state.target,\n      //   getProxyState: () => this.state.proxy,\n      // });\n      this._transport = ensureExist.call(this, transport, 'transport');\n      this._setTransport(this._target);\n      for (const subModule in this._target) {\n        if (\n          Object.prototype.hasOwnProperty.call(this._target, subModule) &&\n          verifyModuleFunc(this._target[subModule])\n        ) {\n          Object.defineProperty(this, subModule, {\n            configurable: false,\n            enumerable: true,\n            get() {\n              return this._target[subModule];\n            },\n          });\n          this[subModule]._getStateV2 = (state, key) => state.target[key];\n        }\n      }\n\n      this._reducer = getProxyClientReducer({\n        targetReducer: this._target.reducer,\n        proxyReducer: this._target.proxyReducer,\n        transport,\n        types: this.actionTypes,\n      });\n    }\n\n    _setTransport(target) {\n      target._transport = this._transport;\n      target._proxyActionTypes = this.actionTypes;\n      target._suppressInit = true;\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule])\n        ) {\n          target[subModule]._transport = this._transport;\n          target[subModule]._proxyActionTypes = this.actionTypes;\n          target[subModule]._suppressInit = true;\n        }\n      }\n    }\n\n    async _sync() {\n      try {\n        const result = await this._transport.request({\n          payload: {\n            type: this.actionTypes.sync,\n            actionNumber: this.state.actionNumber,\n          },\n        });\n        this.store.dispatch({\n          ...result,\n          type: this.actionTypes.sync,\n        });\n      } catch (_) {\n        /* Ignore */\n      }\n      this._syncPromise = null;\n    }\n\n    sync() {\n      if (!this._syncPromise) {\n        this._syncPromise = this._sync();\n      }\n      return this._syncPromise;\n    }\n\n    _initialize(target) {\n      if (\n        typeof target.initializeProxy === 'function' &&\n        !target._proxyInitialized\n      ) {\n        target._proxyInitialized = true;\n        target.initializeProxy();\n      }\n      for (const subModule in target) {\n        if (\n          Object.prototype.hasOwnProperty.call(target, subModule) &&\n          verifyModuleFunc(target[subModule]) &&\n          typeof target[subModule].initializeProxy === 'function' &&\n          !target[subModule]._proxyInitialized\n        ) {\n          target[subModule]._proxyInitialized = true;\n          target[subModule].initializeProxy();\n        }\n      }\n    }\n\n    async initialize() {\n      // initialize the instance before sync to avoid history object from\n      // becoming out of sync\n      this._initialize(this._target);\n      this._transport.on(this._transport.events.push, async (payload) => {\n        if (payload.type === this.actionTypes.action) {\n          if (this._syncPromise) await this._syncPromise;\n          if (payload.actionNumber === this.state.actionNumber + 1) {\n            const action = pushStates(this._target, payload.action);\n            this.store.dispatch({\n              ...payload,\n              action,\n              type: this.actionTypes.action,\n            });\n          } else {\n            await this.sync();\n          }\n        }\n      });\n      await this.sync();\n    }\n  };\n}\n"],"file":"getProxyClient.js"}
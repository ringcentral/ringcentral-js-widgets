{"version":3,"sources":["lib/proxy/getProxyClient.js"],"names":["getProxyClient","Target","transport","options","actionTypes","_id","v4","_target","getState","state","target","getProxyState","proxy","_transport","_setTransport","subModule","Object","prototype","hasOwnProperty","configurable","enumerable","get","_reducer","targetReducer","reducer","proxyReducer","types","_proxyActionTypes","_suppressInit","request","payload","type","sync","actionNumber","result","store","dispatch","_syncPromise","_sync","initializeProxy","_proxyInitialized","_initialize","on","events","push","action"],"mappings":"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","file":"getProxyClient.js","sourcesContent":["import uuid from 'uuid';\r\nimport RcModule from '../RcModule';\r\nimport getProxyClientReducer from './getProxyClientReducer';\r\nimport baseActionTypes from './baseActionTypes';\r\nimport ensureExist from '../ensureExist';\r\n\r\n\r\nexport default function getProxyClient(Target) {\r\n  return class extends RcModule {\r\n    constructor({ transport, ...options }) {\r\n      super({\r\n        ...options,\r\n        actionTypes: baseActionTypes,\r\n      });\r\n      this._id = uuid.v4();\r\n      this._target = new Target({\r\n        ...options,\r\n        getState: () => this.state.target,\r\n        getProxyState: () => this.state.proxy,\r\n      });\r\n      this._transport = this::ensureExist(transport, 'transport');\r\n      this._setTransport(this._target);\r\n      for (const subModule in this._target) {\r\n        if (\r\n          this._target::Object.prototype.hasOwnProperty(subModule) &&\r\n            this._target[subModule] instanceof RcModule\r\n        ) {\r\n          Object.defineProperty(this, subModule, {\r\n            configurable: false,\r\n            enumerable: true,\r\n            get() {\r\n              return this._target[subModule];\r\n            },\r\n          });\r\n        }\r\n      }\r\n\r\n      this._reducer = getProxyClientReducer({\r\n        targetReducer: this._target.reducer,\r\n        proxyReducer: this._target.proxyReducer,\r\n        transport,\r\n        types: this.actionTypes,\r\n      });\r\n    }\r\n\r\n    _setTransport(target) {\r\n      target._transport = this._transport;\r\n      target._proxyActionTypes = this.actionTypes;\r\n      target._suppressInit = true;\r\n      for (const subModule in target) {\r\n        if (\r\n          target::Object.prototype.hasOwnProperty(subModule) &&\r\n            target[subModule] instanceof RcModule\r\n        ) {\r\n          this._setTransport(target[subModule]);\r\n        }\r\n      }\r\n    }\r\n\r\n\r\n    async _sync() {\r\n      try {\r\n        const result = await this._transport.request({\r\n          payload: {\r\n            type: this.actionTypes.sync,\r\n            actionNumber: this.state.actionNumber\r\n          },\r\n        });\r\n        this.store.dispatch({\r\n          ...result,\r\n          type: this.actionTypes.sync,\r\n        });\r\n      } catch (_) { /* Ignore */ }\r\n      this._syncPromise = null;\r\n    }\r\n    sync() {\r\n      if (!this._syncPromise) {\r\n        this._syncPromise = this._sync();\r\n      }\r\n      return this._syncPromise;\r\n    }\r\n\r\n    _initialize(target) {\r\n      if (\r\n        typeof target.initializeProxy === 'function' &&\r\n        !target._proxyInitialized\r\n      ) {\r\n        target._proxyInitialized = true;\r\n        target.initializeProxy();\r\n      }\r\n      for (const subModule in target) {\r\n        if (\r\n          target::Object.prototype.hasOwnProperty(subModule) &&\r\n            target[subModule] instanceof RcModule\r\n        ) {\r\n          this._initialize(target[subModule]);\r\n        }\r\n      }\r\n    }\r\n    async initialize() {\r\n      // initialize the instance before sync to avoid history object from\r\n      // becoming out of sync\r\n      this._initialize(this._target);\r\n      this._transport.on(this._transport.events.push, async (payload) => {\r\n        if (payload.type === this.actionTypes.action) {\r\n          if (this._syncPromise) await this._syncPromise;\r\n          if (payload.actionNumber === this.state.actionNumber + 1) {\r\n            this.store.dispatch({\r\n              ...payload,\r\n              type: this.actionTypes.action,\r\n            });\r\n          } else {\r\n            await this.sync();\r\n          }\r\n        }\r\n      });\r\n      await this.sync();\r\n    }\r\n  };\r\n}\r\n"]}
{"version":3,"file":"ClientTransport.js","names":["uuid","_interopRequireWildcard","require","_TransportBase2","_constants","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","_typeof","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","asyncGeneratorStep","o","c","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","ownKeys","keys","getOwnPropertySymbols","filter","enumerable","push","_objectSpread","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","_toPropertyKey","configurable","writable","_classCallCheck","TypeError","_defineProperties","key","_createClass","prototype","_toPrimitive","Symbol","toPrimitive","String","Number","_inherits","create","constructor","_setPrototypeOf","setPrototypeOf","bind","_createSuper","_isNativeReflectConstruct","_getPrototypeOf","s","Reflect","construct","_possibleConstructorReturn","_assertThisInitialized","ReferenceError","Boolean","valueOf","getPrototypeOf","ClientTransport","_TransportBase","_super","_this","options","undefined","name","TRANSPORT_NAME","_port","_requests","Map","chrome","runtime","connect","CONNECT_PORT_NAME","onMessage","addListener","_ref","type","payload","requestId","result","error","_events","emit","response","callback","reject","Error","_request","regeneratorRuntime","mark","_callee","_ref2","_this2","promise","timeout","wrap","_callee$","_context","prev","next","v4","postMessage","request","setTimeout","_timeout","clearTimeout","concat","functionPath","message","abrupt","stop","_x","TransportBase","exports"],"sources":["lib/ChromeTransport/ClientTransport.ts"],"sourcesContent":["import * as uuid from 'uuid';\n\nimport {\n  TransportBase,\n  type BaseEventEnum,\n  type TransportBaseProps,\n} from '../TransportBase';\n\nimport { CONNECT_PORT_NAME, TRANSPORT_NAME } from './constants';\n\n/* global chrome */\n\nexport interface ClientTransportProps\n  extends Omit<TransportBaseProps, 'name'> {}\n\ntype PromiseCallback = {\n  resolve: (result: any) => void;\n  reject: (reason: any) => void;\n};\n\nexport class ClientTransport extends TransportBase {\n  _port: chrome.runtime.Port;\n  _requests = new Map<string, PromiseCallback>();\n\n  constructor(options: ClientTransportProps = {}) {\n    super({\n      ...options,\n      name: TRANSPORT_NAME,\n    });\n\n    this._port = chrome.runtime.connect({ name: CONNECT_PORT_NAME });\n    this._port.onMessage.addListener(\n      ({\n        type,\n        payload,\n        requestId,\n        result,\n        error,\n      }: {\n        type: keyof BaseEventEnum;\n        payload: unknown;\n        requestId: string;\n        result?: unknown;\n        error?: string;\n      }) => {\n        switch (type) {\n          case this._events.push:\n            {\n              if (payload) {\n                this.emit(this._events.push, payload);\n              }\n            }\n            break;\n          case this._events.response:\n            {\n              const callback = this._requests.get(requestId);\n              if (callback) {\n                if (error) {\n                  callback.reject(new Error(error));\n                } else {\n                  callback.resolve(result);\n                }\n              }\n            }\n            break;\n          default:\n            break;\n        }\n      },\n    );\n  }\n\n  async request({ payload }: { payload: unknown }) {\n    const requestId = uuid.v4();\n    let promise = new Promise((resolve, reject) => {\n      this._requests.set(requestId, {\n        resolve,\n        reject,\n      });\n      this._port.postMessage({\n        type: this._events.request,\n        requestId,\n        payload,\n      });\n    });\n    let timeout: NodeJS.Timeout | null = setTimeout(() => {\n      timeout = null;\n      const callback = this._requests.get(requestId);\n      if (callback) {\n        callback.reject(new Error(this._events.timeout));\n      }\n    }, this._timeout);\n    promise = promise\n      .then((result) => {\n        if (timeout) clearTimeout(timeout);\n        this._requests.delete(requestId);\n        return Promise.resolve(result);\n      })\n      .catch((error) => {\n        if (timeout) clearTimeout(timeout);\n        this._requests.delete(requestId);\n        return Promise.reject(\n          // @ts-expect-error TS(2571): Object is of type 'unknown'.\n          new Error(`${payload.functionPath}: ${error.message}`),\n        );\n      });\n    return promise;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA,IAAAA,IAAA,GAAAC,uBAAA,CAAAC,OAAA;AAEA,IAAAC,eAAA,GAAAD,OAAA;AAMA,IAAAE,UAAA,GAAAF,OAAA;AAAgE,SAAAG,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,yBAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAL,wBAAAK,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,gBAAAK,OAAA,CAAAL,CAAA,0BAAAA,CAAA,sBAAAA,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,sBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,cAAAN,CAAA,cAAAR,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAAA,SAAAW,mBAAAX,CAAA,EAAAL,CAAA,EAAAH,CAAA,EAAAE,CAAA,EAAAkB,CAAA,EAAAV,CAAA,EAAAW,CAAA,cAAAJ,CAAA,GAAAT,CAAA,CAAAE,CAAA,EAAAW,CAAA,GAAAP,CAAA,GAAAG,CAAA,CAAAK,KAAA,WAAAd,CAAA,gBAAAR,CAAA,CAAAQ,CAAA,KAAAS,CAAA,CAAAM,IAAA,GAAApB,CAAA,CAAAW,CAAA,IAAAU,OAAA,CAAAC,OAAA,CAAAX,CAAA,EAAAY,IAAA,CAAAxB,CAAA,EAAAkB,CAAA;AAAA,SAAAO,kBAAAnB,CAAA,6BAAAL,CAAA,SAAAH,CAAA,GAAA4B,SAAA,aAAAJ,OAAA,WAAAtB,CAAA,EAAAkB,CAAA,QAAAV,CAAA,GAAAF,CAAA,CAAAqB,KAAA,CAAA1B,CAAA,EAAAH,CAAA,YAAA8B,MAAAtB,CAAA,IAAAW,kBAAA,CAAAT,CAAA,EAAAR,CAAA,EAAAkB,CAAA,EAAAU,KAAA,EAAAC,MAAA,UAAAvB,CAAA,cAAAuB,OAAAvB,CAAA,IAAAW,kBAAA,CAAAT,CAAA,EAAAR,CAAA,EAAAkB,CAAA,EAAAU,KAAA,EAAAC,MAAA,WAAAvB,CAAA,KAAAsB,KAAA;AAAA,SAAAE,QAAAhC,CAAA,EAAAE,CAAA,QAAAC,CAAA,GAAAQ,MAAA,CAAAsB,IAAA,CAAAjC,CAAA,OAAAW,MAAA,CAAAuB,qBAAA,QAAAd,CAAA,GAAAT,MAAA,CAAAuB,qBAAA,CAAAlC,CAAA,GAAAE,CAAA,KAAAkB,CAAA,GAAAA,CAAA,CAAAe,MAAA,WAAAjC,CAAA,WAAAS,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAE,CAAA,EAAAkC,UAAA,OAAAjC,CAAA,CAAAkC,IAAA,CAAAR,KAAA,CAAA1B,CAAA,EAAAiB,CAAA,YAAAjB,CAAA;AAAA,SAAAmC,cAAAtC,CAAA,aAAAE,CAAA,MAAAA,CAAA,GAAA0B,SAAA,CAAAW,MAAA,EAAArC,CAAA,UAAAC,CAAA,WAAAyB,SAAA,CAAA1B,CAAA,IAAA0B,SAAA,CAAA1B,CAAA,QAAAA,CAAA,OAAA8B,OAAA,CAAArB,MAAA,CAAAR,CAAA,OAAAqC,OAAA,WAAAtC,CAAA,IAAAuC,eAAA,CAAAzC,CAAA,EAAAE,CAAA,EAAAC,CAAA,CAAAD,CAAA,SAAAS,MAAA,CAAA+B,yBAAA,GAAA/B,MAAA,CAAAgC,gBAAA,CAAA3C,CAAA,EAAAW,MAAA,CAAA+B,yBAAA,CAAAvC,CAAA,KAAA6B,OAAA,CAAArB,MAAA,CAAAR,CAAA,GAAAqC,OAAA,WAAAtC,CAAA,IAAAS,MAAA,CAAAC,cAAA,CAAAZ,CAAA,EAAAE,CAAA,EAAAS,MAAA,CAAAE,wBAAA,CAAAV,CAAA,EAAAD,CAAA,iBAAAF,CAAA;AAAA,SAAAyC,gBAAAzC,CAAA,EAAAE,CAAA,EAAAC,CAAA,YAAAD,CAAA,GAAA0C,cAAA,CAAA1C,CAAA,MAAAF,CAAA,GAAAW,MAAA,CAAAC,cAAA,CAAAZ,CAAA,EAAAE,CAAA,IAAAoB,KAAA,EAAAnB,CAAA,EAAAiC,UAAA,MAAAS,YAAA,MAAAC,QAAA,UAAA9C,CAAA,CAAAE,CAAA,IAAAC,CAAA,EAAAH,CAAA;AAAA,SAAA+C,gBAAArC,CAAA,EAAAF,CAAA,UAAAE,CAAA,YAAAF,CAAA,aAAAwC,SAAA;AAAA,SAAAC,kBAAAjD,CAAA,EAAAE,CAAA,aAAAC,CAAA,MAAAA,CAAA,GAAAD,CAAA,CAAAqC,MAAA,EAAApC,CAAA,UAAAiB,CAAA,GAAAlB,CAAA,CAAAC,CAAA,GAAAiB,CAAA,CAAAgB,UAAA,GAAAhB,CAAA,CAAAgB,UAAA,QAAAhB,CAAA,CAAAyB,YAAA,kBAAAzB,CAAA,KAAAA,CAAA,CAAA0B,QAAA,QAAAnC,MAAA,CAAAC,cAAA,CAAAZ,CAAA,EAAA4C,cAAA,CAAAxB,CAAA,CAAA8B,GAAA,GAAA9B,CAAA;AAAA,SAAA+B,aAAAnD,CAAA,EAAAE,CAAA,EAAAC,CAAA,WAAAD,CAAA,IAAA+C,iBAAA,CAAAjD,CAAA,CAAAoD,SAAA,EAAAlD,CAAA,GAAAC,CAAA,IAAA8C,iBAAA,CAAAjD,CAAA,EAAAG,CAAA,GAAAQ,MAAA,CAAAC,cAAA,CAAAZ,CAAA,iBAAA8C,QAAA,SAAA9C,CAAA;AAAA,SAAA4C,eAAAzC,CAAA,QAAAc,CAAA,GAAAoC,YAAA,CAAAlD,CAAA,gCAAAE,OAAA,CAAAY,CAAA,IAAAA,CAAA,GAAAA,CAAA;AAAA,SAAAoC,aAAAlD,CAAA,EAAAD,CAAA,oBAAAG,OAAA,CAAAF,CAAA,MAAAA,CAAA,SAAAA,CAAA,MAAAH,CAAA,GAAAG,CAAA,CAAAmD,MAAA,CAAAC,WAAA,kBAAAvD,CAAA,QAAAiB,CAAA,GAAAjB,CAAA,CAAAgB,IAAA,CAAAb,CAAA,EAAAD,CAAA,gCAAAG,OAAA,CAAAY,CAAA,UAAAA,CAAA,YAAA+B,SAAA,yEAAA9C,CAAA,GAAAsD,MAAA,GAAAC,MAAA,EAAAtD,CAAA;AAAA,SAAAuD,UAAAvD,CAAA,EAAAH,CAAA,6BAAAA,CAAA,aAAAA,CAAA,YAAAgD,SAAA,wDAAA7C,CAAA,CAAAiD,SAAA,GAAAzC,MAAA,CAAAgD,MAAA,CAAA3D,CAAA,IAAAA,CAAA,CAAAoD,SAAA,IAAAQ,WAAA,IAAAtC,KAAA,EAAAnB,CAAA,EAAA2C,QAAA,MAAAD,YAAA,WAAAlC,MAAA,CAAAC,cAAA,CAAAT,CAAA,iBAAA2C,QAAA,SAAA9C,CAAA,IAAA6D,eAAA,CAAA1D,CAAA,EAAAH,CAAA;AAAA,SAAA6D,gBAAA1D,CAAA,EAAAH,CAAA,WAAA6D,eAAA,GAAAlD,MAAA,CAAAmD,cAAA,GAAAnD,MAAA,CAAAmD,cAAA,CAAAC,IAAA,eAAA5D,CAAA,EAAAH,CAAA,WAAAG,CAAA,CAAAM,SAAA,GAAAT,CAAA,EAAAG,CAAA,KAAA0D,eAAA,CAAA1D,CAAA,EAAAH,CAAA;AAAA,SAAAgE,aAAA7D,CAAA,QAAAD,CAAA,GAAA+D,yBAAA,6BAAAjE,CAAA,EAAAoB,CAAA,GAAA8C,eAAA,CAAA/D,CAAA,OAAAD,CAAA,QAAAiE,CAAA,GAAAD,eAAA,OAAAN,WAAA,EAAA5D,CAAA,GAAAoE,OAAA,CAAAC,SAAA,CAAAjD,CAAA,EAAAQ,SAAA,EAAAuC,CAAA,UAAAnE,CAAA,GAAAoB,CAAA,CAAAS,KAAA,OAAAD,SAAA,UAAA0C,0BAAA,OAAAtE,CAAA;AAAA,SAAAsE,2BAAAnE,CAAA,EAAAH,CAAA,QAAAA,CAAA,iBAAAK,OAAA,CAAAL,CAAA,0BAAAA,CAAA,UAAAA,CAAA,iBAAAA,CAAA,YAAAgD,SAAA,qEAAAuB,sBAAA,CAAApE,CAAA;AAAA,SAAAoE,uBAAAvE,CAAA,mBAAAA,CAAA,YAAAwE,cAAA,sEAAAxE,CAAA;AAAA,SAAAiE,0BAAA,cAAA9D,CAAA,IAAAsE,OAAA,CAAArB,SAAA,CAAAsB,OAAA,CAAA1D,IAAA,CAAAoD,OAAA,CAAAC,SAAA,CAAAI,OAAA,iCAAAtE,CAAA,aAAA8D,yBAAA,YAAAA,0BAAA,aAAA9D,CAAA;AAAA,SAAA+D,gBAAA/D,CAAA,WAAA+D,eAAA,GAAAvD,MAAA,CAAAmD,cAAA,GAAAnD,MAAA,CAAAgE,cAAA,CAAAZ,IAAA,eAAA5D,CAAA,WAAAA,CAAA,CAAAM,SAAA,IAAAE,MAAA,CAAAgE,cAAA,CAAAxE,CAAA,MAAA+D,eAAA,CAAA/D,CAAA;AAEhE;AAAA,IAUayE,eAAe,0BAAAC,cAAA;EAAAnB,SAAA,CAAAkB,eAAA,EAAAC,cAAA;EAAA,IAAAC,MAAA,GAAAd,YAAA,CAAAY,eAAA;EAI1B,SAAAA,gBAAA,EAAgD;IAAA,IAAAG,KAAA;IAAA,IAApCC,OAA6B,GAAApD,SAAA,CAAAW,MAAA,QAAAX,SAAA,QAAAqD,SAAA,GAAArD,SAAA,MAAG,CAAC,CAAC;IAAAmB,eAAA,OAAA6B,eAAA;IAC5CG,KAAA,GAAAD,MAAA,CAAA9D,IAAA,OAAAsB,aAAA,CAAAA,aAAA,KACK0C,OAAO;MACVE,IAAI,EAAEC;IAAc;IACnBJ,KAAA,CAPLK,KAAK;IAAAL,KAAA,CACLM,SAAS,GAAG,IAAIC,GAAG,CAA0B,CAAC;IAQ5CP,KAAA,CAAKK,KAAK,GAAGG,MAAM,CAACC,OAAO,CAACC,OAAO,CAAC;MAAEP,IAAI,EAAEQ;IAAkB,CAAC,CAAC;IAChEX,KAAA,CAAKK,KAAK,CAACO,SAAS,CAACC,WAAW,CAC9B,UAAAC,IAAA,EAYM;MAAA,IAXJC,IAAI,GAAAD,IAAA,CAAJC,IAAI;QACJC,OAAO,GAAAF,IAAA,CAAPE,OAAO;QACPC,SAAS,GAAAH,IAAA,CAATG,SAAS;QACTC,MAAM,GAAAJ,IAAA,CAANI,MAAM;QACNC,KAAK,GAAAL,IAAA,CAALK,KAAK;MAQL,QAAQJ,IAAI;QACV,KAAKf,KAAA,CAAKoB,OAAO,CAAC9D,IAAI;UACpB;YACE,IAAI0D,OAAO,EAAE;cACXhB,KAAA,CAAKqB,IAAI,CAACrB,KAAA,CAAKoB,OAAO,CAAC9D,IAAI,EAAE0D,OAAO,CAAC;YACvC;UACF;UACA;QACF,KAAKhB,KAAA,CAAKoB,OAAO,CAACE,QAAQ;UACxB;YACE,IAAMC,QAAQ,GAAGvB,KAAA,CAAKM,SAAS,CAAC9E,GAAG,CAACyF,SAAS,CAAC;YAC9C,IAAIM,QAAQ,EAAE;cACZ,IAAIJ,KAAK,EAAE;gBACTI,QAAQ,CAACC,MAAM,CAAC,IAAIC,KAAK,CAACN,KAAK,CAAC,CAAC;cACnC,CAAC,MAAM;gBACLI,QAAQ,CAAC7E,OAAO,CAACwE,MAAM,CAAC;cAC1B;YACF;UACF;UACA;QACF;UACE;MACJ;IACF,CACF,CAAC;IAAC,OAAAlB,KAAA;EACJ;EAAC5B,YAAA,CAAAyB,eAAA;IAAA1B,GAAA;IAAA5B,KAAA;MAAA,IAAAmF,QAAA,GAAA9E,iBAAA,eAAA+E,kBAAA,CAAAC,IAAA,UAAAC,QAAAC,KAAA;QAAA,IAAAC,MAAA;QAAA,IAAAf,OAAA,EAAAC,SAAA,EAAAe,OAAA,EAAAC,OAAA;QAAA,OAAAN,kBAAA,CAAAO,IAAA,UAAAC,SAAAC,QAAA;UAAA;YAAA,QAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;cAAA;gBAEetB,OAAO,GAAAc,KAAA,CAAPd,OAAO;gBACfC,SAAS,GAAGtG,IAAI,CAAC4H,EAAE,CAAC,CAAC;gBACvBP,OAAO,GAAG,IAAIvF,OAAO,CAAC,UAACC,OAAO,EAAE8E,MAAM,EAAK;kBAC7CO,MAAI,CAACzB,SAAS,CAACnE,GAAG,CAAC8E,SAAS,EAAE;oBAC5BvE,OAAO,EAAPA,OAAO;oBACP8E,MAAM,EAANA;kBACF,CAAC,CAAC;kBACFO,MAAI,CAAC1B,KAAK,CAACmC,WAAW,CAAC;oBACrBzB,IAAI,EAAEgB,MAAI,CAACX,OAAO,CAACqB,OAAO;oBAC1BxB,SAAS,EAATA,SAAS;oBACTD,OAAO,EAAPA;kBACF,CAAC,CAAC;gBACJ,CAAC,CAAC;gBACEiB,OAA8B,GAAGS,UAAU,CAAC,YAAM;kBACpDT,OAAO,GAAG,IAAI;kBACd,IAAMV,QAAQ,GAAGQ,MAAI,CAACzB,SAAS,CAAC9E,GAAG,CAACyF,SAAS,CAAC;kBAC9C,IAAIM,QAAQ,EAAE;oBACZA,QAAQ,CAACC,MAAM,CAAC,IAAIC,KAAK,CAACM,MAAI,CAACX,OAAO,CAACa,OAAO,CAAC,CAAC;kBAClD;gBACF,CAAC,EAAE,IAAI,CAACU,QAAQ,CAAC;gBACjBX,OAAO,GAAGA,OAAO,CACdrF,IAAI,CAAC,UAACuE,MAAM,EAAK;kBAChB,IAAIe,OAAO,EAAEW,YAAY,CAACX,OAAO,CAAC;kBAClCF,MAAI,CAACzB,SAAS,UAAO,CAACW,SAAS,CAAC;kBAChC,OAAOxE,OAAO,CAACC,OAAO,CAACwE,MAAM,CAAC;gBAChC,CAAC,CAAC,SACI,CAAC,UAACC,KAAK,EAAK;kBAChB,IAAIc,OAAO,EAAEW,YAAY,CAACX,OAAO,CAAC;kBAClCF,MAAI,CAACzB,SAAS,UAAO,CAACW,SAAS,CAAC;kBAChC,OAAOxE,OAAO,CAAC+E,MAAM;kBACnB;kBACA,IAAIC,KAAK,IAAAoB,MAAA,CAAI7B,OAAO,CAAC8B,YAAY,QAAAD,MAAA,CAAK1B,KAAK,CAAC4B,OAAO,CAAE,CACvD,CAAC;gBACH,CAAC,CAAC;gBAAC,OAAAX,QAAA,CAAAY,MAAA,WACEhB,OAAO;cAAA;cAAA;gBAAA,OAAAI,QAAA,CAAAa,IAAA;YAAA;UAAA;QAAA,GAAApB,OAAA;MAAA;MAAA,SAAAY,QAAAS,EAAA;QAAA,OAAAxB,QAAA,CAAA5E,KAAA,OAAAD,SAAA;MAAA;MAAA,OAAA4F,OAAA;IAAA;EAAA;EAAA,OAAA5C,eAAA;AAAA,EAtFmBsD,6BAAa;AAAAC,OAAA,CAAAvD,eAAA,GAAAA,eAAA","ignoreList":[]}
{"version":3,"file":"ClientTransport.js","names":["_uuid","require","_TransportBase2","_constants","asyncGeneratorStep","n","t","e","r","o","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","ownKeys","Object","keys","getOwnPropertySymbols","filter","getOwnPropertyDescriptor","enumerable","push","_objectSpread","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","configurable","writable","_classCallCheck","TypeError","_defineProperties","key","_createClass","prototype","_toPrimitive","_typeof","Symbol","toPrimitive","call","String","Number","_inherits","create","constructor","_setPrototypeOf","setPrototypeOf","bind","__proto__","_createSuper","_isNativeReflectConstruct","_getPrototypeOf","s","Reflect","construct","_possibleConstructorReturn","_assertThisInitialized","ReferenceError","Boolean","valueOf","getPrototypeOf","ClientTransport","_TransportBase","_super","_this","options","undefined","name","TRANSPORT_NAME","_port","_requests","Map","chrome","runtime","connect","CONNECT_PORT_NAME","onMessage","addListener","_ref","type","payload","requestId","result","error","_events","send","emit","response","callback","get","reject","Error","_request","regeneratorRuntime","mark","_callee","_ref2","_this2","promise","timeout","wrap","_callee$","_context","prev","next","v4","set","postMessage","request","setTimeout","_timeout","clearTimeout","concat","functionPath","message","abrupt","stop","_x","_send","_callee2","_ref3","_callee2$","_context2","_x2","TransportBase","exports"],"sources":["lib/ChromeTransport/ClientTransport.ts"],"sourcesContent":["import { v4 } from 'uuid';\n\nimport {\n  TransportBase,\n  type BaseEventEnum,\n  type TransportBaseProps,\n} from '../TransportBase';\n\nimport { CONNECT_PORT_NAME, TRANSPORT_NAME } from './constants';\n\n/* global chrome */\n\nexport interface ClientTransportProps\n  extends Omit<TransportBaseProps, 'name'> {}\n\ntype PromiseCallback = {\n  resolve: (result: any) => void;\n  reject: (reason: any) => void;\n};\n\nexport class ClientTransport extends TransportBase {\n  _port: chrome.runtime.Port;\n  _requests = new Map<string, PromiseCallback>();\n\n  constructor(options: ClientTransportProps = {}) {\n    super({\n      ...options,\n      name: TRANSPORT_NAME,\n    });\n\n    this._port = chrome.runtime.connect({ name: CONNECT_PORT_NAME });\n    this._port.onMessage.addListener(\n      ({\n        type,\n        payload,\n        requestId,\n        result,\n        error,\n      }: {\n        type: keyof BaseEventEnum;\n        payload: unknown;\n        requestId: string;\n        result?: unknown;\n        error?: string;\n      }) => {\n        switch (type) {\n          case this._events.send:\n            {\n              if (payload) {\n                this.emit(this._events.send, payload);\n              }\n            }\n            break;\n          case this._events.push:\n            {\n              if (payload) {\n                this.emit(this._events.push, payload);\n              }\n            }\n            break;\n          case this._events.response:\n            {\n              const callback = this._requests.get(requestId);\n              if (callback) {\n                if (error) {\n                  callback.reject(new Error(error));\n                } else {\n                  callback.resolve(result);\n                }\n              }\n            }\n            break;\n          default:\n            break;\n        }\n      },\n    );\n  }\n\n  async request({ payload }: { payload: unknown }) {\n    const requestId = v4();\n    let promise = new Promise((resolve, reject) => {\n      this._requests.set(requestId, {\n        resolve,\n        reject,\n      });\n      this._port.postMessage({\n        type: this._events.request,\n        requestId,\n        payload,\n      });\n    });\n    let timeout: NodeJS.Timeout | null = setTimeout(() => {\n      timeout = null;\n      const callback = this._requests.get(requestId);\n      if (callback) {\n        callback.reject(new Error(this._events.timeout));\n      }\n    }, this._timeout);\n    promise = promise\n      .then((result) => {\n        if (timeout) clearTimeout(timeout);\n        this._requests.delete(requestId);\n        return Promise.resolve(result);\n      })\n      .catch((error) => {\n        if (timeout) clearTimeout(timeout);\n        this._requests.delete(requestId);\n        return Promise.reject(\n          // @ts-expect-error TS(2571): Object is of type 'unknown'.\n          new Error(`${payload.functionPath}: ${error.message}`),\n        );\n      });\n    return promise;\n  }\n\n  async send({ payload }: { payload: unknown }) {\n    this._port.postMessage({\n      type: this._events.send,\n      payload,\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}
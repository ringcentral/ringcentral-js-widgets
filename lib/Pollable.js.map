{"version":3,"sources":["lib/Pollable.js"],"names":["Pollable","deps","dep","optional","options","_timeoutId","Error","clearTimeout","t","timestamp","ttl","Date","now","_clearTimeout","setTimeout","_tabManager","active","fetchData","_startPolling","timeToRetry","_retry"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;IAKqBA,Q,WAHpB,iBAAQ;AACPC,QAAM,CAAC,EAAEC,KAAK,iBAAP,EAA0BC,UAAU,IAApC,EAAD;AADC,CAAR,C;;;AAIC,0BAEG;AAAA,QADEC,OACF;AAAA;;AAAA,qKAEIA,OAFJ;;AAID,UAAKC,UAAL,GAAkB,IAAlB;AAJC;AAKF;AACD;;;;;;AAYA;gCACY;AACV,YAAM,IAAIC,KAAJ,CAAU,8BAAV,CAAN;AACD;;;oCAEe;AACd,UAAI,KAAKD,UAAT,EAAqBE,aAAa,KAAKF,UAAlB;AACtB;;;oCAEgE;AAAA;;AAAA,UAAnDG,CAAmD,uEAA9C,KAAKC,SAAL,GAAiB,KAAKC,GAAtB,GAA4B,EAA7B,GAAmCC,KAAKC,GAAL,EAAY;;AAC/D,WAAKC,aAAL;AACA,WAAKR,UAAL,GAAkBS,WAAW,YAAM;AACjC,eAAKT,UAAL,GAAkB,IAAlB;AACA,YAAI,CAAC,OAAKU,WAAN,IAAqB,OAAKA,WAAL,CAAiBC,MAA1C,EAAkD;AAChD,cAAI,CAAC,OAAKP,SAAN,IAAmBE,KAAKC,GAAL,KAAa,OAAKH,SAAlB,GAA8B,OAAKC,GAA1D,EAA+D;AAC7D,mBAAKO,SAAL;AACD,WAFD,MAEO;AACL,mBAAKC,aAAL;AACD;AACF,SAND,MAMO,IAAI,OAAKT,SAAL,IAAkBE,KAAKC,GAAL,KAAa,OAAKH,SAAlB,GAA8B,OAAKC,GAAzD,EAA8D;AACnE,iBAAKQ,aAAL;AACD,SAFM,MAEA;AACL,iBAAKA,aAAL,CAAmB,OAAKC,WAAxB;AACD;AACF,OAbiB,EAafX,CAbe,CAAlB;AAcD;;;6BAC4B;AAAA;;AAAA,UAAtBA,CAAsB,uEAAlB,KAAKW,WAAa;;AAC3B,WAAKN,aAAL;AACA,WAAKR,UAAL,GAAkBS,WAAW,YAAM;AACjC,eAAKT,UAAL,GAAkB,IAAlB;AACA,YAAI,CAAC,OAAKI,SAAN,IAAmBE,KAAKC,GAAL,KAAa,OAAKH,SAAlB,GAA8B,OAAKC,GAA1D,EAA+D;AAC7D,cAAI,CAAC,OAAKK,WAAN,IAAqB,OAAKA,WAAL,CAAiBC,MAA1C,EAAkD;AAChD,mBAAKC,SAAL;AACD,WAFD,MAEO;AACL;AACA,mBAAKG,MAAL;AACD;AACF;AACF,OAViB,EAUfZ,CAVe,CAAlB;AAWD;;;wBAlDe;AACd,YAAM,IAAIF,KAAJ,CAAU,0BAAV,CAAN;AACD;AACD;;;;wBACU;AACR,YAAM,IAAIA,KAAJ,CAAU,oBAAV,CAAN;AACD;AACD;;;;wBACkB;AAChB,YAAM,IAAIA,KAAJ,CAAU,4BAAV,CAAN;AACD;;;;kBApBkBN,Q","file":"Pollable.js","sourcesContent":["import RcModule from './RcModule';\nimport { Library } from './di';\n\n@Library({\n  deps: [{ dep: 'PollableOptions', optional: true }]\n})\nexport default class Pollable extends RcModule {\n  constructor({\n    ...options\n  }) {\n    super({\n      ...options,\n    });\n    this._timeoutId = null;\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get timestamp() {\n    throw new Error('timestamp is not defined');\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get ttl() {\n    throw new Error('ttl is not defined');\n  }\n  // eslint-disable-next-line class-methods-use-this\n  get timeToRetry() {\n    throw new Error('timeToRetry is not defined');\n  }\n  // eslint-disable-next-line class-methods-use-this\n  fetchData() {\n    throw new Error('fetchData is not implemented');\n  }\n\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n\n  _startPolling(t = (this.timestamp + this.ttl + 10) - Date.now()) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this._tabManager || this._tabManager.active) {\n        if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n          this.fetchData();\n        } else {\n          this._startPolling();\n        }\n      } else if (this.timestamp && Date.now() - this.timestamp < this.ttl) {\n        this._startPolling();\n      } else {\n        this._startPolling(this.timeToRetry);\n      }\n    }, t);\n  }\n  _retry(t = this.timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n        if (!this._tabManager || this._tabManager.active) {\n          this.fetchData();\n        } else {\n          // continue retry checks in case tab becomes main tab\n          this._retry();\n        }\n      }\n    }, t);\n  }\n}\n"]}
{"version":3,"sources":["lib/Pollable.ts"],"names":["Pollable","deps","dep","optional","options","_timeoutId","Error","clearTimeout","t","timestamp","pollingInterval","Date","now","_clearTimeout","setTimeout","_tabManager","active","ttl","fetchData","_startPolling","timeToRetry","_retry","RcModule"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAKqBA,Q,WAHpB,iBAAQ;AACPC,EAAAA,IAAI,EAAE,CAAC;AAAEC,IAAAA,GAAG,EAAE,iBAAP;AAA0BC,IAAAA,QAAQ,EAAE;AAApC,GAAD;AADC,CAAR,C;;;;;AAIC,0BAA4B;AAAA;;AAAA,QAAXC,OAAW;;AAAA;;AAC1B,gDACKA,OADL;AAGA,UAAKC,UAAL,GAAkB,IAAlB;AAJ0B;AAK3B;;;;gCAkBW;AACV,YAAM,IAAIC,KAAJ,CAAU,8BAAV,CAAN;AACD;;;oCAEe;AACd,UAAI,KAAKD,UAAT,EAAqBE,YAAY,CAAC,KAAKF,UAAN,CAAZ;AACtB;;;oCAE0E;AAAA;;AAAA,UAA7DG,CAA6D,uEAAzD,KAAKC,SAAL,GAAiB,KAAKC,eAAtB,GAAwC,EAAxC,GAA6CC,IAAI,CAACC,GAAL,EAAY;;AACzE,WAAKC,aAAL;;AACA,WAAKR,UAAL,GAAkBS,UAAU,CAAC,YAAM;AACjC,QAAA,MAAI,CAACT,UAAL,GAAkB,IAAlB;;AACA,YAAI,CAAC,MAAI,CAACU,WAAN,IAAqB,MAAI,CAACA,WAAL,CAAiBC,MAA1C,EAAkD;AAChD,cAAI,CAAC,MAAI,CAACP,SAAN,IAAmBE,IAAI,CAACC,GAAL,KAAa,MAAI,CAACH,SAAlB,GAA8B,MAAI,CAACQ,GAA1D,EAA+D;AAC7D,YAAA,MAAI,CAACC,SAAL;AACD,WAFD,MAEO;AACL,YAAA,MAAI,CAACC,aAAL;AACD;AACF,SAND,MAMO,IAAI,MAAI,CAACV,SAAL,IAAkBE,IAAI,CAACC,GAAL,KAAa,MAAI,CAACH,SAAlB,GAA8B,MAAI,CAACQ,GAAzD,EAA8D;AACnE,UAAA,MAAI,CAACE,aAAL;AACD,SAFM,MAEA;AACL,UAAA,MAAI,CAACA,aAAL,CAAmB,MAAI,CAACC,WAAxB;AACD;AACF,OAb2B,EAazBZ,CAbyB,CAA5B;AAcD;;;6BAE4B;AAAA;;AAAA,UAAtBA,CAAsB,uEAAlB,KAAKY,WAAa;;AAC3B,WAAKP,aAAL;;AACA,WAAKR,UAAL,GAAkBS,UAAU,CAAC,YAAM;AACjC,QAAA,MAAI,CAACT,UAAL,GAAkB,IAAlB;;AACA,YAAI,CAAC,MAAI,CAACI,SAAN,IAAmBE,IAAI,CAACC,GAAL,KAAa,MAAI,CAACH,SAAlB,GAA8B,MAAI,CAACQ,GAA1D,EAA+D;AAC7D,cAAI,CAAC,MAAI,CAACF,WAAN,IAAqB,MAAI,CAACA,WAAL,CAAiBC,MAA1C,EAAkD;AAChD,YAAA,MAAI,CAACE,SAAL;AACD,WAFD,MAEO;AACL;AACA,YAAA,MAAI,CAACG,MAAL;AACD;AACF;AACF,OAV2B,EAUzBb,CAVyB,CAA5B;AAWD;;;wBAvDe;AACd,YAAM,IAAIF,KAAJ,CAAU,0BAAV,CAAN;AACD;;;wBAES;AACR,YAAM,IAAIA,KAAJ,CAAU,oBAAV,CAAN;AACD;;;wBAEqB;AACpB,aAAO,KAAKW,GAAZ;AACD;;;wBAEiB;AAChB,YAAM,IAAIX,KAAJ,CAAU,4BAAV,CAAN;AACD;;;;EAtBmCgB,qB","sourcesContent":["import { Library } from './di';\nimport RcModule from './RcModule';\n\n@Library({\n  deps: [{ dep: 'PollableOptions', optional: true }],\n})\nexport default class Pollable extends RcModule {\n  constructor({ ...options }) {\n    super({\n      ...options,\n    });\n    this._timeoutId = null;\n  }\n\n  get timestamp() {\n    throw new Error('timestamp is not defined');\n  }\n\n  get ttl() {\n    throw new Error('ttl is not defined');\n  }\n\n  get pollingInterval() {\n    return this.ttl;\n  }\n\n  get timeToRetry() {\n    throw new Error('timeToRetry is not defined');\n  }\n\n  fetchData() {\n    throw new Error('fetchData is not implemented');\n  }\n\n  _clearTimeout() {\n    if (this._timeoutId) clearTimeout(this._timeoutId);\n  }\n\n  _startPolling(t = this.timestamp + this.pollingInterval + 10 - Date.now()) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this._tabManager || this._tabManager.active) {\n        if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n          this.fetchData();\n        } else {\n          this._startPolling();\n        }\n      } else if (this.timestamp && Date.now() - this.timestamp < this.ttl) {\n        this._startPolling();\n      } else {\n        this._startPolling(this.timeToRetry);\n      }\n    }, t);\n  }\n\n  _retry(t = this.timeToRetry) {\n    this._clearTimeout();\n    this._timeoutId = setTimeout(() => {\n      this._timeoutId = null;\n      if (!this.timestamp || Date.now() - this.timestamp > this.ttl) {\n        if (!this._tabManager || this._tabManager.active) {\n          this.fetchData();\n        } else {\n          // continue retry checks in case tab becomes main tab\n          this._retry();\n        }\n      }\n    }, t);\n  }\n}\n"],"file":"Pollable.js"}
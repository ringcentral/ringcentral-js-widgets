{"version":3,"file":"index.js","names":["parseCombinedState","authState","_authState$split","split","_authState$split2","_slicedToArray","state","json","window","atob","combinedState","JSON","parse","now","console","log","ex","callbackUri","location","href","urlSearchParams","URLSearchParams","get","_window$opener","opener","oAuthCallback","close","postMessageToOpener","_window$opener2","postMessage","origin","storageSentTimeout","timeoutId","undefined","hash","slice","join","key","concat","addEventListener","event","isRemoved","newValue","parent","clearTimeout","setTimeout","localStorage","removeItem","setItem"],"sources":["lib/oAuthRedirect/index.ts"],"sourcesContent":["import type { CombinedAuthState } from '../../modules/OAuth';\n\nexport function parseCombinedState(authState: string) {\n  const [state] = authState.split('-'); // first part of auth state\n  try {\n    const json = window.atob(state);\n    const combinedState: CombinedAuthState | null = JSON.parse(json);\n    // validate the combined state\n    if (typeof combinedState?.now === 'number') {\n      console.log('[CombinedState] parsed');\n      return combinedState;\n    }\n  } catch (ex) {\n    console.log('[CombinedState]', ex);\n  }\n}\n\n(() => {\n  const callbackUri = location.href;\n  const urlSearchParams = new URLSearchParams(callbackUri);\n  const state = urlSearchParams.get('state') || '';\n  const combinedState = parseCombinedState(state);\n\n  /* Solution: call hook */\n  try {\n    if (window.opener?.oAuthCallback) {\n      window.opener.oAuthCallback(callbackUri);\n      console.log('[CallHook] success');\n      window.close();\n      return;\n    }\n  } catch (ex) {\n    console.log('[CallHook]', ex);\n  }\n\n  /* Solution: postMessage */\n  const postMessageToOpener = () => {\n    try {\n      if (window.opener?.postMessage && combinedState?.origin) {\n        window.opener.postMessage({ callbackUri }, combinedState.origin);\n        console.log('[PostMessage] success');\n        window.close();\n        return;\n      }\n    } catch (ex) {\n      console.log('[PostMessage]', ex);\n    }\n  };\n\n  /* Solution: localStorage */\n  let storageSentTimeout = false;\n  let timeoutId: NodeJS.Timeout | undefined = undefined;\n  // Listen to storage event to detect if the storage is removed/handled\n  const hash = state.split('-').slice(1).join('-');\n  const key = `${hash}-callbackUri`;\n  window.addEventListener('storage', (event) => {\n    if (event.key !== key) return;\n    const isRemoved = !event.newValue; // is removed by opener or by timeout\n    if (isRemoved && !storageSentTimeout) {\n      console.log('[LocalStorage] success');\n      // Notify parent window to close window.\n      if (window.parent) {\n        window.parent.postMessage('authenticated', '*');\n      }\n      clearTimeout(timeoutId);\n      window.close();\n    }\n  });\n  // If opener can't handle the storage, remove the storage and try to post message to opener\n  timeoutId = setTimeout(() => {\n    console.log('[LocalStorage] timeout');\n    storageSentTimeout = true;\n    localStorage.removeItem(key);\n    postMessageToOpener();\n  }, 1000);\n  // Set storage value\n  localStorage.setItem(key, callbackUri);\n})();\n"],"mappings":"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","ignoreList":[]}
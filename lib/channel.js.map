{"version":3,"file":"channel.js","names":["_ObjectProxy","require","_typeof","o","Symbol","iterator","constructor","prototype","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","asyncGeneratorStep","n","a","c","i","u","done","Promise","resolve","then","_asyncToGenerator","_next","_throw","_classCallCheck","TypeError","_defineProperties","key","_createClass","_toPrimitive","toPrimitive","call","String","Number","Channel","type","_mux","_type","_make","select","actionType","handler","_send","regeneratorRuntime","mark","_callee","packet","wrap","_callee$","_context","prev","next","chrome","runtime","sendMessage","abrupt","sent","stop","send","_x","_broadcast","_callee2","_this","tabs","_callee2$","_context2","proxyChrome","query","discarded","allSettled","map","tab","id","broadcast","_x2","_this2","onMessage","addListener","message","sender","sendResponse","action","err","console","error","exports"],"sources":["lib/channel.ts"],"sourcesContent":["import { proxyChrome } from '@ringcentral-integration/commons/lib/ObjectProxy';\n\ntype Handler = (message: any, sender: chrome.runtime.MessageSender) => void;\n\ntype Packet = {\n  [s: string]: any;\n};\n\nexport class Channel {\n  _mux: Record<string, Handler> = {};\n  _type: string;\n\n  constructor(type: string) {\n    this._type = type;\n    this._make();\n  }\n\n  select(actionType: string, handler: Handler) {\n    this._mux[actionType] = handler;\n    return this;\n  }\n\n  async send(packet: Packet) {\n    return await chrome.runtime.sendMessage({\n      type: this._type,\n      ...packet,\n    });\n  }\n\n  async broadcast(packet: Packet) {\n    const tabs = await proxyChrome.tabs.query({ discarded: false });\n    // Keep behavior of ignoring exception\n    await Promise.allSettled(\n      tabs.map((tab) =>\n        proxyChrome.tabs.sendMessage(tab.id!, {\n          type: this._type,\n          ...packet,\n        }),\n      ),\n    );\n  }\n\n  _make() {\n    chrome.runtime.onMessage.addListener(\n      (\n        message: any,\n        sender: chrome.runtime.MessageSender,\n        sendResponse: (response?: any) => void,\n      ) => {\n        const { type, action } = message;\n        if (type === this._type) {\n          const handler = this._mux[action];\n          if (typeof handler === 'function') {\n            Promise.resolve(handler(message, sender))\n              .then((value) => {\n                sendResponse(value);\n              })\n              .catch((err) => {\n                console.error(err);\n                sendResponse();\n              });\n            // Async\n            return true;\n          }\n        }\n        return false;\n      },\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}
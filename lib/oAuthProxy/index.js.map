{"version":3,"file":"index.js","names":["_popWindow","require","_simpleHash","_interopRequireDefault","e","__esModule","loginWindow","urlSearchParams","URLSearchParams","location","search","prefix","get","hash","simpleHash","window","oAuthCallback","callbackUri","parent","postMessage","addEventListener","_ref","_ref$data","data","oAuthUri","trim","parsedUri","URL","searchParams","set","concat","toString","popWindow","key","newValue","localStorage","removeItem","proxyLoaded","error","close"],"sources":["lib/oAuthProxy/index.ts"],"sourcesContent":["import { popWindow } from '../popWindow';\nimport simpleHash from '../simpleHash';\n\nlet loginWindow: any = null;\n\nconst urlSearchParams = new URLSearchParams(location.search);\nconst prefix = urlSearchParams.get('prefix') || 'rc';\nconst hash = urlSearchParams.get('hash') || simpleHash();\n\n/**\n * @function\n * @global\n * @description oAuthCallback allows redirect to call via window.opener.oAuthCallback if window.opener is not blocked.\n * @param {String} callbackUri\n */\nwindow.oAuthCallback = (callbackUri: string) => {\n  window.parent.postMessage(\n    {\n      callbackUri,\n    },\n    '*',\n  );\n};\n\nwindow.addEventListener('message', ({ data = {} }) => {\n  const { oAuthUri } = data;\n  if (oAuthUri && oAuthUri.trim() !== '') {\n    const parsedUri = new URL(oAuthUri);\n    const searchParams = new URLSearchParams(parsedUri.search);\n    searchParams.set('state', `${searchParams.get('state')}-${prefix}-${hash}`);\n    parsedUri.search = searchParams.toString();\n    loginWindow = popWindow(parsedUri.toString(), `${prefix}-oauth`, 700, 700);\n  }\n});\n\nconst key = `${prefix}-${hash}-callbackUri`;\nwindow.addEventListener('storage', (e) => {\n  if (e.key === key && e.newValue && e.newValue !== '') {\n    const callbackUri = e.newValue;\n    localStorage.removeItem(key);\n    window.parent.postMessage(\n      {\n        callbackUri,\n      },\n      '*',\n    );\n  }\n});\n\ntry {\n  window.parent.postMessage(\n    {\n      proxyLoaded: true,\n    },\n    '*',\n  );\n} catch (error) {\n  /* ignore error */\n}\n\nwindow.addEventListener('beforeunload', () => {\n  if (loginWindow) {\n    try {\n      loginWindow.close();\n    } catch (error) {\n      /* ignore error */\n    }\n  }\n});\n"],"mappings":";;;;;;;;;;;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,WAAA,GAAAC,sBAAA,CAAAF,OAAA;AAAuC,SAAAE,uBAAAC,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,gBAAAA,CAAA;AAEvC,IAAIE,WAAgB,GAAG,IAAI;AAE3B,IAAMC,eAAe,GAAG,IAAIC,eAAe,CAACC,QAAQ,CAACC,MAAM,CAAC;AAC5D,IAAMC,MAAM,GAAGJ,eAAe,CAACK,GAAG,CAAC,QAAQ,CAAC,IAAI,IAAI;AACpD,IAAMC,IAAI,GAAGN,eAAe,CAACK,GAAG,CAAC,MAAM,CAAC,IAAI,IAAAE,sBAAU,EAAC,CAAC;;AAExD;AACA;AACA;AACA;AACA;AACA;AACAC,MAAM,CAACC,aAAa,GAAG,UAACC,WAAmB,EAAK;EAC9CF,MAAM,CAACG,MAAM,CAACC,WAAW,CACvB;IACEF,WAAW,EAAXA;EACF,CAAC,EACD,GACF,CAAC;AACH,CAAC;AAEDF,MAAM,CAACK,gBAAgB,CAAC,SAAS,EAAE,UAAAC,IAAA,EAAmB;EAAA,IAAAC,SAAA,GAAAD,IAAA,CAAhBE,IAAI;IAAJA,IAAI,GAAAD,SAAA,cAAG,CAAC,CAAC,GAAAA,SAAA;EAAA,IACrCE,QAAQ,GAAKD,IAAI,CAAjBC,QAAQ;EAChB,IAAIA,QAAQ,IAAIA,QAAQ,CAACC,IAAI,CAAC,CAAC,KAAK,EAAE,EAAE;IACtC,IAAMC,SAAS,GAAG,IAAIC,GAAG,CAACH,QAAQ,CAAC;IACnC,IAAMI,YAAY,GAAG,IAAIpB,eAAe,CAACkB,SAAS,CAAChB,MAAM,CAAC;IAC1DkB,YAAY,CAACC,GAAG,CAAC,OAAO,KAAAC,MAAA,CAAKF,YAAY,CAAChB,GAAG,CAAC,OAAO,CAAC,OAAAkB,MAAA,CAAInB,MAAM,OAAAmB,MAAA,CAAIjB,IAAI,CAAE,CAAC;IAC3Ea,SAAS,CAAChB,MAAM,GAAGkB,YAAY,CAACG,QAAQ,CAAC,CAAC;IAC1CzB,WAAW,GAAG,IAAA0B,oBAAS,EAACN,SAAS,CAACK,QAAQ,CAAC,CAAC,KAAAD,MAAA,CAAKnB,MAAM,aAAU,GAAG,EAAE,GAAG,CAAC;EAC5E;AACF,CAAC,CAAC;AAEF,IAAMsB,GAAG,MAAAH,MAAA,CAAMnB,MAAM,OAAAmB,MAAA,CAAIjB,IAAI,iBAAc;AAC3CE,MAAM,CAACK,gBAAgB,CAAC,SAAS,EAAE,UAAChB,CAAC,EAAK;EACxC,IAAIA,CAAC,CAAC6B,GAAG,KAAKA,GAAG,IAAI7B,CAAC,CAAC8B,QAAQ,IAAI9B,CAAC,CAAC8B,QAAQ,KAAK,EAAE,EAAE;IACpD,IAAMjB,WAAW,GAAGb,CAAC,CAAC8B,QAAQ;IAC9BC,YAAY,CAACC,UAAU,CAACH,GAAG,CAAC;IAC5BlB,MAAM,CAACG,MAAM,CAACC,WAAW,CACvB;MACEF,WAAW,EAAXA;IACF,CAAC,EACD,GACF,CAAC;EACH;AACF,CAAC,CAAC;AAEF,IAAI;EACFF,MAAM,CAACG,MAAM,CAACC,WAAW,CACvB;IACEkB,WAAW,EAAE;EACf,CAAC,EACD,GACF,CAAC;AACH,CAAC,CAAC,OAAOC,KAAK,EAAE;EACd;AAAA;AAGFvB,MAAM,CAACK,gBAAgB,CAAC,cAAc,EAAE,YAAM;EAC5C,IAAId,WAAW,EAAE;IACf,IAAI;MACFA,WAAW,CAACiC,KAAK,CAAC,CAAC;IACrB,CAAC,CAAC,OAAOD,KAAK,EAAE;MACd;IAAA;EAEJ;AACF,CAAC,CAAC","ignoreList":[]}
{"version":3,"sources":["lib/oAuthProxy/index.ts"],"names":["loginWindow","window","location","href","query","prefix","hash","oAuthCallback","callbackUri","parent","postMessage","addEventListener","data","oAuthUri","trim","parsedUri","state","set","toString","key","e","newValue","localStorage","removeItem","proxyLoaded","error","close"],"mappings":";;;;;;;;;;AAAA;;AAEA;;AACA;;;;AAEA,IAAIA,WAAW,GAAG,IAAlB;;aAII,0BAAMC,MAAM,CAACC,QAAP,CAAgBC,IAAtB,EAA4B,IAA5B,C;0BADFC,K;uCAASC,M;IAAAA,M,oCAAS,I;qCAAMC,I;IAAAA,I,kCAAO,6B;AAGjC;AACA;AACA;AACA;AACA;AACA;;;AACAL,MAAM,CAACM,aAAP,GAAuB,UAACC,WAAD,EAAiB;AACtCP,EAAAA,MAAM,CAACQ,MAAP,CAAcC,WAAd,CACE;AACEF,IAAAA,WAAW,EAAXA;AADF,GADF,EAIE,GAJF;AAMD,CAPD;;AASAP,MAAM,CAACU,gBAAP,CAAwB,SAAxB,EAAmC,gBAAmB;AAAA,uBAAhBC,IAAgB;AAAA,MAAhBA,IAAgB,0BAAT,EAAS;AAAA,MAC5CC,QAD4C,GAC/BD,IAD+B,CAC5CC,QAD4C;;AAEpD,MAAIA,QAAQ,IAAIA,QAAQ,CAACC,IAAT,OAAoB,EAApC,EAAwC;AACtC,QAAMC,SAAS,GAAG,0BAAMF,QAAN,EAAgB,IAAhB,CAAlB;AADsC,QAE9BT,KAF8B,GAEpBW,SAFoB,CAE9BX,KAF8B;AAGtCA,IAAAA,KAAK,CAACY,KAAN,aAAiBZ,KAAK,CAACY,KAAvB,cAAgCX,MAAhC,cAA0CC,IAA1C;AACAS,IAAAA,SAAS,CAACE,GAAV,CAAc,OAAd,EAAuBb,KAAvB;AACAJ,IAAAA,WAAW,GAAG,2BAAUe,SAAS,CAACG,QAAV,EAAV,YAAmCb,MAAnC,aAAmD,GAAnD,EAAwD,GAAxD,CAAd;AACD;AACF,CATD;AAWA,IAAMc,GAAG,aAAMd,MAAN,cAAgBC,IAAhB,iBAAT;AACAL,MAAM,CAACU,gBAAP,CAAwB,SAAxB,EAAmC,UAACS,CAAD,EAAO;AACxC,MAAIA,CAAC,CAACD,GAAF,KAAUA,GAAV,IAAiBC,CAAC,CAACC,QAAnB,IAA+BD,CAAC,CAACC,QAAF,KAAe,EAAlD,EAAsD;AACpD,QAAMb,WAAW,GAAGY,CAAC,CAACC,QAAtB;AACAC,IAAAA,YAAY,CAACC,UAAb,CAAwBJ,GAAxB;AACAlB,IAAAA,MAAM,CAACQ,MAAP,CAAcC,WAAd,CACE;AACEF,MAAAA,WAAW,EAAXA;AADF,KADF,EAIE,GAJF;AAMD;AACF,CAXD;;AAaA,IAAI;AACFP,EAAAA,MAAM,CAACQ,MAAP,CAAcC,WAAd,CACE;AACEc,IAAAA,WAAW,EAAE;AADf,GADF,EAIE,GAJF;AAMD,CAPD,CAOE,OAAOC,KAAP,EAAc;AACd;AACD;;AAEDxB,MAAM,CAACU,gBAAP,CAAwB,cAAxB,EAAwC,YAAM;AAC5C,MAAIX,WAAJ,EAAiB;AACf,QAAI;AACFA,MAAAA,WAAW,CAAC0B,KAAZ;AACD,KAFD,CAEE,OAAOD,KAAP,EAAc;AACd;AACD;AACF;AACF,CARD","sourcesContent":["import parse from 'url-parse';\n\nimport popWindow from '../popWindow';\nimport simpleHash from '../simpleHash';\n\nlet loginWindow = null;\n\nconst {\n  query: { prefix = 'rc', hash = simpleHash() },\n} = parse(window.location.href, true);\n\n/**\n * @function\n * @global\n * @description oAuthCallback allows redirect to call via window.opener.oAuthCallback if window.opener is not blocked.\n * @param {String} callbackUri\n */\nwindow.oAuthCallback = (callbackUri) => {\n  window.parent.postMessage(\n    {\n      callbackUri,\n    },\n    '*',\n  );\n};\n\nwindow.addEventListener('message', ({ data = {} }) => {\n  const { oAuthUri } = data;\n  if (oAuthUri && oAuthUri.trim() !== '') {\n    const parsedUri = parse(oAuthUri, true);\n    const { query } = parsedUri;\n    query.state = `${query.state}-${prefix}-${hash}`;\n    parsedUri.set('query', query);\n    loginWindow = popWindow(parsedUri.toString(), `${prefix}-oauth`, 600, 600);\n  }\n});\n\nconst key = `${prefix}-${hash}-callbackUri`;\nwindow.addEventListener('storage', (e) => {\n  if (e.key === key && e.newValue && e.newValue !== '') {\n    const callbackUri = e.newValue;\n    localStorage.removeItem(key);\n    window.parent.postMessage(\n      {\n        callbackUri,\n      },\n      '*',\n    );\n  }\n});\n\ntry {\n  window.parent.postMessage(\n    {\n      proxyLoaded: true,\n    },\n    '*',\n  );\n} catch (error) {\n  /* ignore error */\n}\n\nwindow.addEventListener('beforeunload', () => {\n  if (loginWindow) {\n    try {\n      loginWindow.close();\n    } catch (error) {\n      /* ignore error */\n    }\n  }\n});\n"],"file":"index.js"}
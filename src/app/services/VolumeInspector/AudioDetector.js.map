{"version":3,"file":"AudioDetector.js","names":["_DetectorListener","require","_RTCAudioMeter","_typeof","o","Symbol","iterator","constructor","prototype","_regenerator","e","t","r","n","toStringTag","i","c","Generator","u","Object","create","_regeneratorDefine2","f","p","y","G","v","a","d","bind","length","l","TypeError","call","done","value","GeneratorFunction","GeneratorFunctionPrototype","getPrototypeOf","setPrototypeOf","__proto__","displayName","w","m","defineProperty","_regeneratorDefine","_invoke","enumerable","configurable","writable","asyncGeneratorStep","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","_classCallCheck","_defineProperties","_toPropertyKey","key","_createClass","_toPrimitive","toPrimitive","String","Number","AudioDetector","exports","_this","_audioMeter","RTCAudioMeter","_listeners","_audioInput","_startListenCallback","intervalId","push","_disposeListenCallback","idx","indexOf","splice","_connect","_callee","input","_t","_context","console","warn","disconnect","updateInputStream","error","message","connect","_x","registerListener","dataCallback","DetectorListener","_genListenerHandle","forEach","clearInterval","_this2","volumeLevel","getMicLevel"],"sources":["src/app/services/VolumeInspector/AudioDetector.ts"],"sourcesContent":["import { DetectorListener } from './DetectorListener';\nimport { RTCAudioMeter } from './RTCAudioMeter';\n\nexport class AudioDetector {\n  private _audioMeter = new RTCAudioMeter();\n  private _listeners: Array<number> = [];\n  private _audioInput?: MediaStream | HTMLMediaElement;\n\n  /**\n   * connect to audio MediaStream or HTMLMediaElement for detecting\n   * @param input MediaStream | HTMLMediaElement\n   */\n  public async connect(input: MediaStream | HTMLMediaElement) {\n    if (!input || this._audioInput === input) {\n      console.warn('The same audio input has connected.');\n      return;\n    }\n    // disconnect an old audio input if exists.\n    this.disconnect();\n    console.warn('Connect to the new media input.');\n    try {\n      await this._audioMeter.updateInputStream(input);\n    } catch (e) {\n      console.error('update input stream error, msg:', (e as Error).message);\n      return;\n    }\n    this._audioInput = input;\n  }\n\n  /**\n   * Add a new listener for the specified audioSource,\n   * The listener will call dataCallback(volume) cyclically after it calls start().\n   * The volume will be a number from [0,1].\n   * @param dataCallback (volume: number) => {}\n   * @return DetectorListener |\n   */\n  public registerListener(dataCallback: (volume: number) => void) {\n    return new DetectorListener(\n      this._startListenCallback,\n      this._genListenerHandle(dataCallback),\n      this._disposeListenCallback,\n    );\n  }\n\n  /**\n   * disconnect to the audioSource, and clear all listeners.\n   */\n  public disconnect(): void {\n    if (this._listeners.length > 0) {\n      this._listeners.forEach(clearInterval);\n      this._listeners = [];\n    }\n    if (this._audioInput) {\n      delete this._audioInput;\n    }\n  }\n\n  // manager listener for starting listening\n  private _startListenCallback = (intervalId: number) => {\n    this._listeners.push(intervalId);\n  };\n\n  // generate a listener handle by dataCallback\n  private _genListenerHandle(dataCallback: (volume: number) => void) {\n    return () => {\n      let volumeLevel: number;\n      try {\n        volumeLevel = this._audioMeter.getMicLevel();\n      } catch (e) {\n        console.warn('getVolume Error, return volume = 0, err:', e);\n        volumeLevel = 0;\n      }\n      dataCallback(volumeLevel);\n    };\n  }\n\n  // disposer listener by intervalId\n  private _disposeListenCallback = (intervalId: number) => {\n    const idx = this._listeners.indexOf(intervalId);\n    if (idx >= 0) {\n      this._listeners.splice(idx, 1);\n    }\n  };\n}\n"],"mappings":"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","ignoreList":[]}
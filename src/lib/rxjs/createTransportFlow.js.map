{"version":3,"file":"createTransportFlow.js","names":["_rxjs","require","createTransportFlow","exports","transport","emit$","options","_len","arguments","length","arg","Array","_key","defer","emit","apply","concat","listen$","key","onValue","Observable","observer","destroy","listen","value","next","waitFlowResponded","getListener","subject$","Subject","merge","pipe","switchMap","NEVER"],"sources":["src/lib/rxjs/createTransportFlow.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { EmitOptions, Transport } from 'reactant-share';\nimport { defer, merge, NEVER, Observable, Subject, switchMap } from 'rxjs';\n\n/**\n * a flow base transport instance, you can use that to work with flow way transport emit or listen\n *\n * @example\n * ```ts\n * const transportFlow = createTransportFlow(transport);\n *\n * transportFlow\n *   .listen$('login-success')\n *   .pipe(\n *     tap(() => {\n *       this._clientNotificationStatus();\n *     }),\n *     switchMap(() =>\n *       transportFlow.emit$({\n *         name: 'set-current-tz',\n *         response: true,\n *       }),\n *     ),\n *     tap(() => {\n *       console.log('set time zone successfully');\n *     }),\n *   )\n *   .subscribe();\n * ```\n */\nexport const createTransportFlow = <\n  S extends Record<string, (...args: any[]) => any>,\n>(\n  transport: Transport,\n) => {\n  const emit$ = <K extends keyof S>(\n    options: EmitOptions<K>,\n    ...arg: Parameters<S[K]>\n  ) =>\n    defer(() => transport.emit(options, ...arg)) as Observable<\n      Awaited<ReturnType<S[K]>>\n    >;\n\n  const listen$ = <K extends keyof S, F extends S[K]>(\n    key: K,\n    onValue?: (value: any) => any,\n  ) =>\n    new Observable<Awaited<ReturnType<F>>>((observer) => {\n      const destroy = transport.listen(key, (value: any) => {\n        observer.next(value);\n\n        return onValue?.(value);\n      });\n\n      return () => {\n        destroy?.();\n      };\n    });\n\n  return {\n    /**\n     * emit value with flow way.\n     *\n     * ### if you work with other connection tool, please make sure peer connected before emit value.\n     *\n     * like:\n     *\n     * @example\n     * ```ts\n     * adapterConnection.peerBeConnected$\n     *    .pipe(\n     *       switchMap(() => adapterConnection.emit$('example', value))\n     *    )\n     * ```\n     */\n    emit$,\n    listen$,\n  };\n};\n\n/**\n * when you use listen and want flow be emit with responded inner value, use that wrap\n * @param getListener that source listener\n *\n * @example\n * ```ts\n * waitFlowResponded<string>((obs$) =>\n      transportFlow.listen$(\n        contactSwitcher.fullSyncStart,\n        (clientId: string) => {\n          obs$.next('example next flow');\n\n          return 'some value'\n        },\n      ),\n    ).pipe(\n      tap((obs) => {\n        console.log(obs); // should 'example next flow'\n      }),\n    );\n * ```\n */\nexport const waitFlowResponded = <T = any>(\n  getListener: (subject: Subject<T>) => Observable<unknown>,\n) => {\n  return defer(() => {\n    const subject$ = new Subject<T>();\n\n    return merge(\n      // subject must put in front, some sync method must be listen first\n      subject$,\n      getListener(subject$).pipe(\n        // source never emit, all emit be handle by subject\n        switchMap(() => NEVER),\n      ),\n    );\n  });\n};\n"],"mappings":";;;;;;;;AAEA,IAAAA,KAAA,GAAAC,OAAA;AAFA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,IAAMC,mBAAmB,GAAAC,OAAA,CAAAD,mBAAA,GAAG,SAAtBA,mBAAmBA,CAG9BE,SAAoB,EACjB;EACH,IAAMC,KAAK,GAAG,SAARA,KAAKA,CACTC,OAAuB;IAAA,SAAAC,IAAA,GAAAC,SAAA,CAAAC,MAAA,EACpBC,GAAG,OAAAC,KAAA,CAAAJ,IAAA,OAAAA,IAAA,WAAAK,IAAA,MAAAA,IAAA,GAAAL,IAAA,EAAAK,IAAA;MAAHF,GAAG,CAAAE,IAAA,QAAAJ,SAAA,CAAAI,IAAA;IAAA;IAAA,OAEN,IAAAC,WAAK,EAAC;MAAA,OAAMT,SAAS,CAACU,IAAI,CAAAC,KAAA,CAAdX,SAAS,GAAME,OAAO,EAAAU,MAAA,CAAKN,GAAG,EAAC;IAAA,EAAC;EAAA,CAE3C;EAEH,IAAMO,OAAO,GAAG,SAAVA,OAAOA,CACXC,GAAM,EACNC,OAA6B;IAAA,OAE7B,IAAIC,gBAAU,CAAyB,UAACC,QAAQ,EAAK;MACnD,IAAMC,OAAO,GAAGlB,SAAS,CAACmB,MAAM,CAACL,GAAG,EAAE,UAACM,KAAU,EAAK;QACpDH,QAAQ,CAACI,IAAI,CAACD,KAAK,CAAC;QAEpB,OAAOL,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAGK,KAAK,CAAC;MACzB,CAAC,CAAC;MAEF,OAAO,YAAM;QACXF,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAG,CAAC;MACb,CAAC;IACH,CAAC,CAAC;EAAA;EAEJ,OAAO;IACL;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;IACIjB,KAAK,EAALA,KAAK;IACLY,OAAO,EAAPA;EACF,CAAC;AACH,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,IAAMS,iBAAiB,GAAAvB,OAAA,CAAAuB,iBAAA,GAAG,SAApBA,iBAAiBA,CAC5BC,WAAyD,EACtD;EACH,OAAO,IAAAd,WAAK,EAAC,YAAM;IACjB,IAAMe,QAAQ,GAAG,IAAIC,aAAO,CAAI,CAAC;IAEjC,OAAO,IAAAC,WAAK;IACV;IACAF,QAAQ,EACRD,WAAW,CAACC,QAAQ,CAAC,CAACG,IAAI;IACxB;IACA,IAAAC,eAAS,EAAC;MAAA,OAAMC,WAAK;IAAA,EACvB,CACF,CAAC;EACH,CAAC,CAAC;AACJ,CAAC","ignoreList":[]}
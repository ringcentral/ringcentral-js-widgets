{"version":3,"file":"delegate.js","names":["_reactantShare","require","_delegateMainClient","_parallel","_parallelClients","_proxify","_toConsumableArray","r","_arrayWithoutHoles","_iterableToArray","_unsupportedIterableToArray","_nonIterableSpread","TypeError","a","_arrayLikeToArray","t","toString","call","slice","constructor","name","Array","from","test","Symbol","iterator","isArray","length","e","n","_typeof","o","prototype","generateDelegate","type","isDecorator","arguments","undefined","target","key","descriptor","delegateMainClient","parallelClients","parallel","proxify","Error","concat","delegate","_len","args","_key","_ref","_args$","_generateDelegate","value","apply","originalDelegate"],"sources":["src/lib/decorators/delegate.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n\n/* eslint-disable func-names */\nimport { EmitParameter, delegate as originalDelegate } from 'reactant-share';\n\nimport { delegateMainClient } from './delegateMainClient';\nimport { parallel } from './parallel';\nimport { parallelClients } from './parallelClients';\nimport { proxify } from './proxify';\n\ntype FunctionKeys<T> = Exclude<\n  {\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    [K in keyof T]: T[K] extends Function ? K : never;\n  }[keyof T],\n  void\n>;\n\ntype Options<\n  O extends EmitParameter<any>['respond'],\n  P extends DelegateTypes = 'server',\n> = {\n  /**\n   * The target port to execute the method.\n   */\n  target?: P;\n} & (P extends 'server'\n  ? { respond?: O } & Pick<\n      EmitParameter<any>,\n      Exclude<keyof EmitParameter<any>, 'name' | '_extra' | 'respond'>\n    >\n  : {});\n\ntype ProxyArgs<\n  F extends (...args: any[]) => any,\n  O extends EmitParameter<any>['respond'],\n  P extends DelegateTypes = 'server',\n> = Parameters<F> extends []\n  ? [\n      /**\n       * Pass in the parameters for this method.\n       */\n      args?: Parameters<F>,\n      /**\n       * proxy execution options\n       */\n      options?: Options<O, P>,\n    ]\n  : [\n      /**\n       * Pass in the parameters for this method.\n       */\n      args: Parameters<F>,\n      /**\n       * proxy execution options\n       */\n      options?: Options<O, P>,\n    ];\n\ntype DelegateTypes = 'mainClient' | 'clients' | 'all' | 'server';\n\nconst generateDelegate =\n  (type: DelegateTypes, isDecorator = true) =>\n  (\n    target: any,\n    key: string,\n    descriptor: TypedPropertyDescriptor<(...args: any[]) => Promise<any>>,\n  ) => {\n    switch (type) {\n      case 'mainClient':\n        return delegateMainClient(target, key, descriptor, isDecorator);\n      case 'clients':\n        return parallelClients(target, key, descriptor, isDecorator);\n      case 'all':\n        return parallel(target, key, descriptor, isDecorator);\n      case 'server':\n        return proxify(target, key, descriptor);\n      default:\n        throw new Error(`Unsupported delegate type '${type}'`);\n    }\n  };\n\nfunction delegate<\n  T extends Record<string | number | symbol, any>,\n  K extends FunctionKeys<T>,\n  O extends EmitParameter<any>['respond'],\n  P extends DelegateTypes = 'server',\n>(\n  /**\n   * Designate an execution module from the server side.\n   */\n  module: T,\n  /**\n   * Specify the name of a method in this module.\n   */\n  key: K,\n  ...args: ProxyArgs<T[K], O, P>\n): P extends 'all' | 'clients'\n  ? void\n  : O extends false\n  ? void\n  : ReturnType<T[K]> extends Promise<infer R>\n  ? Promise<R>\n  : Promise<ReturnType<T[K]>>;\nfunction delegate(\n  type: DelegateTypes,\n): (\n  target: any,\n  key: string,\n  descriptor: TypedPropertyDescriptor<(...args: any[]) => Promise<any>>,\n) => TypedPropertyDescriptor<(...args: any) => Promise<any>>;\n/**\n * delegate execution to `'mainClient' | 'clients' | 'all' | 'server'`\n *\n * @example\n *\n * Using function(target is 'server' by default):\n *\n * ```ts\n * await delegate(this.counter, 'increment'); // without function args\n * await delegate(this.counter, 'decrement', [1]); // function args is [1].\n * delegate(this.counter, 'decrement', [1], { target: 'all' }); // Unless the target is 'server', there are no more options available.\n * ```\n * Using decorator:\n *\n * ```ts\n * delegate('mainClient'); // make the method run in the main client port(always only have one client)\n * delegate('clients'); // make the method run in all clients port\n * delegate('all'); // make the method run in both all clients and server port\n * delegate('server'); // make the method run in server port\n * ```\n */\nfunction delegate(...args: any[]) {\n  if (typeof args[0] === 'string') {\n    // it's a decorator\n    const type = args[0] as DelegateTypes;\n    return generateDelegate(type);\n  } else if (typeof args[0] === 'object') {\n    // it's a function\n    const type = (args[3]?.target as DelegateTypes) ?? 'server';\n    if (type !== 'server') {\n      const { value } = generateDelegate(type, false)(args[0], args[1], {\n        value: args[0][args[1]],\n      });\n      return value!.apply(args[0], args[2]);\n    }\n    return originalDelegate(...(args as Parameters<typeof originalDelegate>));\n  }\n  throw new Error(`\n    The first parameter of the delegate decorator must be a string or object.\n  `);\n}\n\nexport { delegate };\n"],"mappings":"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","ignoreList":[]}
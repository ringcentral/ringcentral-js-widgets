{"version":3,"file":"waitUntil.js","names":["_polling","require","_sleep","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","waitUntil","_ref","length","_ref$interval","interval","_ref$timeout","timeout","timeoutPromise","sleep","poolingPromise","polling","rejector","clearTimers","cancel","promise","_ref2","regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","race","Error","concat","stop","_x","_x2","exports"],"sources":["src/utils/waitUntil.ts"],"sourcesContent":["import { polling } from './polling';\nimport { sleep } from './sleep';\n\nexport interface WaitUntilOption {\n  /**\n   * interval time in `ms`\n   *\n   * @default 100\n   */\n  interval?: number;\n  /**\n   * timeout time in `ms`\n   *\n   * @default 5000\n   */\n  timeout?: number;\n}\n\nexport interface WaitUntilPromise extends Promise<void> {\n  /** cancel that wailUntil timer */\n  cancel: () => void;\n}\n\n/**\n * Polling check `fn` result until `fn` return `true`\n *\n * throw error when timeout\n */\nexport const waitUntil = (\n  fn: () => boolean | Promise<boolean>,\n  { interval = 100, timeout = 5000 }: WaitUntilOption = {},\n) => {\n  const timeoutPromise = sleep(timeout);\n  const poolingPromise = polling(fn, interval);\n  let rejector: (reason?: any) => void;\n\n  const clearTimers = () => {\n    timeoutPromise.cancel();\n    poolingPromise.cancel();\n  };\n\n  // eslint-disable-next-line no-async-promise-executor\n  const promise = new Promise(async (resolve, reject) => {\n    rejector = reject;\n    await Promise.race([\n      poolingPromise,\n      timeoutPromise.then(() => {\n        reject(new Error(`${timeout} ms timeout error`));\n      }),\n    ])\n      // TODO: use then and catch for support old browser, that can be remove after we no longer need support that.\n      .then(clearTimers)\n      .catch(clearTimers);\n\n    resolve();\n  }) as WaitUntilPromise;\n\n  promise.cancel = () => {\n    rejector(new Error('Async waitUntil has been cancelled'));\n    clearTimers();\n  };\n\n  return promise;\n};\n"],"mappings":"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"}
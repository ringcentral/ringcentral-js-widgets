{"version":3,"file":"waitUntil.js","names":["waitUntil","fn","interval","timeout","timeoutPromise","sleep","poolingPromise","polling","rejector","clearTimers","cancel","promise","Promise","resolve","reject","race","then","Error"],"sources":["src/utils/waitUntil.ts"],"sourcesContent":["import { polling } from './polling';\nimport { sleep } from './sleep';\n\nexport interface WaitUntilOption {\n  /**\n   * interval time in `ms`\n   *\n   * @default 100\n   */\n  interval?: number;\n  /**\n   * timeout time in `ms`\n   *\n   * @default 5000\n   */\n  timeout?: number;\n}\n\nexport interface WaitUntilPromise extends Promise<void> {\n  /** cancel that wailUntil timer */\n  cancel: () => void;\n}\n\n/**\n * Polling check `fn` result until `fn` return `true`\n *\n * throw error when timeout\n */\nexport const waitUntil = (\n  fn: () => boolean | Promise<boolean>,\n  { interval = 100, timeout = 5000 }: WaitUntilOption = {},\n) => {\n  const timeoutPromise = sleep(timeout);\n  const poolingPromise = polling(fn, interval);\n  let rejector: (reason?: any) => void;\n\n  const clearTimers = () => {\n    timeoutPromise.cancel();\n    poolingPromise.cancel();\n  };\n\n  // eslint-disable-next-line no-async-promise-executor\n  const promise = new Promise(async (resolve, reject) => {\n    rejector = reject;\n    await Promise.race([\n      poolingPromise,\n      timeoutPromise.then(() => {\n        reject(new Error(`${timeout} ms timeout error`));\n      }),\n    ])\n      // TODO: use then and catch for support old browser, that can be remove after we no longer need support that.\n      .then(clearTimers)\n      .catch(clearTimers);\n\n    resolve();\n  }) as WaitUntilPromise;\n\n  promise.cancel = () => {\n    rejector(new Error('Async waitUntil has been cancelled'));\n    clearTimers();\n  };\n\n  return promise;\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;AAsBA;AACA;AACA;AACA;AACA;AACO,IAAMA,SAAS,GAAG,SAAZA,SAAY,CACvBC,EADuB,EAGpB;EAAA,+EADmD,EACnD;EAAA,yBADDC,QACC;EAAA,IADDA,QACC,8BADU,GACV;EAAA,wBADeC,OACf;EAAA,IADeA,OACf,6BADyB,IACzB;;EACH,IAAMC,cAAc,GAAG,IAAAC,YAAA,EAAMF,OAAN,CAAvB;EACA,IAAMG,cAAc,GAAG,IAAAC,gBAAA,EAAQN,EAAR,EAAYC,QAAZ,CAAvB;EACA,IAAIM,QAAJ;;EAEA,IAAMC,WAAW,GAAG,SAAdA,WAAc,GAAM;IACxBL,cAAc,CAACM,MAAf;IACAJ,cAAc,CAACI,MAAf;EACD,CAHD,CALG,CAUH;;;EACA,IAAMC,OAAO,GAAG,IAAIC,OAAJ;IAAA,oEAAY,iBAAOC,OAAP,EAAgBC,MAAhB;MAAA;QAAA;UAAA;YAAA;cAC1BN,QAAQ,GAAGM,MAAX;cAD0B;cAAA,OAEpBF,OAAO,CAACG,IAAR,CAAa,CACjBT,cADiB,EAEjBF,cAAc,CAACY,IAAf,CAAoB,YAAM;gBACxBF,MAAM,CAAC,IAAIG,KAAJ,WAAad,OAAb,uBAAD,CAAN;cACD,CAFD,CAFiB,CAAb,EAMJ;cANI,CAOHa,IAPG,CAOEP,WAPF,WAQGA,WARH,CAFoB;;YAAA;cAY1BI,OAAO;;YAZmB;YAAA;cAAA;UAAA;QAAA;MAAA;IAAA,CAAZ;;IAAA;MAAA;IAAA;EAAA,IAAhB;;EAeAF,OAAO,CAACD,MAAR,GAAiB,YAAM;IACrBF,QAAQ,CAAC,IAAIS,KAAJ,CAAU,oCAAV,CAAD,CAAR;IACAR,WAAW;EACZ,CAHD;;EAKA,OAAOE,OAAP;AACD,CAnCM"}
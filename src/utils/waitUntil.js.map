{"version":3,"file":"waitUntil.js","names":["_polling","require","_sleep","asyncGeneratorStep","n","t","e","r","o","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","waitUntil","fn","_ref","length","undefined","_ref$interval","interval","_ref$timeout","timeout","timeoutPromise","sleep","poolingPromise","polling","rejector","clearTimers","cancel","promise","_ref2","regeneratorRuntime","mark","_callee","reject","wrap","_callee$","_context","prev","next","race","Error","concat","stop","_x","_x2","exports"],"sources":["src/utils/waitUntil.ts"],"sourcesContent":["import { polling } from './polling';\nimport { sleep } from './sleep';\n\nexport interface WaitUntilOption {\n  /**\n   * interval time in `ms`\n   *\n   * @default 100\n   */\n  interval?: number;\n  /**\n   * timeout time in `ms`\n   *\n   * @default 5000\n   */\n  timeout?: number;\n}\n\nexport interface WaitUntilPromise extends Promise<void> {\n  /** cancel that wailUntil timer */\n  cancel: () => void;\n}\n\n/**\n * Polling check `fn` result until `fn` return `true`\n *\n * throw error when timeout\n */\nexport const waitUntil = (\n  fn: () => boolean | Promise<boolean>,\n  { interval = 100, timeout = 5000 }: WaitUntilOption = {},\n) => {\n  const timeoutPromise = sleep(timeout);\n  const poolingPromise = polling(fn, interval);\n  let rejector: (reason?: any) => void;\n\n  const clearTimers = () => {\n    timeoutPromise.cancel();\n    poolingPromise.cancel();\n  };\n\n  // eslint-disable-next-line no-async-promise-executor\n  const promise = new Promise(async (resolve, reject) => {\n    rejector = reject;\n    await Promise.race([\n      poolingPromise,\n      timeoutPromise.then(() => {\n        reject(new Error(`${timeout} ms timeout error`));\n      }),\n    ])\n      // TODO: use then and catch for support old browser, that can be remove after we no longer need support that.\n      .then(clearTimers)\n      .catch(clearTimers);\n\n    resolve();\n  }) as WaitUntilPromise;\n\n  promise.cancel = () => {\n    rejector(new Error('Async waitUntil has been cancelled'));\n    clearTimers();\n  };\n\n  return promise;\n};\n"],"mappings":"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","ignoreList":[]}
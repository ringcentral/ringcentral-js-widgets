{"version":3,"file":"downloadFile.js","names":["_getHostPath","require","_isSafari","_sleep","appendAndClickDownloadLink","target","_ref","href","download","link","document","createElement","body","appendChild","dispatchEvent","MouseEvent","bubbles","downloadFile","exports","url","filename","isSafari","global","window","open","remove","downloadFileWithIframe","serverResponseTime","arguments","length","undefined","iframe","style","display","addEventListener","contentWindow","src","sleepPromise","sleep","downloadFileWithIframeCors","_iframe$contentWindow","postMessage","key","hostUrl","getHostPath"],"sources":["src/utils/downloadFile.ts"],"sourcesContent":["import { getHostPath } from './getHostPath';\nimport { isSafari } from './isSafari';\nimport { sleep } from './sleep';\n\ntype DownloadLinkOptions = {\n  href: string;\n  download: string;\n};\n\nfunction appendAndClickDownloadLink(\n  target: Window,\n  { href, download }: DownloadLinkOptions,\n) {\n  const link = target.document.createElement('a');\n  link.href = href;\n  // that custom file name only support with same site origin\n  link.download = download;\n\n  target.document.body.appendChild(link); // required for firefox\n\n  link.dispatchEvent(new MouseEvent('click', { bubbles: false }));\n\n  return link;\n}\n\n/**\n * create browser download event\n *\n * ! Safari not support download a href, always open by window.open _self\n */\nexport const downloadFile = (url: string, filename: string) => {\n  if (isSafari()) {\n    return global.window.open(url, '_self');\n  }\n\n  const link = appendAndClickDownloadLink(global.window, {\n    href: url,\n    download: filename,\n  });\n\n  link.remove();\n};\n\n/**\n * with iframe mechanism\n * let you download multiple files in one browser tab.\n *\n * ! Safari not support download a href, always open by window.open _self\n */\nexport const downloadFileWithIframe = (\n  url: string,\n  filename: string,\n  /**\n   * server response time must in side this value\n   *\n   * if that server not start download stream in 20s, that event will be cancelled.\n   *\n   * @default 20000ms => 20s\n   */\n  serverResponseTime = 20 * 1000,\n) => {\n  if (isSafari()) {\n    return global.window.open(url, '_self');\n  }\n\n  const iframe = document.createElement('iframe');\n  iframe.style.display = 'none';\n\n  document.body.appendChild(iframe);\n\n  iframe.addEventListener('load', () => {\n    appendAndClickDownloadLink(iframe.contentWindow!, {\n      href: url,\n      download: filename,\n    });\n  });\n\n  iframe.src = 'about:blank';\n\n  // TODO: there is an only way to remove that download iframe, but need backend support\n  // https://stackoverflow.com/a/4168965/7720164\n  // remove that download iframe after 20s,\n  // that download event will be keep in main tab.\n  // sever response download stream event inside 20s can make this download work.\n\n  // const id = encodeURIComponent(url);\n  // const prevIframe = document.getElementById(id);\n\n  // if (prevIframe) {\n  //   // eslint-disable-next-line no-console\n  //   console.log('continue previous download event');\n  //   // continue previous download event\n  //   return;\n  // }\n  // iframe.id = id;\n  const sleepPromise = sleep(serverResponseTime);\n\n  sleepPromise\n    .catch(() => {\n      // ignore cancel error\n    })\n    .finally(() => {\n      iframe.remove();\n    });\n  return sleepPromise;\n};\n\n/**\n * same function with downloadFileWithIframe, but use postMessage method to avoid the same origin policy\n *\n * ! must enable that `includeHiddenDownloadPage` in your project.config.json\n *\n * avoid the error:\n * Uncaught SecurityError: Failed to read a named property 'document' from 'Window': Blocked a frame with origin \"\n */\nexport const downloadFileWithIframeCors = (\n  url: string,\n  filename: string,\n  /**\n   * server response time must in side this value\n   *\n   * if that server not start download stream in 20s, that event will be cancelled.\n   *\n   * @default 20000ms => 20s\n   */\n  serverResponseTime = 20 * 1000,\n) => {\n  if (isSafari()) {\n    return global.window.open(url, '_self');\n  }\n\n  const iframe = document.createElement('iframe');\n  iframe.style.display = 'none';\n\n  document.body.appendChild(iframe);\n\n  iframe.addEventListener('load', () => {\n    iframe.contentWindow?.postMessage({\n      key: 'ɵɵ.rc-download',\n      url,\n      filename,\n    });\n  });\n  const hostUrl = getHostPath();\n\n  iframe.src = hostUrl + 'hidden-download.html';\n\n  const sleepPromise = sleep(serverResponseTime);\n\n  sleepPromise\n    .catch(() => {\n      // ignore cancel error\n    })\n    .finally(() => {\n      iframe.remove();\n    });\n  return sleepPromise;\n};\n"],"mappings":"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","ignoreList":[]}
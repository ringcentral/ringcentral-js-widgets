{"version":3,"file":"downloadFile.js","names":["_isSafari","require","_sleep","appendAndClickDownloadLink","target","_ref","href","download","link","document","createElement","body","appendChild","dispatchEvent","MouseEvent","bubbles","downloadFile","url","filename","isSafari","global","window","open","remove","exports","downloadFileWithIframe","serverResponseTime","arguments","length","undefined","iframe","style","display","addEventListener","contentWindow","src","sleepPromise","sleep","error"],"sources":["src/utils/downloadFile.ts"],"sourcesContent":["import { isSafari } from './isSafari';\nimport { sleep, SleepPromise } from './sleep';\n\ntype DownloadLinkOptions = {\n  href: string;\n  download: string;\n};\n\nfunction appendAndClickDownloadLink(\n  target: Window,\n  { href, download }: DownloadLinkOptions,\n) {\n  const link = target.document.createElement('a');\n  link.href = href;\n  // that custom file name only support with same site origin\n  link.download = download;\n\n  target.document.body.appendChild(link); // required for firefox\n\n  link.dispatchEvent(new MouseEvent('click', { bubbles: false }));\n\n  return link;\n}\n\n/**\n * create browser download event\n *\n * ! Safari not support download a href, always open by window.open _self\n */\nexport const downloadFile = (url: string, filename: string) => {\n  if (isSafari()) {\n    return global.window.open(url, '_self');\n  }\n\n  const link = appendAndClickDownloadLink(global.window, {\n    href: url,\n    download: filename,\n  });\n\n  link.remove();\n};\n\n/**\n * with iframe mechanism\n * let you download multiple files in one browser tab.\n *\n * ! Safari not support download a href, always open by window.open _self\n */\nexport const downloadFileWithIframe = (\n  url: string,\n  filename: string,\n  /**\n   * server response time must in side this value\n   *\n   * if that server not start download stream in 20s, that event will be cancelled.\n   *\n   * @default 20000ms => 20s\n   */\n  serverResponseTime = 20 * 1000,\n) => {\n  if (isSafari()) {\n    return global.window.open(url, '_self');\n  }\n\n  const iframe = document.createElement('iframe');\n  iframe.style.display = 'none';\n\n  document.body.appendChild(iframe);\n\n  iframe.addEventListener('load', () => {\n    appendAndClickDownloadLink(iframe.contentWindow!, {\n      href: url,\n      download: filename,\n    });\n  });\n\n  iframe.src = 'about:blank';\n\n  // TODO: there is an only way to remove that download iframe, but need backend support\n  // https://stackoverflow.com/a/4168965/7720164\n  // remove that download iframe after 20s,\n  // that download event will be keep in main tab.\n  // sever response download stream event inside 20s can make this download work.\n\n  // const id = encodeURIComponent(url);\n  // const prevIframe = document.getElementById(id);\n\n  // if (prevIframe) {\n  //   // eslint-disable-next-line no-console\n  //   console.log('continue previous download event');\n  //   // continue previous download event\n  //   return;\n  // }\n  // iframe.id = id;\n\n  let sleepPromise!: SleepPromise;\n\n  try {\n    sleepPromise = sleep(serverResponseTime);\n\n    sleepPromise.finally(() => {\n      iframe.remove();\n    });\n  } catch (error) {\n    //\n  }\n\n  return sleepPromise;\n};\n"],"mappings":";;;;;;;;;AAAA,IAAAA,SAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AAOA,SAASE,0BAA0BA,CACjCC,MAAc,EAAAC,IAAA,EAEd;EAAA,IADEC,IAAI,GAAAD,IAAA,CAAJC,IAAI;IAAEC,QAAQ,GAAAF,IAAA,CAARE,QAAQ;EAEhB,IAAMC,IAAI,GAAGJ,MAAM,CAACK,QAAQ,CAACC,aAAa,CAAC,GAAG,CAAC;EAC/CF,IAAI,CAACF,IAAI,GAAGA,IAAI;EAChB;EACAE,IAAI,CAACD,QAAQ,GAAGA,QAAQ;EAExBH,MAAM,CAACK,QAAQ,CAACE,IAAI,CAACC,WAAW,CAACJ,IAAI,CAAC,CAAC,CAAC;;EAExCA,IAAI,CAACK,aAAa,CAAC,IAAIC,UAAU,CAAC,OAAO,EAAE;IAAEC,OAAO,EAAE;EAAM,CAAC,CAAC,CAAC;EAE/D,OAAOP,IAAI;AACb;;AAEA;AACA;AACA;AACA;AACA;AACO,IAAMQ,YAAY,GAAG,SAAfA,YAAYA,CAAIC,GAAW,EAAEC,QAAgB,EAAK;EAC7D,IAAI,IAAAC,kBAAQ,EAAC,CAAC,EAAE;IACd,OAAOC,MAAM,CAACC,MAAM,CAACC,IAAI,CAACL,GAAG,EAAE,OAAO,CAAC;EACzC;EAEA,IAAMT,IAAI,GAAGL,0BAA0B,CAACiB,MAAM,CAACC,MAAM,EAAE;IACrDf,IAAI,EAAEW,GAAG;IACTV,QAAQ,EAAEW;EACZ,CAAC,CAAC;EAEFV,IAAI,CAACe,MAAM,CAAC,CAAC;AACf,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AALAC,OAAA,CAAAR,YAAA,GAAAA,YAAA;AAMO,IAAMS,sBAAsB,GAAG,SAAzBA,sBAAsBA,CACjCR,GAAW,EACXC,QAAgB,EASb;EAAA,IADHQ,kBAAkB,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,EAAE,GAAG,IAAI;EAE9B,IAAI,IAAAR,kBAAQ,EAAC,CAAC,EAAE;IACd,OAAOC,MAAM,CAACC,MAAM,CAACC,IAAI,CAACL,GAAG,EAAE,OAAO,CAAC;EACzC;EAEA,IAAMa,MAAM,GAAGrB,QAAQ,CAACC,aAAa,CAAC,QAAQ,CAAC;EAC/CoB,MAAM,CAACC,KAAK,CAACC,OAAO,GAAG,MAAM;EAE7BvB,QAAQ,CAACE,IAAI,CAACC,WAAW,CAACkB,MAAM,CAAC;EAEjCA,MAAM,CAACG,gBAAgB,CAAC,MAAM,EAAE,YAAM;IACpC9B,0BAA0B,CAAC2B,MAAM,CAACI,aAAa,EAAG;MAChD5B,IAAI,EAAEW,GAAG;MACTV,QAAQ,EAAEW;IACZ,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFY,MAAM,CAACK,GAAG,GAAG,aAAa;;EAE1B;EACA;EACA;EACA;EACA;;EAEA;EACA;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;;EAEA,IAAIC,YAA2B;EAE/B,IAAI;IACFA,YAAY,GAAG,IAAAC,YAAK,EAACX,kBAAkB,CAAC;IAExCU,YAAY,WAAQ,CAAC,YAAM;MACzBN,MAAM,CAACP,MAAM,CAAC,CAAC;IACjB,CAAC,CAAC;EACJ,CAAC,CAAC,OAAOe,KAAK,EAAE;IACd;EAAA;EAGF,OAAOF,YAAY;AACrB,CAAC;AAACZ,OAAA,CAAAC,sBAAA,GAAAA,sBAAA"}
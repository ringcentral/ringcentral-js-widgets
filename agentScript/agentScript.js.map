{"version":3,"file":"agentScript.js","names":["_SingleTabBroadcastChannel","require","_events","_enums","_typeof","o","Symbol","iterator","constructor","prototype","asyncGeneratorStep","n","t","e","r","a","c","i","u","value","done","Promise","resolve","then","_asyncToGenerator","arguments","apply","_next","_throw","_classCallCheck","TypeError","_defineProperties","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","_toPrimitive","toPrimitive","call","String","Number","AgentScriptApp","_this","_channel","eventEmitter","EventEmitter","toAngularKey","fromAngularKey","eventKeys","updateScript","agentScriptEvents","INIT","setScriptResult","SET_SCRIPT_RESULT","updateDisposition","UPDATE_DISPOSITION","getKnowledgeBaseArticles","GET_KNOWLEDGE_BASE_ARTICLES","bindAngularEventAndSend","bindAngularEvent","_ref","regeneratorRuntime","mark","_callee","knowledgeBaseArticles","wrap","_callee$","_context","prev","next","request","sent","sendToAngular","stop","_x","_init","_callee2","_callee2$","_context2","SingleTabBroadcastChannel","EV_AGENT_SCRIPT_BROADCAST_KEY","from","EV_AGENT_SCRIPT_PAGE_KEY","to","EV_APP_PAGE_KEY","onTabIdExist","t0","config","_bindBroadCastEvent","init","_this2","addEventListener","_ref2","data","keys","_this3","forEach","on","send","cb","emit","window","app"],"sources":["agentScript/agentScript.ts"],"sourcesContent":["import { SingleTabBroadcastChannel } from '@ringcentral-integration/commons/lib/SingleTabBroadcastChannel';\nimport { EventEmitter } from 'events';\n\nimport {\n  agentScriptEvents,\n  EV_AGENT_SCRIPT_BROADCAST_KEY,\n  EV_AGENT_SCRIPT_PAGE_KEY,\n  EV_APP_PAGE_KEY,\n} from '../enums';\n\nclass AgentScriptApp {\n  private _channel: SingleTabBroadcastChannel;\n  eventEmitter = new EventEmitter();\n\n  toAngularKey = 'to_angular';\n  fromAngularKey = 'from_angular';\n\n  eventKeys = {\n    updateScript: agentScriptEvents.INIT,\n    setScriptResult: agentScriptEvents.SET_SCRIPT_RESULT,\n    updateDisposition: agentScriptEvents.UPDATE_DISPOSITION,\n    getKnowledgeBaseArticles: agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES,\n  };\n\n  constructor() {\n    this.bindAngularEventAndSend([\n      this.eventKeys.setScriptResult,\n      this.eventKeys.updateDisposition,\n    ]);\n\n    this.bindAngularEvent(\n      this.eventKeys.getKnowledgeBaseArticles,\n      async (value: any) => {\n        const knowledgeBaseArticles = await this._channel.request({\n          key: agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES,\n          value,\n        });\n\n        this.sendToAngular(\n          this.eventKeys.getKnowledgeBaseArticles,\n          knowledgeBaseArticles,\n        );\n      },\n    );\n  }\n\n  // that init method call from angular.\n  async init() {\n    this._channel = await new SingleTabBroadcastChannel(\n      EV_AGENT_SCRIPT_BROADCAST_KEY,\n      {\n        from: EV_AGENT_SCRIPT_PAGE_KEY,\n        to: EV_APP_PAGE_KEY,\n      },\n    ).onTabIdExist();\n\n    const value = (await this._channel.request({\n      key: agentScriptEvents.INIT,\n    })) || {\n      config: null,\n      call: null,\n    };\n\n    this.sendToAngular(this.eventKeys.updateScript, value);\n\n    this._bindBroadCastEvent();\n  }\n\n  private _bindBroadCastEvent() {\n    this._channel.addEventListener(({ data }) => {\n      const { key, value } = data;\n      switch (key) {\n        case agentScriptEvents.INIT:\n          this.sendToAngular(this.eventKeys.updateScript, value);\n          break;\n        default:\n          break;\n      }\n    });\n  }\n\n  bindAngularEventAndSend(keys: string[]) {\n    keys.forEach((key) => {\n      this.eventEmitter.on(this.fromAngularKey + key, (value) =>\n        this._channel.send({ key, value }),\n      );\n    });\n    return this;\n  }\n\n  bindAngularEvent(key: string, cb: (...args: any[]) => void) {\n    this.eventEmitter.on(this.fromAngularKey + key, cb);\n    return this;\n  }\n\n  sendToAngular(key: string, value: any) {\n    this.eventEmitter.emit(this.toAngularKey + key, value);\n  }\n}\n\n// Here just assertion as any, that only for using in angular.\n(window as any).app = new AgentScriptApp();\n"],"mappings":"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","ignoreList":[]}
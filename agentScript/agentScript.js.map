{"version":3,"file":"agentScript.js","names":["_events","require","_SingleTabBroadcastChannel","_enums","_typeof","obj","Symbol","iterator","constructor","prototype","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","self","args","arguments","apply","err","undefined","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","_createClass","protoProps","staticProps","_toPrimitive","String","input","hint","prim","toPrimitive","res","call","Number","AgentScriptApp","_this","_channel","eventEmitter","EventEmitter","toAngularKey","fromAngularKey","eventKeys","updateScript","agentScriptEvents","INIT","setScriptResult","SET_SCRIPT_RESULT","updateDisposition","UPDATE_DISPOSITION","getKnowledgeBaseArticles","GET_KNOWLEDGE_BASE_ARTICLES","bindAngularEventAndSend","bindAngularEvent","_ref","regeneratorRuntime","mark","_callee","knowledgeBaseArticles","wrap","_callee$","_context","prev","next","request","sent","sendToAngular","stop","_x","_init","_callee2","_callee2$","_context2","SingleTabBroadcastChannel","EV_AGENT_SCRIPT_BROADCAST_KEY","from","EV_AGENT_SCRIPT_PAGE_KEY","to","EV_APP_PAGE_KEY","onTabIdExist","t0","config","_bindBroadCastEvent","init","_this2","addEventListener","_ref2","data","keys","_this3","forEach","on","send","cb","emit","window","app"],"sources":["agentScript/agentScript.ts"],"sourcesContent":["import { EventEmitter } from 'events';\n\nimport { SingleTabBroadcastChannel } from '@ringcentral-integration/commons/lib/SingleTabBroadcastChannel';\n\nimport {\n  agentScriptEvents,\n  EV_AGENT_SCRIPT_BROADCAST_KEY,\n  EV_AGENT_SCRIPT_PAGE_KEY,\n  EV_APP_PAGE_KEY,\n} from '../enums';\n\nclass AgentScriptApp {\n  private _channel: SingleTabBroadcastChannel;\n  eventEmitter = new EventEmitter();\n\n  toAngularKey = 'to_angular';\n  fromAngularKey = 'from_angular';\n\n  eventKeys = {\n    updateScript: agentScriptEvents.INIT,\n    setScriptResult: agentScriptEvents.SET_SCRIPT_RESULT,\n    updateDisposition: agentScriptEvents.UPDATE_DISPOSITION,\n    getKnowledgeBaseArticles: agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES,\n  };\n\n  constructor() {\n    this.bindAngularEventAndSend([\n      this.eventKeys.setScriptResult,\n      this.eventKeys.updateDisposition,\n    ]);\n\n    this.bindAngularEvent(\n      this.eventKeys.getKnowledgeBaseArticles,\n      async (value: any) => {\n        const knowledgeBaseArticles = await this._channel.request({\n          key: agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES,\n          value,\n        });\n\n        this.sendToAngular(\n          this.eventKeys.getKnowledgeBaseArticles,\n          knowledgeBaseArticles,\n        );\n      },\n    );\n  }\n\n  // that init method call from angular.\n  async init() {\n    this._channel = await new SingleTabBroadcastChannel(\n      EV_AGENT_SCRIPT_BROADCAST_KEY,\n      {\n        from: EV_AGENT_SCRIPT_PAGE_KEY,\n        to: EV_APP_PAGE_KEY,\n      },\n    ).onTabIdExist();\n\n    const value = (await this._channel.request({\n      key: agentScriptEvents.INIT,\n    })) || {\n      config: null,\n      call: null,\n    };\n\n    this.sendToAngular(this.eventKeys.updateScript, value);\n\n    this._bindBroadCastEvent();\n  }\n\n  private _bindBroadCastEvent() {\n    this._channel.addEventListener(({ data }) => {\n      const { key, value } = data;\n      switch (key) {\n        case agentScriptEvents.INIT:\n          this.sendToAngular(this.eventKeys.updateScript, value);\n          break;\n        default:\n          break;\n      }\n    });\n  }\n\n  bindAngularEventAndSend(keys: string[]) {\n    keys.forEach((key) => {\n      this.eventEmitter.on(this.fromAngularKey + key, (value) =>\n        this._channel.send({ key, value }),\n      );\n    });\n    return this;\n  }\n\n  bindAngularEvent(key: string, cb: (...args: any[]) => void) {\n    this.eventEmitter.on(this.fromAngularKey + key, cb);\n    return this;\n  }\n\n  sendToAngular(key: string, value: any) {\n    this.eventEmitter.emit(this.toAngularKey + key, value);\n  }\n}\n\n// Here just assertion as any, that only for using in angular.\n(window as any).app = new AgentScriptApp();\n"],"mappings":"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"}
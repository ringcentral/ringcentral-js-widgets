<!DOCTYPE html>
<html>
<head>
    <title>Conversation</title>
    <link rel="stylesheet" type="text/css" href="../build/styles/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<div id='container'></div>
<body>
<script src="../bower_components/ringcentral/build/ringcentral-bundle.js"></script>
<script src="../bower_components/ringcentral-web-phone/build/ringcentral-web-phone.js"></script>
<!-- <script src='../node_modules/lz-string/libs/lz-string.min.js'></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
<script src='../build/widgets.js'></script>
<script src="../build/build.js"></script>
<script>
// w.config({
//     path: '../template/',
//     preload: {
//         'messages': 'messages',
//         'conversation': 'conversation-advanced',
//         'contacts': 'contacts',
//         'auth-panel': 'auth-panel',
//         'time-line': 'time-line',
//     },
//     locale: {
//         'zh-tw': 'zh-tw.json',
//         'en-us': 'en-us.json'
//     }
// }, init)
var rcMessageService = w.service()['rcMessageService']
var rcMessageProvider = w.service()['rcMessageProvider']
var accountService = w.service()['accountService']
var loginService = w.service()['loginService']
var rcContactSearchProvider = w.service()['rcContactSearchProvider']
var rcContactService = w.service()['rcContactService']
var callLogService = w.service()['callLogService']
var conversationService = w.service()['conversationService']
var dialPadSearchProviders = [rcContactSearchProvider]
init()
function init() {
    var authPanel = w('auth-panel', {
        actions: {
            login: {
                method: function() {
                    return loginService.login(
                        this.props.username,
                        this.props.extension,
                        this.props.password
                    )
                },
                after: function() {
                    this.unmount()
                    // conversation.mount('#container')
                    // messageWidget.mount('#container')
                    // contacts.mount('#container')
                    timeline.mount('#container')
                }
            }
        }
    })

    var timeline = w('time-line', {
        actions: {
            init: {
                after: function() {
                    rcMessageService.subscribeToMessageUpdate()
                    rcMessageProvider.onMessageUpdated(msg => {
                        this.updateTimeline(conversationService.syncContent(this.props.contacts, msg))
                        if (this.props.currentConv) {
                            this.props.currentConv.confirmMessages()
                            this.props.currentConv.addIncomingMessages()
                        }
                    })
                }
            },
            mount: {
                after: function() {
                    return cacheContacts().then(contacts => this.props.contacts = contacts)
                }
            },
            fetchData: {
                method: function() {
                    return Promise.all([
                        cacheContacts(), // first one must be the contacts
                        rcMessageService.syncMessages(conversationService.cachedHour),
                        callLogService.getCallLogs(),
                    ]).then(result => conversationService.organizeContent(...result))
                }
            },
            focusSearchBox: {
                after: function() {
                    contacts.mount(this.props.dom.mask)
                    this.props.dom.mask.classList.remove('display-none')
                    this.props.dom.timeline.classList.add('display-none')
                }
            },
            blurSearchBox: {
                after: function() {
                    setTimeout(() => {
                        contacts.unmount()
                        this.props.dom.mask.classList.add('display-none')
                        this.props.dom.timeline.classList.remove('display-none')
                    }, 100)
                }
            },
            search: {
                method: function() {
                    contacts.props.dom.searchText.value = this.props.dom.searchText.value 
                    contacts.search()
                }
            },
            enterItem: {
                after: function() {
                    this.unmount()
                    var contact = this.props.selectedContent.contact
                    var fromNumber = contact.msg[0].direction === 'Outbound'? contact.msg[0].from: contact.msg[0].to
                    var toNumber = contact.msg[0].direction === 'Outbound'? contact.msg[0].to: contact.msg[0].from
                    this.props.currentConv = conv(contact, () => {
                        this.mount('#container')
                    }, {
                        fromNumber,
                        toNumber,
                        anchorContent: this.props.selectedContent
                    })
                    this.props.currentConv.mount('#container')
                }
            }
        }
    })

    var contacts = w('contacts', {
        data: {
            searchBox: false
        },
        actions: {
            init: {
                after: function() {}
            },
            mount: {
                after: function() {
                    
                }
            },
            fetchRelatedContact: {
                method: function() {
                    return Promise.all([
                        rcMessageService.syncMessages(conversationService.cachedHour),
                        callLogService.getCallLogs(),
                        cacheContacts()
                    ]).then(result => {
                        var [msgs, logs, contacts] = result
                        this.props.contacts = contacts.reduce((result, contact) => {
                            result[contact.id] = contact
                            return result
                        }, {})
                        return conversationService.getConversations(contacts, msgs, logs)
                    }).then(relateContacts => {
                        this.props.relateContacts = relateContacts
                        return relateContacts
                    }).then(relateContacts => 
                        Object.keys(relateContacts).map(index => {
                            // adapt to messages template format
                            relateContacts[index].msg[0].contact = relateContacts[index].displayName
                            // for conversation-advance temaplate
                            relateContacts[index].msg[0].contactId = index
                            return relateContacts[index].msg[0]
                        })
                    )
                }
            },
            fetchContacts: {
                method: function() {
                    // var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                    //     return provider.searchAll();
                    // });
                    // return contactSearchService.query(dialPadSearchFunctions);
                    return cacheContacts().then(contacts => {
                        this.props.contacts = contacts.reduce((result, contact) => {
                            result[contact.id] = contact
                            return result
                        }, {})
                        return contacts.map(contact => {
                            return {
                                name: contact.displayName,
                                type: 'rc',
                                id: contact.id,
                            }
                        });
                    }).catch(e => console.error(e))
                }
            },
            selectContact: {
                method: function() {
                    this.unmount()
                    timeline.unmount()
                    var contact = 
                        (this.props.relateContacts && 
                        this.props.relateContacts[this.props.selectedContact.id]) ||
                        this.props.contacts[this.props.selectedContact.id]
                    var conversation = timeline.props.currentConv = conv(contact, () => {
                        timeline.mount('#container')
                    })
                    conversation.mount('#container')
                }
            },
            focus: {
                after: function() {
                    console.log('focus');
                }
            }
        }
    });
    
    authPanel.mount('#container')
}
var cacheContacts = (function() {
    var contact = null
    var data = localStorage.getItem('rc-contacts')
    var fetch
    // FIXME: temp disable it
    
    var fetch = new Promise((resolve, reject) => {
      // Hack for delay the refreshing request
      setTimeout(() => {
        rcContactService.completeCompanyContact()
        .then(data => {
            if (data)
                localStorage.setItem('rc-contacts', LZString.compressToUTF16(JSON.stringify(data)))
            return resolve(data)
        })
      }, 100)
    })
    var fetch = rcContactService.completeCompanyContact().then(data => {
                    if (data)
                        localStorage.setItem('rc-contacts', LZString.compressToUTF16(JSON.stringify(data)))
                    return data
                })
    return function() {
        if (contact)
            return contact
        contact = data? Promise.resolve(JSON.parse(LZString.decompressFromUTF16(data))): fetch
        return contact
    }
})()


function conv(contact, afterBack, options = {}) {
    return w('conversation-advanced', {
        data: {
            new: true,
            contact: contact,
            fromNumber: options.fromNumber,
            toNumber: options.toNumber,
            anchorContent: options.anchorContent
        },
        actions: {
            init: {
                after: function() {
                    this.props.hourOffset = 3 * 24
                    
                }
            },
            mount: {
                after: function() {
                    return accountService.getAccountInfo()
                            .then(info => this.props.fromExtension = info.extensionNumber)
                            .then(this.getOutboundCallerID)
                }
            },
            send: {
                method: function() {
                    if (this.props.toNumber === this.props.toExtension) {
                        return rcMessageService.sendPagerMessage(
                            this.props.message,
                            this.props.fromExtension,
                            this.props.toExtension
                        );
                    }
                    else {
                        return rcMessageService.sendSMSMessage(
                            this.props.message,
                            this.props.fromNumber,
                            this.props.toNumber
                        );
                    }
                }
            },
            queryContacts: {
                method: function() {
                    var dialPadSearchFunctions = dialPadSearchProviders.map(provider => {
                        return provider.search(this.props.to);
                    });
                    return contactSearchService.query(dialPadSearchFunctions);
                }
            },
            getOutboundCallerID: {
                method: function() {
                    return accountService.getPhoneNumber().then(() => 
                        accountService.listNumber("VoiceFax", 'SmsSender'));
                }
            },
            reachTop: {
                method: function() {
                    return conversationService.loadContent(this.props.contact, this.props.hourOffset)
                }
            },
            back: {
                after: function() {
                    this.unmount()
                    if (afterBack && typeof afterBack === 'function')
                        afterBack()
                }
            }
        }
    });
    conversation.mount('#container')
}
</script>
</body>
</html>

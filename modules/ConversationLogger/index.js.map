{"version":3,"sources":["modules/ConversationLogger/index.js"],"names":["getLogId","conversationId","date","conversationLogIdentityFunction","conversation","conversationLogId","ConversationLogger","deps","dep","optional","auth","contactMatcher","conversationMatcher","dateTimeFormat","extensionInfo","messageStore","appFeatures","storage","tabManager","isLoggedContact","isAutoUpdate","formatDateTime","accordWithLogRequirement","options","name","actionTypes","identityFunction","_auth","ensureExist","call","_contactMatcher","_conversationMatcher","_dateTimeFormat","_extensionInfo","_messageStore","_appFeatures","_storage","_tabManager","_isLoggedContact","_formatDateTime","_isAutoUpdate","_accordWithLogRequirement","_storageKey","_name","onMessageUpdated","record","_processConversationLogMap","registerReducer","key","reducer","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","conversationLogIds","_autoLogQueue","_autoLogPromise","pending","_readyCheckFunction","_lastProcessedConversations","_lastAutoLog","ownerId","Promise","all","splice","map","_processConversationLog","length","_processQueue","push","correspondents","reduce","result","contact","number","phoneNumber","extensionNumber","dataMapping","concat","conversationLog","conversationLogMap","lastRecord","Object","keys","sort","sortByDate","find","item","conversationLogMatches","lastActivity","correspondentMatches","_getCorrespondentMatches","match","queries","_autoLogConversation","autoLog","type","messageTypes","sms","addIfNotExist","numberMap","numbers","self","forEach","selfNumber","selfMatches","selfEntity","correspondentEntity","getLastMatchedCorrespondentEntity","triggerMatch","oldMap","active","messages","id","accordWithProcessLogRequirement","_queueAutoLogConversation","log","redirect","idx","queueIndex","findIndex","store","dispatch","setAutoLog","message","utcTimestamp","creationTime","hasReadTextPermission","getItem","LoggerBase","proxify","selector","conversationStore","conversationLogMapping","values","allMessages","mapping","slice","logIds","output"],"mappings":"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","sourcesContent":["import messageTypes from '../../enums/messageTypes';\nimport { Module } from '../../lib/di';\nimport ensureExist from '../../lib/ensureExist';\nimport LoggerBase from '../../lib/LoggerBase';\nimport { getNumbersFromMessage, sortByDate } from '../../lib/messageHelper';\nimport proxify from '../../lib/proxy/proxify';\nimport { selector } from '../../lib/selector';\nimport sleep from '../../lib/sleep';\nimport { actionTypes } from './actionTypes';\nimport getDataReducer from './getDataReducer';\n\nexport function getLogId({ conversationId, date }) {\n  return `${conversationId}/${date}`;\n}\n\nexport function conversationLogIdentityFunction(conversation) {\n  return conversation.conversationLogId;\n}\n\n/**\n * @class\n * @description Conversation logger module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Storage',\n    { dep: 'TabManager', optional: true },\n    'ContactMatcher',\n    'ConversationMatcher',\n    'DateTimeFormat',\n    'ExtensionInfo',\n    'MessageStore',\n    'AppFeatures',\n    { dep: 'ConversationLoggerOptions', optional: false },\n  ],\n})\nexport default class ConversationLogger extends LoggerBase {\n  constructor({\n    auth,\n    contactMatcher,\n    conversationMatcher,\n    dateTimeFormat,\n    extensionInfo,\n    messageStore,\n    appFeatures,\n    storage,\n    tabManager,\n    isLoggedContact = () => false,\n    isAutoUpdate = true,\n    formatDateTime = (...args) => dateTimeFormat.formatDateTime(...args),\n    accordWithLogRequirement,\n    ...options\n  }) {\n    super({\n      ...options,\n      name: 'conversationLogger',\n      actionTypes,\n      identityFunction: conversationLogIdentityFunction,\n    });\n    this._auth = ensureExist.call(this, auth, 'auth');\n    this._contactMatcher = ensureExist.call(\n      this,\n      contactMatcher,\n      'contactMatcher',\n    );\n    this._conversationMatcher = ensureExist.call(\n      this,\n      conversationMatcher,\n      'conversationMatcher',\n    );\n    this._dateTimeFormat = ensureExist.call(\n      this,\n      dateTimeFormat,\n      'dateTimeFormat',\n    );\n    this._extensionInfo = ensureExist.call(\n      this,\n      extensionInfo,\n      'extensionInfo',\n    );\n    this._messageStore = ensureExist.call(this, messageStore, 'messageStore');\n    this._appFeatures = appFeatures;\n    this._storage = ensureExist.call(this, storage, 'storage');\n    this._tabManager = tabManager;\n    this._isLoggedContact = isLoggedContact;\n    this._formatDateTime = formatDateTime;\n    this._isAutoUpdate = isAutoUpdate;\n    this._accordWithLogRequirement = accordWithLogRequirement;\n    this._storageKey = `${this._name}Data`;\n    this._messageStore.onMessageUpdated((record) => {\n      this._processConversationLogMap(record);\n    });\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: getDataReducer(this.actionTypes),\n    });\n\n    this._contactMatcher.addQuerySource({\n      getQueriesFn: () => this.uniqueNumbers,\n      readyCheckFn: () => this._messageStore.ready && this._extensionInfo.ready,\n    });\n    this._conversationMatcher.addQuerySource({\n      getQueriesFn: () => this.conversationLogIds,\n      readyCheckFn: () => this._messageStore.ready && this._extensionInfo.ready,\n    });\n\n    this._autoLogQueue = [];\n    this._autoLogPromise = null;\n  }\n\n  _shouldInit() {\n    return (\n      this.pending &&\n      this._contactMatcher.ready &&\n      this._conversationMatcher.ready &&\n      this._dateTimeFormat.ready &&\n      this._extensionInfo.ready &&\n      this._messageStore.ready &&\n      this._appFeatures.ready &&\n      this._storage.ready &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this._readyCheckFunction()\n    );\n  }\n\n  _shouldReset() {\n    return (\n      this.ready &&\n      (!this._contactMatcher.ready ||\n        !this._conversationMatcher.ready ||\n        !this._dateTimeFormat.ready ||\n        !this._extensionInfo.ready ||\n        !this._messageStore.ready ||\n        !this._appFeatures.ready ||\n        !this._storage.ready ||\n        (this._tabManager && !this._tabManager.ready) ||\n        !this._readyCheckFunction())\n    );\n  }\n\n  _onReset() {\n    this._lastProcessedConversations = null;\n    this._lastAutoLog = null;\n    this._autoLogPromise = null;\n    this._autoLogQueue = [];\n  }\n\n  async _processQueue() {\n    const { ownerId } = this._auth;\n    await sleep(300);\n    if (ownerId !== this._auth.ownerId) return;\n    await Promise.all(\n      this._autoLogQueue\n        .splice(0, 10)\n        .map((conversation) => this._processConversationLog({ conversation })),\n    );\n    if (ownerId === this._auth.ownerId && this._autoLogQueue.length > 0) {\n      this._autoLogPromise = this._processQueue();\n    } else {\n      this._autoLogPromise = null;\n    }\n  }\n\n  _queueAutoLogConversation({ conversation }) {\n    this._autoLogQueue.push(conversation);\n    if (!this._autoLogPromise) {\n      this._autoLogPromise = this._processQueue();\n    }\n  }\n\n  _getCorrespondentMatches(conversation) {\n    return (\n      (conversation.correspondents &&\n        conversation.correspondents.reduce((result, contact) => {\n          const number = contact.phoneNumber || contact.extensionNumber;\n          return number && this._contactMatcher.dataMapping[number]\n            ? result.concat(this._contactMatcher.dataMapping[number])\n            : result;\n        }, [])) ||\n      []\n    );\n  }\n\n  getLastMatchedCorrespondentEntity(conversation) {\n    const conversationLog = this.conversationLogMap[\n      conversation.conversationId\n    ];\n    if (!conversationLog) {\n      return null;\n    }\n    const lastRecord = Object.keys(conversationLog)\n      .map((date) => this.conversationLogMap[conversation.conversationId][date])\n      .sort(sortByDate)\n      .find((item) => item.conversationLogMatches.length > 0);\n    if (\n      lastRecord &&\n      this._conversationMatcher.dataMapping[lastRecord.conversationLogId] &&\n      this._conversationMatcher.dataMapping[lastRecord.conversationLogId].length\n    ) {\n      const lastActivity = this._conversationMatcher.dataMapping[\n        lastRecord.conversationLogId\n      ][0];\n      const correspondentMatches = this._getCorrespondentMatches(lastRecord);\n      return correspondentMatches.find((item) =>\n        this._isLoggedContact(conversation, lastActivity, item),\n      );\n    }\n    return null;\n  }\n\n  async _processConversationLog({ conversation }) {\n    // await this._conversationMatcher.triggerMatch();\n    await this._conversationMatcher.match({\n      queries: [conversation.conversationLogId],\n    });\n    if (\n      this._isAutoUpdate &&\n      this._conversationMatcher.dataMapping[conversation.conversationLogId] &&\n      this._conversationMatcher.dataMapping[conversation.conversationLogId]\n        .length\n    ) {\n      // update conversation\n      await this._autoLogConversation({\n        conversation,\n      });\n    } else if (this.autoLog && conversation.type === messageTypes.sms) {\n      // new entry\n      const numbers = [];\n      const numberMap = {};\n      /* eslint { \"no-inner-declarations\": 0 } */\n      function addIfNotExist(contact) {\n        const number = contact.phoneNumber || contact.extensionNumber;\n        if (number && !numberMap[number]) {\n          numbers.push(number);\n          numberMap[number] = true;\n        }\n      }\n      addIfNotExist(conversation.self);\n      conversation.correspondents.forEach(addIfNotExist);\n      await this._contactMatcher.match({ queries: numbers });\n      const selfNumber =\n        conversation.self &&\n        (conversation.self.phoneNumber || conversation.self.extensionNumber);\n      const selfMatches =\n        (selfNumber && this._contactMatcher.dataMapping[selfNumber]) || [];\n      const correspondentMatches = this._getCorrespondentMatches(conversation);\n\n      const selfEntity =\n        (selfMatches && selfMatches.length === 1 && selfMatches[0]) || null;\n\n      let correspondentEntity = this.getLastMatchedCorrespondentEntity(\n        conversation,\n      );\n\n      correspondentEntity =\n        correspondentEntity ||\n        (correspondentMatches &&\n          correspondentMatches.length === 1 &&\n          correspondentMatches[0]) ||\n        null;\n      await this._autoLogConversation({\n        conversation,\n        selfEntity,\n        correspondentEntity,\n      });\n    }\n  }\n\n  accordWithProcessLogRequirement(...rest) {\n    return (\n      !this._accordWithLogRequirement || this._accordWithLogRequirement(...rest)\n    );\n  }\n\n  _processConversationLogMap() {\n    if (this.ready && this._lastAutoLog !== this.autoLog) {\n      this._lastAutoLog = this.autoLog;\n      if (this.autoLog) {\n        // force conversation log checking when switch auto log to on\n        this._lastProcessedConversations = null;\n      }\n    }\n    if (\n      this.ready &&\n      this._lastProcessedConversations !== this.conversationLogMap\n    ) {\n      this._conversationMatcher.triggerMatch();\n      this._contactMatcher.triggerMatch();\n      const oldMap = this._lastProcessedConversations || {};\n      this._lastProcessedConversations = this.conversationLogMap;\n      if (!this._tabManager || this._tabManager.active) {\n        Object.keys(this._lastProcessedConversations).forEach(\n          (conversationId) => {\n            Object.keys(\n              this._lastProcessedConversations[conversationId],\n            ).forEach((date) => {\n              const conversation = this._lastProcessedConversations[\n                conversationId\n              ][date];\n              if (\n                !oldMap[conversationId] ||\n                !oldMap[conversationId][date] ||\n                conversation.messages[0].id !==\n                  oldMap[conversationId][date].messages[0].id\n              ) {\n                if (this.accordWithProcessLogRequirement(conversation)) {\n                  this._queueAutoLogConversation({\n                    conversation,\n                  });\n                }\n              }\n            });\n          },\n        );\n      }\n    }\n  }\n\n  async _autoLogConversation({\n    conversation,\n    selfEntity,\n    correspondentEntity,\n  }) {\n    await this.log({\n      conversation,\n      selfEntity,\n      correspondentEntity,\n    });\n  }\n\n  @proxify\n  async log({ conversation, ...options }) {\n    super.log({ item: conversation, ...options });\n  }\n\n  @proxify\n  async logConversation({\n    conversationId,\n    correspondentEntity,\n    redirect,\n    ...options\n  }) {\n    if (this.conversationLogMap[conversationId]) {\n      await Promise.all(\n        Object.keys(this.conversationLogMap[conversationId])\n          .map((date) => this.conversationLogMap[conversationId][date])\n          .sort(sortByDate)\n          .map((conversation, idx) => {\n            const queueIndex = this._autoLogQueue.findIndex(\n              (item) =>\n                item.conversationLogId === conversation.conversationLogId,\n            );\n            if (queueIndex > -1) {\n              this._autoLogQueue.splice(queueIndex, 1);\n            }\n            return this.log({\n              ...options,\n              conversation,\n              correspondentEntity,\n              redirect: redirect && idx === 0, // only direct on the first item\n            });\n          }),\n      );\n    }\n  }\n\n  get available() {\n    return this._appFeatures.hasReadTextPermission;\n  }\n\n  get autoLog() {\n    return this._storage.getItem(this._storageKey).autoLog;\n  }\n\n  @proxify\n  async setAutoLog(autoLog) {\n    if (this.ready && autoLog !== this.autoLog) {\n      this.store.dispatch({\n        type: this.actionTypes.setAutoLog,\n        autoLog,\n      });\n    }\n  }\n\n  @selector\n  conversationLogMap = [\n    () => this._messageStore.conversationStore,\n    () => this._extensionInfo.extensionNumber,\n    () => this._conversationMatcher.dataMapping,\n    (conversationStore, extensionNumber, conversationLogMapping = {}) => {\n      const messages = Object.values(conversationStore).reduce(\n        (allMessages, messages) => [...allMessages, ...messages],\n        [],\n      );\n      const mapping = {};\n      messages\n        .slice()\n        .sort(sortByDate)\n        .forEach((message) => {\n          const { conversationId } = message;\n          const date = this._formatDateTime({\n            type: 'date',\n            utcTimestamp: message.creationTime,\n          });\n          if (!mapping[conversationId]) {\n            mapping[conversationId] = {};\n          }\n          if (!mapping[conversationId][date]) {\n            const conversationLogId = getLogId({ conversationId, date });\n            mapping[conversationId][date] = {\n              conversationLogId,\n              conversationId,\n              creationTime: message.creationTime, // for sorting\n              date,\n              type: message.type,\n              messages: [],\n              conversationLogMatches:\n                conversationLogMapping[conversationLogId] || [],\n              ...getNumbersFromMessage({ extensionNumber, message }),\n            };\n          }\n          mapping[conversationId][date].messages.push(message);\n        });\n      return mapping;\n    },\n  ];\n\n  @selector\n  conversationLogIds = [\n    () => this.conversationLogMap,\n    (conversationLogMap) => {\n      const logIds = [];\n      Object.keys(conversationLogMap).forEach((conversationId) => {\n        Object.keys(conversationLogMap[conversationId]).forEach((date) => {\n          logIds.push(\n            conversationLogMap[conversationId][date].conversationLogId,\n          );\n        });\n      });\n      return logIds;\n    },\n  ];\n\n  @selector\n  uniqueNumbers = [\n    () => this.conversationLogMap,\n    (conversationLogMap) => {\n      const output = [];\n      const numberMap = {};\n      function addIfNotExist(contact = {}) {\n        const number = contact.phoneNumber || contact.extensionNumber;\n        if (number && !numberMap[number]) {\n          output.push(number);\n          numberMap[number] = true;\n        }\n      }\n      Object.keys(conversationLogMap).forEach((conversationId) => {\n        Object.keys(conversationLogMap[conversationId]).forEach((date) => {\n          const conversation = conversationLogMap[conversationId][date];\n          addIfNotExist(conversation.self);\n          conversation.correspondents.forEach(addIfNotExist);\n        });\n      });\n      return output;\n    },\n  ];\n\n  getConversationLogId(message) {\n    if (!message) {\n      return;\n    }\n    const { conversationId } = message;\n    const date = this._formatDateTime({\n      type: 'date',\n      utcTimestamp: message.creationTime,\n    });\n    return getLogId({\n      conversationId,\n      date,\n    });\n  }\n\n  get dataMapping() {\n    return this._conversationMatcher.dataMapping;\n  }\n}\n"],"file":"index.js"}
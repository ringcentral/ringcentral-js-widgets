{"version":3,"sources":["modules/Subscription/index.ts"],"names":["DEFAULT_TIME_TO_RETRY","Subscription","deps","dep","optional","auth","client","storage","timeToRetry","options","actionTypes","_auth","_client","_storage","_timeToRetry","_cacheStorageKey","_reducer","registerReducer","key","reducer","_resetPromise","_removePromise","_retryTimeoutId","_registerTimeoutId","store","subscribe","loginStatus","loggedIn","ready","status","moduleStatuses","pending","_startSleepDetection","dispatch","type","initSuccess","notLoggedIn","reset","addBeforeLogoutHandler","_stopSleepDetection","_detectSleep","_sleepTimeout","clearTimeout","t","Date","now","setTimeout","_subscription","console","log","renewPromise","automaticRenewing","resubscribeAtPubNub","sdk","service","subscriptions","Subscriptions","createSubscription","cachedSubscription","setSubscription","error","on","events","notification","message","removeSuccess","removeError","renewSuccess","subscription","renewError","removeAllListeners","_retry","subscribeSuccess","subscribeError","delay","normalizeEventFilter","eventFilters","sort","filters","setEventFilters","register","_createSubscription","_register","oldFilters","addFilters","concat","length","_subscribe","removeFilters","remove","_stopRetry","_remove","resetSuccess","_reset","state","subscriptionStatus","getItem","_pubnub","RcModule","proxify"],"mappings":"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","sourcesContent":["import { equals, map } from 'ramda';\n\nimport { Subscriptions } from '@ringcentral/subscriptions';\n\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport loginStatus from '../Auth/loginStatus';\nimport { actionTypes } from './actionTypes';\nimport getSubscriptionReducer, {\n  getCachedSubscriptionReducer,\n} from './getSubscriptionReducer';\nimport { normalizeEventFilter } from './normalizeEventFilter';\n\nconst DEFAULT_TIME_TO_RETRY = 20 * 1000;\n\n/**\n * @class\n * @description Subscription module to subscibe notification\n */\n@Module({\n  deps: [\n    'Auth',\n    'Client',\n    'Storage',\n    { dep: 'SubscriptionOptions', optional: true },\n  ],\n})\nexport default class Subscription extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Auth} params.auth - auth module instance\n   * @param {Client} params.client - client module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {Number} params.timeToRetry - time to retry, default 60 seconds\n   */\n  constructor({\n    auth,\n    client,\n    storage,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._client = client;\n    this._storage = storage;\n    this._timeToRetry = timeToRetry;\n    this._cacheStorageKey = 'cachedSubscription';\n    this._reducer = getSubscriptionReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._cacheStorageKey,\n      reducer: getCachedSubscriptionReducer(this.actionTypes),\n    });\n\n    this._resetPromise = null;\n    this._removePromise = null;\n    this._retryTimeoutId = null;\n    this._registerTimeoutId = null;\n  }\n\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        this._storage.ready &&\n        this.status === moduleStatuses.pending\n      ) {\n        this._startSleepDetection();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        (this._auth.loginStatus === loginStatus.notLoggedIn ||\n          !this._storage.ready) &&\n        this.ready\n      ) {\n        this.reset();\n      }\n    });\n    this._auth.addBeforeLogoutHandler(async () => {\n      if (this.ready) {\n        await this.reset();\n      }\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get filters() {\n    return this.state.filters;\n  }\n\n  get message() {\n    return this.state.message;\n  }\n\n  get subscriptionStatus() {\n    return this.state.subscriptionStatus;\n  }\n\n  get cachedSubscription() {\n    return this._storage.getItem(this._cacheStorageKey);\n  }\n\n  _startSleepDetection() {\n    this._stopSleepDetection();\n    this._detectSleep();\n  }\n\n  // TODO Use SleepDetector module after\n  _stopSleepDetection() {\n    if (this._sleepTimeout) {\n      clearTimeout(this._sleepTimeout);\n      this._sleepTimeout = null;\n    }\n  }\n\n  _detectSleep() {\n    const t = Date.now();\n    this._sleepTimeout = setTimeout(async () => {\n      // For chrome 88 timer-throttling https://developer.chrome.com/blog/timer-throttling-in-chrome-88/\n      // need to make sure time diff is more than 1 min\n      if (this.ready && this._subscription && Date.now() - t > 75 * 1000) {\n        console.log('==== Sleep Detected ====');\n        // to wait automatic renew finish\n        const renewPromise = this._subscription.automaticRenewing();\n        if (renewPromise) {\n          await renewPromise;\n        }\n        // this._subscription may be removed at renewError event\n        if (this._subscription) {\n          // forcibly reconnect pubnub to ensure pubnub is alive\n          await this._subscription.resubscribeAtPubNub();\n        }\n      }\n      this._detectSleep();\n    }, 20 * 1000);\n  }\n\n  _createSubscription() {\n    const sdk = this._client.service;\n    const subscriptions = new Subscriptions({ sdk });\n    this._subscription = subscriptions.createSubscription();\n    if (this.cachedSubscription) {\n      try {\n        this._subscription.setSubscription(this.cachedSubscription);\n      } catch (error) {\n        this._subscription = subscriptions.createSubscription();\n      }\n    }\n    this._subscription.on(this._subscription.events.notification, (message) => {\n      this.store.dispatch({\n        type: this.actionTypes.notification,\n        message,\n      });\n    });\n    this._subscription.on(this._subscription.events.removeSuccess, () => {\n      this.store.dispatch({\n        type: this.actionTypes.removeSuccess,\n      });\n    });\n    this._subscription.on(this._subscription.events.removeError, (error) => {\n      this.store.dispatch({\n        type: this.actionTypes.removeError,\n        error,\n      });\n    });\n    this._subscription.on(this._subscription.events.renewSuccess, () => {\n      if (this._subscription) {\n        this.store.dispatch({\n          type: this.actionTypes.renewSuccess,\n          subscription: this._subscription.subscription(),\n        });\n      }\n    });\n    this._subscription.on(this._subscription.events.renewError, (error) => {\n      if (this._subscription) {\n        this._subscription.reset();\n        this._subscription.removeAllListeners();\n        this._subscription = null;\n      }\n      this.store.dispatch({\n        type: this.actionTypes.renewError,\n        error,\n      });\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        this._storage.ready\n      ) {\n        // immediately start the retry process after the first renewError\n        this._retry(0);\n      }\n    });\n    this._subscription.on(this._subscription.events.subscribeSuccess, () => {\n      if (this._subscription) {\n        this.store.dispatch({\n          type: this.actionTypes.subscribeSuccess,\n          subscription: this._subscription.subscription(),\n        });\n      }\n    });\n    this._subscription.on(this._subscription.events.subscribeError, (error) => {\n      this.store.dispatch({\n        type: this.actionTypes.subscribeError,\n        error,\n      });\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        this._storage.ready\n      ) {\n        this._retry();\n      }\n    });\n  }\n\n  _register(delay = 2000) {\n    if (this._registerTimeoutId) {\n      clearTimeout(this._registerTimeoutId);\n    }\n    this._registerTimeoutId = setTimeout(() => {\n      this._registerTimeoutId = null;\n      this.store.dispatch({\n        type: this.actionTypes.subscribe,\n      });\n      if (\n        this._subscription &&\n        !equals(\n          map(normalizeEventFilter, this._subscription.eventFilters()).sort(),\n          map(normalizeEventFilter, this.filters).sort(),\n        )\n      ) {\n        this._subscription.setEventFilters(this.filters);\n        this._subscription.register();\n      }\n    }, delay);\n  }\n\n  _subscribe(delay) {\n    if (!this._subscription) {\n      this._createSubscription();\n    }\n    this._register(delay);\n  }\n\n  @proxify\n  async subscribe(events = [], delay = 2000) {\n    if (this.ready) {\n      const oldFilters = this.filters;\n      this.store.dispatch({\n        type: this.actionTypes.addFilters,\n        filters: [].concat(events),\n      });\n      if (oldFilters.length !== this.filters.length) {\n        await this._subscribe(delay);\n      }\n    }\n  }\n\n  @proxify\n  async unsubscribe(events = []) {\n    if (this.ready) {\n      const oldFilters = this.filters;\n      this.store.dispatch({\n        type: this.actionTypes.removeFilters,\n        filters: [].concat(events),\n      });\n      if (this.filters.length === 0) {\n        this.remove();\n      } else if (oldFilters.length !== this.filters.length) {\n        this._subscribe();\n      }\n    }\n  }\n\n  async _stopRetry() {\n    if (this._retryTimeoutId) {\n      clearTimeout(this._retryTimeoutId);\n      this._retryTimeoutId = null;\n    }\n  }\n\n  async _retry(t = this._timeToRetry) {\n    this._stopRetry();\n    this._retryTimeoutId = setTimeout(() => {\n      if (this.ready) {\n        this._subscribe();\n      }\n    }, t);\n  }\n\n  async _remove() {\n    if (this._subscription) {\n      try {\n        this.store.dispatch({\n          type: this.actionTypes.remove,\n        });\n        await this._subscription.remove();\n      } catch (error) {\n        /* falls through */\n      }\n      if (this._subscription) {\n        // check again in case subscription object was removed while waiting\n        this._subscription.reset();\n        this._subscription.removeAllListeners();\n        this._subscription = null;\n      }\n      this._removePromise = null;\n    }\n  }\n\n  @proxify\n  async remove() {\n    if (!this._removePromise) {\n      this._removePromise = this._remove();\n    }\n    return this._removePromise;\n  }\n\n  async _reset() {\n    this.store.dispatch({\n      type: this.actionTypes.reset,\n    });\n    this._stopSleepDetection();\n    this._stopRetry();\n    if (this._subscription) {\n      if (this._auth.loggedIn) {\n        try {\n          await this.remove();\n        } catch (error) {\n          /* falls through */\n        }\n      } else {\n        this._subscription.reset();\n        this._subscription.removeAllListeners();\n        this._subscription = null;\n      }\n    }\n    this._resetPromise = null;\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  @proxify\n  async reset() {\n    if (!this._resetPromise) {\n      this._resetPromise = this._reset();\n    }\n    return this._resetPromise;\n  }\n\n  get pubnub() {\n    return this._subscription && this._subscription._pubnub;\n  }\n}\n"],"file":"index.js"}
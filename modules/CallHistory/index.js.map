{"version":3,"sources":["modules/CallHistory/index.js"],"names":["CallHistory","deps","dep","optional","accountInfo","callLog","callMonitor","storage","activityMatcher","contactMatcher","tabManager","options","_accountInfo","ensureExist","_callLog","_storage","_activityMatcher","_contactMatcher","_callMonitor","_tabManager","_reducer","actionTypes","_endedCallsStorageKey","registerReducer","key","reducer","endedCalls","addQuerySource","getQueriesFn","uniqueNumbers","readyCheckFn","ready","sessionIds","store","subscribe","_onStateChange","_shouldInit","_initModuleStatus","_shouldReset","_resetModuleStatus","_processCallHistory","pending","_lastProcessedNumbers","active","_lastProcessedIds","monitorCalls","calls","callLogCalls","_lastProcessedMonitorCalls","filter","find","call","sessionId","currentCall","currentCalls","_lastProcessedCalls","ids","forEach","recentlyEndedCalls","_shouldTriggerContactMatch","triggerMatch","_shouldTriggerActivityMatch","_getEndedCalls","length","_addEndedCalls","shouldRemove","_shouldRemoveEndedCalls","_removeEndedCalls","dispatch","type","init","initSuccess","reset","resetSuccess","map","result","addEndedCalls","timestamp","Date","now","sync","removeEndedCalls","clickToSMS","clickToCall","state","status","moduleStatuses","getItem","RcModule","proxify","getter","countryCode","callFrom","from","phoneNumber","callTo","to","sort","sortByStartTime","normalizedCalls","dataMapping","callMatched","contactMapping","activityMapping","fromNumber","extensionNumber","toNumber","fromMatches","toMatches","activityMatches","matched","toNumberEntity","filteredEndedCalls","output","numberMap","addIfNotExist","number","push","addNumbersFromCall","concat"],"mappings":"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","file":"index.js","sourcesContent":["import { createSelector } from 'reselect';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { sortByStartTime } from '../../lib/callLogHelpers';\nimport actionTypes from './actionTypes';\nimport getCallHistoryReducer, { getEndedCallsReducer } from './getCallHistoryReducer';\nimport ensureExist from '../../lib/ensureExist';\nimport normalizeNumber from '../../lib/normalizeNumber';\nimport getter from '../../lib/getter';\nimport proxify from '../../lib/proxy/proxify';\n\n/**\n * @class\n * @description Call history managing module\n */\n@Module({\n  deps: [\n    'AccountInfo',\n    'CallLog',\n    'CallMonitor',\n    { dep: 'Storage', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'CallHistoryOptions', optional: true },\n    { dep: 'TabManager', optional: true },\n  ]\n})\nexport default class CallHistory extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {AccountInfo} params.accountInfo - accountInfo module instance\n   * @param {CallLog} params.callLog - callLog module instance\n   * @param {CallMonitor} params.callMonitor - callMonitor module instance\n   * @param {ActivityMatcher} params.activityMatcher - activityMatcher module instance\n   * @param {ContactMatcher} params.contactMatcher - contactMatcher module instance\n   */\n  constructor({\n    accountInfo,\n    callLog,\n    callMonitor,\n    storage,\n    activityMatcher,\n    contactMatcher,\n    tabManager,\n    ...options\n  }) {\n    super({\n      ...options,\n    });\n    this._accountInfo = this::ensureExist(accountInfo, 'accountInfo');\n    this._callLog = this::ensureExist(callLog, 'callLog');\n    this._storage = storage;\n    this._activityMatcher = activityMatcher;\n    this._contactMatcher = contactMatcher;\n    this._callMonitor = callMonitor;\n    this._tabManager = tabManager;\n\n    if (this._storage) {\n      this._reducer = getCallHistoryReducer(this.actionTypes);\n      this._endedCallsStorageKey = 'callHistoryEndedCalls';\n      this._storage.registerReducer({\n        key: this._endedCallsStorageKey,\n        reducer: getEndedCallsReducer(this.actionTypes),\n      });\n    } else {\n      this._reducer = getCallHistoryReducer(this.actionTypes, {\n        endedCalls: getEndedCallsReducer(this.actionTypes),\n      });\n    }\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: () => this.uniqueNumbers,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          (!this._tabManager || this._tabManager.ready) &&\n          this._callLog.ready &&\n          this._accountInfo.ready\n        ),\n      });\n    }\n    if (this._activityMatcher) {\n      this._activityMatcher.addQuerySource({\n        getQueriesFn: () => this.sessionIds,\n        readyCheckFn: () => (\n          (!this._callMonitor || this._callMonitor.ready) &&\n          (!this._tabManager || this._tabManager.ready) &&\n          this._callLog.ready\n        ),\n      });\n    }\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this._initModuleStatus();\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    } else if (\n      this.ready\n    ) {\n      this._processCallHistory();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._callLog.ready &&\n      (!this._callMonitor || this._callMonitor.ready) &&\n      this._accountInfo.ready &&\n      (!this._contactMatcher || this._contactMatcher.ready) &&\n      (!this._activityMatcher || this._activityMatcher.ready) &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._callLog.ready ||\n        (this._callMonitor && !this._callMonitor.ready) ||\n        !this._accountInfo.ready ||\n        (this._contactMatcher && !this._contactMatcher.ready) ||\n        (this._tabManager && !this._tabManager.ready) ||\n        (this._activityMatcher && !this._activityMatcher.ready)\n      ) &&\n      this.ready\n    );\n  }\n\n  _shouldTriggerContactMatch(uniqueNumbers) {\n    if (\n      this._lastProcessedNumbers !== uniqueNumbers &&\n      (!this._tabManager || this._tabManager.active)\n    ) {\n      this._lastProcessedNumbers = uniqueNumbers;\n      if (this._contactMatcher && this._contactMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _shouldTriggerActivityMatch(sessionIds) {\n    if (\n      this._lastProcessedIds !== sessionIds &&\n      (!this._tabManager || this._tabManager.active)\n    ) {\n      this._lastProcessedIds = sessionIds;\n      if (this._activityMatcher && this._activityMatcher.ready) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  _getEndedCalls() {\n    if (this._callMonitor) {\n      const monitorCalls = this._callMonitor.calls;\n      const callLogCalls = this._callLog.calls;\n      if (this._lastProcessedMonitorCalls !== monitorCalls) {\n        const endedCalls = (this._lastProcessedMonitorCalls || [])\n          .filter(call => (\n            !monitorCalls.find(currentCall => call.sessionId === currentCall.sessionId) &&\n            // if the call's callLog has been fetch, skip\n            !callLogCalls.find(currentCall => call.sessionId === currentCall.sessionId)\n          ));\n        this._lastProcessedMonitorCalls = monitorCalls;\n        return endedCalls;\n      }\n    }\n    return null;\n  }\n\n  _shouldRemoveEndedCalls() {\n    const currentCalls = this._callLog.calls;\n    if (currentCalls !== this._lastProcessedCalls) {\n      this._lastProcessedCalls = currentCalls;\n      const ids = {};\n      currentCalls.forEach((call) => {\n        ids[call.sessionId] = true;\n      });\n      return this.recentlyEndedCalls.filter(call => ids[call.sessionId]);\n    }\n    return null;\n  }\n\n  _processCallHistory() {\n    const uniqueNumbers = this.uniqueNumbers;\n    if (this._shouldTriggerContactMatch(uniqueNumbers)) {\n      this._contactMatcher.triggerMatch();\n    }\n    const sessionIds = this.sessionIds;\n    if (this._shouldTriggerActivityMatch(sessionIds)) {\n      this._activityMatcher.triggerMatch();\n    }\n\n    const endedCalls = this._getEndedCalls();\n    if (endedCalls && endedCalls.length) {\n      this._addEndedCalls(endedCalls);\n    }\n\n    const shouldRemove = this._shouldRemoveEndedCalls();\n    if (shouldRemove && shouldRemove.length) {\n      this._removeEndedCalls(shouldRemove);\n    }\n  }\n\n  _initModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.init,\n    });\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n    });\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.reset,\n    });\n    this._lastProcessedCalls = null;\n    this._lastProcessedIds = null;\n    this._lastProcessedMonitorCalls = null;\n    this._lastProcessedNumbers = null;\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  _addEndedCalls(endedCalls) {\n    endedCalls.map((call) => {\n      call.result = 'Disconnected';\n      return call;\n    });\n    this.store.dispatch({\n      type: this.actionTypes.addEndedCalls,\n      endedCalls,\n      timestamp: Date.now(),\n    });\n    this._callLog.sync();\n  }\n\n  _removeEndedCalls(endedCalls) {\n    this.store.dispatch({\n      type: this.actionTypes.removeEndedCalls,\n      endedCalls,\n    });\n  }\n\n  // for track click to sms in call history\n  @proxify\n  onClickToSMS() {\n    this.store.dispatch({\n      type: this.actionTypes.clickToSMS\n    });\n  }\n  // for track click to call in call history\n  @proxify\n  onClickToCall() {\n    this.store.dispatch({\n      type: this.actionTypes.clickToCall,\n    });\n  }\n\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  @getter\n  normalizedCalls = createSelector(\n    () => this._callLog.calls,\n    () => this._accountInfo.countryCode,\n    (calls, countryCode) => (\n      calls.map((call) => {\n        const callFrom = {\n          ...call.from,\n        };\n        if (callFrom.phoneNumber) {\n          callFrom.phoneNumber = normalizeNumber({\n            phoneNumber: callFrom.phoneNumber,\n            countryCode,\n          });\n        }\n        const callTo = {\n          ...call.to,\n        };\n        if (callTo.phoneNumber) {\n          callTo.phoneNumber = normalizeNumber({\n            phoneNumber: callTo.phoneNumber,\n            countryCode,\n          });\n        }\n        return {\n          ...call,\n          from: callFrom,\n          to: callTo,\n        };\n      }).sort(sortByStartTime)\n    ),\n  )\n\n  @getter\n  calls = createSelector(\n    () => this.normalizedCalls,\n    () => this.recentlyEndedCalls,\n    () => (this._contactMatcher && this._contactMatcher.dataMapping),\n    () => (this._activityMatcher && this._activityMatcher.dataMapping),\n    () => (this._callMonitor && this._callMonitor.callMatched),\n    (\n      normalizedCalls,\n      endedCalls,\n      contactMapping = {},\n      activityMapping = {},\n      callMatched = {}\n    ) => {\n      const sessionIds = {};\n      const calls = normalizedCalls.map((call) => {\n        sessionIds[call.sessionId] = true;\n        const fromNumber = call.from && (call.from.phoneNumber || call.from.extensionNumber);\n        const toNumber = call.to && (call.to.phoneNumber || call.to.extensionNumber);\n        const fromMatches = (fromNumber && contactMapping[fromNumber]) || [];\n        const toMatches = (toNumber && contactMapping[toNumber]) || [];\n        const activityMatches = (activityMapping[call.sessionId]) || [];\n        const matched = callMatched[call.sessionId];\n        return {\n          ...call,\n          fromMatches,\n          toMatches,\n          activityMatches,\n          toNumberEntity: matched,\n        };\n      });\n      const filteredEndedCalls = endedCalls\n        .filter(call => !sessionIds[call.sessionId])\n        .map((call) => {\n          const activityMatches = (activityMapping[call.sessionId]) || [];\n          return {\n            ...call,\n            activityMatches\n          };\n        });\n      return [\n        ...filteredEndedCalls,\n        ...calls\n      ].sort(sortByStartTime);\n    }\n  )\n\n  @getter\n  uniqueNumbers = createSelector(\n    () => this.normalizedCalls,\n    () => this.recentlyEndedCalls,\n    (normalizedCalls, endedCalls) => {\n      const output = [];\n      const numberMap = {};\n      function addIfNotExist(number) {\n        if (!numberMap[number]) {\n          output.push(number);\n          numberMap[number] = true;\n        }\n      }\n      function addNumbersFromCall(call) {\n        if (call.from && call.from.phoneNumber) {\n          addIfNotExist(call.from.phoneNumber);\n        } else if (call.from && call.from.extensionNumber) {\n          addIfNotExist(call.from.extensionNumber);\n        }\n        if (call.to && call.to.phoneNumber) {\n          addIfNotExist(call.to.phoneNumber);\n        } else if (call.to && call.to.extensionNumber) {\n          addIfNotExist(call.to.extensionNumber);\n        }\n      }\n      normalizedCalls.forEach(addNumbersFromCall);\n      endedCalls.forEach(addNumbersFromCall);\n      return output;\n    },\n  )\n\n  @getter\n  sessionIds = createSelector(\n    () => this._callLog.calls,\n    () => this.recentlyEndedCalls,\n    (calls, endedCalls) => {\n      const sessionIds = {};\n      return calls.map((call) => {\n        sessionIds[call.sessionId] = true;\n        return call.sessionId;\n      }).concat(\n        endedCalls\n          .filter(call => !sessionIds[call.sessionId])\n          .map(call => call.sessionId)\n      );\n    },\n  )\n\n  get recentlyEndedCalls() {\n    if (this._storage) {\n      return this._storage.getItem(this._endedCallsStorageKey);\n    }\n    return this.state.endedCalls;\n  }\n}\n"]}
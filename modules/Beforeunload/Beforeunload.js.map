{"version":3,"file":"Beforeunload.js","names":["_di","require","_core","_dec","_class","_createForOfIteratorHelper","r","e","t","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","_n","F","s","n","done","value","f","TypeError","o","a","u","call","next","_toConsumableArray","_arrayWithoutHoles","_iterableToArray","_nonIterableSpread","_arrayLikeToArray","toString","slice","constructor","name","from","test","_classCallCheck","_defineProperties","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","prototype","i","_toPrimitive","_typeof","toPrimitive","String","Number","_callSuper","_getPrototypeOf","_possibleConstructorReturn","_isNativeReflectConstruct","Reflect","construct","apply","_assertThisInitialized","ReferenceError","Boolean","valueOf","setPrototypeOf","getPrototypeOf","bind","__proto__","_inherits","create","_setPrototypeOf","UNLOAD_EVENT_NAME","Beforeunload","exports","Module","deps","dep","optional","_RcModuleV","_this$_deps$beforeunl","_this$_deps$beforeunl2","_this","_window","_list","_bindState","_beforeunloadHandler","event","checkShouldBlock","preventDefault","returnValue","_deps","beforeunloadOptions","originWindow","window","get","set","removeEventListener","addEventListener","add","cb","index","list","indexOf","concat","remove","_removeItem","clear","_iterator","_step","fn","err","onAfterUnload","_this2","notNeedCheck","arguments","undefined","removeAfterUnloadListener","console","log","splice","RcModuleV2"],"sources":["modules/Beforeunload/Beforeunload.ts"],"sourcesContent":["import { Module } from '@ringcentral-integration/commons/lib/di';\nimport { RcModuleV2 } from '@ringcentral-integration/core';\n\nimport type { Deps } from './Beforeunload.interface';\n\nconst UNLOAD_EVENT_NAME = 'beforeunload';\n\ntype BeforeunloadFn = () => boolean;\n\n@Module({\n  name: 'Beforeunload',\n  deps: [{ dep: 'BeforeunloadOptions', optional: true }],\n})\nexport class Beforeunload extends RcModuleV2<Deps> {\n  _window: Window;\n\n  private get list() {\n    return this._list;\n  }\n\n  private set list(value) {\n    this._list = value;\n\n    if (this._bindState && this._list.length === 0) {\n      this._window.removeEventListener(\n        UNLOAD_EVENT_NAME,\n        this._beforeunloadHandler,\n      );\n      // TODO: binding event here, that will not emit when close tab, not sure why\n      // this._window.removeEventListener('pagehide', this._onAfterUnload);\n      this._bindState = false;\n    } else if (!this._bindState && this._list.length > 0) {\n      this._window.addEventListener(\n        UNLOAD_EVENT_NAME,\n        this._beforeunloadHandler,\n      );\n      // TODO: binding event here, that will not emit when close tab, not sure why\n      // this._window.addEventListener('pagehide', this._onAfterUnload);\n      this._bindState = true;\n    }\n  }\n\n  private _list: BeforeunloadFn[] = [];\n\n  private _bindState = false;\n\n  constructor() {\n    super({\n      deps: {},\n    });\n    this._window = this._deps.beforeunloadOptions?.originWindow ?? window;\n  }\n\n  /**\n   * add method into window event beforeunload\n   * @param cb a callback with boolean, if return `true` that will block browser close.\n   */\n  add(cb: BeforeunloadFn) {\n    const index = this.list.indexOf(cb);\n\n    if (index === -1) {\n      this.list = [...this.list, cb];\n      return this.list.length;\n    }\n\n    return index;\n  }\n\n  /**\n   * remove check from check list.\n   * @param cb a callback that you add previous.\n   */\n  remove(cb: BeforeunloadFn) {\n    const index = this.list.indexOf(cb);\n\n    if (index > -1) {\n      this._removeItem(index);\n    }\n\n    return index;\n  }\n\n  /**\n   * clear all check methods\n   */\n  clear() {\n    this.list = [];\n  }\n\n  /**\n   * check all should block callback, and return should we need block\n   */\n  checkShouldBlock() {\n    for (const fn of this._list) {\n      if (fn()) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * that method will trigger after check not leave success\n   */\n  onAfterUnload(cb: () => void, notNeedCheck = false) {\n    this._window.addEventListener('pagehide', () => {\n      if (notNeedCheck || this.checkShouldBlock()) {\n        cb();\n      }\n    });\n  }\n\n  removeAfterUnloadListener(cb: () => void) {\n    console.log('removeAfterUnloadListener~~');\n    this._window.removeEventListener('pagehide', cb);\n  }\n\n  private _removeItem(i: number) {\n    const list = [...this.list];\n    list.splice(i, 1);\n\n    this.list = list;\n  }\n\n  private _beforeunloadHandler = (event: BeforeUnloadEvent) => {\n    if (this.checkShouldBlock()) {\n      event.preventDefault();\n      event.returnValue = '';\n      return;\n    }\n\n    // Guarantee the browser unload by removing the returnValue property of the event\n    delete event.returnValue;\n  };\n}\n"],"mappings":"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","ignoreList":[]}
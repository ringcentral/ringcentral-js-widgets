{"version":3,"sources":["modules/UserGuideV2/UserGuide.ts"],"names":["SUPPORTED_LOCALES","UserGuide","name","deps","dep","optional","that","options","curIdx","playing","trackEvents","whatsNew","_deps","locale","ready","allGuides","currentLocale","enableCache","storageKey","preLoadImageStatus","guides","firstLogin","carouselState","initUserGuide","preLoadImage","pending","auth","storage","extensionFeatures","loggedIn","webphone","ringSession","dismiss","url","Promise","resolve","reject","img","Image","src","onload","onerror","_preLoadImage","setPreLoadImageStatus","userGuideOptions","context","locales","Object","keys","sort","map","key","reduce","prev","curr","forEach","push","updateCarousel","entered","setGuides","setCarousel","hasPermission","prevGuides","resolveGuides","loadGuides","JSON","stringify","start","isCallingEnabled","hasReadMessagesPermission","currentGuides","length","RcModuleV2","state","action","proxify"],"mappings":"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","sourcesContent":["import {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n  watch,\n} from '@ringcentral-integration/core';\nimport { contains } from 'ramda';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { trackEvents } from '../Analytics';\nimport {\n  CarouselOptions,\n  CarouselState,\n  Deps,\n  Guides,\n} from './UserGuide.interface';\n\nconst SUPPORTED_LOCALES = {\n  'en-US': 'en-US',\n  'fr-CA': 'fr-CA',\n};\n\n@Module({\n  name: 'UserGuide',\n  deps: [\n    'Auth',\n    'Locale',\n    'Storage',\n    'Webphone',\n    'ExtensionFeatures',\n    { dep: 'UserGuideOptions', optional: true },\n  ],\n})\nexport class UserGuide extends RcModuleV2<Deps> {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'UserGuide',\n    });\n  }\n\n  @storage\n  @state\n  allGuides: Guides = {};\n\n  @state\n  carouselState: CarouselState = {\n    curIdx: 0,\n    entered: false,\n    playing: false,\n  };\n\n  @state\n  preLoadImageStatus = false;\n\n  @state\n  firstLogin = false;\n\n  @action\n  setPreLoadImageStatus() {\n    this.preLoadImageStatus = true;\n  }\n\n  @action\n  setGuides(guides: Guides) {\n    this.allGuides = guides;\n  }\n\n  @track((that: UserGuide, options: Required<CarouselOptions>) => {\n    if (options.curIdx === 0 && options.playing) {\n      return [trackEvents.whatsNew];\n    }\n  })\n  @action\n  setCarousel({ firstLogin, ...carouselState }: Required<CarouselOptions>) {\n    this.carouselState = carouselState;\n    this.firstLogin = firstLogin;\n  }\n\n  async onInitSuccess() {\n    await this.initUserGuide();\n    await this.preLoadImage();\n  }\n\n  _shouldInit() {\n    return !!(\n      this.pending &&\n      this._deps.auth.ready &&\n      this._deps.locale.ready &&\n      this._deps.storage.ready &&\n      this._deps.extensionFeatures.ready &&\n      this._deps.auth.loggedIn\n    );\n  }\n\n  _shouldReset() {\n    return !!(\n      this.ready &&\n      (!this._deps.auth.ready ||\n        !this._deps.locale.ready ||\n        !this._deps.storage.ready ||\n        !this._deps.extensionFeatures.ready)\n    );\n  }\n\n  onInitOnce() {\n    // When there is an incoming call,\n    // the guide should be dismissed\n    watch(\n      this,\n      () => this._deps.webphone.ringSession,\n      (ringSession) => {\n        if (this._deps.webphone.ready && ringSession) {\n          this.dismiss();\n        }\n      },\n    );\n  }\n\n  @proxify\n  async _preLoadImage(url: string) {\n    await new Promise((resolve, reject) => {\n      const img = new Image();\n      img.src = url;\n      img.onload = resolve;\n      img.onerror = reject;\n    });\n  }\n\n  @proxify\n  async preLoadImage() {\n    const url = this.guides[0];\n    if (url) {\n      await this._preLoadImage(url);\n    }\n    this.setPreLoadImageStatus();\n  }\n\n  /**\n   * Using webpack `require.context` to load guides files.\n   * Image files will be sorted by file name in ascending order.\n   * @return {Map<String, Array<URI>>}\n   */\n  resolveGuides() {\n    if (typeof this._deps.userGuideOptions?.context === 'function') {\n      const locales = Object.keys(SUPPORTED_LOCALES);\n      return this._deps.userGuideOptions.context\n        .keys()\n        .sort()\n        .map((key: string) => this._deps.userGuideOptions.context(key))\n        .reduce((prev: Record<string, string[]>, curr: string) => {\n          locales.forEach((locale) => {\n            if (!prev[locale]) prev[locale] = [];\n            if (contains(locale, curr)) {\n              prev[locale].push(curr);\n            }\n          });\n          return prev;\n        }, {} as Record<string, string[]>);\n    }\n    return {};\n  }\n\n  @proxify\n  async dismiss() {\n    this.updateCarousel({\n      curIdx: 0,\n      entered: false,\n      playing: false,\n      firstLogin: false,\n    });\n  }\n\n  @proxify\n  async loadGuides(guides: Guides) {\n    if (guides) {\n      this.setGuides(guides);\n    }\n  }\n\n  @proxify\n  async updateCarousel({\n    curIdx,\n    entered,\n    playing,\n    firstLogin = this.firstLogin,\n  }: CarouselOptions) {\n    this.setCarousel({\n      curIdx,\n      entered,\n      playing,\n      firstLogin,\n    });\n  }\n\n  get hasPermission() {\n    // For extensions without calling or read message permissions, most of the content in\n    // the user guide is not applicable to them. So we should not show the user guide for\n    // these extensions.\n    return (\n      this._deps.extensionFeatures.isCallingEnabled ||\n      this._deps.extensionFeatures.hasReadMessagesPermission\n    );\n  }\n\n  @proxify\n  async initUserGuide() {\n    if (!this.hasPermission) return;\n    const prevGuides = this.allGuides;\n    const guides = this.resolveGuides();\n    // Determine if it needs to be displayed when first log in,\n    // the principles behind this is to use webpack's file hash,\n    // i.e. if any of the guide files is changed, the file name hash\n    // will be changed as well, in this case, it will be displayed.\n    await this.loadGuides(guides);\n    if (JSON.stringify(guides) !== JSON.stringify(prevGuides)) {\n      this.start({ firstLogin: true });\n    }\n  }\n\n  @proxify\n  async start({ firstLogin = false } = {}) {\n    // Start guides only when images are ready\n    this.setCarousel({\n      curIdx: 0,\n      entered: true,\n      playing: true,\n      firstLogin,\n    });\n  }\n\n  @computed((that: UserGuide) => [\n    that._deps.locale.ready,\n    that.allGuides,\n    that._deps.locale.currentLocale,\n  ])\n  get guides() {\n    if (!this._deps.locale.ready) return [];\n    if (this.allGuides) {\n      const currentGuides = this.allGuides[this._deps.locale.currentLocale];\n      if (currentGuides && currentGuides.length > 0) return currentGuides;\n      return this.allGuides[SUPPORTED_LOCALES['en-US']] || [];\n    }\n    return [];\n  }\n\n  get started() {\n    return this.carouselState.entered && this.carouselState.playing;\n  }\n}\n"],"file":"UserGuide.js"}
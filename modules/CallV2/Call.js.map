{"version":3,"sources":["modules/CallV2/Call.ts"],"names":["TO_NUMBER","FROM_NUMBER","ANONYMOUS","Call","name","deps","dep","optional","_","callSettingMode","callingModes","webphone","trackEvents","callAttemptWebRTC","callAttempt","outboundWebRTCCallConnected","outboundCallConnected","enableCache","storageKey","_internationalCheck","_permissionCheck","_callSettingMode","_useCallControlToMakeCall","_deps","callOptions","internationalCheck","permissionCheck","useCallControlToMakeCall","data","toNumberEntities","push","isConference","phoneNumber","recipient","callStatus","connecting","lastPhoneNumber","lastRecipient","idle","ready","_processCall","_initCallModule","_resetCallModule","cleanToNumberEntities","callingSettings","callingMode","connect","disconnect","oldCallSettingMode","entityId","startTime","isIdle","toNumberMatched","input","fromNumber","session","extendedControls","toNumber","extension","trim","length","alert","warning","message","callErrors","noToNumber","_getValidatedNumbers","validatedNumbers","_getNumbers","_makeCall","connectSuccess","connectError","response","clone","json","feature","statusCode","status","type","payload","ringoutErrors","firstLegConnectFailed","connectFailed","danger","networkError","includes","noInternational","availabilityMonitor","checkIfHAError","internalError","isWebphone","theFromNumber","myLocation","waitingValidateNumbers","number","parsedToNumber","parsedFromNumber","numbers","map","x","validatedResult","allowRegionSettings","brand","brandConfig","areaCode","regionSettings","countryCode","phoneNumbers","toNumberIndex","findIndex","fromNumberIndex","numberValidate","validateNumbers","result","errors","forEach","error","international","extensionFeatures","features","InternationalCalling","available","originalString","parsedToNumberE164","e164","subAddress","join","parsedFromNumberE164","homeCountryId","softphone","jupiter","ringout","makeCall","split","prompt","ringoutPrompt","activeCallControl","RcModuleV2","state","storage","action","proxify"],"mappings":"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","sourcesContent":["import {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n} from '@ringcentral-integration/core';\nimport extractControls from '@ringcentral-integration/phone-number/lib/extractControls';\n\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { validateNumbers } from '../../lib/validateNumbers';\nimport { trackEvents } from '../Analytics';\nimport callingModes from '../CallingSettings/callingModes';\nimport { ringoutErrors } from '../Ringout/ringoutErrors';\nimport { Deps, Recipient, ToNumberMatched } from './Call.interface';\nimport { callErrors } from './callErrors';\nimport { callStatus } from './callStatus';\n\nconst TO_NUMBER = 'toNumber';\nconst FROM_NUMBER = 'fromNumber';\nconst ANONYMOUS = 'anonymous';\n\n/**\n * @class\n * @description Call managing module\n */\n@Module({\n  name: 'Call',\n  deps: [\n    'Alert',\n    'Storage',\n    'Brand',\n    'Softphone',\n    'Ringout',\n    'NumberValidate',\n    'RegionSettings',\n    'CallingSettings',\n    'ExtensionFeatures',\n    { dep: 'Webphone', optional: true },\n    { dep: 'AvailabilityMonitor', optional: true },\n    { dep: 'CallOptions', optional: true },\n    { dep: 'ActiveCallControl', optional: true },\n  ],\n})\nexport class Call extends RcModuleV2<Deps> {\n  _internationalCheck: boolean;\n  _permissionCheck: boolean;\n  _callSettingMode: string = null;\n  _useCallControlToMakeCall: boolean;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'callData',\n    });\n    this._internationalCheck =\n      this._deps.callOptions?.internationalCheck ?? true;\n    this._permissionCheck = this._deps.callOptions?.permissionCheck ?? true;\n    this._useCallControlToMakeCall =\n      this._deps.callOptions?.useCallControlToMakeCall ?? false;\n  }\n\n  @state\n  callStatus = callStatus.idle;\n\n  @state\n  toNumberEntities: ToNumberMatched[] = [];\n\n  get lastPhoneNumber() {\n    return this.data.lastPhoneNumber;\n  }\n\n  get lastRecipient() {\n    return this.data.lastRecipient;\n  }\n\n  @storage\n  @state\n  data: {\n    lastPhoneNumber: string;\n    lastRecipient: Recipient;\n  } = {\n    lastPhoneNumber: null,\n    lastRecipient: null,\n  };\n\n  @action\n  toNumberMatched(data: ToNumberMatched) {\n    this.toNumberEntities.push(data);\n  }\n\n  @action\n  cleanToNumberEntities() {\n    this.toNumberEntities = [];\n  }\n\n  @track((_: Call, { callSettingMode }) => [\n    callSettingMode === callingModes.webphone\n      ? trackEvents.callAttemptWebRTC\n      : trackEvents.callAttempt,\n    { callSettingMode },\n  ])\n  @action\n  connect({\n    isConference,\n    phoneNumber = null,\n    recipient = null,\n    callSettingMode,\n  }: {\n    isConference: boolean;\n    phoneNumber: string;\n    recipient: Recipient;\n    callSettingMode: string;\n  }) {\n    this.callStatus = callStatus.connecting;\n    if (!isConference) {\n      this.data.lastPhoneNumber = phoneNumber;\n      this.data.lastRecipient = recipient;\n    }\n  }\n\n  @track((_: Call, callSettingMode) => [\n    callSettingMode === callingModes.webphone\n      ? trackEvents.outboundWebRTCCallConnected\n      : trackEvents.outboundCallConnected,\n    { callSettingMode },\n  ])\n  @action\n  connectSuccess(callSettingMode: string) {\n    this.callStatus = callStatus.idle;\n  }\n\n  @action\n  connectError() {\n    this.callStatus = callStatus.idle;\n  }\n\n  async onStateChange() {\n    if (this.ready) {\n      await this._processCall();\n    }\n  }\n\n  onInit() {\n    this._initCallModule();\n  }\n\n  onReset() {\n    this._resetCallModule();\n    this.cleanToNumberEntities();\n  }\n\n  async _initCallModule() {\n    this._callSettingMode = this._deps.callingSettings.callingMode;\n    if (\n      this._callSettingMode === callingModes.webphone &&\n      this._deps.webphone\n    ) {\n      await this._deps.webphone.connect();\n    }\n  }\n\n  _resetCallModule() {\n    this._callSettingMode = this._deps.callingSettings.callingMode;\n    if (\n      this._callSettingMode === callingModes.webphone &&\n      this._deps.webphone\n    ) {\n      this._deps.webphone.disconnect();\n    }\n  }\n\n  async _processCall() {\n    const oldCallSettingMode = this._callSettingMode;\n    if (\n      this._deps.callingSettings.callingMode !== oldCallSettingMode &&\n      this._deps.webphone\n    ) {\n      this._callSettingMode = this._deps.callingSettings.callingMode;\n      if (oldCallSettingMode === callingModes.webphone) {\n        this._deps.webphone.disconnect();\n      } else if (this._callSettingMode === callingModes.webphone) {\n        await this._deps.webphone.connect();\n      }\n    }\n  }\n\n  // save the click to dial entity, only when call took place\n  onToNumberMatch({ entityId, startTime }: ToNumberMatched) {\n    if (this.isIdle) {\n      this.toNumberMatched({ entityId, startTime });\n    }\n  }\n\n  @proxify\n  async call({\n    phoneNumber: input,\n    recipient,\n    fromNumber,\n    isConference = false,\n  }: {\n    phoneNumber: string;\n    recipient: Recipient;\n    fromNumber: string;\n    isConference?: boolean;\n  }) {\n    let session = null;\n    if (this.isIdle) {\n      const { phoneNumber, extendedControls } = extractControls(input);\n      const toNumber =\n        (recipient && (recipient.phoneNumber || recipient.extension)) ||\n        phoneNumber;\n      if (!toNumber || `${toNumber}`.trim().length === 0) {\n        this._deps.alert.warning({\n          message: callErrors.noToNumber,\n        });\n      } else {\n        this.connect({\n          isConference,\n          phoneNumber,\n          recipient,\n          callSettingMode: this._callSettingMode,\n        });\n        try {\n          let validatedNumbers;\n          if (this._permissionCheck) {\n            validatedNumbers = await this._getValidatedNumbers({\n              toNumber,\n              fromNumber,\n              isConference,\n            });\n          } else {\n            validatedNumbers = this._getNumbers({\n              toNumber,\n              fromNumber,\n              isConference,\n            });\n          }\n          if (validatedNumbers) {\n            session = await this._makeCall({\n              ...validatedNumbers,\n              extendedControls,\n            });\n            this.connectSuccess(this._callSettingMode);\n          } else {\n            this.connectError();\n          }\n        } catch (error) {\n          const { feature } = (await error?.response?.clone().json()) || {};\n          const statusCode = error?.response?.status;\n          if (!error.message && error.type && (callErrors as any)[error.type]) {\n            // validate format error\n            this._deps.alert.warning({\n              message: (callErrors as any)[error.type],\n              payload: {\n                phoneNumber: error.phoneNumber,\n              },\n            });\n          } else if (error.message === ringoutErrors.firstLegConnectFailed) {\n            this._deps.alert.warning({\n              message: callErrors.connectFailed,\n              payload: error,\n            });\n          } else if (error.message === 'Failed to fetch') {\n            this._deps.alert.danger({\n              message: callErrors.networkError,\n              payload: error,\n            });\n          } else if (\n            feature &&\n            feature.includes('InternationalCalls') &&\n            statusCode === 403\n          ) {\n            // ringout call may not have international permission, then first leg can't be create\n            // directly, customer will not be able to hear the voice prompt, so show a warning\n            this._deps.alert.danger({\n              message: callErrors.noInternational,\n            });\n          } else if (error.message !== 'Refresh token has expired') {\n            if (\n              !this._deps.availabilityMonitor ||\n              !this._deps.availabilityMonitor.checkIfHAError(error)\n            ) {\n              this._deps.alert.danger({\n                message: callErrors.internalError,\n                payload: error,\n              });\n            }\n          }\n          this.connectError();\n          throw error;\n        }\n      }\n    }\n    return session;\n  }\n\n  _getNumbers({\n    toNumber,\n    fromNumber,\n    isConference,\n  }: {\n    toNumber: string;\n    fromNumber?: string;\n    isConference?: boolean;\n  }) {\n    const isWebphone =\n      this._deps.callingSettings.callingMode === callingModes.webphone;\n    const theFromNumber =\n      fromNumber ||\n      (isWebphone\n        ? this._deps.callingSettings.fromNumber\n        : this._deps.callingSettings.myLocation);\n\n    if (isWebphone && (theFromNumber === null || theFromNumber === '')) {\n      return null;\n    }\n\n    const waitingValidateNumbers = [];\n\n    if (!isConference) {\n      waitingValidateNumbers.push({\n        type: TO_NUMBER,\n        number: toNumber,\n      });\n    }\n\n    if (\n      theFromNumber &&\n      theFromNumber.length > 0 &&\n      !(isWebphone && theFromNumber === ANONYMOUS)\n    ) {\n      waitingValidateNumbers.push({\n        type: FROM_NUMBER,\n        number: theFromNumber,\n      });\n    }\n\n    let parsedToNumber;\n    let parsedFromNumber;\n\n    if (waitingValidateNumbers.length) {\n      const numbers = waitingValidateNumbers.map((x) => x.number);\n      const validatedResult = validateNumbers({\n        allowRegionSettings: this._deps.brand.brandConfig.allowRegionSettings,\n        areaCode: this._deps.regionSettings.areaCode,\n        countryCode: this._deps.regionSettings.countryCode,\n        phoneNumbers: numbers,\n      });\n      const toNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === TO_NUMBER,\n      );\n      const fromNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === FROM_NUMBER,\n      );\n      parsedToNumber = validatedResult[toNumberIndex];\n      parsedFromNumber = validatedResult[fromNumberIndex];\n    }\n    if (isWebphone && theFromNumber === ANONYMOUS) {\n      parsedFromNumber = ANONYMOUS;\n    }\n    return {\n      toNumber: parsedToNumber || toNumber,\n      fromNumber: parsedFromNumber,\n    };\n  }\n\n  @proxify\n  async _getValidatedNumbers({\n    toNumber,\n    fromNumber,\n    isConference,\n  }: {\n    toNumber: string;\n    fromNumber: string;\n    isConference: boolean;\n  }) {\n    const isWebphone =\n      this._deps.callingSettings.callingMode === callingModes.webphone;\n    const theFromNumber =\n      fromNumber ||\n      (isWebphone\n        ? this._deps.callingSettings.fromNumber\n        : this._deps.callingSettings.myLocation);\n\n    if (isWebphone && (theFromNumber === null || theFromNumber === '')) {\n      return null;\n    }\n\n    const waitingValidateNumbers = [];\n\n    if (!isConference) {\n      waitingValidateNumbers.push({\n        type: TO_NUMBER,\n        number: toNumber,\n      });\n    }\n\n    if (\n      theFromNumber &&\n      theFromNumber.length > 0 &&\n      !(isWebphone && theFromNumber === ANONYMOUS)\n    ) {\n      waitingValidateNumbers.push({\n        type: FROM_NUMBER,\n        number: theFromNumber,\n      });\n    }\n\n    let parsedToNumber;\n    let parsedFromNumber;\n    if (waitingValidateNumbers.length) {\n      const numbers = waitingValidateNumbers.map((x) => x.number);\n      const validatedResult = await this._deps.numberValidate.validateNumbers(\n        numbers,\n      );\n      if (!validatedResult.result) {\n        validatedResult.errors.forEach((error: any) => {\n          // TODO: determine how to deal with multiple errors\n          // this._deps.alert.warning({\n          //   message: callErrors[error.type],\n          //   payload: {\n          //     phoneNumber: error.phoneNumber\n          //   }\n          // });\n          throw error;\n        });\n        return null;\n      }\n      const toNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === TO_NUMBER,\n      );\n      const fromNumberIndex = waitingValidateNumbers.findIndex(\n        (x) => x.type === FROM_NUMBER,\n      );\n      // TODO: fix `validatedResult` type in `numberValidate` module.\n      parsedToNumber = (validatedResult as any).numbers[toNumberIndex];\n      parsedFromNumber = (validatedResult as any).numbers[fromNumberIndex];\n    }\n    if (this._internationalCheck) {\n      if (\n        parsedToNumber &&\n        parsedToNumber.international &&\n        !this._deps.extensionFeatures.features?.InternationalCalling?.available\n      ) {\n        const error = {\n          phoneNumber: parsedToNumber.originalString,\n          type: 'noInternational',\n        };\n        throw error;\n      }\n    }\n\n    let parsedToNumberE164 = toNumber;\n    if (parsedToNumber) {\n      parsedToNumberE164 = parsedToNumber.e164;\n      // add ext back if any\n      if (parsedToNumber.e164 && parsedToNumber.subAddress) {\n        parsedToNumberE164 = [\n          parsedToNumber.e164,\n          parsedToNumber.subAddress,\n        ].join('*');\n      }\n    }\n\n    // using e164 in response to call\n    let parsedFromNumberE164;\n    if (parsedFromNumber) {\n      parsedFromNumberE164 = parsedFromNumber.e164;\n      // add ext back if any\n      if (parsedFromNumber.e164 && parsedFromNumber.subAddress) {\n        parsedFromNumberE164 = [\n          parsedFromNumber.e164,\n          parsedFromNumber.subAddress,\n        ].join('*');\n      }\n    }\n    if (isWebphone && theFromNumber === ANONYMOUS) {\n      parsedFromNumberE164 = ANONYMOUS;\n    }\n    return {\n      toNumber: parsedToNumberE164,\n      fromNumber: parsedFromNumberE164,\n    };\n  }\n\n  @proxify\n  async _makeCall({\n    toNumber,\n    fromNumber,\n    callingMode = this._deps.callingSettings.callingMode,\n    extendedControls = [],\n  }: {\n    toNumber: string;\n    fromNumber: string;\n    callingMode?: string;\n    extendedControls?: string[];\n  }) {\n    const homeCountryId = this._deps.regionSettings.homeCountryId;\n    let session;\n    switch (callingMode) {\n      case callingModes.softphone:\n      case callingModes.jupiter:\n        session = this._deps.softphone.makeCall(toNumber, callingMode);\n        break;\n      case callingModes.ringout:\n        session = await this._deps.ringout.makeCall({\n          fromNumber,\n          toNumber: toNumber && toNumber.split('*')[0], // remove extension number in ringout mode\n          prompt: this._deps.callingSettings.ringoutPrompt,\n        });\n        break;\n      case callingModes.webphone: {\n        if (this._deps.activeCallControl && this._useCallControlToMakeCall) {\n          session = await this._deps.activeCallControl.makeCall({\n            fromNumber,\n            toNumber,\n            homeCountryId,\n            extendedControls,\n          });\n        } else if (this._deps.webphone) {\n          // TODO: fix `webphone` module type\n          session = (await this._deps.webphone.makeCall({\n            fromNumber,\n            toNumber,\n            homeCountryId,\n            extendedControls,\n          })) as any;\n        }\n        break;\n      }\n\n      default:\n        break;\n    }\n    return session;\n  }\n\n  get isIdle() {\n    return this.callStatus === callStatus.idle;\n  }\n}\n"],"file":"Call.js"}
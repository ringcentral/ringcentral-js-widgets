{"version":3,"file":"callMonitorHelper.js","names":["_callDirections","_interopRequireDefault","require","obj","__esModule","getSessionStartTime","session","webphoneStartTime","direction","callDirections","inbound","creationTime","startTime","matchWephoneSessionWithAcitveCall","sessions","callItem","undefined","matches","filter","partyData","telephonySessionId","_session$partyData","sessionId","partyId","callId","id","toName","toLowerCase","indexOf","sipData","remoteUri","from","outbound","to","Math","abs","length","sort","x","y","gapX","gapY","isCurrentDeviceEndCall","normalizeTelephonySession","status","otherParties"],"sources":["modules/CallMonitor/callMonitorHelper.ts"],"sourcesContent":["import callDirections from '../../enums/callDirections';\nimport type { Call } from '../../interfaces/Call.interface';\nimport type { ActiveCall } from '../../interfaces/Presence.model';\nimport type { NormalizedSession } from '../../interfaces/Webphone.interface';\nimport type { ActiveCallControlSessionData } from '../../interfaces/ActiveSession.interface';\n\nfunction getSessionStartTime(session: NormalizedSession) {\n  let webphoneStartTime;\n  if (session.direction === callDirections.inbound) {\n    webphoneStartTime = session.creationTime;\n  } else {\n    webphoneStartTime = session.startTime || session.creationTime;\n  }\n  return webphoneStartTime;\n}\n\nexport function matchWephoneSessionWithAcitveCall(\n  sessions: NormalizedSession[],\n  callItem: ActiveCall | Call,\n) {\n  if (!sessions || !callItem) {\n    return undefined;\n  }\n  const matches = sessions.filter((session) => {\n    // Strategy 1: use `P-Rc-Api-Ids` header of a webRTC session to match with `telephonySessionId`\n    // and `partyId` of a call data from presence api.\n    // when caller calls him self, the sessionId are the same, so we need the `partyId` to identify the participants.\n    if (session.partyData && callItem.telephonySessionId) {\n      const { sessionId, partyId } = session.partyData;\n      if (sessionId !== callItem.telephonySessionId) {\n        return false;\n      }\n      if (partyId === callItem.partyId) {\n        return true;\n      }\n      // For switched call, partyId is not matched\n      if (session.callId === callItem.id) {\n        return true;\n      }\n      return false;\n    }\n\n    // Strategy 2: use `call-id` header of a webRTC session to match with\n    // `id` of a call data from presence api.\n    // This approach is unstable since the `id` of a call data from presence api can change before\n    // the call being accepted.\n    if (session.callId === callItem.id) {\n      return true;\n    }\n\n    if (session.direction !== callItem.direction) {\n      return false;\n    }\n\n    /**\n     * Strategy 3:\n     * Hack: for conference call, the `to` field is Conference,\n     * and the callItem's id won't change. According to `sip.js/src/session.js`\n     * the `InviteClientContext`'s id will always begin with callItem's id.\n     */\n    if (callItem.toName && callItem.toName.toLowerCase() === 'conference') {\n      // @ts-expect-error\n      return session.id.indexOf(callItem.id) === 0;\n    }\n\n    if (\n      // @ts-expect-error\n      !(callItem as ActiveCall).sipData.remoteUri ||\n      // @ts-expect-error\n      (callItem as ActiveCall).sipData.remoteUri === ''\n    ) {\n      return false;\n    }\n\n    if (\n      session.direction === callDirections.inbound &&\n      // @ts-expect-error\n      (callItem as ActiveCall).sipData.remoteUri.indexOf(session.from) === -1\n    ) {\n      return false;\n    }\n\n    if (\n      session.direction === callDirections.outbound &&\n      // @ts-expect-error\n      (callItem as ActiveCall).sipData.remoteUri.indexOf(session.to) === -1\n    ) {\n      return false;\n    }\n\n    // 16000 is from experience in test.\n    // there is delay bettween active call created and webphone session created\n    // for example, the time delay is decided by when webphone get invite info\n    // @ts-expect-error\n    if (Math.abs(callItem.startTime - getSessionStartTime(session)) > 16000) {\n      return false;\n    }\n    return true;\n  });\n\n  if (matches.length > 1) {\n    // order by the time gap asc\n    matches.sort((x, y) => {\n      // @ts-expect-error\n      const gapX = Math.abs(callItem.startTime - getSessionStartTime(x));\n      // @ts-expect-error\n      const gapY = Math.abs(callItem.startTime - getSessionStartTime(y));\n      return gapX === gapY ? 0 : gapX - gapY;\n    });\n  }\n\n  return matches[0];\n}\n\nexport function isCurrentDeviceEndCall(sessions: string[], callItem: Call) {\n  // @ts-expect-error\n  return sessions.indexOf(callItem.telephonySessionId) !== -1;\n}\n\nexport function normalizeTelephonySession(\n  session: ActiveCallControlSessionData,\n) {\n  return {\n    status: session.status,\n    id: session.id,\n    direction: session.direction,\n    otherParties: session.otherParties,\n  };\n}\n"],"mappings":"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"}
{"version":3,"sources":["modules/DetailedPresence/index.js"],"names":["presenceRegExp","DetailedPresence","deps","auth","client","subscription","connectivityMonitor","rolesAndPermissions","storage","options","actionTypes","_subscriptionHandler","message","test","event","body","sequence","_lastSequence","activeCalls","dndStatus","telephonyStatus","presenceStatus","userStatus","store","dispatch","type","notification","lastDndStatus","timestamp","Date","now","_onStateChange","_auth","loggedIn","_subscription","ready","_rolesAndPermissions","_connectivityMonitor","status","pending","init","_connectivity","connectivity","hasPresencePermission","fetch","subscribe","detailedPresenceWithSip","initSuccess","reset","_lastTelephonyStatus","_lastMessage","resetSuccess","_fetch","_client","_storage","_lastNotDisturbDndStatusStorageKey","_reducer","registerReducer","key","reducer","lastNotDisturbDndStatus","addSelector","state","calls","map","call","sessionId","data","filter","ownerId","service","platform","get","json","fetchSuccess","_promise","fetchError","error","_selectors","sessionIdList"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAKA,IAAMA,iBAAiB,wDAAvB;;AAEA;;;;IAcqBC,gB,WAVpB,gBAAO;AACNC,QAAM,CACJ,MADI,EAEJ,QAFI,EAGJ,SAHI,EAIJ,cAJI,EAKJ,qBALI,EAMJ,qBANI;AADA,CAAP,C;;;AAWC;;;;;;;;AAQA,kCAQG;AAAA;;AAAA,QAPDC,IAOC,QAPDA,IAOC;AAAA,QANDC,MAMC,QANDA,MAMC;AAAA,QALDC,YAKC,QALDA,YAKC;AAAA,QAJDC,mBAIC,QAJDA,mBAIC;AAAA,QAHDC,mBAGC,QAHDA,mBAGC;AAAA,QAFDC,OAEC,QAFDA,OAEC;AAAA,QADEC,OACF;AAAA;;AAAA,qLAEIA,OAFJ;AAGCC;AAHD;;AAAA,UAyCHC,oBAzCG,GAyCoB,UAACC,OAAD,EAAa;AAClC,UAAIZ,eAAea,IAAf,CAAoBD,QAAQE,KAA5B,KAAsCF,QAAQG,IAAlD,EAAwD;AACtD,YAAIH,QAAQG,IAAR,CAAaC,QAAjB,EAA2B;AACzB,cAAIJ,QAAQG,IAAR,CAAaC,QAAb,IAAyB,MAAKC,aAAlC,EAAiD;AAC/C;AACD;AACD,gBAAKA,aAAL,GAAqBL,QAAQG,IAAR,CAAaC,QAAlC;AACD;AANqD,4BAalDJ,QAAQG,IAb0C;AAAA,YAQpDG,WARoD,iBAQpDA,WARoD;AAAA,YASpDC,SAToD,iBASpDA,SAToD;AAAA,YAUpDC,eAVoD,iBAUpDA,eAVoD;AAAA,YAWpDC,cAXoD,iBAWpDA,cAXoD;AAAA,YAYpDC,UAZoD,iBAYpDA,UAZoD;;AActD,cAAKC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,gBAAM,MAAKf,WAAL,CAAiBgB,YADL;AAElBR,kCAFkB;AAGlBC,8BAHkB;AAIlBC,0CAJkB;AAKlBC,wCALkB;AAMlBC,gCANkB;AAOlBV,mBAASA,QAAQG,IAAR,CAAaH,OAPJ;AAQlBe,yBAAe,MAAKR,SARF;AASlBS,qBAAWC,KAAKC,GAAL;AATO,SAApB;AAWD;AACF,KApEE;;AAAA,UAqEHC,cArEG,8DAqEc;AAAA;AAAA;AAAA;AAAA;AAAA,oBAEb,MAAKC,KAAL,CAAWC,QAAX,IACA,MAAKC,aAAL,CAAmBC,KADnB,IAEA,MAAKC,oBAAL,CAA0BD,KAF1B,KAGC,CAAC,MAAKE,oBAAN,IAA8B,MAAKA,oBAAL,CAA0BF,KAHzD,KAIA,MAAKG,MAAL,KAAgB,yBAAeC,OANlB;AAAA;AAAA;AAAA;;AAQb,oBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,sBAAM,MAAKf,WAAL,CAAiB8B;AADL,eAApB;AAGA,kBAAI,MAAKH,oBAAT,EAA+B;AAC7B,sBAAKI,aAAL,GAAqB,MAAKJ,oBAAL,CAA0BK,YAA/C;AACD;;AAbY,mBAcT,MAAKN,oBAAL,CAA0BO,qBAdjB;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAeL,MAAKC,KAAL,EAfK;;AAAA;AAgBX,oBAAKV,aAAL,CAAmBW,SAAnB,CAA6B,8BAAoBC,uBAAjD;;AAhBW;AAkBb,oBAAKvB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,sBAAM,MAAKf,WAAL,CAAiBqC;AADL,eAApB;AAlBa;AAAA;;AAAA;AAqBR,kBACL,CACE,CAAC,MAAKf,KAAL,CAAWC,QAAZ,IACA,CAAC,MAAKC,aAAL,CAAmBC,KADpB,IAEC,MAAKE,oBAAL,IAA6B,CAAC,MAAKA,oBAAL,CAA0BF,KAH3D,KAKA,MAAKA,KANA,EAOL;AACA,sBAAKZ,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKf,WAAL,CAAiBsC;AADL,iBAApB;AAGA,sBAAKC,oBAAL,GAA4B,IAA5B;AACA,sBAAKhC,aAAL,GAAqB,CAArB;AACA,sBAAKiC,YAAL,GAAoB,IAApB;AACA,sBAAK3B,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,MAAKf,WAAL,CAAiByC;AADL,iBAApB;AAGD,eAjBM,MAiBA,IACL,MAAKhB,KAAL,IACA,MAAKD,aAAL,CAAmBC,KADnB,IAEA,MAAKD,aAAL,CAAmBtB,OAFnB,IAGA,MAAKsB,aAAL,CAAmBtB,OAAnB,KAA+B,MAAKsC,YAJ/B,EAKL;AACA,sBAAKA,YAAL,GAAoB,MAAKhB,aAAL,CAAmBtB,OAAvC;AACA,sBAAKD,oBAAL,CAA0B,MAAKuC,YAA/B;AACD,eARM,MAQA,IACL,MAAKf,KAAL,IACA,MAAKE,oBADL,IAEA,MAAKA,oBAAL,CAA0BF,KAF1B,IAGA,MAAKM,aAAL,KAAuB,MAAKJ,oBAAL,CAA0BK,YAJ5C,EAKL;AACA,sBAAKD,aAAL,GAAqB,MAAKJ,oBAAL,CAA0BK,YAA/C;AACA;AACA,oBAAI,MAAKD,aAAT,EAAwB;AACtB,sBAAI,MAAKL,oBAAL,CAA0BO,qBAA9B,EAAqD;AACnD,0BAAKS,MAAL;AACD;AACF;AACF;;AA3Dc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KArEd;;AAKD,UAAKpB,KAAL,GAAa7B,IAAb;AACA,UAAKkD,OAAL,GAAejD,MAAf;AACA,UAAKkD,QAAL,GAAgB9C,OAAhB;AACA,UAAK0B,aAAL,GAAqB7B,YAArB;AACA,UAAKgC,oBAAL,GAA4B/B,mBAA5B;AACA,UAAK8B,oBAAL,GAA4B7B,mBAA5B;AACA,UAAKgD,kCAAL,GAA0C,uCAA1C;AACA,QAAI,MAAKD,QAAT,EAAmB;AACjB,YAAKE,QAAL,GAAgB,0CAA2B,MAAK9C,WAAhC,CAAhB;AACA,YAAK4C,QAAL,CAAcG,eAAd,CAA8B;AAC5BC,aAAK,MAAKH,kCADkB;AAE5BI,iBAAS,2DAAkC,MAAKjD,WAAvC;AAFmB,OAA9B;AAID,KAND,MAMO;AACL,YAAK8C,QAAL,GAAgB,0CAA2B,MAAK9C,WAAhC,EAA6C;AAC3DkD,iCAAyB,2DAAkC,MAAKlD,WAAvC;AADkC,OAA7C,CAAhB;AAGD;AACD,UAAKwC,YAAL,GAAoB,IAApB;AACA,UAAKW,WAAL,CAAiB,eAAjB,EACE;AAAA,aAAM,MAAKC,KAAL,CAAWC,KAAjB;AAAA,KADF,EAEE;AAAA,aAASA,MAAMC,GAAN,CAAU;AAAA,eAAQC,KAAKC,SAAb;AAAA,OAAV,CAAT;AAAA,KAFF;;AAKA,UAAKL,WAAL,CAAiB,OAAjB,EACE;AAAA,aAAM,MAAKC,KAAL,CAAWK,IAAjB;AAAA,KADF,EAEE;AAAA,aACE,8CAAyBA,IAAzB,EACGC,MADH,CACU;AAAA,eAAQ,CAAC,6BAAQH,IAAR,CAAT;AAAA,OADV,CADF;AAAA,KAFF;AAOA,UAAKf,YAAL,GAAoB,IAApB;AACA,UAAKD,oBAAL,GAA4B,IAA5B;AACA,UAAKhC,aAAL,GAAqB,CAArB;AAtCC;AAuCF;;;;iCA4FY;AACX,WAAKM,KAAL,CAAWsB,SAAX,CAAqB,KAAKd,cAA1B;AACD;;;;;;;;;;;AAiBC,qBAAKR,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKf,WAAL,CAAiBkC;AADL,iBAApB;AAGQyB,uB,GAAY,KAAKrC,K,CAAjBqC,O;;;uBASK,KAAKhB,OAAL,CAAaiB,OAAb,CAAqBC,QAArB,GACRC,GADQ,CACJ,8BAAoB1B,uBADhB,C;;;uCAC0C2B,I;AAPnDvD,2B,SAAAA,W;AACAC,yB,SAAAA,S;AACAC,+B,SAAAA,e;AACAC,8B,SAAAA,c;AACAC,0B,SAAAA,U;AACAV,uB,SAAAA,O;;AAGF,oBAAI,KAAKoB,KAAL,CAAWqC,OAAX,KAAuBA,OAA3B,EAAoC;AAClC,uBAAK9C,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKf,WAAL,CAAiBgE,YADL;AAElBxD,4CAFkB;AAGlBC,wCAHkB;AAIlBC,oDAJkB;AAKlBC,kDALkB;AAMlBC,0CANkB;AAOlBV,oCAPkB;AAQlBgB,+BAAWC,KAAKC,GAAL;AARO,mBAApB;AAUA,uBAAK6C,QAAL,GAAgB,IAAhB;AACD;;;;;;;;AAED,oBAAI,KAAK3C,KAAL,CAAWqC,OAAX,KAAuBA,OAA3B,EAAoC;AAClC,uBAAK9C,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,KAAKf,WAAL,CAAiBkE,UADL;AAElBC;AAFkB,mBAApB;AAIA,uBAAKF,QAAL,GAAgB,IAAhB;AACD;;;;;;;;;;;;;;;;;;wBAjDM;AACT,aAAO,KAAKb,KAAL,CAAWK,IAAlB;AACD;;;wBACW;AACV,aAAO,KAAKW,UAAL,CAAgBf,KAAhB,EAAP;AACD;;;wBAEqB;AACpB,aAAO,KAAKD,KAAL,CAAW1C,eAAlB;AACD;;;wBAEmB;AAClB,aAAO,KAAK0D,UAAL,CAAgBC,aAAhB,EAAP;AACD;;;;kBArKkB9E,gB","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport Presence from '../Presence';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { getLastNotDisturbDndStatusReducer } from '../Presence/getPresenceReducer';\nimport actionTypes from './actionTypes';\nimport getDetailedPresenceReducer from './getDetailedPresenceReducer';\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport {\n  isEnded,\n  removeInboundRingOutLegs,\n} from '../../lib/callLogHelpers';\n\nconst presenceRegExp = /.*\\/presence\\?detailedTelephonyState=true&sipData=true/;\n\n/**\n * @class\n * @description Presence detail info managing module\n */\n@Module({\n  deps: [\n    'Auth',\n    'Client',\n    'Storage',\n    'Subscription',\n    'RolesAndPermissions',\n    'ConnectivityMonitor'\n  ]\n})\nexport default class DetailedPresence extends Presence {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Auth} params.auth - auth module instance\n   * @param {Client} params.client - client module instance\n   * @param {Subscription} params.subscription - subscription module instance\n   * @param {ConnectivityMonitor} params.connectivityMonitor - connectivityMonitor module instance\n   */\n  constructor({\n    auth,\n    client,\n    subscription,\n    connectivityMonitor,\n    rolesAndPermissions,\n    storage,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._client = client;\n    this._storage = storage;\n    this._subscription = subscription;\n    this._connectivityMonitor = connectivityMonitor;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this._lastNotDisturbDndStatusStorageKey = 'lastNotDisturbDndStatusDetailPresence';\n    if (this._storage) {\n      this._reducer = getDetailedPresenceReducer(this.actionTypes);\n      this._storage.registerReducer({\n        key: this._lastNotDisturbDndStatusStorageKey,\n        reducer: getLastNotDisturbDndStatusReducer(this.actionTypes)\n      });\n    } else {\n      this._reducer = getDetailedPresenceReducer(this.actionTypes, {\n        lastNotDisturbDndStatus: getLastNotDisturbDndStatusReducer(this.actionTypes),\n      });\n    }\n    this._lastMessage = null;\n    this.addSelector('sessionIdList',\n      () => this.state.calls,\n      calls => calls.map(call => call.sessionId),\n    );\n\n    this.addSelector('calls',\n      () => this.state.data,\n      data => (\n        removeInboundRingOutLegs(data)\n          .filter(call => !isEnded(call))\n      ),\n    );\n    this._lastMessage = null;\n    this._lastTelephonyStatus = null;\n    this._lastSequence = 0;\n  }\n\n  _subscriptionHandler = (message) => {\n    if (presenceRegExp.test(message.event) && message.body) {\n      if (message.body.sequence) {\n        if (message.body.sequence <= this._lastSequence) {\n          return;\n        }\n        this._lastSequence = message.body.sequence;\n      }\n      const {\n        activeCalls,\n        dndStatus,\n        telephonyStatus,\n        presenceStatus,\n        userStatus,\n      } = message.body;\n      this.store.dispatch({\n        type: this.actionTypes.notification,\n        activeCalls,\n        dndStatus,\n        telephonyStatus,\n        presenceStatus,\n        userStatus,\n        message: message.body.message,\n        lastDndStatus: this.dndStatus,\n        timestamp: Date.now(),\n      });\n    }\n  }\n  _onStateChange = async () => {\n    if (\n      this._auth.loggedIn &&\n      this._subscription.ready &&\n      this._rolesAndPermissions.ready &&\n      (!this._connectivityMonitor || this._connectivityMonitor.ready) &&\n      this.status === moduleStatuses.pending\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (this._connectivityMonitor) {\n        this._connectivity = this._connectivityMonitor.connectivity;\n      }\n      if (this._rolesAndPermissions.hasPresencePermission) {\n        await this.fetch();\n        this._subscription.subscribe(subscriptionFilters.detailedPresenceWithSip);\n      }\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (\n      (\n        !this._auth.loggedIn ||\n        !this._subscription.ready ||\n        (this._connectivityMonitor && !this._connectivityMonitor.ready)\n      ) &&\n      this.ready\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.reset,\n      });\n      this._lastTelephonyStatus = null;\n      this._lastSequence = 0;\n      this._lastMessage = null;\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    } else if (\n      this.ready &&\n      this._subscription.ready &&\n      this._subscription.message &&\n      this._subscription.message !== this._lastMessage\n    ) {\n      this._lastMessage = this._subscription.message;\n      this._subscriptionHandler(this._lastMessage);\n    } else if (\n      this.ready &&\n      this._connectivityMonitor &&\n      this._connectivityMonitor.ready &&\n      this._connectivity !== this._connectivityMonitor.connectivity\n    ) {\n      this._connectivity = this._connectivityMonitor.connectivity;\n      // fetch data on regain connectivity\n      if (this._connectivity) {\n        if (this._rolesAndPermissions.hasPresencePermission) {\n          this._fetch();\n        }\n      }\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(this._onStateChange);\n  }\n\n  get data() {\n    return this.state.data;\n  }\n  get calls() {\n    return this._selectors.calls();\n  }\n\n  get telephonyStatus() {\n    return this.state.telephonyStatus;\n  }\n\n  get sessionIdList() {\n    return this._selectors.sessionIdList();\n  }\n  async _fetch() {\n    this.store.dispatch({\n      type: this.actionTypes.fetch,\n    });\n    const { ownerId } = this._auth;\n    try {\n      const {\n        activeCalls,\n        dndStatus,\n        telephonyStatus,\n        presenceStatus,\n        userStatus,\n        message,\n      } = (await this._client.service.platform()\n        .get(subscriptionFilters.detailedPresenceWithSip)).json();\n      if (this._auth.ownerId === ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.fetchSuccess,\n          activeCalls,\n          dndStatus,\n          telephonyStatus,\n          presenceStatus,\n          userStatus,\n          message,\n          timestamp: Date.now(),\n        });\n        this._promise = null;\n      }\n    } catch (error) {\n      if (this._auth.ownerId === ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.fetchError,\n          error,\n        });\n        this._promise = null;\n      }\n    }\n  }\n}\n"]}
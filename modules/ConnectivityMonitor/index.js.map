{"version":3,"sources":["modules/ConnectivityMonitor/index.ts"],"names":["DEFAULT_TIME_TO_RETRY","DEFAULT_HEART_BEAT_INTERVAL","defaultCheckConnectionFn","fetch","ConnectivityMonitor","deps","dep","optional","client","environment","timeToRetry","heartBeatInterval","checkConnectionFunc","options","actionTypes","_client","ensureExist","call","_environment","_timeToRetry","_heartBeatInterval","_reducer","_retryTimeoutId","_lastEnvironmentCounter","_requestSuccessHandler","bind","_requestErrorHandler","_networkErrorHandler","_checkConnectionFunc","pending","ready","changeCounter","_shouldInit","_bindHandlers","store","dispatch","type","initSuccess","_retry","_shouldRebindHandlers","subscribe","_onStateChange","res","connectivity","connectSuccess","error","message","rateLimiterErrorMessage","rateLimitReached","availabilityErrorMessages","serviceLimited","response","connectFail","networkLoss","_unbindHandlers","service","on","events","requestSuccess","requestError","window","addEventListener","removeListener","removeEventListener","clearTimeout","t","_clearTimeout","setTimeout","_checkConnection","state","status","moduleStatuses","RcModule","proxify"],"mappings":"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","sourcesContent":["import 'isomorphic-fetch';\n\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport ensureExist from '../../lib/ensureExist';\nimport proxify from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport availabilityErrorMessages from '../AvailabilityMonitor/errorMessages';\nimport rateLimiterErrorMessage from '../RateLimiter/errorMessages';\nimport actionTypes from './actionTypes';\nimport getConnectivityMonitorReducer from './getConnectivityMonitorReducer';\n\nexport const DEFAULT_TIME_TO_RETRY = 5 * 1000;\nexport const DEFAULT_HEART_BEAT_INTERVAL = 60 * 1000;\n\nasync function defaultCheckConnectionFn() {\n  return fetch('https://pubsub.pubnub.com/time/0');\n}\n\n/**\n * @class\n * @description Connectivity monitor module\n */\n@Module({\n  deps: [\n    'Client',\n    { dep: 'Environment', optional: true },\n    { dep: 'ConnectivityMonitorOptions', optional: true },\n  ],\n})\nexport default class ConnectivityMonitor extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Environment} params.environment - environment module instance\n   * @param {Number} params.timeToRetry - time to Retry\n   * @param {Number} params.heartBeatInterval - heart beat interval\n   * @param {Function} params.checkConnectionFunc - function to check network\n   */\n  constructor({\n    client,\n    environment,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    heartBeatInterval = DEFAULT_HEART_BEAT_INTERVAL,\n    checkConnectionFunc = defaultCheckConnectionFn,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = ensureExist.call(this, client, 'client');\n    this._environment = environment;\n    this._timeToRetry = timeToRetry;\n    this._heartBeatInterval = heartBeatInterval;\n    this._reducer = getConnectivityMonitorReducer(this.actionTypes);\n    this._retryTimeoutId = null;\n    this._lastEnvironmentCounter = 0;\n\n    // auto bind this\n    this._requestSuccessHandler = this._requestSuccessHandler.bind(this);\n    this._requestErrorHandler = this._requestErrorHandler.bind(this);\n    this._networkErrorHandler = this._networkErrorHandler.bind(this);\n\n    this._checkConnectionFunc = async () => {\n      try {\n        await checkConnectionFunc();\n        this._requestSuccessHandler();\n      } catch (error) {\n        this._requestErrorHandler(error);\n      }\n    };\n  }\n\n  _shouldInit() {\n    return !!(this.pending && (!this._environment || this._environment.ready));\n  }\n\n  _shouldRebindHandlers() {\n    return !!(\n      this.ready &&\n      this._environment &&\n      this._environment.ready &&\n      this._environment.changeCounter !== this._lastEnvironmentCounter\n    );\n  }\n\n  _onStateChange() {\n    if (this._shouldInit()) {\n      this._bindHandlers();\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      this._retry();\n    } else if (this._shouldRebindHandlers()) {\n      this._lastEnvironmentCounter = this._environment.changeCounter;\n      this._bindHandlers();\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _requestSuccessHandler(res) {\n    if (!this.connectivity) {\n      this.store.dispatch({\n        type: this.actionTypes.connectSuccess,\n      });\n    }\n    this._retry();\n  }\n\n  _requestErrorHandler(error) {\n    if (\n      error.message &&\n      (error.message === rateLimiterErrorMessage.rateLimitReached ||\n        error.message === availabilityErrorMessages.serviceLimited)\n    )\n      return;\n\n    if (!error.response) {\n      if (this.connectivity) {\n        this.store.dispatch({\n          type: this.actionTypes.connectFail,\n        });\n      }\n    }\n    this._retry();\n  }\n\n  _networkErrorHandler() {\n    if (!this.networkLoss) {\n      this.store.dispatch({\n        type: this.actionTypes.networkLoss,\n      });\n    }\n    this._retry();\n  }\n\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.client();\n    client.on(client.events.requestSuccess, this._requestSuccessHandler);\n    client.on(client.events.requestError, this._requestErrorHandler);\n    if (typeof window !== 'undefined') {\n      window.addEventListener('offline', this._networkErrorHandler);\n    }\n    this._unbindHandlers = () => {\n      client.removeListener(\n        client.events.requestSuccess,\n        this._requestSuccessHandler,\n      );\n      client.removeListener(\n        client.events.requestError,\n        this._requestErrorHandler,\n      );\n      if (typeof window !== 'undefined') {\n        window.removeEventListener('offline', this._networkErrorHandler);\n      }\n      this._unbindHandlers = null;\n    };\n  }\n\n  @proxify\n  async _checkConnection() {\n    try {\n      await this._checkConnectionFunc();\n    } catch (error) {\n      // catch error\n    }\n  }\n\n  _clearTimeout() {\n    if (this._retryTimeoutId) {\n      clearTimeout(this._retryTimeoutId);\n      this._retryTimeoutId = null;\n    }\n  }\n\n  _retry(t = this.connectivity ? this._heartBeatInterval : this._timeToRetry) {\n    this._clearTimeout();\n    this._retryTimeoutId = setTimeout(() => {\n      this._retryTimeoutId = null;\n      this._checkConnection();\n    }, t);\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get connectivity() {\n    return this.state.connectivity;\n  }\n\n  get networkLoss() {\n    return this.state.networkLoss;\n  }\n}\n"],"file":"index.js"}
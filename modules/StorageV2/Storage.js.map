{"version":3,"sources":["modules/StorageV2/Storage.ts"],"names":["Storage","name","deps","dep","optional","StorageProvider","storageOptions","migrationMapping","_disableInactiveTabsWrite","_storage","_storageHandler","storedData","_deps","disableInactiveTabsWrite","ready","storageWritable","currentData","data","key","setItem","_StorageProvider","storageKey","getData","newKey","oldKey","index","_storageReducers","removeItem","setData","Object","prototype","hasOwnProperty","call","value","syncData","on","auth","loginStatus","loggedIn","tabManager","pending","notLoggedIn","off","removeListener","destroy","resetData","active","prefix","ownerId","StorageBase"],"mappings":"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","sourcesContent":["import { watch } from '@ringcentral-integration/core';\nimport { Module } from '../../lib/di';\nimport { StorageBase, IStorage } from '../../lib/StorageBaseV2';\nimport loginStatus from '../Auth/loginStatus';\nimport { Deps } from './Storage.interface';\n\n@Module({\n  name: 'Storage',\n  deps: [\n    'Auth',\n    { dep: 'TabManager', optional: true },\n    { dep: 'StorageOptions', optional: true },\n  ],\n})\nexport class Storage<T = {}> extends StorageBase<Deps & T> {\n  /* migration storage v1 to v2 */\n  public migrationMapping: Record<string, string | Record<string, string>> = {};\n  /* migration storage v1 to v2 */\n  protected _disableInactiveTabsWrite: boolean;\n  protected _storage: IStorage;\n  protected _storageHandler: ({\n    key,\n    value,\n  }: {\n    key: string;\n    value: unknown;\n  }) => void = null;\n\n  constructor(deps: Deps & T) {\n    super(deps, {\n      name: 'storage',\n      StorageProvider: deps.storageOptions?.StorageProvider,\n    });\n    this._disableInactiveTabsWrite =\n      this._deps.storageOptions?.disableInactiveTabsWrite ?? true;\n  }\n\n  storedData: Record<string, any> = {};\n\n  get storageWritable() {\n    return (\n      !this._disableInactiveTabsWrite ||\n      !this._deps.tabManager ||\n      this._deps.tabManager.active\n    );\n  }\n\n  onStateChange() {\n    if (this.ready && this.storageWritable) {\n      const currentData = this.data;\n      // save new data to storage when changed\n      for (const key in currentData) {\n        if (this.storedData[key] !== currentData[key]) {\n          this._storage.setItem(key, currentData[key]);\n          this.storedData[key] = currentData[key];\n        }\n      }\n    }\n  }\n\n  get storageKey() {\n    return `${this.prefix ? `${this.prefix}-` : ''}storage-${\n      this._deps.auth.ownerId\n    }`;\n  }\n\n  async onInit() {\n    this._storage = new this._StorageProvider({\n      storageKey: this.storageKey,\n    });\n    this.storedData = await this._storage.getData();\n    /* migration storage v1 to v2 */\n    /* eslint-disable */\n    for (const newKey in this.migrationMapping) {\n      const oldKey = this.migrationMapping[newKey];\n      if (typeof oldKey === 'string') {\n        if (this.storedData[oldKey]) {\n          this.storedData[newKey] = this.storedData[oldKey];\n        }\n      } else if (typeof oldKey === 'object') {\n        for (const index in oldKey) {\n          if (this.storedData[oldKey[index]]) {\n            this.storedData[newKey] = this.storedData[newKey] ?? {};\n            (this.storedData[newKey] as Record<string, any>)[\n              index\n            ] = this.storedData[oldKey[index]];\n          }\n        }\n      }\n      if (\n        typeof this.storedData[newKey] !== 'undefined' &&\n        this.storageWritable\n      ) {\n        this._storage.setItem(newKey, this.storedData[newKey]);\n      }\n    }\n    /* eslint-enable */\n    /* migration storage v1 to v2 */\n    for (const key in this.storedData) {\n      if (!this._storageReducers[key]) {\n        delete this.storedData[key];\n        await this._storage.removeItem(key);\n      }\n    }\n    this.setData({\n      ...this.data,\n      ...this.storedData,\n    });\n    const currentData = this.data;\n    for (const key in currentData) {\n      if (\n        !Object.prototype.hasOwnProperty.call(this.storedData, key) &&\n        this.storageWritable\n      ) {\n        this._storage.setItem(key, currentData[key]);\n      }\n    }\n  }\n\n  onInitSuccess() {\n    this._storageHandler = ({ key, value }) => {\n      if (this.ready) {\n        this.storedData[key] = value;\n        this.syncData(key, value);\n      }\n    };\n    this._storage.on('storage', this._storageHandler);\n  }\n\n  _shouldInit() {\n    return (\n      this._deps.auth.loginStatus === loginStatus.loggedIn &&\n      (!this._deps.tabManager || this._deps.tabManager.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      ((!!this._deps.tabManager && !this._deps.tabManager.ready) ||\n        this._deps.auth.notLoggedIn) &&\n      this.ready\n    );\n  }\n\n  onReset() {\n    if (this._storageHandler) {\n      if (this._storage.off) {\n        this._storage.off('storage', this._storageHandler);\n      } else if (this._storage.removeListener) {\n        this._storage.removeListener('storage', this._storageHandler);\n      }\n      this._storageHandler = null;\n    }\n    if (this._storage) {\n      this._storage.destroy();\n      this._storage = null;\n    }\n    this.resetData();\n  }\n}\n"],"file":"Storage.js"}
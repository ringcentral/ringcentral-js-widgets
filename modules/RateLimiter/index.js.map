{"version":3,"sources":["modules/RateLimiter/index.ts"],"names":["DEFAULT_THROTTLE_DURATION","RateLimiter","deps","dep","optional","alert","client","environment","globalStorage","throttleDuration","suppressAlerts","options","actionTypes","_beforeRequestHandler","throttling","Error","errorMessages","rateLimitReached","_checkTimestamp","store","dispatch","type","stopThrottle","_requestErrorHandler","error","message","_throttleDuration","response","retryAfter","headers","get","Number","parseInt","wasThrottling","startThrottle","timestamp","Date","now","showAlert","setTimeout","_alert","_client","_environment","_storage","_suppressAlerts","_storageKey","_reducer","registerReducer","key","reducer","_timeoutId","_lastEnvironmentCounter","subscribe","ready","_bindHandlers","initSuccess","changeCounter","warning","ttl","allowDuplicates","_unbindHandlers","service","on","events","requestError","beforeRequest","removeListener","state","status","getItem","moduleStatuses","RcModule","proxify"],"mappings":"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","sourcesContent":["import moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport proxify from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport { actionTypes } from './actionTypes';\nimport { errorMessages } from './errorMessages';\nimport getRateLimiterReducer, {\n  getTimestampReducer,\n} from './getRateLimiterReducer';\n\nconst DEFAULT_THROTTLE_DURATION = 61 * 1000;\n\n/**\n * @class\n * @description Rate limiter managing module\n */\n@Module({\n  deps: [\n    'Alert',\n    'Client',\n    { dep: 'Environment', optional: true },\n    'GlobalStorage',\n    { dep: 'RateLimiterOptions', optional: true },\n  ],\n})\nexport default class RateLimiter extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Alert} params.alert - alert module instance\n   * @param {Client} params.client - client module instance\n   * @param {Environment} params.environment - environment module instance\n   * @param {GlobalStorage} params.globalStorage - globalStorage module instance\n   * @param {Number} params.throttleDuration - throttle duration, default 61 seconds\n   */\n  constructor({\n    alert,\n    client,\n    environment,\n    globalStorage,\n    throttleDuration = DEFAULT_THROTTLE_DURATION,\n    suppressAlerts = false,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._alert = alert;\n    this._client = client;\n    this._environment = environment;\n    this._storage = globalStorage;\n    this._throttleDuration = throttleDuration;\n    this._suppressAlerts = suppressAlerts;\n    this._storageKey = 'rateLimiterTimestamp';\n    this._reducer = getRateLimiterReducer(this.actionTypes);\n    this._storage.registerReducer({\n      key: this._storageKey,\n      reducer: getTimestampReducer(this.actionTypes),\n    });\n    this._timeoutId = null;\n    this._lastEnvironmentCounter = 0;\n  }\n\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        !this.ready &&\n        this._storage.ready &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this._bindHandlers();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._environment &&\n        this._environment.changeCounter !== this._lastEnvironmentCounter\n      ) {\n        this._lastEnvironmentCounter = this._environment.changeCounter;\n        this._bindHandlers();\n      }\n    });\n  }\n\n  /**\n   * If the app is throttling, an incoming request will lead to an exception\n   */\n  _beforeRequestHandler = () => {\n    if (this.throttling) {\n      throw new Error(errorMessages.rateLimitReached);\n    }\n  };\n\n  _checkTimestamp = () => {\n    if (!this.throttling) {\n      this.store.dispatch({\n        type: this.actionTypes.stopThrottle,\n      });\n    }\n  };\n\n  @proxify\n  async showAlert() {\n    if (!this.throttling || !this._alert || this._suppressAlerts) {\n      return;\n    }\n\n    this._alert.warning({\n      message: errorMessages.rateLimitReached,\n      ttl: this.ttl,\n      allowDuplicates: false,\n    });\n  }\n\n  _requestErrorHandler = (error) => {\n    if (\n      !(error instanceof Error) ||\n      error.message !== 'Request rate exceeded'\n    ) {\n      return;\n    }\n\n    // Get `retry-after` from response headers first\n    this._throttleDuration = DEFAULT_THROTTLE_DURATION;\n    if (error.response) {\n      const retryAfter = error.response.headers.get('retry-after');\n      if (retryAfter) {\n        this._throttleDuration = 1000 * Number.parseInt(retryAfter, 10);\n      }\n    }\n\n    const wasThrottling = this.throttling;\n    this.store.dispatch({\n      type: this.actionTypes.startThrottle,\n      timestamp: Date.now(),\n    });\n    if (!wasThrottling) {\n      this.showAlert();\n    }\n    setTimeout(this._checkTimestamp, this._throttleDuration);\n  };\n\n  _bindHandlers() {\n    if (this._unbindHandlers) {\n      this._unbindHandlers();\n    }\n    const client = this._client.service.client();\n    // TODO: Bind the `rateLimitError` event instead\n    client.on(client.events.requestError, this._requestErrorHandler);\n    client.on(client.events.beforeRequest, this._beforeRequestHandler);\n    this._unbindHandlers = () => {\n      client.removeListener(\n        client.events.requestError,\n        this._requestErrorHandler,\n      );\n      client.removeListener(\n        client.events.beforeRequest,\n        this._beforeRequestHandler,\n      );\n      this._unbindHandlers = null;\n    };\n  }\n\n  get ttl() {\n    return this.throttling\n      ? this._throttleDuration - (Date.now() - this.timestamp)\n      : 0;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get timestamp() {\n    return this._storage.getItem(this._storageKey);\n  }\n\n  get throttleDuration() {\n    return this._throttleDuration;\n  }\n\n  /**\n   * Is in throttling status\n   */\n  get throttling() {\n    return Date.now() - this.timestamp <= this._throttleDuration;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n}\n"],"file":"index.js"}
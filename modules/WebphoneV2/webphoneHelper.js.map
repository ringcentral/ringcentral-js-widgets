{"version":3,"sources":["modules/WebphoneV2/webphoneHelper.ts"],"names":["environment","window","global","isChrome","navigator","browserUa","userAgent","toLowerCase","match","isFirefox","indexOf","isEnableMidLinesInSDP","version","parseInt","isWebSocketSupport","WebSocket","isWebRTCSupport","MediaStream","RTCPeerConnection","mediaDevices","getUserMedia","isBrowserSupport","extractHeadersData","session","headers","raw","data","split","map","sub","reduce","accum","key","value","Object","keys","length","__rc_partyData","__rc_callId","getCallQueueName","direction","toUserName","fromUserName","callDirections","outbound","queueName","endsWith","normalizeSession","request","to","displayName","from","id","callId","__rc_direction","callStatus","__rc_callStatus","uri","user","fromNumber","__rc_fromNumber","fromTag","toTag","startTime","Date","getTime","creationTime","__rc_creationTime","isOnHold","localHold","isOnMute","__rc_isOnMute","isOnFlip","__rc_isOnFlip","isOnTransfer","__rc_isOnTransfer","isToVoicemail","__rc_isToVoicemail","isForwarded","__rc_isForwarded","isReplied","__rc_isReplied","recordStatus","__rc_recordStatus","idle","contactMatch","__rc_contactMatch","minimized","__rc_minimized","partyData","lastActiveTime","__rc_lastActiveTime","cached","removed","callQueueName","warmTransferSessionId","__rc_transferSessionId","isRing","inbound","sessionStatus","connecting","sortByCreationTimeDesc","l","r","sortByLastActiveTimeDesc","isConferenceSession","isRecording","pending","recording"],"mappings":"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","sourcesContent":["import callDirections from '../../enums/callDirections';\nimport { camelize } from '../../lib/di/utils/utils';\nimport { recordStatus } from './recordStatus';\nimport { sessionStatus } from './sessionStatus';\nimport {\n  NormalizedSession,\n  PartyData,\n  WebphoneSession,\n  WebphoneSessionRequestHeaders,\n} from './Webphone.interface';\n\nlet environment: Window & typeof globalThis;\nif (typeof window !== 'undefined') {\n  environment = window;\n}\nif (typeof global !== 'undefined') {\n  environment = global.window || global;\n}\n\nexport function isChrome() {\n  if (!environment.navigator) {\n    return false;\n  }\n  const browserUa = environment.navigator.userAgent.toLowerCase();\n  return !!browserUa.match(/chrom(e|ium)/);\n}\n\nexport function isFirefox() {\n  if (!environment.navigator) {\n    return false;\n  }\n  const browserUa = environment.navigator.userAgent.toLowerCase();\n  return browserUa.indexOf('firefox') > -1 && !isChrome();\n}\n\nexport function isEnableMidLinesInSDP() {\n  if (!isFirefox()) {\n    return false;\n  }\n  const version = parseInt(\n    navigator.userAgent.toLowerCase().match(/firefox\\/([0-9]+)/)[1],\n    10,\n  );\n  return version >= 63;\n}\n\nexport function isWebSocketSupport() {\n  return !!(environment && environment.WebSocket);\n}\n\nexport function isWebRTCSupport() {\n  if (!environment.navigator) {\n    return false;\n  }\n  return !!(\n    environment.MediaStream &&\n    environment.RTCPeerConnection &&\n    environment.navigator.mediaDevices.getUserMedia\n  );\n}\n\nexport function isBrowserSupport() {\n  return isWebSocketSupport() && isWebRTCSupport();\n}\n\nexport function extractHeadersData(\n  session: WebphoneSession,\n  headers: WebphoneSessionRequestHeaders,\n) {\n  if (\n    headers &&\n    headers['P-Rc-Api-Ids'] &&\n    headers['P-Rc-Api-Ids'][0] &&\n    headers['P-Rc-Api-Ids'][0].raw\n  ) {\n    /**\n     * interface PartyData {\n     *  \"partyId\": String,\n     *  \"sessionId\": String\n     * }\n     *\n     * INFO: partyId is ID of the participant in current Session. Mostly it represents User on the call,\n     * it could be active participant (talking right now) or already disconnected User,\n     * e.g. who made a transfer to another person.\n     * To identify the User who owns the party you need to find owner.extensionId within party.\n     */\n    const data = headers['P-Rc-Api-Ids'][0].raw\n      .split(';')\n      .map((sub) => sub.split('='))\n      .reduce((accum, [key, value]) => {\n        accum[camelize(key)] = value;\n        return accum;\n      }, {} as { [key: string]: string });\n\n    if (Object.keys(data).length) {\n      session.__rc_partyData = data as PartyData;\n    }\n  }\n\n  if (\n    headers &&\n    headers['Call-ID'] &&\n    headers['Call-ID'][0] &&\n    headers['Call-ID'][0].raw\n  ) {\n    session.__rc_callId = headers['Call-ID'][0].raw;\n  }\n}\n\nexport function getCallQueueName({\n  direction,\n  toUserName,\n  fromUserName,\n}: {\n  direction: string;\n  toUserName: string;\n  fromUserName: string;\n}) {\n  if (direction === callDirections.outbound) {\n    return null;\n  }\n  let queueName = null;\n  if (toUserName && fromUserName === toUserName && toUserName.endsWith(' - ')) {\n    queueName = toUserName;\n  }\n  return queueName;\n}\n\nexport function normalizeSession(session?: WebphoneSession): NormalizedSession {\n  if (!session) {\n    return session;\n  }\n  const toUserName = session.request?.to?.displayName;\n  const fromUserName = session.request?.from?.displayName;\n  return {\n    id: session.id,\n    callId: session.__rc_callId,\n    direction: session.__rc_direction,\n    callStatus: session.__rc_callStatus,\n    to: session.request?.to?.uri?.user,\n    toUserName,\n    from: session.request?.from?.uri?.user,\n    fromNumber: session.__rc_fromNumber,\n    fromUserName,\n    fromTag: session.fromTag,\n    toTag: session.toTag,\n    startTime: session.startTime && new Date(session.startTime).getTime(),\n    creationTime: session.__rc_creationTime,\n    isOnHold: !!session.localHold,\n    isOnMute: !!session.__rc_isOnMute,\n    isOnFlip: !!session.__rc_isOnFlip,\n    isOnTransfer: !!session.__rc_isOnTransfer,\n    isToVoicemail: !!session.__rc_isToVoicemail,\n    isForwarded: !!session.__rc_isForwarded,\n    isReplied: !!session.__rc_isReplied,\n    recordStatus: session.__rc_recordStatus || recordStatus.idle,\n    contactMatch: session.__rc_contactMatch,\n    minimized: !!session.__rc_minimized,\n    partyData: session.__rc_partyData || null,\n    lastActiveTime: session.__rc_lastActiveTime,\n    cached: false,\n    removed: false,\n    callQueueName: getCallQueueName({\n      direction: session.__rc_direction,\n      toUserName,\n      fromUserName,\n    }),\n    warmTransferSessionId: session.__rc_transferSessionId,\n  };\n}\n\nexport function isRing(session: NormalizedSession) {\n  return !!(\n    session &&\n    session.direction === callDirections.inbound &&\n    session.callStatus === sessionStatus.connecting\n  );\n}\n\nexport function isOnHold(session: NormalizedSession) {\n  return !!(session && session.isOnHold);\n}\n\nexport function sortByCreationTimeDesc(\n  l: NormalizedSession,\n  r: NormalizedSession,\n) {\n  return r.startTime - l.startTime;\n}\n\nexport function sortByLastActiveTimeDesc(\n  l: NormalizedSession,\n  r: NormalizedSession,\n) {\n  if (!l || !r) {\n    return 0;\n  }\n  if (r.lastActiveTime !== l.lastActiveTime) {\n    return r.lastActiveTime - l.lastActiveTime;\n  }\n  return sortByCreationTimeDesc(l, r);\n}\n\n/**\n * HACK: this function is not very reliable, only use it before the merging complete.\n */\nexport function isConferenceSession(session: NormalizedSession) {\n  return session && session.to && session.to.indexOf('conf_') === 0;\n}\n\nexport function isRecording(session: NormalizedSession) {\n  return !!(\n    session &&\n    (session.recordStatus === recordStatus.pending ||\n      session.recordStatus === recordStatus.recording)\n  );\n}\n"],"file":"webphoneHelper.js"}
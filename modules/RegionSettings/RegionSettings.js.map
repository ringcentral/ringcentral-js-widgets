{"version":3,"sources":["modules/RegionSettings/RegionSettings.ts"],"names":["RegionSettings","name","deps","dep","optional","that","_deps","dialingPlan","plans","extensionInfo","country","availableCountries","countryCode","enableCache","storageKey","storage","migrationMapping","areaCode","data","ready","tabManager","active","checkRegionSettings","alert","warning","allowDuplicates","message","regionSettingsMessages","dialingPlansChanged","ttl","plan","isoCode","brand","brandConfig","allowRegionSettings","regionSettingsOptions","suppressSettingsChangedWarning","_alertSettingsChanged","_setData","danger","areaCodeInvalid","trim","info","saveSuccess","setData","length","hasMultiplePlans","isUSOrCA","homeCountry","find","homeCountryId","id","RcModuleV2","state","action","proxify"],"mappings":"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","sourcesContent":["import { find } from 'ramda';\n\nimport {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  watch,\n} from '@ringcentral-integration/core';\n\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport validateAreaCode from '../../lib/validateAreaCode';\nimport { Deps, RegionSettingsData } from './RegionSettings.interface';\nimport { regionSettingsMessages } from './regionSettingsMessages';\n\n@Module({\n  name: 'RegionSettings',\n  deps: [\n    'Brand',\n    'Alert',\n    'DialingPlan',\n    'ExtensionInfo',\n    'Storage',\n    { dep: 'TabManager', optional: true },\n    { dep: 'RegionSettingsOptions', optional: true },\n  ],\n})\nexport class RegionSettings extends RcModuleV2<Deps> {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'RegionSettings',\n    });\n    /* migration storage v1 to v2 */\n    if (this._deps.storage) {\n      this._deps.storage.migrationMapping =\n        this._deps.storage.migrationMapping ?? {};\n      this._deps.storage.migrationMapping['RegionSettings-data'] = {\n        countryCode: 'regionSettingsCountryCode',\n        areaCode: 'regionSettingsAreaCode',\n      };\n    }\n    /* migration storage v1 to v2 */\n  }\n\n  @storage\n  @state\n  data = {\n    countryCode: 'US',\n    areaCode: '',\n  };\n\n  get countryCode() {\n    return this.data.countryCode || 'US';\n  }\n\n  get areaCode() {\n    return this.data.areaCode || '';\n  }\n\n  @action\n  _setData({\n    countryCode = this.data.countryCode,\n    areaCode = this.data.areaCode,\n  }: RegionSettingsData) {\n    this.data.countryCode = countryCode;\n    this.data.areaCode = areaCode;\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this.availableCountries,\n      () => {\n        if (\n          this.ready &&\n          (!this._deps.tabManager || this._deps.tabManager.active)\n        ) {\n          this.checkRegionSettings();\n        }\n      },\n    );\n  }\n\n  onInit() {\n    if (!this._deps.tabManager || this._deps.tabManager.active) {\n      this.checkRegionSettings();\n    }\n  }\n\n  @computed((that: RegionSettings) => [\n    that._deps.dialingPlan.plans,\n    that._deps.extensionInfo.country,\n  ])\n  get availableCountries() {\n    const plans = this._deps.dialingPlan.plans;\n    const country = this._deps.extensionInfo.country;\n    if (plans && plans.length > 0) {\n      return plans;\n    }\n    return country ? [country] : [];\n  }\n\n  _alertSettingsChanged() {\n    this._deps.alert.warning({\n      allowDuplicates: false,\n      message: regionSettingsMessages.dialingPlansChanged,\n      ttl: 0,\n    });\n  }\n\n  @proxify\n  async checkRegionSettings() {\n    let { countryCode } = this;\n    if (\n      countryCode &&\n      !find((plan) => plan.isoCode === countryCode, this.availableCountries)\n    ) {\n      countryCode = null;\n      if (\n        this._deps.brand.brandConfig?.allowRegionSettings &&\n        !this._deps.regionSettingsOptions?.suppressSettingsChangedWarning\n      ) {\n        this._alertSettingsChanged();\n      }\n    }\n    if (!countryCode) {\n      const country =\n        find(\n          (plan) => plan.isoCode === this._deps.extensionInfo.country.isoCode,\n          this.availableCountries,\n        ) || this.availableCountries[0];\n      countryCode = country && country.isoCode;\n      this._setData({\n        countryCode,\n        areaCode: '',\n      });\n    }\n  }\n\n  @proxify\n  async setData({ areaCode, countryCode }: RegionSettingsData) {\n    if (!validateAreaCode(areaCode)) {\n      this._deps.alert.danger({\n        message: regionSettingsMessages.areaCodeInvalid,\n      });\n      return;\n    }\n    this._setData({\n      countryCode,\n      areaCode: areaCode && areaCode.trim(),\n    });\n    this._deps.alert.info({\n      message: regionSettingsMessages.saveSuccess,\n    });\n  }\n\n  setCountryCode(countryCode: RegionSettingsData['countryCode']) {\n    this.setData({\n      countryCode,\n    });\n  }\n\n  setAreaCode(areaCode: RegionSettingsData['areaCode']) {\n    this.setData({\n      areaCode,\n    });\n  }\n\n  @computed(({ availableCountries }: RegionSettings) => [availableCountries])\n  get showRegionSettings() {\n    const allowRegionSettings =\n      !!this._deps.brand.brandConfig.allowRegionSettings;\n    const hasMultiplePlans = this.availableCountries.length > 1;\n    const isUSOrCA =\n      this.availableCountries.length === 1 &&\n      (this.availableCountries[0].isoCode === 'US' ||\n        this.availableCountries[0].isoCode === 'CA');\n\n    return allowRegionSettings && (hasMultiplePlans || isUSOrCA);\n  }\n\n  @computed(({ availableCountries, countryCode }: RegionSettings) => [\n    availableCountries,\n    countryCode,\n  ])\n  get homeCountryId() {\n    const homeCountry = this.availableCountries.find(\n      (country) => country.isoCode === this.countryCode,\n    );\n    const homeCountryId = (homeCountry && homeCountry.id) || '1';\n    return homeCountryId;\n  }\n}\n"],"file":"RegionSettings.js"}
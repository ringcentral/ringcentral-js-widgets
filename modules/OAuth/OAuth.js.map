{"version":3,"sources":["modules/OAuth/OAuth.ts"],"names":["OAuth","name","deps","dep","optional","oAuthOptions","loginPath","redirectUri","restrictSameOriginRedirectUri","restOAuthOptions","_uuid","uuid","v4","_loginWindow","_redirectCheckTimeout","_isInElectron","window","addEventListener","close","error","data","callbackUri","_clearRedirectCheckTimeout","_handleCallbackUri","e","key","callbackUriStorageKey","newValue","localStorage","removeItem","ready","_deps","auth","loggedIn","routerInteraction","currentPath","oAuthReady","atLoginPage","setupOAuth","destroyOAuth","multiple","oAuthCallback","setOAuthReady","client","service","platform","discovery","loginUrlWithDiscovery","oAuthUri","isRedirectUriSameOrigin","_setupRedirectCheckTimeout","clearTimeout","setTimeout","closed","location","href","indexOf","prefix","origin","btoa","Date","now","encodeURIComponent","OAuthBase","background","proxify"],"mappings":"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","sourcesContent":["import * as uuid from 'uuid';\n\nimport background from '@ringcentral-integration/commons/lib/background';\nimport { Module } from '@ringcentral-integration/commons/lib/di';\nimport proxify from '@ringcentral-integration/commons/lib/proxy/proxify';\nimport { watch } from '@ringcentral-integration/core';\n\nimport { isElectron } from '../../lib/isElectron';\nimport { OAuthBase } from '../../lib/OAuthBase';\nimport { popWindow } from '../../lib/popWindow';\nimport { Deps } from './OAuth.interface';\n\n@Module({\n  name: 'OAuth',\n  deps: [\n    'Client',\n    'RouterInteraction',\n    { dep: 'OAuthOptions', optional: true },\n  ],\n})\nexport class OAuth extends OAuthBase<Deps> {\n  private _uuid = uuid.v4();\n\n  private _loginWindow: Window = null;\n  private _redirectCheckTimeout: ReturnType<typeof setTimeout> = null;\n  private _isInElectron = isElectron();\n\n  constructor({\n    oAuthOptions: {\n      loginPath = '/',\n      redirectUri = './redirect.html',\n      restrictSameOriginRedirectUri = true,\n      ...restOAuthOptions\n    } = {},\n    ...deps\n  }: Deps) {\n    super({\n      ...deps,\n      oAuthOptions: {\n        loginPath,\n        redirectUri,\n        restrictSameOriginRedirectUri,\n        ...restOAuthOptions,\n      },\n    });\n  }\n\n  get name() {\n    return 'OAuth';\n  }\n\n  get prefix() {\n    return this._deps.oAuthOptions?.prefix;\n  }\n\n  get restrictSameOriginRedirectUri() {\n    return this._deps.oAuthOptions?.restrictSameOriginRedirectUri;\n  }\n\n  get isRedirectUriSameOrigin() {\n    return this.restrictSameOriginRedirectUri\n      ? this.redirectUri.indexOf(window.origin) === 0\n      : true;\n  }\n\n  get authState() {\n    return `${btoa(`${Date.now()}`)}-${this.prefix}-${encodeURIComponent(\n      btoa(this._uuid),\n    )}`;\n  }\n\n  get callbackUriStorageKey() {\n    return `${this.prefix}-${encodeURIComponent(btoa(this._uuid))}-callbackUri`;\n  }\n\n  onInitOnce() {\n    super.onInitOnce && super.onInitOnce();\n    // close login window when unload and login window exist\n    window.addEventListener('beforeunload', () => {\n      if (this._loginWindow) {\n        try {\n          this._loginWindow.close();\n        } catch (error) {\n          /* ignore error */\n        }\n      }\n    });\n    // listen callback uri from redirect page, works with coss origin redirect page\n    window.addEventListener('message', ({ data = {} }) => {\n      if (!data) {\n        return;\n      }\n      const { callbackUri } = data;\n      if (callbackUri) {\n        this._clearRedirectCheckTimeout();\n        this._handleCallbackUri(callbackUri);\n      }\n    });\n    // listen callback uri from storage, works only with same origin\n    window.addEventListener('storage', (e) => {\n      if (\n        e.key === this.callbackUriStorageKey &&\n        e.newValue &&\n        e.newValue !== ''\n      ) {\n        const callbackUri = e.newValue;\n        localStorage.removeItem(this.callbackUriStorageKey);\n        this._clearRedirectCheckTimeout();\n        this._handleCallbackUri(callbackUri);\n      }\n    });\n\n    watch(\n      this,\n      () => [\n        this.ready,\n        this._deps.auth.loggedIn,\n        this._deps.routerInteraction.currentPath,\n        this._deps.oAuthOptions?.loginPath,\n        this.oAuthReady,\n      ],\n      () => {\n        const atLoginPage =\n          this._deps.routerInteraction.currentPath ===\n          this._deps.oAuthOptions?.loginPath;\n\n        if (\n          this.ready &&\n          !this._deps.auth.loggedIn &&\n          atLoginPage &&\n          !this.oAuthReady\n        ) {\n          this.setupOAuth();\n        } else if (this._deps.auth.loggedIn || !atLoginPage) {\n          this.destroyOAuth();\n        }\n      },\n      { multiple: true },\n    );\n  }\n\n  @background\n  async setupOAuth() {\n    if (this.oAuthReady) return;\n\n    window.oAuthCallback = (callbackUri) => {\n      this._clearRedirectCheckTimeout();\n      this._handleCallbackUri(callbackUri);\n    };\n\n    this.setOAuthReady(true);\n  }\n\n  @background\n  async destroyOAuth() {\n    if (!this.oAuthReady) return;\n\n    window.oAuthCallback = null;\n    this.setOAuthReady(false);\n  }\n\n  @proxify\n  async openOAuthPage() {\n    if (!this.oAuthReady) return;\n\n    if (this._deps.client.service.platform().discovery()) {\n      await this._deps.client.service.platform().loginUrlWithDiscovery();\n    }\n\n    this._loginWindow = popWindow(this.oAuthUri, 'rc-oauth', 600, 600);\n\n    if (this.isRedirectUriSameOrigin) {\n      this._setupRedirectCheckTimeout();\n    }\n  }\n\n  @proxify\n  async openOAuthPageInOtherRouter() {\n    if (this._deps.client.service.platform().discovery()) {\n      await this._deps.client.service.platform().loginUrlWithDiscovery();\n    }\n    this._loginWindow = popWindow(this.oAuthUri, 'rc-oauth', 600, 600);\n\n    if (this.isRedirectUriSameOrigin) {\n      this._setupRedirectCheckTimeout();\n    }\n  }\n\n  private _clearRedirectCheckTimeout() {\n    if (this._redirectCheckTimeout === null) return;\n\n    clearTimeout(this._redirectCheckTimeout);\n  }\n\n  private _setupRedirectCheckTimeout() {\n    this._clearRedirectCheckTimeout();\n    this._redirectCheckTimeout = setTimeout(() => {\n      this._redirectCheckTimeout = null;\n\n      if (\n        !this._loginWindow ||\n        this._loginWindow.closed ||\n        // for electron, the .window is always undefined\n        (!this._isInElectron && !this._loginWindow.window)\n      ) {\n        this._loginWindow = null;\n        return;\n      }\n\n      try {\n        const callbackUri = this._loginWindow.location.href;\n        if (callbackUri.indexOf(this.redirectUri) !== -1) {\n          this._loginWindow.close();\n          this._loginWindow = null;\n          this._handleCallbackUri(callbackUri);\n          return;\n        }\n      } catch (e) {\n        // ignore e\n        // console.log('checking redirect uri');\n      }\n      this._setupRedirectCheckTimeout();\n    }, 1000);\n  }\n}\n"],"file":"OAuth.js"}
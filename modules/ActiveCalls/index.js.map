{"version":3,"sources":["modules/ActiveCalls/index.js"],"names":["presenceRegExp","FETCH_DELAY","DEFAULT_TTL","ActiveCalls","deps","dep","optional","client","rolesAndPermissions","tabManager","fetchDelay","ttl","options","name","getDataReducer","subscriptionFilters","detailedPresenceWithSip","subscriptionHandler","message","test","event","ownerId","_auth","_fetchDelay","fetchData","fetchFunction","_client","account","extension","activeCalls","list","params","_rolesAndPermissions","addSelector","data","ready","permissions","ReadCallLog","_selectors","calls"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAIA,IAAMA,iBAAiB,yCAAvB;AACA,IAAMC,cAAc,IAApB;AACA,IAAMC,cAAc,IAAI,EAAJ,GAAS,IAA7B;;AAEA;;;;IAYqBC,W,WARpB,gBAAO;AACNC,QAAM,CACJ,QADI,EAEJ,qBAFI,EAGJ,EAAEC,KAAK,YAAP,EAAqBC,UAAU,IAA/B,EAHI,EAIJ,EAAED,KAAK,oBAAP,EAA6BC,UAAU,IAAvC,EAJI;AADA,CAAP,C;;;AASC;;;;;;AAMA,6BAOG;AAAA;;AAAA,QANDC,MAMC,QANDA,MAMC;AAAA,QALDC,mBAKC,QALDA,mBAKC;AAAA,QAJDC,UAIC,QAJDA,UAIC;AAAA,+BAHDC,UAGC;AAAA,QAHDA,UAGC,mCAHYT,WAGZ;AAAA,wBAFDU,GAEC;AAAA,QAFDA,GAEC,4BAFKT,WAEL;AAAA,QADEU,OACF;AAAA;;AAAA,2KAEIA,OAFJ;AAGCC,YAAM,aAHP;AAICN,oBAJD;AAKCI,cALD;AAMCG,2DAND;AAOCC,2BAAqB,CAAC,8BAAoBC,uBAArB,CAPtB;AAQCC;AAAA,+EAAqB,iBAAOC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACflB,eAAemB,IAAf,CAAoBD,QAAQE,KAA5B,CADe;AAAA;AAAA;AAAA;;AAETC,yBAFS,GAEG,MAAKC,KAFR,CAETD,OAFS;AAAA;AAAA,yBAGX,qBAAM,MAAKE,WAAX,CAHW;;AAAA;AAAA,wBAIbF,YAAY,MAAKC,KAAL,CAAWD,OAJV;AAAA;AAAA;AAAA;;AAAA;AAAA,yBAKT,MAAKG,SAAL,EALS;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAArB;;AAAA;AAAA;AAAA;AAAA,SARD;AAiBCC;AAAA,+EAAe;AAAA;AAAA;AAAA;AAAA;AAAA,oDAAY,yBAAU;AAAA,2BACnC,MAAKC,OAAL,CAAaC,OAAb,GAAuBC,SAAvB,GAAmCC,WAAnC,GAAiDC,IAAjD,CAAsDC,MAAtD,CADmC;AAAA,mBAAV,CAAZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAf;;AAAA;AAAA;AAAA;AAAA;AAjBD;;AAqBD,UAAKR,WAAL,GAAmBb,UAAnB;AACA,UAAKsB,oBAAL,GAA4BxB,mBAA5B;AACA,UAAKyB,WAAL,CACE,OADF,EAEE;AAAA,aAAM,MAAKC,IAAX;AAAA,KAFF,EAGE;AAAA,aAAQA,QAAQ,EAAhB;AAAA,KAHF;AAvBC;AA4BF;;;;kCAEa;AACZ,aAAO,+IAAuB,KAAKF,oBAAL,CAA0BG,KAAxD;AACD;;;wBAEoB;AACnB,aAAO,KAAKH,oBAAL,CAA0BI,WAA1B,CAAsCC,WAA7C;AACD;;;wBAEW;AACV,aAAO,KAAKC,UAAL,CAAgBC,KAAhB,EAAP;AACD;;;;kBAtDkBpC,W","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport DataFetcher from '../../lib/DataFetcher';\nimport sleep from '../../lib/sleep';\nimport fetchList from '../../lib/fetchList';\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport {\n  getDataReducer\n} from './getActiveCallsReducer';\n\nconst presenceRegExp = /\\/presence\\?detailedTelephonyState=true/;\nconst FETCH_DELAY = 1000;\nconst DEFAULT_TTL = 5 * 60 * 1000;\n\n/**\n * @class\n * @description Active calls list manaing module\n */\n@Module({\n  deps: [\n    'Client',\n    'RolesAndPermissions',\n    { dep: 'TabManager', optional: true },\n    { dep: 'ActiveCallsOptions', optional: true }\n  ]\n})\nexport default class ActiveCalls extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Number} params.ttl - local cache timestamp, default 5 mins.\n   */\n  constructor({\n    client,\n    rolesAndPermissions,\n    tabManager, // do not pass tabManager to DataFetcher as data is not shared in localStorage\n    fetchDelay = FETCH_DELAY,\n    ttl = DEFAULT_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      name: 'activeCalls',\n      client,\n      ttl,\n      getDataReducer,\n      subscriptionFilters: [subscriptionFilters.detailedPresenceWithSip],\n      subscriptionHandler: async (message) => {\n        if (presenceRegExp.test(message.event)) {\n          const { ownerId } = this._auth;\n          await sleep(this._fetchDelay);\n          if (ownerId === this._auth.ownerId) {\n            await this.fetchData();\n          }\n        }\n      },\n      fetchFunction: async () => fetchList(params =>\n        this._client.account().extension().activeCalls().list(params)\n      )\n    });\n    this._fetchDelay = fetchDelay;\n    this._rolesAndPermissions = rolesAndPermissions;\n    this.addSelector(\n      'calls',\n      () => this.data,\n      data => data || [],\n    );\n  }\n\n  _shouldInit() {\n    return super._shouldInit() && this._rolesAndPermissions.ready;\n  }\n\n  get _hasPermission() {\n    return this._rolesAndPermissions.permissions.ReadCallLog;\n  }\n\n  get calls() {\n    return this._selectors.calls();\n  }\n}\n"]}
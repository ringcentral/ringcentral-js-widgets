{"version":3,"sources":["modules/RolesAndPermissions/index.js"],"names":["DEFAULT_TTL","extractData","permissions","output","forEach","item","permission","id","RolesAndPermissions","deps","dep","optional","isCRM","flag","client","alert","extensionInfo","ttl","options","name","fetchFunction","_client","account","extension","authzProfile","get","readyCheckFn","_extensionInfo","ready","forbiddenHandler","_auth","logout","_alert","danger","message","insufficientPrivilege","cleanOnReset","_isCRM","_flag","addSelector","data","loginStatus","loggedIn","tierEnabled","invalidTier","ReadUserInfo","fetchData","serviceFeatures","_selectors","RingOut","enabled","WebPhone","webphoneEnabled","ringoutEnabled","ReadCallLog","callingEnabled","ReadPresenceStatus","EditPresenceStatus","Pager","SMS","readTextPermissions","voicemailPermissions","readFaxPermissions","PagerReceiving","SMSReceiving","Voicemail","FaxReceiving","hasReadMessagesPermission","Conferencing"],"mappings":"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","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport DataFetcher from '../../lib/DataFetcher';\nimport permissionsMessages from './permissionsMessages';\nimport loginStatus from '../Auth/loginStatus';\nimport ensureExist from '../../lib/ensureExist';\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\n\nfunction extractData(permissions) {\n  const output = {};\n  permissions.permissions.forEach((item) => {\n    output[item.permission.id] = true;\n  });\n  return output;\n}\n\n/**\n * @class\n * @description Roles and permission module\n */\n@Module({\n  deps: [\n    'Client', 'Alert', 'ExtensionInfo',\n    { dep: 'RolesAndPermissionsOptions', optional: true }\n  ]\n})\nexport default class RolesAndPermissions extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Alert} params.alert - alert module instance\n   * @param {ExtensionInfo} params.extensionInfo - extensionInfo module instance\n   * @param {Bool} params.isCRM - if it is CRM\n   * @param {String} params.flag - app flag\n   * @param {Number} params.ttl - local cache time\n   */\n  constructor({\n    isCRM,\n    flag,\n    client,\n    alert,\n    extensionInfo,\n    ttl = DEFAULT_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      name: 'rolesAndPermissions',\n      client,\n      ttl,\n      fetchFunction: async () => extractData(\n        await this._client.account().extension().authzProfile().get()\n      ),\n      readyCheckFn: () => this._extensionInfo.ready,\n      forbiddenHandler: async () => {\n        await this._auth.logout();\n        this._alert.danger({\n          message: permissionsMessages.insufficientPrivilege,\n          ttl: 0,\n        });\n        return {};\n      },\n      cleanOnReset: true,\n    });\n    this._isCRM = !!isCRM;\n    this._flag = flag || 'SalesForce';\n    this._alert = ensureExist(alert, 'alert');\n    this._extensionInfo = ensureExist(extensionInfo, 'extensionInfo');\n    this.addSelector(\n      'permissions',\n      () => this.data,\n      data => data || {},\n    );\n  }\n\n  async _onStateChange() {\n    await super._onStateChange();\n    if (this.ready &&\n      this._auth.loginStatus === loginStatus.loggedIn &&\n      this._isCRM &&\n      this.tierEnabled !== null &&\n      !this.tierEnabled\n    ) {\n      await this._auth.logout();\n      this._alert.danger({\n        message: permissionsMessages.invalidTier,\n        ttl: 0,\n      });\n    }\n    if (\n      this.ready &&\n      this._auth.loginStatus === loginStatus.loggedIn &&\n      !this.permissions.ReadUserInfo\n    ) {\n      await this._auth.logout();\n      this._alert.danger({\n        message: permissionsMessages.insufficientPrivilege,\n        ttl: 0,\n      });\n    }\n  }\n\n  refreshServiceFeatures() {\n    if (this._extensionInfo.ready) {\n      this._extensionInfo.fetchData();\n    }\n  }\n\n  get serviceFeatures() {\n    return this._extensionInfo.serviceFeatures;\n  }\n\n  get permissions() {\n    return this._selectors.permissions();\n  }\n\n  get ringoutEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.RingOut &&\n      this._extensionInfo.serviceFeatures.RingOut.enabled\n    );\n  }\n\n  get webphoneEnabled() {\n    return !!(\n      this._extensionInfo.serviceFeatures &&\n      this._extensionInfo.serviceFeatures.WebPhone &&\n      this._extensionInfo.serviceFeatures.WebPhone.enabled\n    );\n  }\n\n  get callingEnabled() {\n    return this.webphoneEnabled || this.ringoutEnabled;\n  }\n\n  get tierEnabled() {\n    if (\n      !this._extensionInfo.serviceFeatures ||\n      !this._extensionInfo.serviceFeatures[this._flag]\n    ) {\n      return null;\n    }\n    return this._extensionInfo.serviceFeatures[this._flag].enabled;\n  }\n\n  get hasReadCallLogPermission() {\n    return !!(\n      this.ready &&\n      this.permissions &&\n      this.permissions.ReadCallLog\n    );\n  }\n\n  get hasPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions && this.permissions.ReadPresenceStatus\n    );\n  }\n\n  get hasEditPresencePermission() {\n    return !!(\n      this.ready &&\n      this.callingEnabled &&\n      this.permissions &&\n      this.permissions.EditPresenceStatus\n    );\n  }\n\n  get hasComposeTextPermission() {\n    return !!(\n      this.serviceFeatures && (\n        (this.serviceFeatures.Pager && this.serviceFeatures.Pager.enabled) ||\n        (this.serviceFeatures.SMS && this.serviceFeatures.SMS.enabled)\n      )\n    );\n  }\n  get onlyPagerPermission() {\n    return !!(\n      this.serviceFeatures && (\n        (this.serviceFeatures.Pager && this.serviceFeatures.Pager.enabled) &&\n        (this.serviceFeatures.SMS && !this.serviceFeatures.SMS.enabled)\n      )\n    );\n  }\n\n  get hasReadMessagesPermission() {\n    return this.ready && (\n      this.readTextPermissions ||\n      this.voicemailPermissions ||\n      this.readFaxPermissions\n    );\n  }\n\n  get readTextPermissions() {\n    return !!(\n      this.serviceFeatures && (\n        (\n          this.serviceFeatures.PagerReceiving &&\n          this.serviceFeatures.PagerReceiving.enabled\n        ) ||\n        (\n          this.serviceFeatures.SMSReceiving &&\n          this.serviceFeatures.SMSReceiving.enabled\n        )\n      )\n    );\n  }\n\n  get voicemailPermissions() {\n    return !!(\n      this.callingEnabled &&\n      this.serviceFeatures && (\n        this.serviceFeatures.Voicemail &&\n        this.serviceFeatures.Voicemail.enabled\n      )\n    );\n  }\n\n  get readFaxPermissions() {\n    return !!(\n      this.serviceFeatures && (\n        this.serviceFeatures.FaxReceiving &&\n        this.serviceFeatures.FaxReceiving.enabled\n      )\n    );\n  }\n\n  get hasUserGuidePermission() {\n    return !!(this.callingEnabled || this.hasReadMessagesPermission);\n  }\n\n  get hasConferencingPermission() {\n    return !!(\n      this.serviceFeatures && (\n        this.serviceFeatures.Conferencing &&\n        this.serviceFeatures.Conferencing.enabled\n      )\n    );\n  }\n}\n"]}
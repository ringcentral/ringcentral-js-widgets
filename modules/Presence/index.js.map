{"version":3,"sources":["modules/Presence/index.js"],"names":["presenceEndPoint","Presence","deps","dep","optional","auth","client","storage","subscription","actionTypes","options","_subscriptionHandler","message","test","event","body","sequence","_lastSequence","store","dispatch","type","notification","_auth","_client","_subscription","_storage","_lastMessage","_delayTimeoutId","_lastNotDisturbDndStatusStorageKey","_reducer","registerReducer","key","reducer","lastNotDisturbDndStatus","subscribe","loginStatus","loggedIn","ready","status","pending","init","fetch","initSuccess","reset","resetSuccess","ownerId","account","extension","presence","get","data","fetchSuccess","lastDndStatus","dndStatus","_promise","fetchError","error","_fetch","params","platform","service","put","response","json","updateSuccess","updateError","userStatusParams","userStatus","takeAllCalls","doNotAcceptDepartmentCalls","presenceStatus","available","_getUpdateStatusParams","_update","busy","doNotAcceptAnyCalls","offline","state","getItem"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;AACA;;;;AAGA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,mBAAmB,qBAAzB;;AAEA;;;;IAUqBC,Q,WANpB,gBAAO;AACNC,QAAM,CACJ,MADI,EACI,QADJ,EACc,SADd,EACyB,cADzB,EAEJ,EAAEC,KAAK,iBAAP,EAA0BC,UAAU,IAApC,EAFI;AADA,CAAP,C;;;AAOC;;;;;;;;;AASA,0BAOG;AAAA,QANDC,IAMC,QANDA,IAMC;AAAA,QALDC,MAKC,QALDA,MAKC;AAAA,QAJDC,OAIC,QAJDA,OAIC;AAAA,QAHDC,YAGC,QAHDA,YAGC;AAAA,gCAFDC,WAEC;AAAA,QAFDA,WAEC;AAAA,QADEC,OACF;AAAA;;AAAA,qKAEIA,OAFJ;AAGCD;AAHD;;AAAA,UA2BHE,oBA3BG,GA2BoB,UAACC,OAAD,EAAa;AAClC,UAAIA,WAAWZ,iBAAiBa,IAAjB,CAAsBD,QAAQE,KAA9B,CAAX,IAAmDF,QAAQG,IAA/D,EAAqE;AACnE,YAAIH,QAAQG,IAAR,CAAaC,QAAjB,EAA2B;AACzB,cAAIJ,QAAQG,IAAR,CAAaC,QAAb,IAAyB,MAAKC,aAAlC,EAAiD;AAC/C;AACD;AACD,gBAAKA,aAAL,GAAqBL,QAAQG,IAAR,CAAaC,QAAlC;AACD;AACD,cAAKE,KAAL,CAAWC,QAAX;AACEC,gBAAM,MAAKX,WAAL,CAAiBY;AADzB,WAEKT,QAAQG,IAFb;AAID;AACF,KAxCE;;AAKD,UAAKO,KAAL,GAAajB,IAAb;AACA,UAAKkB,OAAL,GAAejB,MAAf;AACA,UAAKkB,aAAL,GAAqBhB,YAArB;AACA,UAAKiB,QAAL,GAAgBlB,OAAhB;AACA,UAAKmB,YAAL,GAAoB,IAApB;;AAEA,UAAKC,eAAL,GAAuB,IAAvB;AACA,UAAKC,kCAAL,GAA0C,yBAA1C;AACA,QAAI,MAAKH,QAAT,EAAmB;AACjB,YAAKI,QAAL,GAAgB,kCAAmB,MAAKpB,WAAxB,CAAhB;AACA,YAAKgB,QAAL,CAAcK,eAAd,CAA8B;AAC5BC,aAAK,MAAKH,kCADkB;AAE5BI,iBAAS,2DAAkC,MAAKvB,WAAvC;AAFmB,OAA9B;AAID,KAND,MAMO;AACL,YAAKoB,QAAL,GAAgB,kCAAmB,MAAKpB,WAAxB,EAAqC;AACnDwB,iCAAyB,2DAAkC,MAAKxB,WAAvC;AAD0B,OAArC,CAAhB;AAGD;AACD,UAAKQ,aAAL,GAAqB,CAArB;AAxBC;AAyBF;;;;iCAiBY;AAAA;;AACX,WAAKC,KAAL,CAAWgB,SAAX,4DAAqB;AAAA;AAAA;AAAA;AAAA;AAAA,sBAEjB,OAAKZ,KAAL,CAAWa,WAAX,KAA2B,sBAAYC,QAAvC,IACA,OAAKZ,aAAL,CAAmBa,KADnB,IAEA,OAAKC,MAAL,KAAgB,yBAAeC,OAJd;AAAA;AAAA;AAAA;;AAMjB,uBAAKrB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,OAAKX,WAAL,CAAiB+B;AADL,iBAApB;AANiB;AAAA,uBASX,OAAKC,KAAL,EATW;;AAAA;AAUjB,uBAAKjB,aAAL,CAAmBU,SAAnB,CAA6B,iCAA7B;AACA,uBAAKhB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,OAAKX,WAAL,CAAiBiC;AADL,iBAApB;AAXiB;AAAA;;AAAA;AAcZ,oBACL,CAAC,OAAKpB,KAAL,CAAWa,WAAX,KAA2B,sBAAYC,QAAvC,IACC,CAAC,OAAKZ,aAAL,CAAmBa,KADtB,KAEA,OAAKA,KAHA,EAIL;AACA,yBAAKnB,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,OAAKX,WAAL,CAAiBkC;AADL,mBAApB;AAGA,yBAAK1B,aAAL,GAAqB,CAArB;AACA,yBAAKS,YAAL,GAAoB,IAApB;AACA,yBAAKR,KAAL,CAAWC,QAAX,CAAoB;AAClBC,0BAAM,OAAKX,WAAL,CAAiBmC;AADL,mBAApB;AAGD,iBAbM,MAaA,IACL,OAAKP,KAAL,IACA,OAAKb,aAAL,CAAmBa,KADnB,IAEA,OAAKb,aAAL,CAAmBZ,OAFnB,IAGA,OAAKY,aAAL,CAAmBZ,OAAnB,KAA+B,OAAKc,YAJ/B,EAKL;AACA,yBAAKA,YAAL,GAAoB,OAAKF,aAAL,CAAmBZ,OAAvC;AACA,yBAAKD,oBAAL,CAA0B,OAAKe,YAA/B;AACD;;AAnCkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAArB;AAqCD;;;;;;;;;;AAGC,qBAAKR,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKX,WAAL,CAAiBgC;AADL,iBAApB;;AAIUI,uB,GAAY,KAAKvB,K,CAAjBuB,O;;uBACW,KAAKtB,OAAL,CAAauB,OAAb,GAAuBC,SAAvB,GAAmCC,QAAnC,GAA8CC,GAA9C,E;;;AAAbC,oB;;AACN,oBAAIL,YAAY,KAAKvB,KAAL,CAAWuB,OAA3B,EAAoC;AAClC,uBAAK3B,KAAL,CAAWC,QAAX;AACEC,0BAAM,KAAKX,WAAL,CAAiB0C;AADzB,qBAEKD,IAFL;AAGEE,mCAAe,KAAKC;AAHtB;AAKD;AACD,qBAAKC,QAAL,GAAgB,IAAhB;;;;;;;;AAEA,qBAAKA,QAAL,GAAgB,IAAhB;AACA,qBAAKpC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKX,WAAL,CAAiB8C,UADL;AAElBC;AAFkB,iBAApB;;;;;;;;;;;;;;;;;;;;;;;;;AASF,oBAAI,CAAC,KAAKF,QAAV,EAAoB;AAClB,uBAAKA,QAAL,GAAgB,KAAKG,MAAL,EAAhB;AACD;kDACM,KAAKH,Q;;;;;;;;;;;;;;;;;;;+FAGAI,M;;;;;;;AAEFb,uB,GAAY,KAAKvB,K,CAAjBuB,O;AACFc,wB,GAAW,KAAKpC,OAAL,CAAaqC,OAAb,CAAqBD,QAArB,E;;uBACMA,SAASE,GAAT,CACrB,iCADqB,EAErBH,MAFqB,C;;;AAAjBI,wB;AAIAZ,oB,GAAOY,SAASC,IAAT,E;;AACb,oBAAIlB,YAAY,KAAKvB,KAAL,CAAWuB,OAA3B,EAAoC;AAClC,uBAAK3B,KAAL,CAAWC,QAAX;AACEC,0BAAM,KAAKX,WAAL,CAAiBuD;AADzB,qBAEKd,IAFL;AAGEE,mCAAe,KAAKC;AAHtB;AAKD;;;;;;;;AAED,qBAAKnC,KAAL,CAAWC,QAAX,CAAoB;AAClBC,wBAAM,KAAKX,WAAL,CAAiBwD,WADL;AAElBT;AAFkB,iBAApB;;;;;;;;;;;;;;;;;;;2CAQmBU,gB,EAAkB;AACvC,UAAMR,SAAS;AACbL,mBAAW,KAAKA,SADH;AAEbc,oBAAYD;AAFC,OAAf;AAIA,UACER,OAAOL,SAAP,KAAqB,oBAAUe,YAA/B,IACAV,OAAOL,SAAP,KAAqB,oBAAUgB,0BAFjC,EAGE;AACAX,eAAOL,SAAP,GAAmB,KAAKpB,uBAAL,IAAgC,oBAAUmC,YAA7D;AACD;AACD,aAAOV,MAAP;AACD;;;;;;;;;;sBAEK,KAAKY,cAAL,KAAwB,yBAAeC,S;;;;;;;;AAGrCb,sB,GAAS,KAAKc,sBAAL,CAA4B,yBAAeD,SAA3C,C;;uBACT,KAAKE,OAAL,CAAaf,MAAb,C;;;;;;;;;;;;;;;;;;;;;;;;;sBAIJ,KAAKY,cAAL,KAAwB,yBAAeI,IAAvC,IACA,KAAKrB,SAAL,KAAmB,oBAAUsB,mB;;;;;;;;AAIzBjB,sB,GAAS,KAAKc,sBAAL,CAA4B,yBAAeE,IAA3C,C;;uBACT,KAAKD,OAAL,CAAaf,MAAb,C;;;;;;;;;;;;;;;;;;;;;;;;;sBAKJ,KAAKY,cAAL,KAAwB,yBAAeI,IAAvC,IACA,KAAKrB,SAAL,KAAmB,oBAAUsB,mB;;;;;;;;AAIzBjB,sB,GAAS;AACbL,6BAAW,oBAAUsB,mBADR;AAEbR,8BAAY,yBAAeO;AAFd,iB;;uBAIT,KAAKD,OAAL,CAAaf,MAAb,C;;;;;;;;;;;;;;;;;;;;;;;;;sBAIF,KAAKY,cAAL,KAAwB,yBAAeM,O;;;;;;;;AAGrClB,sB,GAAS,KAAKc,sBAAL,CAA4B,yBAAeI,OAA3C,C;;uBACT,KAAKH,OAAL,CAAaf,MAAb,C;;;;;;;;;;;;;;;;;;;;;;;;;AAIAA,sB,GAAS;AACbS,8BAAY,KAAKA;AADJ,iB;;AAGf,oBAAI,KAAKd,SAAL,KAAmB,oBAAUe,YAAjC,EAA+C;AAC7CV,yBAAOL,SAAP,GAAmB,oBAAUgB,0BAA7B;AACD,iBAFD,MAEO,IAAI,KAAKhB,SAAL,KAAmB,oBAAUgB,0BAAjC,EAA6D;AAClEX,yBAAOL,SAAP,GAAmB,oBAAUe,YAA7B;AACD;;qBACGV,OAAOL,S;;;;;;uBACH,KAAKoB,OAAL,CAAaf,MAAb,C;;;;;;;;;;;;;;;;;;wBAIG;AACX,aAAO,KAAKmB,KAAL,CAAWvC,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKuC,KAAL,CAAWvC,MAAX,KAAsB,yBAAeD,KAA5C;AACD;;;wBAEe;AACd,aAAO,KAAKwC,KAAL,CAAWxB,SAAlB;AACD;;;wBAE6B;AAC5B,UAAI,KAAK5B,QAAT,EAAmB;AACjB,eAAO,KAAKA,QAAL,CAAcqD,OAAd,CAAsB,KAAKlD,kCAA3B,CAAP;AACD;AACD,aAAO,KAAKiD,KAAL,CAAW5C,uBAAlB;AACD;;;wBAEgB;AACf,aAAO,KAAK4C,KAAL,CAAWV,UAAlB;AACD;;;wBAEa;AACZ,aAAO,KAAKU,KAAL,CAAWjE,OAAlB;AACD;;;wBAEoB;AACnB,aAAO,KAAKiE,KAAL,CAAWP,cAAlB;AACD;;;;kBA5PkBrE,Q","file":"index.js","sourcesContent":["import RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport getPresenceReducer, {\n  getLastNotDisturbDndStatusReducer\n} from './getPresenceReducer';\nimport presenceActionTypes from './actionTypes';\nimport loginStatus from '../Auth/loginStatus';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport dndStatus from './dndStatus';\nimport presenceStatus from './presenceStatus';\nimport proxify from '../../lib/proxy/proxify';\n\nconst presenceEndPoint = /.*\\/presence(\\?.*)?/;\n\n/**\n * @class\n * @description Presence info module\n */\n@Module({\n  deps: [\n    'Auth', 'Client', 'Storage', 'Subscription',\n    { dep: 'PresenceOptions', optional: true }\n  ]\n})\nexport default class Presence extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Auth} params.auth - auth module instance\n   * @param {Client} params.client - client module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {Subscription} params.subscription - subscription module instance\n   * @param {Object} params.actionTypes - actionTypes enums\n   */\n  constructor({\n    auth,\n    client,\n    storage,\n    subscription,\n    actionTypes = presenceActionTypes,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._auth = auth;\n    this._client = client;\n    this._subscription = subscription;\n    this._storage = storage;\n    this._lastMessage = null;\n\n    this._delayTimeoutId = null;\n    this._lastNotDisturbDndStatusStorageKey = 'lastNotDisturbDndStatus';\n    if (this._storage) {\n      this._reducer = getPresenceReducer(this.actionTypes);\n      this._storage.registerReducer({\n        key: this._lastNotDisturbDndStatusStorageKey,\n        reducer: getLastNotDisturbDndStatusReducer(this.actionTypes)\n      });\n    } else {\n      this._reducer = getPresenceReducer(this.actionTypes, {\n        lastNotDisturbDndStatus: getLastNotDisturbDndStatusReducer(this.actionTypes),\n      });\n    }\n    this._lastSequence = 0;\n  }\n\n  _subscriptionHandler = (message) => {\n    if (message && presenceEndPoint.test(message.event) && message.body) {\n      if (message.body.sequence) {\n        if (message.body.sequence <= this._lastSequence) {\n          return;\n        }\n        this._lastSequence = message.body.sequence;\n      }\n      this.store.dispatch({\n        type: this.actionTypes.notification,\n        ...message.body,\n      });\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(async () => {\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        this._subscription.ready &&\n        this.status === moduleStatuses.pending\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        await this.fetch();\n        this._subscription.subscribe('/account/~/extension/~/presence');\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      } else if (\n        (this._auth.loginStatus !== loginStatus.loggedIn ||\n          !this._subscription.ready) &&\n        this.ready\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.reset,\n        });\n        this._lastSequence = 0;\n        this._lastMessage = null;\n        this.store.dispatch({\n          type: this.actionTypes.resetSuccess,\n        });\n      } else if (\n        this.ready &&\n        this._subscription.ready &&\n        this._subscription.message &&\n        this._subscription.message !== this._lastMessage\n      ) {\n        this._lastMessage = this._subscription.message;\n        this._subscriptionHandler(this._lastMessage);\n      }\n    });\n  }\n  @proxify\n  async _fetch() {\n    this.store.dispatch({\n      type: this.actionTypes.fetch,\n    });\n    try {\n      const { ownerId } = this._auth;\n      const data = await this._client.account().extension().presence().get();\n      if (ownerId === this._auth.ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.fetchSuccess,\n          ...data,\n          lastDndStatus: this.dndStatus,\n        });\n      }\n      this._promise = null;\n    } catch (error) {\n      this._promise = null;\n      this.store.dispatch({\n        type: this.actionTypes.fetchError,\n        error,\n      });\n      throw error;\n    }\n  }\n  @proxify\n  async fetch() {\n    if (!this._promise) {\n      this._promise = this._fetch();\n    }\n    return this._promise;\n  }\n  @proxify\n  async _update(params) {\n    try {\n      const { ownerId } = this._auth;\n      const platform = this._client.service.platform();\n      const response = await platform.put(\n        '/account/~/extension/~/presence',\n        params\n      );\n      const data = response.json();\n      if (ownerId === this._auth.ownerId) {\n        this.store.dispatch({\n          type: this.actionTypes.updateSuccess,\n          ...data,\n          lastDndStatus: this.dndStatus,\n        });\n      }\n    } catch (error) {\n      this.store.dispatch({\n        type: this.actionTypes.updateError,\n        error,\n      });\n      throw error;\n    }\n  }\n\n  _getUpdateStatusParams(userStatusParams) {\n    const params = {\n      dndStatus: this.dndStatus,\n      userStatus: userStatusParams,\n    };\n    if (\n      params.dndStatus !== dndStatus.takeAllCalls &&\n      params.dndStatus !== dndStatus.doNotAcceptDepartmentCalls\n    ) {\n      params.dndStatus = this.lastNotDisturbDndStatus || dndStatus.takeAllCalls;\n    }\n    return params;\n  }\n  async setAvailable() {\n    if (this.presenceStatus === presenceStatus.available) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.available);\n    await this._update(params);\n  }\n  async setBusy() {\n    if (\n      this.presenceStatus === presenceStatus.busy &&\n      this.dndStatus !== dndStatus.doNotAcceptAnyCalls\n    ) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.busy);\n    await this._update(params);\n  }\n\n  async setDoNotDisturb() {\n    if (\n      this.presenceStatus === presenceStatus.busy &&\n      this.dndStatus === dndStatus.doNotAcceptAnyCalls\n    ) {\n      return;\n    }\n    const params = {\n      dndStatus: dndStatus.doNotAcceptAnyCalls,\n      userStatus: presenceStatus.busy,\n    };\n    await this._update(params);\n  }\n\n  async setInvisible() {\n    if (this.presenceStatus === presenceStatus.offline) {\n      return;\n    }\n    const params = this._getUpdateStatusParams(presenceStatus.offline);\n    await this._update(params);\n  }\n\n  async toggleAcceptCallQueueCalls() {\n    const params = {\n      userStatus: this.userStatus,\n    };\n    if (this.dndStatus === dndStatus.takeAllCalls) {\n      params.dndStatus = dndStatus.doNotAcceptDepartmentCalls;\n    } else if (this.dndStatus === dndStatus.doNotAcceptDepartmentCalls) {\n      params.dndStatus = dndStatus.takeAllCalls;\n    }\n    if (params.dndStatus) {\n      await this._update(params);\n    }\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get dndStatus() {\n    return this.state.dndStatus;\n  }\n\n  get lastNotDisturbDndStatus() {\n    if (this._storage) {\n      return this._storage.getItem(this._lastNotDisturbDndStatusStorageKey);\n    }\n    return this.state.lastNotDisturbDndStatus;\n  }\n\n  get userStatus() {\n    return this.state.userStatus;\n  }\n\n  get message() {\n    return this.state.message;\n  }\n\n  get presenceStatus() {\n    return this.state.presenceStatus;\n  }\n}\n"]}
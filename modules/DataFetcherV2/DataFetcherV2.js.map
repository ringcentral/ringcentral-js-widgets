{"version":3,"sources":["modules/DataFetcherV2/DataFetcherV2.ts"],"names":["DataFetcherV2","name","deps","dep","optional","storageKey","enableCache","_sources","Set","_timeoutIds","Map","_promises","_deps","sleepDetector","on","events","detected","_handleSleepDetected","auth","loggedIn","ready","key","isFetching","source","disableCache","data","timestamp","Date","now","timestamps","storageData","cachedData","cachedTimestamps","_setData","_setFetching","ownerId","fetchFunction","polling","_startPolling","timeToRetry","_retry","has","clearTimeout","get","t","getTimestamp","pollingInterval","_clearTimeout","set","setTimeout","_checkIsActiveTab","readyCheckFunction","permissionCheckFunction","_expired","fetchData","_fetchData","ttl","isFreshLogin","tabManager","active","getSourceStatus","sourceStatus","pending","_setSourceStatus","initializing","_shouldFetch","getData","status","readyCheck","permissionCheck","_tryInitializeSource","cleanOnReset","Array","from","keys","forEach","add","registeredKeys","_getRegisteredKeys","k","Object","prototype","hasOwnProperty","call","_deleteKeys","_getInvalidCachedKeys","_cleanCache","_processSources","RcModuleV2","state","storage","action","proxify"],"mappings":"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","sourcesContent":["import {\n  RcModuleV2,\n  state,\n  storage,\n  action,\n} from '@ringcentral-integration/core';\nimport { forEach } from 'ramda';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { Deps } from './DataFetcherV2.interface';\nimport { SourceStatusType, sourceStatus } from './sourceStatus';\nimport { DataSource } from './DataSource';\n\n@Module({\n  name: 'DataFetcherV2',\n  deps: [\n    'Auth',\n    'Storage',\n    'SleepDetector',\n    { dep: 'TabManager', optional: true },\n    { dep: 'DataFetcherV2Options', optional: true },\n  ],\n})\nexport class DataFetcherV2 extends RcModuleV2<Deps> {\n  protected _sources = new Set<DataSource<any>>();\n  protected _timeoutIds = new Map<string, NodeJS.Timeout>();\n  protected _promises = new Map<string, Promise<void>>();\n\n  constructor(deps: Deps) {\n    super({\n      storageKey: 'dataFetcherV2',\n      enableCache: true,\n      deps,\n    });\n    this._deps.sleepDetector.on(this._deps.sleepDetector.events.detected, () =>\n      this._handleSleepDetected(),\n    );\n  }\n\n  _shouldInit() {\n    return this._deps.auth.loggedIn && super._shouldInit();\n  }\n\n  _shouldReset() {\n    return !!(\n      super._shouldReset() ||\n      (this.ready && !this._deps.auth.loggedIn)\n    );\n  }\n\n  @state\n  sourceStatus: Record<string, SourceStatusType> = {};\n\n  get cachedData() {\n    return this.storageData.cachedData;\n  }\n\n  get cachedTimestamps() {\n    return this.storageData.cachedTimestamps;\n  }\n\n  @storage\n  @state\n  storageData: {\n    cachedData: Record<string, any>;\n    cachedTimestamps: Record<string, number>;\n  } = {\n    cachedData: {},\n    cachedTimestamps: {},\n  };\n\n  @state\n  data: Record<string, any> = {};\n\n  @state\n  timestamps: Record<string, number> = {};\n\n  @state\n  isFetching: Record<string, boolean> = {};\n\n  @action\n  protected _setFetching(key: string, isFetching: boolean) {\n    this.isFetching[key] = isFetching;\n  }\n\n  getFetching<T>(source: DataSource<T>) {\n    return !!this.isFetching[source.key];\n  }\n\n  @action\n  protected _setData<T>(\n    key: string,\n    disableCache: boolean,\n    data: T,\n    timestamp = Date.now(),\n  ): void {\n    if (disableCache) {\n      this.data[key] = data;\n      this.timestamps[key] = timestamp;\n    } else {\n      this.storageData.cachedData[key] = data;\n      this.storageData.cachedTimestamps[key] = timestamp;\n    }\n  }\n\n  updateData<T>(source: DataSource<T>, data: T, timestamp: number): void {\n    this._setData(source.key, source.disableCache, data, timestamp);\n  }\n\n  @proxify\n  protected async _fetchData<T>(source: DataSource<T>): Promise<void> {\n    this._setFetching(source.key, true);\n    const { ownerId } = this._deps.auth;\n    try {\n      const data = await source.fetchFunction();\n      if (this._deps.auth.ownerId === ownerId) {\n        this._setData(source.key, source.disableCache, data, Date.now());\n        this._setFetching(source.key, false);\n        if (source.polling) {\n          this._startPolling(source);\n        }\n        this._promises.delete(source.key);\n      }\n    } catch (error) {\n      if (this._deps.auth.ownerId === ownerId) {\n        this._promises.delete(source.key);\n        this._setFetching(source.key, false);\n        if (source.polling) {\n          this._startPolling(source, source.timeToRetry);\n        } else {\n          this._retry(source);\n        }\n        throw error;\n      }\n    }\n  }\n\n  protected _clearTimeout<T>(source: DataSource<T>) {\n    if (this._timeoutIds.has(source.key)) {\n      clearTimeout(this._timeoutIds.get(source.key));\n      this._timeoutIds.delete(source.key);\n    }\n  }\n\n  protected _startPolling<T>(\n    source: DataSource<T>,\n    t = this.getTimestamp(source) + source.pollingInterval + 10 - Date.now(),\n  ) {\n    this._clearTimeout(source);\n    this._timeoutIds.set(\n      source.key,\n      setTimeout(() => {\n        this._timeoutIds.delete(source.key);\n        if (\n          this.ready &&\n          this._checkIsActiveTab(source) &&\n          source.readyCheckFunction() &&\n          source.permissionCheckFunction()\n        ) {\n          if (this._expired(source)) {\n            this.fetchData(source);\n          } else {\n            this._startPolling(source);\n          }\n        } else if (!this._expired(source)) {\n          this._startPolling(source);\n        } else {\n          this._startPolling(source, source.timeToRetry);\n        }\n      }, t),\n    );\n  }\n\n  protected _retry<T>(source: DataSource<T>, t = source.timeToRetry) {\n    this._clearTimeout(source);\n    this._timeoutIds.set(\n      source.key,\n      setTimeout(() => {\n        if (this._expired(source)) {\n          if (\n            this.ready &&\n            this._checkIsActiveTab(source) &&\n            source.readyCheckFunction() &&\n            source.permissionCheckFunction()\n          ) {\n            this.fetchData(source);\n          } else {\n            this._retry(source);\n          }\n        }\n      }, t),\n    );\n  }\n\n  @proxify\n  async fetchData(source: DataSource<any>): Promise<void> {\n    if (!this._promises.get(source.key)) {\n      this._promises.set(source.key, this._fetchData(source));\n    }\n    return this._promises.get(source.key);\n  }\n\n  getTimestamp<T>(source: DataSource<T>) {\n    if (source.disableCache) {\n      return this.timestamps[source.key] || null;\n    }\n    return this.cachedTimestamps[source.key] || null;\n  }\n\n  get sources() {\n    return this._sources;\n  }\n\n  protected _expired<T>(source: DataSource<T>) {\n    return Date.now() - this.getTimestamp(source) > source.ttl;\n  }\n\n  protected _shouldFetch<T>(source: DataSource<T>, isFreshLogin = false) {\n    return (\n      this._checkIsActiveTab<T>(source) &&\n      (isFreshLogin || this._expired(source))\n    );\n  }\n\n  private _checkIsActiveTab<T>(source: DataSource<T>) {\n    // if cache is disabled, then each tab should fetch its own data\n    // therefore tabManager should be ignored\n    return (\n      source.disableCache ||\n      !this._deps.tabManager ||\n      this._deps.tabManager.active\n    );\n  }\n\n  protected async _tryInitializeSource<T>(\n    source: DataSource<T>,\n  ): Promise<void> {\n    if (this.getSourceStatus(source) === sourceStatus.pending) {\n      this._setSourceStatus(source.key, sourceStatus.initializing);\n      if (this._shouldFetch(source)) {\n        try {\n          await this.fetchData(source);\n        } catch {\n          this._retry(source);\n        }\n      } else if (source.polling) {\n        this._startPolling(source);\n      } else {\n        this._retry(source);\n      }\n      return;\n    }\n    if (this.getData(source) !== null && this.getTimestamp(source) !== null) {\n      this._setSourceStatus(source.key, sourceStatus.ready);\n    }\n  }\n\n  @action\n  protected _setSourceStatus(key: string, status: SourceStatusType) {\n    this.sourceStatus[key] = status;\n  }\n\n  getSourceStatus<T>(source: DataSource<T>) {\n    return this.sourceStatus[source.key];\n  }\n\n  protected _processSources() {\n    if (this.ready) {\n      forEach((source) => {\n        if (!this.getSourceStatus(source)) {\n          this._setSourceStatus(source.key, sourceStatus.pending);\n        }\n        const status = this.getSourceStatus(source);\n        const readyCheck = this.ready && source.readyCheckFunction();\n        const permissionCheck = readyCheck && source.permissionCheckFunction();\n        if (readyCheck) {\n          if (\n            status === sourceStatus.pending ||\n            status === sourceStatus.initializing\n          ) {\n            // if user has no permission to fetch data, bypass the initialization process\n            if (!permissionCheck) {\n              this._setSourceStatus(source.key, sourceStatus.ready);\n              this._setData(source.key, source.disableCache, null, 0);\n            } else {\n              this._tryInitializeSource(source);\n            }\n          } else if (status === sourceStatus.ready) {\n            if (\n              !permissionCheck &&\n              this.getData(source) !== null &&\n              this.getTimestamp(source) !== null\n            ) {\n              // no permission but has data, set data to null\n              // use 0 for timestamp so we know this is on purpose\n              this._setData(source.key, source.disableCache, null, 0);\n            } else if (\n              permissionCheck &&\n              this.getData(source) === null &&\n              this.getTimestamp(source) === 0 &&\n              !this._promises.get(source.key)\n            ) {\n              // if the data set to null due to permission before\n              // but now there is permission, then fetch data\n              this.fetchData(source);\n            }\n          }\n        } else if (status === sourceStatus.ready) {\n          this._setSourceStatus(source.key, sourceStatus.pending);\n          if (source.cleanOnReset) {\n            this._setData(source.key, source.disableCache, null, null);\n          }\n        }\n      }, Array.from(this._sources));\n    }\n  }\n\n  protected _handleSleepDetected() {\n    forEach((source) => {\n      if (this.ready && this._shouldFetch(source)) {\n        this.fetchData(source);\n      }\n    }, Array.from(this._sources));\n  }\n\n  protected _getRegisteredKeys() {\n    const keys = new Set<string>();\n    this._sources.forEach((source) => {\n      keys.add(source.key);\n    });\n    return keys;\n  }\n\n  protected _getInvalidCachedKeys() {\n    const registeredKeys = this._getRegisteredKeys();\n    const keys = new Set<string>();\n    for (const k in this.cachedData) {\n      if (\n        Object.prototype.hasOwnProperty.call(this.cachedData, k) &&\n        !registeredKeys.has(k)\n      ) {\n        keys.add(k);\n      }\n    }\n    for (const k in this.cachedTimestamps) {\n      if (\n        Object.prototype.hasOwnProperty.call(this.cachedTimestamps, k) &&\n        !registeredKeys.has(k)\n      ) {\n        keys.add(k);\n      }\n    }\n    return keys;\n  }\n\n  @action\n  protected _deleteKeys(keys: Set<string>) {\n    keys.forEach((k) => {\n      delete this.cachedData[k];\n      delete this.cachedTimestamps[k];\n    });\n  }\n\n  protected _cleanCache() {\n    this._deleteKeys(this._getInvalidCachedKeys());\n  }\n\n  onInit() {\n    // clean up cached sources that are no longer exist\n    this._cleanCache();\n  }\n\n  onReset() {\n    forEach((source) => {\n      // clear all pollings or retries\n      this._clearTimeout(source);\n      // clear all pending requests\n      this._promises.delete(source.key);\n      // reset isFetching\n      this._setFetching(source.key, false);\n      if (this.getSourceStatus(source) !== sourceStatus.pending) {\n        this._setSourceStatus(source.key, sourceStatus.pending);\n      }\n      if (\n        source.cleanOnReset &&\n        this.getData(source) !== null &&\n        this.getTimestamp(source) !== null\n      ) {\n        this._setData(source.key, source.disableCache, null, null);\n      }\n    }, Array.from(this._sources));\n  }\n\n  onStateChange() {\n    this._processSources();\n  }\n\n  register<T>(source: DataSource<T>) {\n    this._sources.add(source);\n  }\n\n  getData<T>(source: DataSource<T>): T {\n    if (this._sources.has(source)) {\n      if (source.disableCache) {\n        return this.data[source.key] || null;\n      }\n      return this.cachedData[source.key] || null;\n    }\n    return null;\n  }\n}\n"],"file":"DataFetcherV2.js"}
{"version":3,"sources":["modules/EvCallDisposition/EvCallDisposition.ts"],"names":["EvCallDisposition","name","deps","dep","optional","enableCache","storageKey","id","data","callsMapping","disposed","dispositionStateMapping","_deps","evCallMonitor","onCallAnswered","call","outdialDispositions","disposition","dispositions","find","isDefault","getCallId","session","setDisposition","dispositionId","notes","evCallHistory","callDisposition","isDisposed","evClient","dispositionCall","uii","dispId","setDispositionState","RcModuleV2","storage","state","action"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IA0BMA,iB,WAZL,gBAAO;AACNC,EAAAA,IAAI,EAAE,mBADA;AAENC,EAAAA,IAAI,EAAE,CACJ,SADI,EAEJ,eAFI,EAGJ,eAHI,EAIJ,UAJI,EAKJ;AAAEC,IAAAA,GAAG,EAAE,gBAAP;AAAyBC,IAAAA,QAAQ,EAAE;AAAnC,GALI,EAMJ;AAAED,IAAAA,GAAG,EAAE,iBAAP;AAA0BC,IAAAA,QAAQ,EAAE;AAApC,GANI,EAOJ;AAAED,IAAAA,GAAG,EAAE,0BAAP;AAAmCC,IAAAA,QAAQ,EAAE;AAA7C,GAPI;AAFA,CAAP,C;;;;;AAaC,6BAAYF,IAAZ,EAAwB;AAAA;;AAAA;;AACtB,8BAAM;AACJA,MAAAA,IAAI,EAAJA,IADI;AAEJG,MAAAA,WAAW,EAAE,IAFT;AAGJC,MAAAA,UAAU,EAAE;AAHR,KAAN;;AADsB;;AAAA;;AAAA;AAMvB;;;;mCAWcC,E,EAAYC,I,EAAwC;AACjE,WAAKC,YAAL,CAAkBF,EAAlB,IAAwBC,IAAxB;AACD;;;sCAGiBD,E,EAAY;AAC5B,aAAO,KAAKE,YAAL,CAAkBF,EAAlB,CAAP;AACD;;;wCAGmBA,E,EAAYG,Q,EAA6C;AAC3E,WAAKC,uBAAL,CAA6BJ,EAA7B,IAAmCG,QAAnC;AACD;;;iCAEY;AAAA;;AACX,WAAKE,KAAL,CAAWC,aAAX,CAAyBC,cAAzB,CAAwC,UAACC,IAAD,EAAU;AAChD,YAAIA,IAAI,CAACC,mBAAT,EAA8B;AAC5B,cAAMC,WAAW,GAAGF,IAAI,CAACC,mBAAL,CAAyBE,YAAzB,CAAsCC,IAAtC,CAClB;AAAA,gBAAGC,SAAH,QAAGA,SAAH;AAAA,mBAAmBA,SAAnB;AAAA,WADkB,CAApB;;AAGA,cAAMb,EAAE,GAAG,MAAI,CAACK,KAAL,CAAWC,aAAX,CAAyBQ,SAAzB,CAAmCN,IAAI,CAACO,OAAxC,CAAX;;AACA,UAAA,MAAI,CAACC,cAAL,CAAoBhB,EAApB,EAAwB;AACtBiB,YAAAA,aAAa,EAAEP,WAAW,GAAGA,WAAW,CAACO,aAAf,GAA+B,IADnC;AAEtBC,YAAAA,KAAK,EAAE;AAFe,WAAxB;AAID;AACF,OAXD;AAYD;;;gCAEWlB,E,EAAY;AACtB,UAAMQ,IAAI,GAAG,KAAKH,KAAL,CAAWc,aAAX,CAAyBjB,YAAzB,CAAsCF,EAAtC,CAAb;AACA,UAAMoB,eAAe,GAAG,KAAKlB,YAAL,CAAkBF,EAAlB,CAAxB;AACA,UAAMqB,UAAU,GACd,KAAKjB,uBAAL,CAA6BJ,EAA7B,KACA,KAAKI,uBAAL,CAA6BJ,EAA7B,EAAiCG,QAFnC;AAGA,UAAI,CAACK,IAAI,CAACC,mBAAN,IAA6BY,UAAjC,EAA6C;;AAE7C,WAAKhB,KAAL,CAAWiB,QAAX,CAAoBC,eAApB,CAAoC;AAClCC,QAAAA,GAAG,EAAEhB,IAAI,CAACgB,GADwB;AAElCC,QAAAA,MAAM,EAAEL,eAAe,CAACH,aAFU;AAGlCC,QAAAA,KAAK,EAAEE,eAAe,CAACF;AAHW,OAApC;;AAMA,WAAKQ,mBAAL,CAAyB1B,EAAzB,EAA6B;AAAEG,QAAAA,QAAQ,EAAE;AAAZ,OAA7B;AACD;;;;EA9D6BwB,gB,gFAS7BC,a,EACAC,W;;;;;WACwC,E;;4FAExCD,a,EACAC,W;;;;;WACoD,E;;oEAEpDC,Y,gKAKAA,Y,qKAKAA,Y","sourcesContent":["import { Module } from '@ringcentral-integration/commons/lib/di';\nimport {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n} from '@ringcentral-integration/core';\n\nimport {\n  CallDisposition,\n  Deps,\n  EvCallDispositionMapping,\n  EvDispositionStateMapping,\n} from './EvCallDisposition.interface';\n\n@Module({\n  name: 'EvCallDisposition',\n  deps: [\n    'Storage',\n    'EvCallMonitor',\n    'EvCallHistory',\n    'EvClient',\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'ActivityMatcher', optional: true },\n    { dep: 'EvCallDispositionOptions', optional: true },\n  ],\n})\nclass EvCallDisposition extends RcModuleV2<Deps> implements CallDisposition {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvCallDisposition',\n    });\n  }\n\n  @storage\n  @state\n  callsMapping: EvCallDispositionMapping = {};\n\n  @storage\n  @state\n  dispositionStateMapping: EvDispositionStateMapping = {};\n\n  @action\n  setDisposition(id: string, data: EvCallDispositionMapping[string]) {\n    this.callsMapping[id] = data;\n  }\n\n  @action\n  removeDisposition(id: string) {\n    delete this.callsMapping[id];\n  }\n\n  @action\n  setDispositionState(id: string, disposed: EvDispositionStateMapping[string]) {\n    this.dispositionStateMapping[id] = disposed;\n  }\n\n  onInitOnce() {\n    this._deps.evCallMonitor.onCallAnswered((call) => {\n      if (call.outdialDispositions) {\n        const disposition = call.outdialDispositions.dispositions.find(\n          ({ isDefault }) => isDefault,\n        );\n        const id = this._deps.evCallMonitor.getCallId(call.session);\n        this.setDisposition(id, {\n          dispositionId: disposition ? disposition.dispositionId : null,\n          notes: '',\n        });\n      }\n    });\n  }\n\n  disposeCall(id: string) {\n    const call = this._deps.evCallHistory.callsMapping[id];\n    const callDisposition = this.callsMapping[id];\n    const isDisposed =\n      this.dispositionStateMapping[id] &&\n      this.dispositionStateMapping[id].disposed;\n    if (!call.outdialDispositions || isDisposed) return;\n\n    this._deps.evClient.dispositionCall({\n      uii: call.uii,\n      dispId: callDisposition.dispositionId,\n      notes: callDisposition.notes,\n    });\n\n    this.setDispositionState(id, { disposed: true });\n  }\n}\n\nexport { EvCallDisposition };\n"],"file":"EvCallDisposition.js"}
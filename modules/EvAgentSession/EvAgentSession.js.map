{"version":3,"sources":["modules/EvAgentSession/EvAgentSession.ts"],"names":["ACCEPTABLE_LOGIN_TYPES","loginTypes","integratedSoftphone","RC_PHONE","externalPhone","DEFAULT_LOGIN_TYPE","NONE","dropDownOptions","None","WAIT_EV_SERVER_ROLLBACK_DELAY","DEFAULT_FORM_GROUP","selectedInboundQueueIds","loginType","selectedSkillProfileId","extensionNumber","autoAnswer","EvAgentSession","name","deps","dep","optional","that","_deps","locale","currentLocale","evAuth","agentConfig","auth","isFreshLogin","skillProfileList","agent","inboundQueues","_","type","trackEvents","agentSessionSetLoginType","value","skillProfileId","agentSessionSetSkillProfileId","ids","agentSessionSetInboundQueueIds","takingCall","agentSessionSetTakingCall","agentSessionSetAutoAnswer","formGroup","isEvLogged","ready","agentSessionConfigureAgent","selectedSkillProfile","selectedInboundQueues","_tabConfigSuccess","alive","_tabConfigWorking","tabManagerEnabled","isAlive","isIntegratedSoftphone","hasMultipleTabs","enableCache","storageKey","isForceLogin","isReconnected","isAgentUpdating","_isReConfiguring","_autoConfigureRetryTimes","_eventEmitter","EventEmitter","_loginPromise","_updateSessionBlockId","_isLogin","TabLife","tabManager","prefix","_mainTabBeforeunloadHandler","console","log","isMainTab","firstTabIdExcludeMainTab","_mainTabAfterUnloadHandler","evCallDataSource","changeCallsLimited","setMainTabId","_sendTabManager","tabManagerEvents","MAIN_TAB_WILL_UNLOAD","onceLoginSuccess","beforeAgentLogout","_resetAllState","presence","beforeunloadHandler","shouldBlockBrowser","configSuccess","_emitConfigSuccess","configured","token","accessToken","status","_clearCalls","defaultAutoAnswerOn","defaultSkillProfileId","agentPermissions","allowInbound","map","inboundQueue","gateId","data","setFormGroup","loggedIn","checkIsMainTabAlive","id","beforeunload","add","onAfterUnload","_init","onConfigSuccess","calls","length","setDialoutStatus","dialoutStatuses","idle","routerInteraction","push","block","next","configureAgent","triggerEvent","error","_emitReConfigFail","_configWorkingAlive","_mainTabHandle","_configSuccessAlive","connected","_tabReConfig","onLeave","isFirstTab","isLeave","_pollAskIfCanBeNewMainTab","initAgentSession","isOnLoginSuccess","_initTabLife","_initAgentSession","_afterLogin","_autoConfigureAgent","setFreshConfig","resetFormGroup","_navigateToSessionConfigPage","resetAllConfig","setConfigSuccess","_destroyTabLife","clear","removeAfterUnloadListener","_checkTabManagerEvent","event","args","AGENT_CONFIG_SUCCESS","UPDATE_SESSION","SET_MIAN_TAB_ID","UPDATE_SESSION_SUCCESS","UPDATE_SESSION_SUCCESS_ALERT","UPDATE_SESSION_FAIL","RELOGIN","CONFIGURE_FAIL","_othersTabConfigureAgent","_configureFail","onceLogoutThenLogin","then","loginPromise","tabbie","_newMainTabReConfig","mainTabId","setMainTabIdInThisTab","_unblockUpdateSession","window","location","reload","_showUpdateSuccessAlert","reLoginAgent","isBlock","alertMessage","messageTypes","NOT_INBOUND_QUEUE_SELECTED","unblock","init","destroy","checkSelectIsInList","some","profile","profileId","setSkillProfileId","checkedInboundQueues","reduce","result","inboundQueueId","setInboundQueueIds","emit","agentSessionEvents","TRIGGER_CONFIG","callback","on","CONFIG_SUCCESS","RECONFIG_FAIL","_setMainTabId","evClient","getRefreshedToken","emitSetMainTabComplete","getAgentConfig","setAgent","config","_checkFieldsResult","needAssignFormGroupValue","_connectEvServer","connectResult","existingLoginFound","newReconnect","isForce","_handleAgentResult","_emitTriggerConfig","voiceConnectionChanged","extensionNumberChanged","updateAgentConfigs","goToSettingsPage","fn","alert","danger","message","ttl","sendLogoutTabEvent","refreshToken","access_token","setAccessToken","logoutAgent","loginAgent","Promise","resolve","onceLogout","success","UPDATE_AGENT_SUCCESS","AGENT_CONFIG_DETAIL_ERROR","payload","UPDATE_AGENT_ERROR","AGENT_CONFIG_ERROR","Error","assignFormGroupValue","timeoutId","resolves","race","res","once","tabs","checkIsAlive","setTimeout","clearTimeout","off","forEach","r","e","needAsyncAllTabs","_setConfigSuccess","multiLoginRequest","notInboundQueueSelected","find","item","isDefault","EXISTING_LOGIN_FOUND","modalUI","confirm","title","i18n","getString","content","confirmButtonText","cancelButtonText","onConfirm","appStatus","evStatus","CLOSED","childrenSize","confirmed","EXISTING_LOGIN_ENGAGED","dialDest","_getDialDest","queueIds","EMPTY_PHONE_NUMBER","formatPhoneNumber","phoneNumber","input","parsedNumber","isValid","INVALID_PHONE_NUMBER","send","clearCalls","localStorage","enable","label","inboundSettings","availableQueues","queue","gateName","checked","defaultSkill","_pickSkillProfile","availableSkillProfiles","profileName","results","filter","sessionConfigs","RcModuleV2","storage","state","action"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\nimport { equals } from 'ramda';\n\nimport { Module } from '@ringcentral-integration/commons/lib/di';\nimport sleep from '@ringcentral-integration/commons/lib/sleep';\nimport {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n  watch,\n} from '@ringcentral-integration/core';\nimport { format, parse } from '@ringcentral-integration/phone-number';\n\nimport {\n  agentSessionEvents,\n  dialoutStatuses,\n  dropDownOptions,\n  loginTypes,\n  LoginTypes,\n  messageTypes,\n  tabManagerEvents,\n} from '../../enums';\nimport { LoginType } from '../../interfaces/EvAgentSessionUI.interface';\nimport {\n  EvAgentConfig,\n  EvAvailableSkillProfile,\n  EvConfigureAgentOptions,\n} from '../../lib/EvClient';\nimport { evStatus } from '../../lib/EvClient/enums';\nimport { TabLife } from '../../lib/tabLife';\nimport { trackEvents } from '../../lib/trackEvents';\nimport { AgentSession, Deps, FormGroup } from './EvAgentSession.interface';\nimport i18n from './i18n';\nimport { tabManagerEnabled } from './tabManagerEnabled.decorator';\n\nconst ACCEPTABLE_LOGIN_TYPES = [\n  loginTypes.integratedSoftphone,\n  loginTypes.RC_PHONE,\n  loginTypes.externalPhone,\n];\nconst DEFAULT_LOGIN_TYPE = loginTypes.integratedSoftphone;\n\nconst NONE = dropDownOptions.None;\n\n// ! wait all tab is logout complete, server has some delay after logout\nconst WAIT_EV_SERVER_ROLLBACK_DELAY = 2000;\n\nconst DEFAULT_FORM_GROUP = {\n  selectedInboundQueueIds: [] as any,\n  loginType: DEFAULT_LOGIN_TYPE,\n  selectedSkillProfileId: NONE,\n  extensionNumber: '',\n  autoAnswer: false,\n};\n\ntype AutoConfigType =\n  | 'already success'\n  | 'other tab config'\n  | 'config'\n  | 'retry';\n\ntype ConfigureAgentParams = {\n  config?: EvConfigureAgentOptions;\n  triggerEvent?: boolean;\n  needAssignFormGroupValue?: boolean;\n};\n\n@Module({\n  name: 'EvAgentSession',\n  deps: [\n    'EvClient',\n    'Auth',\n    'EvAuth',\n    'EvCallDataSource',\n    'Alert',\n    'Auth',\n    'Locale',\n    'Presence',\n    'RouterInteraction',\n    'ModalUI',\n    'Block',\n    'Beforeunload',\n    'Storage',\n    { dep: 'TabManager', optional: true },\n    { dep: 'EvAgentSessionOptions', optional: true },\n  ],\n})\nclass EvAgentSession extends RcModuleV2<Deps> implements AgentSession {\n  isForceLogin = false;\n  isReconnected = false;\n  isAgentUpdating = false;\n\n  private _isReConfiguring = false;\n\n  _autoConfigureRetryTimes = 0;\n\n  private _eventEmitter = new EventEmitter();\n  private _loginPromise: Promise<void>;\n\n  private _updateSessionBlockId: string;\n  private _isLogin = false;\n\n  private _tabConfigWorking = new TabLife(\n    `${this._deps.tabManager.prefix}sessionConfig_working`,\n  );\n\n  private _tabConfigSuccess = new TabLife(\n    `${this._deps.tabManager.prefix}sessionConfig_success`,\n  );\n\n  @tabManagerEnabled()\n  private _configSuccessAlive() {\n    this._tabConfigSuccess.alive();\n  }\n\n  @tabManagerEnabled()\n  private _configWorkingAlive() {\n    this._tabConfigWorking.alive();\n  }\n\n  async isConfigTabAlive() {\n    return !this.tabManagerEnabled || this._tabConfigSuccess?.isAlive();\n  }\n\n  get shouldBlockBrowser() {\n    // when there is not integrated softphone and not has multiple tabs\n    return !this.isIntegratedSoftphone && !this.hasMultipleTabs;\n  }\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvAgentSession',\n    });\n    // ! that onceLoginSuccess for get event before onInitOnce.\n    this._deps.evAuth.onceLoginSuccess(() => {\n      // when that is seconds time get onLoginSuccess\n      console.log('----------onLoginSuccess1');\n      this._isLogin = true;\n    });\n    // ! logout event should in constructor, when logout that will not call init.\n    this._deps.evAuth.beforeAgentLogout(() => {\n      this._resetAllState();\n    });\n\n    this._deps.presence.beforeunloadHandler = () => this.shouldBlockBrowser;\n    watch(\n      this,\n      () => this.configSuccess,\n      (configSuccess) => {\n        if (configSuccess) {\n          this._emitConfigSuccess();\n        }\n      },\n    );\n  }\n\n  @storage\n  @state\n  selectedSkillProfileId: string = NONE;\n\n  @storage\n  @state\n  selectedInboundQueueIds: string[] = [];\n\n  @storage\n  @state\n  loginType: LoginTypes = DEFAULT_LOGIN_TYPE;\n\n  @storage\n  @state\n  extensionNumber = '';\n\n  @storage\n  @state\n  takingCall = true;\n\n  @storage\n  @state\n  autoAnswer = false;\n\n  @storage\n  @state\n  configured = false;\n\n  @state\n  configSuccess = false;\n\n  @storage\n  @state\n  formGroup: FormGroup = DEFAULT_FORM_GROUP;\n\n  @storage\n  @state\n  accessToken = '';\n\n  get isExternalPhone() {\n    return this.formGroup.loginType === loginTypes.externalPhone;\n  }\n\n  get isIntegratedSoftphone() {\n    return this.loginType === loginTypes.integratedSoftphone;\n  }\n\n  get localStorage() {\n    return window?.localStorage;\n  }\n\n  get tabManagerEnabled() {\n    return this._deps.tabManager?.enable;\n  }\n\n  get hasMultipleTabs() {\n    return this._deps.tabManager?.hasMultipleTabs;\n  }\n\n  @computed((that: EvAgentSession) => [that._deps.locale.currentLocale])\n  get loginTypeList() {\n    const { currentLocale } = this._deps.locale;\n\n    return ACCEPTABLE_LOGIN_TYPES.map(\n      (type) =>\n        ({\n          id: type,\n          label: i18n.getString(type, currentLocale),\n        } as LoginType),\n    );\n  }\n\n  @computed((that: EvAgentSession) => [\n    that._deps.evAuth.agentConfig,\n    that._deps.auth.isFreshLogin,\n  ])\n  get inboundQueues() {\n    const { agentConfig, agentPermissions } = this._deps.evAuth;\n    if (\n      !agentConfig ||\n      !agentConfig?.inboundSettings ||\n      !agentPermissions?.allowInbound\n    ) {\n      return [];\n    }\n    const {\n      inboundSettings: { availableQueues = [] },\n    } = agentConfig;\n\n    const { isFreshLogin } = this._deps.auth;\n\n    return availableQueues.map((queue) => ({\n      gateId: queue.gateId,\n      gateName: queue.gateName,\n      checked: isFreshLogin,\n    }));\n  }\n\n  @computed((that: EvAgentSession) => [that.skillProfileList])\n  get defaultSkillProfileId() {\n    const defaultSkill = this._pickSkillProfile(this.skillProfileList);\n    return defaultSkill ? defaultSkill.profileId : NONE;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that._deps.evAuth.agent,\n    that._deps.locale.currentLocale,\n  ])\n  get skillProfileList() {\n    const { agentConfig } = this._deps.evAuth.agent || {};\n\n    if (!agentConfig || !agentConfig.inboundSettings) {\n      return [];\n    }\n    const {\n      inboundSettings: { availableSkillProfiles = [] },\n    } = agentConfig;\n\n    const defaultSkill = this._pickSkillProfile(availableSkillProfiles);\n\n    if (!defaultSkill && availableSkillProfiles.length > 0) {\n      return [\n        {\n          profileId: NONE,\n          profileName: i18n.getString(NONE, this._deps.locale.currentLocale),\n        },\n        ...availableSkillProfiles,\n      ];\n    }\n\n    return availableSkillProfiles;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.skillProfileList,\n    that.selectedSkillProfileId,\n  ])\n  get selectedSkillProfile() {\n    const selectedSkillProfile = this.skillProfileList.find(\n      (profile) => profile.profileId === this.formGroup.selectedSkillProfileId,\n    );\n    return selectedSkillProfile?.profileName;\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.inboundQueues,\n    that.selectedInboundQueueIds,\n  ])\n  get selectedInboundQueues() {\n    const results = this.formGroup.selectedInboundQueueIds.map((id) => {\n      return this.inboundQueues.find((queue) => queue.gateId === id);\n    });\n    return results.filter((result) => result).map((result) => result.gateName);\n  }\n\n  @action\n  resetAllConfig() {\n    this.selectedInboundQueueIds = [];\n    this.selectedSkillProfileId = NONE;\n    this.loginType = DEFAULT_LOGIN_TYPE;\n    this.extensionNumber = '';\n    this.takingCall = true;\n    this.autoAnswer = false;\n    this.configSuccess = false;\n    this.configured = false;\n  }\n\n  @action\n  setAccessToken(token: string) {\n    this.accessToken = token;\n  }\n\n  @action\n  _setConfigSuccess(status: boolean) {\n    this.configSuccess = status;\n  }\n\n  @action\n  setConfigSuccess(status: boolean) {\n    console.log('setConfigSuccess~', status);\n    this.configSuccess = status;\n    this.configured = status;\n  }\n\n  @track((_: EvAgentSession, type: LoginTypes) => [\n    trackEvents.agentSessionSetLoginType,\n    { value: type },\n  ])\n  @action\n  setLoginType(type: LoginTypes) {\n    this.loginType = type;\n  }\n\n  @track((_: EvAgentSession, skillProfileId: string) => [\n    trackEvents.agentSessionSetSkillProfileId,\n    { value: skillProfileId },\n  ])\n  @action\n  setSkillProfileId(skillProfileId: string) {\n    this.selectedSkillProfileId = skillProfileId;\n  }\n\n  @track((_: EvAgentSession, ids: string[]) => [\n    trackEvents.agentSessionSetInboundQueueIds,\n    { value: ids },\n  ])\n  @action\n  setInboundQueueIds(ids: string[]) {\n    this.selectedInboundQueueIds = ids;\n  }\n\n  @action\n  setExtensionNumber(extensionNumber: string) {\n    this.extensionNumber = extensionNumber;\n  }\n\n  @track((_: EvAgentSession, takingCall: boolean) => [\n    trackEvents.agentSessionSetTakingCall,\n    { value: takingCall },\n  ])\n  @action\n  setTakingCall(takingCall: boolean) {\n    this.takingCall = takingCall;\n  }\n\n  @track((_: EvAgentSession, autoAnswer: boolean) => [\n    trackEvents.agentSessionSetAutoAnswer,\n    { value: autoAnswer },\n  ])\n  @action\n  setAutoAnswer(autoAnswer: boolean) {\n    this.autoAnswer = autoAnswer;\n  }\n\n  @action\n  setFreshConfig() {\n    this._clearCalls();\n\n    this.loginType = DEFAULT_LOGIN_TYPE;\n    this.extensionNumber = '';\n    this.takingCall = true;\n    this.autoAnswer = this.defaultAutoAnswerOn;\n    this.configSuccess = false;\n    this.configured = false;\n\n    this.selectedSkillProfileId = this.defaultSkillProfileId;\n    if (this._deps.evAuth.agentPermissions.allowInbound) {\n      this.selectedInboundQueueIds = this.inboundQueues.map(\n        (inboundQueue) => inboundQueue.gateId,\n      );\n    }\n  }\n\n  get defaultAutoAnswerOn() {\n    return this._deps.evAuth.agentPermissions.defaultAutoAnswerOn;\n  }\n\n  @action\n  assignFormGroupValue() {\n    const {\n      selectedInboundQueueIds,\n      extensionNumber,\n      loginType,\n      selectedSkillProfileId,\n      autoAnswer,\n    } = this.formGroup;\n    this.selectedInboundQueueIds = selectedInboundQueueIds;\n    this.extensionNumber = extensionNumber;\n    this.loginType = loginType;\n    this.selectedSkillProfileId = selectedSkillProfileId;\n    this.autoAnswer = autoAnswer;\n  }\n\n  @action\n  setFormGroup(data: FormGroup) {\n    this.formGroup = { ...this.formGroup, ...data };\n  }\n\n  resetFormGroup() {\n    this.setFormGroup({\n      selectedInboundQueueIds: this.selectedInboundQueueIds,\n      selectedSkillProfileId: this.selectedSkillProfileId,\n      loginType: this.loginType,\n      extensionNumber: this.extensionNumber,\n      autoAnswer: this.autoAnswer,\n    });\n  }\n\n  @computed((that: EvAgentSession) => [\n    that.selectedInboundQueueIds,\n    that.selectedSkillProfileId,\n    that.loginType,\n    that.extensionNumber,\n    that.formGroup,\n  ])\n  get isSessionChanged() {\n    const sessionConfigs = {\n      selectedInboundQueueIds: this.selectedInboundQueueIds,\n      selectedSkillProfileId: this.selectedSkillProfileId,\n      loginType: this.loginType,\n      extensionNumber: this.extensionNumber,\n      autoAnswer: this.autoAnswer,\n    };\n    return !equals(sessionConfigs, this.formGroup);\n  }\n\n  _shouldReset() {\n    return super._shouldReset() && !this._deps.auth.loggedIn;\n  }\n\n  async checkIsMainTabAlive() {\n    return this._deps.tabManager.checkIsMainTabAlive();\n  }\n\n  private _mainTabBeforeunloadHandler = () => {\n    console.log(\n      '_mainTabBeforeunloadHandler~~',\n      this._deps.tabManager.hasMultipleTabs,\n      this.isMainTab,\n      this._deps.tabManager.firstTabIdExcludeMainTab,\n    );\n\n    if (\n      this._deps.tabManager.hasMultipleTabs &&\n      this.isMainTab &&\n      this._deps.tabManager.firstTabIdExcludeMainTab\n    ) {\n      return true;\n    }\n    return false;\n  };\n\n  private _mainTabAfterUnloadHandler = () => {\n    console.log(\n      '_mainTabAfterUnloadHandler~~',\n      this._deps.tabManager.firstTabIdExcludeMainTab,\n    );\n    this._deps.evCallDataSource.changeCallsLimited(false);\n    if (!this.isMainTab) return;\n    const firstTabIdExcludeMainTab =\n      this._deps.tabManager.firstTabIdExcludeMainTab;\n\n    this._deps.tabManager.setMainTabId(firstTabIdExcludeMainTab);\n\n    this._sendTabManager(\n      tabManagerEvents.MAIN_TAB_WILL_UNLOAD,\n      firstTabIdExcludeMainTab,\n    );\n  };\n\n  @tabManagerEnabled()\n  private _setMainTabId() {\n    console.log('_setMainTabId~~~');\n    const { id } = this._deps.tabManager;\n    this._deps.tabManager.setMainTabId(id);\n    this._deps.beforeunload.add(this._mainTabBeforeunloadHandler);\n    this._deps.beforeunload.onAfterUnload(\n      this._mainTabAfterUnloadHandler,\n      true,\n    );\n  }\n\n  onInitOnce() {\n    this._init();\n\n    this.onConfigSuccess(() => {\n      if (this._deps.presence.calls.length === 0) {\n        this._deps.presence.setDialoutStatus(dialoutStatuses.idle);\n      }\n\n      if (this.isAgentUpdating) {\n        this.isAgentUpdating = false;\n      } else {\n        console.log('!!!!to Dialer');\n        this._deps.routerInteraction.push('/dialer');\n      }\n    });\n  }\n\n  private async _tabReConfig() {\n    console.log('_tabReConfig~~~', this._isReConfiguring);\n    if (this._isReConfiguring) return;\n\n    this._isReConfiguring = true;\n\n    if (this.isIntegratedSoftphone) {\n      try {\n        await this._deps.block.next(async () => {\n          // !! sip register need to configure agent at fisrt\n          await this.configureAgent({\n            triggerEvent: false,\n          });\n        });\n      } catch (error) {\n        console.error('re config fail', error);\n        this._emitReConfigFail();\n        return;\n      }\n    } else {\n      this._configWorkingAlive();\n    }\n\n    this.isReconnected = true;\n\n    this._mainTabHandle();\n    this._configSuccessAlive();\n\n    this._isReConfiguring = false;\n  }\n\n  // _newMainTabReConfig and _pollAskIfCanBeNewMainTab are all for handle new main tab\n  private async _newMainTabReConfig() {\n    console.log(\n      '_newMainTabReConfig~',\n      !this.isReconnected,\n      this._deps.evAuth.connected,\n      this.configSuccess,\n      this.isMainTab,\n    );\n\n    if (\n      !this.isReconnected &&\n      this._deps.evAuth.connected &&\n      this.configSuccess &&\n      this.isMainTab\n    ) {\n      console.log('_newMainTabReConfig success~');\n      await this._tabReConfig();\n    }\n  }\n\n  @tabManagerEnabled()\n  private _pollAskIfCanBeNewMainTab() {\n    console.log('_pollAskIfCanBeNewMainTab~~');\n    this._tabConfigSuccess.onLeave(async () => {\n      console.log(\n        '_tabReConfig in _pollAskIfCanBeNewMainTab~',\n        this._deps.tabManager.isFirstTab,\n        this._deps.evAuth.connected,\n        this.configSuccess,\n        !this._isReConfiguring,\n      );\n      if (\n        this._deps.tabManager.isFirstTab &&\n        this._deps.evAuth.connected &&\n        this.configSuccess &&\n        !this._isReConfiguring &&\n        (await this._tabConfigWorking.isLeave())\n      ) {\n        await this._tabReConfig();\n      } else if (!this.isMainTab) {\n        this._pollAskIfCanBeNewMainTab();\n      }\n    }, 3000);\n  }\n\n  @computed((that: EvAgentSession) => [\n    that._deps.evAuth.isEvLogged,\n    that.ready,\n  ])\n  get isOnLoginSuccess() {\n    return this.ready && this._deps.evAuth.isEvLogged;\n  }\n\n  private async _init() {\n    if (this._isLogin) {\n      await this.initAgentSession();\n    }\n    // ! that must call after onInitOnce, because when that is not in init once,\n    // ! that configured will some times to be false because storage block\n    watch(\n      this,\n      () => this.isOnLoginSuccess,\n      async (isOnLoginSuccess) => {\n        if (isOnLoginSuccess) {\n          // when that is seconds time get onLoginSuccess\n          console.log('----------onLoginSuccess2');\n          await this.initAgentSession();\n        }\n      },\n    );\n  }\n\n  async initAgentSession() {\n    await this._deps.block.next(async () => {\n      this._initTabLife();\n      await this._initAgentSession();\n    });\n  }\n\n  private async _initAgentSession() {\n    console.log('_initAgentSession~', this.isAgentUpdating);\n    if (this.isAgentUpdating) {\n      return;\n    }\n    this._afterLogin();\n\n    console.log('autoconfig~', !this._deps.auth.isFreshLogin, this.configured);\n\n    if (this._deps.auth.isFreshLogin === false && this.configured) {\n      try {\n        return this._autoConfigureAgent();\n      } catch (e) {\n        console.error(e);\n      }\n    }\n\n    this.setFreshConfig();\n\n    this.resetFormGroup();\n\n    this._navigateToSessionConfigPage();\n  }\n\n  private _navigateToSessionConfigPage() {\n    this._deps.routerInteraction.push('/sessionConfig');\n    console.log('to sessionConfig~~');\n  }\n\n  // ! also reset in onReset for auth logout by rc\n  onReset() {\n    console.log('onReset in EvAgentSession~~');\n    try {\n      this._resetAllState();\n      this.isAgentUpdating = false;\n    } catch (error) {\n      // ignore error\n    }\n  }\n\n  private _resetAllState() {\n    console.log('_resetAllState~~', this.isMainTab);\n    if (!this.isAgentUpdating) {\n      this.resetAllConfig();\n    }\n    if (this.isMainTab) {\n      this._deps.tabManager.setMainTabId(null);\n    }\n    this.setConfigSuccess(false);\n    this.isReconnected = false;\n    this._destroyTabLife();\n    this._deps.evCallDataSource.changeCallsLimited(false);\n    this._deps.beforeunload.clear();\n    this._deps.beforeunload.removeAfterUnloadListener(\n      this._mainTabAfterUnloadHandler,\n    );\n  }\n\n  async onStateChange() {\n    if (this.ready && this.tabManagerEnabled && this._deps.tabManager.ready) {\n      await this._checkTabManagerEvent();\n    }\n  }\n\n  private async _checkTabManagerEvent() {\n    const { event } = this._deps.tabManager;\n    const data = event?.args[0];\n    if (event) {\n      switch (event.name) {\n        case tabManagerEvents.AGENT_CONFIG_SUCCESS:\n          console.log(\n            '_othersTabConfigureAgent from tabManagerEvents.AGENT_CONFIG_SUCCESS~~',\n          );\n          try {\n            await this._othersTabConfigureAgent();\n          } catch (error) {\n            this._configureFail();\n          }\n          break;\n        case tabManagerEvents.UPDATE_SESSION:\n          this._updateSessionBlockId = this._deps.block.block();\n          this.isAgentUpdating = true;\n\n          // if voiceConnectionChanged\n          if (data) {\n            this.onceLogoutThenLogin().then((loginPromise) => {\n              this._loginPromise = loginPromise;\n            });\n          }\n          break;\n        case tabManagerEvents.MAIN_TAB_WILL_UNLOAD:\n          console.log(\n            'MAIN_TAB_WILL_UNLOAD~~',\n            data === this._deps.tabManager.tabbie.id,\n            this.isMainTab,\n          );\n          if (data === this._deps.tabManager.tabbie.id || this.isMainTab) {\n            // now this tab is the new main tab\n            await this._newMainTabReConfig();\n          }\n          break;\n        case tabManagerEvents.SET_MIAN_TAB_ID:\n          if (this._deps.tabManager.mainTabId !== data) {\n            console.log('SET_MIAN_TAB_ID in this tab~');\n            this._deps.tabManager.setMainTabIdInThisTab(data);\n          }\n          break;\n        case tabManagerEvents.UPDATE_SESSION_SUCCESS:\n          try {\n            console.log('UPDATE_SESSION_SUCCESS~~', data);\n            // if voiceConnectionChanged\n            if (data) {\n              this._destroyTabLife();\n              this._initTabLife();\n              await this._loginPromise;\n              await this._othersTabConfigureAgent();\n            } else {\n              this.setConfigSuccess(true);\n            }\n\n            this._unblockUpdateSession();\n\n            this.isAgentUpdating = false;\n          } catch (error) {\n            // when that auto config fail, just reload that tab\n            console.log(error);\n            window.location.reload();\n          }\n          break;\n        case tabManagerEvents.UPDATE_SESSION_SUCCESS_ALERT:\n          this._showUpdateSuccessAlert();\n          break;\n        case tabManagerEvents.UPDATE_SESSION_FAIL:\n          this._unblockUpdateSession();\n          break;\n        case tabManagerEvents.RELOGIN:\n          await this.reLoginAgent({\n            isBlock: true,\n            alertMessage: messageTypes.NOT_INBOUND_QUEUE_SELECTED,\n          });\n          break;\n        case tabManagerEvents.CONFIGURE_FAIL:\n          console.log('other tab be called to invoke _configureFail~~');\n          this._configureFail();\n          break;\n        default:\n          break;\n      }\n    }\n  }\n\n  private _unblockUpdateSession() {\n    this._deps.block.unblock(this._updateSessionBlockId);\n  }\n\n  @tabManagerEnabled()\n  private _initTabLife() {\n    console.log('initTabLife~');\n    this._tabConfigWorking.init();\n    this._tabConfigSuccess.init();\n  }\n\n  @tabManagerEnabled()\n  private _destroyTabLife() {\n    this._tabConfigWorking?.destroy();\n    this._tabConfigSuccess?.destroy();\n  }\n\n  private _afterLogin() {\n    // if that is not first login set SessionConfig data again\n    if (!this._deps.auth.isFreshLogin) {\n      const checkSelectIsInList = this.skillProfileList.some(\n        (profile) => profile.profileId === this.selectedSkillProfileId,\n      );\n      if (!checkSelectIsInList) {\n        this.setSkillProfileId(this.defaultSkillProfileId);\n      }\n\n      // check all selected queue is in inboundQueue list\n      const checkedInboundQueues = this.selectedInboundQueueIds.reduce(\n        (result, inboundQueueId) => {\n          if (\n            this.inboundQueues.some(\n              (inboundQueue) => inboundQueue.gateId === inboundQueueId,\n            )\n          ) {\n            result.push(inboundQueueId);\n          }\n          return result;\n        },\n        [],\n      );\n      this.setInboundQueueIds(checkedInboundQueues);\n    }\n  }\n\n  private _emitTriggerConfig() {\n    this._eventEmitter.emit(agentSessionEvents.TRIGGER_CONFIG);\n  }\n\n  onTriggerConfig(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.TRIGGER_CONFIG, callback);\n    return this;\n  }\n\n  private _emitConfigSuccess() {\n    this._eventEmitter.emit(agentSessionEvents.CONFIG_SUCCESS);\n  }\n\n  onConfigSuccess(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.CONFIG_SUCCESS, callback);\n    return this;\n  }\n\n  private _emitReConfigFail() {\n    this._eventEmitter.emit(agentSessionEvents.RECONFIG_FAIL);\n  }\n\n  onReConfigFail(callback: () => void) {\n    this._eventEmitter.on(agentSessionEvents.RECONFIG_FAIL, callback);\n    return this;\n  }\n\n  private _mainTabHandle() {\n    console.log('_mainTabHandle~~');\n    this._setMainTabId();\n    // refresh token prevent get token fail to get sip_info\n    this._deps.evClient.getRefreshedToken();\n    this._deps.tabManager.emitSetMainTabComplete();\n  }\n\n  async updateAgentConfigs() {\n    const agentConfig = await this._deps.evClient.getAgentConfig();\n    const agent = {\n      ...this._deps.evAuth.agent,\n      agentConfig,\n    };\n    this._deps.evAuth.setAgent(agent);\n    // !! update agentConfig need before set config success.\n    this.setConfigSuccess(true);\n  }\n\n  /**\n   * config agent in session config page\n   * @param triggerEvent is that should trigger event, default is true\n   */\n  @track((that: EvAgentSession) => [\n    trackEvents.agentSessionConfigureAgent,\n    {\n      'Voice Connection': that.loginType,\n      'Persistent Voice Connection': that.takingCall,\n      'Skill Profile': that.selectedSkillProfile,\n      'Inbound Queues': that.selectedInboundQueues,\n      'Auto Answer': that.autoAnswer,\n    },\n  ])\n  async configureAgent({\n    config = this._checkFieldsResult(this.formGroup),\n    triggerEvent = true,\n    needAssignFormGroupValue = false,\n  }: ConfigureAgentParams = {}) {\n    this._configWorkingAlive();\n    console.log('configureAgent~~', triggerEvent);\n    this._clearCalls();\n    const connectResult = await this._connectEvServer(config);\n    let result = connectResult.result;\n    const existingLoginFound = connectResult.existingLoginFound;\n    // Session timeout\n    // this will occur when stay in session config page for long time\n    if (result.data.status !== 'SUCCESS') {\n      this._navigateToSessionConfigPage();\n      await this._deps.evAuth.newReconnect(false);\n\n      if (existingLoginFound) {\n        config.isForce = true;\n      }\n      result = (await this._connectEvServer(config)).result;\n    }\n\n    this._handleAgentResult({ config: result.data, needAssignFormGroupValue });\n\n    if (triggerEvent) {\n      this._mainTabHandle();\n      this._emitTriggerConfig();\n      this._configSuccessAlive();\n      this._sendTabManager(tabManagerEvents.AGENT_CONFIG_SUCCESS);\n      this.setConfigSuccess(true);\n    }\n  }\n\n  async updateAgent(voiceConnectionChanged: boolean) {\n    try {\n      await this._deps.block.next(async () => {\n        if (voiceConnectionChanged) this._configWorkingAlive();\n        const config = this._checkFieldsResult(this.formGroup);\n\n        this._clearCalls();\n\n        this.isAgentUpdating = true;\n\n        this._sendTabManager(\n          tabManagerEvents.UPDATE_SESSION,\n          voiceConnectionChanged,\n        );\n\n        const extensionNumberChanged =\n          this.extensionNumber !== this.formGroup.extensionNumber;\n\n        if (voiceConnectionChanged || extensionNumberChanged)\n          await this.reLoginAgent();\n\n        config.isForce = true;\n        const { result } = await this._connectEvServer(config);\n        this._handleAgentResult({\n          config: result.data,\n          isAgentUpdating: true,\n          needAssignFormGroupValue: true,\n        });\n\n        if (voiceConnectionChanged) {\n          this._mainTabHandle();\n          this._emitTriggerConfig();\n        }\n\n        await this.updateAgentConfigs();\n\n        if (voiceConnectionChanged) this._configSuccessAlive();\n\n        // * update session complete, and config ready\n        this._sendTabManager(\n          tabManagerEvents.UPDATE_SESSION_SUCCESS,\n          voiceConnectionChanged,\n        );\n\n        this.goToSettingsPage();\n\n        this._sendTabManager(tabManagerEvents.UPDATE_SESSION_SUCCESS_ALERT);\n        this._showUpdateSuccessAlert();\n      });\n    } catch (error) {\n      this._sendTabManager(tabManagerEvents.UPDATE_SESSION_FAIL);\n      this._unblockUpdateSession();\n\n      console.error('error', error);\n    }\n  }\n\n  async reLoginAgent({\n    isBlock,\n    alertMessage,\n  }: {\n    isBlock?: boolean;\n    alertMessage?: string;\n  } = {}) {\n    const fn = async () => {\n      if (alertMessage) {\n        this._deps.alert.danger({\n          message: alertMessage,\n          ttl: 0,\n        });\n      }\n      this._deps.evAuth.sendLogoutTabEvent();\n\n      const { access_token } = await this._deps.auth.refreshToken();\n      this.setAccessToken(access_token);\n\n      // * then do logout send to every tab\n      await this._deps.evAuth.logoutAgent();\n\n      // ! wait all tab is logout complete, server has some delay after logout\n      await sleep(WAIT_EV_SERVER_ROLLBACK_DELAY);\n\n      await this._deps.evAuth.loginAgent(this.accessToken);\n    };\n\n    return isBlock ? this._deps.block.next(fn) : fn();\n  }\n\n  onceLogoutThenLogin() {\n    return new Promise<Promise<void>>((resolve) => {\n      this._deps.evAuth.onceLogout(async () => {\n        // ! wait all tab is logout complete, server has some delay after logout\n        await sleep(WAIT_EV_SERVER_ROLLBACK_DELAY);\n        resolve(this._deps.evAuth.loginAgent(this.accessToken));\n      });\n    });\n  }\n\n  goToSettingsPage() {\n    this._deps.routerInteraction.push('/settings');\n  }\n\n  private _showUpdateSuccessAlert() {\n    this._deps.alert.success({\n      message: messageTypes.UPDATE_AGENT_SUCCESS,\n    });\n  }\n\n  private _handleAgentResult({\n    config: { message, status },\n    isAgentUpdating,\n    needAssignFormGroupValue,\n  }: {\n    config: EvAgentConfig;\n    isAgentUpdating?: boolean;\n    needAssignFormGroupValue?: boolean;\n  }) {\n    if (status !== 'SUCCESS') {\n      if (typeof message === 'string') {\n        this._deps.alert.danger({\n          message: messageTypes.AGENT_CONFIG_DETAIL_ERROR,\n          ttl: 0,\n          payload: message,\n        });\n      } else {\n        this._deps.alert.danger({\n          message: isAgentUpdating\n            ? messageTypes.UPDATE_AGENT_ERROR\n            : messageTypes.AGENT_CONFIG_ERROR,\n          ttl: 0,\n        });\n      }\n      throw new Error(message);\n    }\n    if (needAssignFormGroupValue) {\n      this.assignFormGroupValue();\n    }\n  }\n\n  private async _autoConfigureAgent(): Promise<void> {\n    console.log('_autoConfigureAgent~', this.tabManagerEnabled);\n\n    const isFirstTab = this._deps.tabManager.isFirstTab;\n\n    if (this._autoConfigureRetryTimes >= 5) {\n      console.log('stop autoConfigureRetry~~', this._autoConfigureRetryTimes);\n      this._autoConfigureRetryTimes = 0;\n      return this._configureFail(isFirstTab);\n    }\n\n    let timeoutId: NodeJS.Timeout = null;\n    if (this.tabManagerEnabled) {\n      const resolves: ((\n        value?: AutoConfigType | PromiseLike<AutoConfigType>,\n      ) => void)[] = [null, null, null];\n      return Promise.race<AutoConfigType>([\n        new Promise<AutoConfigType>((res) => {\n          console.log('res already success~~');\n          resolves[0] = () => res('already success');\n\n          this._eventEmitter.once(\n            agentSessionEvents.CONFIG_SUCCESS,\n            resolves[0],\n          );\n        }),\n        new Promise<AutoConfigType>((res) => {\n          resolves[1] = res;\n          // check isSuccess first\n          if (this.isAgentUpdating || this._deps.tabManager.tabs.length !== 1) {\n            const checkIsAlive = () => {\n              console.log('checkIsAlive~~');\n              this._tabConfigSuccess.isAlive().then(async (result) => {\n                console.log('isAlive ?~', result);\n                if (result) {\n                  console.log('res other tab config~~');\n                  res('other tab config');\n                } else {\n                  checkIsAlive();\n                }\n              });\n            };\n\n            checkIsAlive();\n          }\n        }),\n        new Promise<AutoConfigType>((res) => {\n          resolves[2] = res;\n          // when there is too many tab, that event will block\n          // then check local\n          if (isFirstTab) {\n            this._tabConfigWorking.isLeave().then(async (result) => {\n              console.log('isLeave ?~', result);\n              if (result) {\n                this._configWorkingAlive();\n                console.log('res config~~');\n                res('config');\n              }\n            });\n          }\n        }),\n        new Promise<AutoConfigType>((res) => {\n          timeoutId = setTimeout(() => {\n            res('retry');\n          }, 10000);\n        }),\n      ])\n        .then((result) => {\n          clearTimeout(timeoutId);\n          this._eventEmitter.off(\n            agentSessionEvents.CONFIG_SUCCESS,\n            resolves[0],\n          );\n          console.log('clear all memory with promise~');\n          // clear all memory with promise\n          resolves.forEach((r) => r());\n          resolves.length = 0;\n\n          console.log('!!!!!', result);\n\n          switch (result) {\n            case 'retry':\n              console.log('retry auto config~');\n              this._autoConfigureRetryTimes++;\n              return this._autoConfigureAgent();\n            case 'other tab config':\n              console.log('_othersTabConfigureAgent in auto config~~');\n              return this._othersTabConfigureAgent();\n            case 'config': {\n              console.log('configureAgent in auto config~~');\n              //! when reConfig, if that change queue or others field in ev admin, that will get error, should redirect to sessionPage\n              const config = this._checkFieldsResult({\n                selectedInboundQueueIds: this.selectedInboundQueueIds,\n                selectedSkillProfileId: this.selectedSkillProfileId,\n                loginType: this.loginType,\n                extensionNumber: this.extensionNumber,\n              });\n              return this.configureAgent({ config });\n            }\n            case 'already success':\n            default:\n              return Promise.resolve();\n          }\n        })\n        .catch((e) => {\n          console.log('_autoConfigureAgent error~~', e);\n          this._configureFail(isFirstTab);\n          return e;\n        });\n    }\n\n    return this.configureAgent();\n  }\n\n  _configureFail(needAsyncAllTabs = false) {\n    console.log(\n      '_configureFail~~',\n      this._deps.tabManager.hasMultipleTabs,\n      needAsyncAllTabs,\n    );\n    if (this._deps.tabManager.hasMultipleTabs && needAsyncAllTabs) {\n      this._sendTabManager(tabManagerEvents.CONFIGURE_FAIL);\n    }\n    this._navigateToSessionConfigPage();\n    this._setConfigSuccess(false);\n  }\n\n  async _othersTabConfigureAgent() {\n    console.log('_othersTabConfigureAgent~~', this.configSuccess);\n    if (this.configSuccess) {\n      return;\n    }\n\n    await this._deps.evClient.multiLoginRequest();\n\n    await this.updateAgentConfigs();\n\n    if (this.notInboundQueueSelected) {\n      this._sendTabManager(tabManagerEvents.RELOGIN);\n      await this.reLoginAgent({\n        isBlock: true,\n        alertMessage: messageTypes.NOT_INBOUND_QUEUE_SELECTED,\n      });\n    }\n\n    this._pollAskIfCanBeNewMainTab();\n  }\n\n  private _pickSkillProfile(skillProfileList: EvAvailableSkillProfile[]) {\n    return skillProfileList.find((item) => item.isDefault === '1');\n  }\n\n  private async _connectEvServer(config: EvConfigureAgentOptions) {\n    console.log('configure ev agent in _connectEvServer~~', config);\n    let result = await this._deps.evClient.configureAgent(config);\n    const { status } = result.data;\n    const existingLoginFound = status === messageTypes.EXISTING_LOGIN_FOUND;\n\n    if (existingLoginFound) {\n      const { currentLocale } = this._deps.locale;\n\n      // TODO: think about sync up in all tabs?\n      const confirmed = await this._deps.modalUI.confirm(\n        {\n          title: i18n.getString('multipleLoginsTitle', currentLocale),\n          content: i18n.getString('multipleLoginsContent', currentLocale),\n          confirmButtonText: i18n.getString(\n            'multipleLoginsConfirm',\n            currentLocale,\n          ),\n          cancelButtonText: i18n.getString(\n            'multipleLoginsCancel',\n            currentLocale,\n          ),\n          onConfirm: async () => {\n            if (this._deps.evClient.appStatus === evStatus.CLOSED) {\n              await this._deps.evAuth.loginAgent();\n            }\n            result = await this._deps.evClient.configureAgent({\n              ...config,\n              isForce: true,\n            });\n            this.isForceLogin = true;\n          },\n          childrenSize: 'small',\n        },\n        true,\n      );\n\n      if (!confirmed) {\n        this.isForceLogin = false;\n        throw new Error(status);\n      }\n    } else if (status === messageTypes.EXISTING_LOGIN_ENGAGED) {\n      this._deps.alert.danger({\n        message: messageTypes.EXISTING_LOGIN_ENGAGED,\n        ttl: 0,\n      });\n\n      throw new Error(messageTypes.EXISTING_LOGIN_ENGAGED);\n    }\n\n    return { result, existingLoginFound };\n  }\n\n  private _checkFieldsResult(formGroup: FormGroup): EvConfigureAgentOptions {\n    const { selectedInboundQueueIds, selectedSkillProfileId } = formGroup;\n    if (this.notInboundQueueSelected) {\n      this._deps.alert.danger({\n        message: messageTypes.NOT_INBOUND_QUEUE_SELECTED,\n        ttl: 0,\n      });\n      throw new Error(`'queueIds' is an empty array.`);\n    }\n\n    return {\n      dialDest: this._getDialDest(formGroup),\n      queueIds: selectedInboundQueueIds,\n      skillProfileId:\n        selectedSkillProfileId === NONE ? '' : selectedSkillProfileId,\n    };\n  }\n\n  private _getDialDest({ loginType, extensionNumber }: FormGroup) {\n    // Only external phone has number input\n    switch (loginType) {\n      case loginTypes.externalPhone: {\n        if (!extensionNumber) {\n          this._deps.alert.danger({\n            message: messageTypes.EMPTY_PHONE_NUMBER,\n            ttl: 0,\n          });\n          throw new Error(`'extensionNumber' is an empty number.`);\n        }\n        const formatPhoneNumber = format({\n          phoneNumber: extensionNumber,\n        });\n        const { parsedNumber, isValid } = parse({\n          input: formatPhoneNumber,\n        });\n        if (!isValid || !parsedNumber || parsedNumber === '') {\n          this._deps.alert.danger({\n            message: messageTypes.INVALID_PHONE_NUMBER,\n            ttl: 0,\n          });\n          throw new Error(`'extensionNumber' is not a valid number.`);\n        }\n        this.setFormGroup({ extensionNumber: parsedNumber });\n        return extensionNumber;\n      }\n      case loginTypes.integratedSoftphone:\n        return 'integrated';\n      case loginTypes.RC_PHONE:\n      default:\n        return 'RC_PHONE';\n    }\n  }\n\n  private _sendTabManager(event: string, value?: any) {\n    this._deps.tabManager?.send(event, value);\n  }\n\n  private _clearCalls() {\n    this._deps.presence.clearCalls();\n  }\n\n  get isMainTab() {\n    return this._deps.tabManager.isMainTab;\n  }\n\n  get notInboundQueueSelected() {\n    return (\n      !this._deps.evAuth.agentPermissions.allowInbound ||\n      this.formGroup.selectedInboundQueueIds.length === 0\n    );\n  }\n}\n\nexport { EvAgentSession };\n"],"file":"EvAgentSession.js"}
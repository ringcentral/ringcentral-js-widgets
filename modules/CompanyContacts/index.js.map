{"version":3,"sources":["modules/CompanyContacts/index.js"],"names":["contactsRegExp","DEFAULT_TTL","DEFAULT_SHOW_DISABLED","DEFAULT_SHOW_NOT_ACTIVATED","DEFAULT_ALLOW_SETTINGS","DEFAULT_TYPE_FILTERS","extensionTypes","digitalUser","user","department","CompanyContacts","deps","dep","optional","client","rolesAndPermissions","storage","ttl","polling","showDisabled","extensionTypeFilters","showNotActivated","allowSettings","options","getReducer","getDataFetcherReducer","types","reducers","getDataReducer","getTimestampReducer","subscriptionFilters","companyContacts","subscriptionHandler","message","ready","test","event","body","contacts","contact","_processContact","fetchFunction","params","_client","account","directory","list","readyCheckFn","_rolesAndPermissions","_allowSettings","_storage","_settingsStorageKey","registerReducer","key","reducer","actionTypes","ensureExist","eventType","oldEtag","newEtag","store","dispatch","type","upsert","timestamp","Date","now","extensionNumber","item","filteredContacts","permissions","ReadExtensions","getItem","state","DataFetcher","selector","filters","typeFilter","acc","status","extensionStatusTypes","disabled","notActivated","data","_extensionFilter","extensionFilter"],"mappings":"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","sourcesContent":["import {\n  find,\n  filter,\n  reduce,\n} from 'ramda';\nimport { combineReducers } from 'redux';\nimport { Module } from '../../lib/di';\nimport DataFetcher from '../../lib/DataFetcher';\nimport { getDataFetcherReducer } from '../../lib/DataFetcher/getDataFetcherReducer';\nimport fetchList from '../../lib/fetchList';\nimport ensureExist from '../../lib/ensureExist';\nimport { selector } from '../../lib/selector';\n\nimport actionTypes from './actionTypes';\nimport {\n  getDataReducer,\n  getTimestampReducer,\n  getExtensionTypeFiltersReducer,\n  getShowDisabledReducer,\n  getShowNotActivatedReducer,\n} from './getReducers';\nimport subscriptionFilters from '../../enums/subscriptionFilters';\nimport extensionTypes from '../../enums/extensionTypes';\nimport { extensionStatusTypes } from '../../enums/extensionStatusTypes';\n\nconst contactsRegExp = /.*\\/directory\\/contacts$/;\n\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000;\nconst DEFAULT_SHOW_DISABLED = false;\nconst DEFAULT_SHOW_NOT_ACTIVATED = false;\nconst DEFAULT_ALLOW_SETTINGS = false;\n\n// Consider enable all extension types and filter through selector if\n// we'll allow users to configure this through settings\nconst DEFAULT_TYPE_FILTERS = [\n  extensionTypes.digitalUser,\n  extensionTypes.user,\n  extensionTypes.department,\n  // extensionTypes.limited,\n  // extensionTypes.announcement,\n  // extensionTypes.applicationExtension,\n  // extensionTypes.bot,\n  // extensionTypes.faxUser,\n  // extensionTypes.ivrMenu,\n  // extensionTypes.pagingOnly,\n  // extensionTypes.parkLocation,\n  // extensionTypes.sharedLinesGroup,\n];\n\n/**\n * @class\n * @description Accound extension list managing module\n */\n@Module({\n  deps: [\n    'Client',\n    'RolesAndPermissions',\n    { dep: 'CompanyContactsOptions', optional: true }\n  ]\n})\nexport default class CompanyContacts extends DataFetcher {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Number} params.ttl - local cache timestamp, default 24 hours\n   */\n  constructor({\n    client,\n    rolesAndPermissions,\n    storage,\n    ttl = DEFAULT_TTL,\n    polling = true,\n    showDisabled = DEFAULT_SHOW_DISABLED,\n    extensionTypeFilters = DEFAULT_TYPE_FILTERS,\n    showNotActivated = DEFAULT_SHOW_NOT_ACTIVATED,\n    allowSettings = DEFAULT_ALLOW_SETTINGS,\n    ...options\n  }) {\n    super({\n      ...options,\n      client,\n      storage,\n      ttl,\n      polling,\n      getReducer: (\n        allowSettings ?\n          getDataFetcherReducer :\n          (types, reducers = {}) => getDataFetcherReducer(\n            types,\n            {\n              ...reducers,\n              showDisabled: getShowDisabledReducer(types, showDisabled),\n              showNotActivated: getShowNotActivatedReducer(types, showNotActivated),\n              extensionTypeFilters: getExtensionTypeFiltersReducer(types, extensionTypeFilters),\n            }\n          )\n      ),\n      getDataReducer,\n      getTimestampReducer,\n      subscriptionFilters: [subscriptionFilters.companyContacts],\n      subscriptionHandler: async (message) => {\n        if (\n          this.ready &&\n          message &&\n          contactsRegExp.test(message.event) &&\n          message.body &&\n          message.body.contacts\n        ) {\n          for (const contact of message.body.contacts) {\n            await this._processContact(contact);\n          }\n        }\n      },\n      fetchFunction: () => fetchList(params => (\n        this._client.account().directory().contacts().list(params)\n      )),\n      readyCheckFn: () => this._rolesAndPermissions.ready,\n    });\n    this._allowSettings = allowSettings;\n\n    if (this._allowSettings) {\n      this._storage = ensureExist(storage, 'storage');\n      this._settingsStorageKey = 'CompanyContacts-settings';\n      this._storage.registerReducer({\n        key: this._settingsStorageKey,\n        reducer: combineReducers({\n          showDisabled: getShowDisabledReducer(this.actionTypes, showDisabled),\n          showNotActivated: getShowNotActivatedReducer(this.actionTypes, showNotActivated),\n          extensionTypeFilters: getExtensionTypeFiltersReducer(\n            this.actionTypes,\n            extensionTypeFilters,\n          ),\n        }),\n      });\n    }\n    this._rolesAndPermissions = this:: ensureExist(rolesAndPermissions, 'rolesAndPermissions');\n  }\n\n  get _name() {\n    return 'CompanyContacts';\n  }\n\n  get _actionTypes() {\n    return actionTypes;\n  }\n\n  async _processContact({\n    eventType,\n    oldEtag,\n    newEtag,\n    ...contact\n  }) {\n    switch (eventType) {\n      case 'Create':\n      case 'Update':\n        this.store.dispatch({\n          type: this.actionTypes.upsert,\n          contact,\n          timestamp: Date.now(),\n        });\n        break;\n      case 'Delete':\n        this.store.dispatch({\n          type: this.actionTypes.delete,\n          contact,\n          timestamp: Date.now(),\n        });\n        break;\n      default:\n        /* do nothing */\n    }\n  }\n\n  /**\n   * TODO: Currently we don't have clearly defined business rule on\n   * what extension numbers are considered available for dialing.\n   * @param {String} extensionNumber\n   * @returns {Boolean}\n   */\n  isAvailableExtension(extensionNumber) {\n    return !!find(item => item.extensionNumber === extensionNumber, this.filteredContacts);\n  }\n\n  @selector\n  _extensionFilter = [\n    () => this.showDisabled,\n    () => this.showNotActivated,\n    () => this.extensionTypeFilters,\n    (showDisabled, showNotActivated, filters) => {\n      const typeFilter = reduce(\n        (acc, item) => {\n          acc[item] = true;\n          return acc;\n        },\n        {},\n        filters,\n      );\n      return filter(item => !(\n        (!showDisabled && item.status === extensionStatusTypes.disabled) ||\n        (!showNotActivated && item.status === extensionStatusTypes.notActivated) ||\n        (!typeFilter[item.type])\n      ));\n    }\n  ]\n\n  @selector\n  filteredContacts = [\n    () => this.data,\n    () => this._extensionFilter,\n    (data, extensionFilter) => extensionFilter(data),\n  ]\n\n  get _hasPermission() {\n    return !!this._rolesAndPermissions.permissions.ReadExtensions;\n  }\n\n  get allowSettings() {\n    return this._allowSettings;\n  }\n\n  get showDisabled() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey).showDisabled;\n    }\n    return this.state.showDisabled;\n  }\n\n  get showNotActivated() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey).showNotActivated;\n    }\n    return this.state.showNotActivated;\n  }\n\n  get extensionTypeFilters() {\n    if (this.allowSettings) {\n      return this._storage.getItem(this._settingsStorageKey).extensionTypeFilters;\n    }\n    return this.state.extensionTypeFilters;\n  }\n}\n"],"file":"index.js"}
{"version":3,"sources":["modules/EvAgentScript/EvAgentScript.ts"],"names":["EvAgentScript","name","deps","dep","optional","enableCache","storageKey","_channel","_eventEmitter","EventEmitter","_hadResponse","debouncedSetCallScriptResult","fn","setCallScriptResult","state","isDisplayAgentScript","script","currentCallScript","id","data","callScriptResultMapping","emit","agentScriptEvents","SET_SCRIPT_RESULT","console","log","cb","on","UPDATE_DISPOSITION","_bindChannel","_responseInitScript","_deps","evCallMonitor","onCallAnswered","call","getIsAgentScript","getScript","scriptId","scriptVersion","uii","evAuth","beforeAgentLogout","reset","setIsDisplayAgentScript","tabManager","enable","sessionStorage","getItem","EV_AGENT_SCRIPT_BROADCAST_KEY","setItem","SingleTabBroadcastChannel","from","EV_APP_PAGE_KEY","to","EV_AGENT_SCRIPT_PAGE_KEY","init","addEventListener","key","value","evCall","activityCallId","currentCall","INIT","GET_KNOWLEDGE_BASE_ARTICLES","_getKnowledgeBaseGroups","setTimeout","knowledgeBaseGroupIds","evClient","getKnowledgeBaseGroups","send","config","version","type","response","result","JSON","parse","json","setCurrentCallScript","scriptResult","encodeUii","sessionId","session","_formatScriptResult","saveScriptResult","resultCopy","model","output","undefined","leadField","Object","entries","RcModuleV2","storage","action"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events';\nimport { clone, reduce } from 'ramda';\n\nimport { debounce } from '@ringcentral-integration/commons/lib/debounce-throttle';\nimport { Module } from '@ringcentral-integration/commons/lib/di';\nimport { SingleTabBroadcastChannel } from '@ringcentral-integration/commons/lib/SingleTabBroadcastChannel';\nimport {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  watch,\n} from '@ringcentral-integration/core';\n\nimport {\n  agentScriptEvents,\n  EV_AGENT_SCRIPT_BROADCAST_KEY,\n  EV_AGENT_SCRIPT_PAGE_KEY,\n  EV_APP_PAGE_KEY,\n} from '../../enums';\nimport { EvCallData } from '../../interfaces/EvData.interface';\nimport {\n  EvAgentScriptData,\n  EvAgentScriptResult,\n  EvAgentScriptResultModel,\n  EvBaseCall,\n  EvCallDispositionItem,\n  EvScriptResponseJSON,\n} from '../../lib/EvClient';\nimport {\n  AgentScript,\n  Deps,\n  EvCallScriptResultMapping,\n} from './EvAgentScript.interface';\n\n@Module({\n  name: 'EvAgentScript',\n  deps: [\n    'EvClient',\n    'EvAuth',\n    'EvCall',\n    'Storage',\n    'TabManager',\n    'EvCallMonitor',\n    { dep: 'EvAgentScriptOptions', optional: true },\n  ],\n})\nclass EvAgentScript<T = {}>\n  extends RcModuleV2<Deps & T>\n  implements AgentScript\n{\n  private _channel: SingleTabBroadcastChannel;\n\n  protected _eventEmitter = new EventEmitter();\n  private _hadResponse = false;\n\n  constructor(deps: Deps & T) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvAgentScript',\n    });\n  }\n\n  // currentChatScripts: any = null;\n\n  @storage\n  @state\n  currentCallScript: EvAgentScriptData = null;\n\n  @storage\n  @state\n  isDisplayAgentScript = true;\n\n  @storage\n  @state\n  callScriptResultMapping: EvCallScriptResultMapping = {};\n\n  @action\n  setIsDisplayAgentScript(state: boolean) {\n    this.isDisplayAgentScript = state;\n  }\n\n  @action\n  setCurrentCallScript(script: EvAgentScriptData) {\n    this.currentCallScript = script;\n  }\n\n  @action\n  setCallScriptResult(id: string, data: EvAgentScriptResult) {\n    this.callScriptResultMapping[id] = data;\n    this._eventEmitter.emit(agentScriptEvents.SET_SCRIPT_RESULT, id, data);\n  }\n\n  debouncedSetCallScriptResult = debounce({ fn: this.setCallScriptResult });\n\n  reset() {\n    console.log('!!!EvAgentScript reset');\n    // this.setIsDisplayAgentScript(false);\n  }\n\n  onSetScriptResult(cb: (id: string, data: EvAgentScriptResult) => any) {\n    this._eventEmitter.on(agentScriptEvents.SET_SCRIPT_RESULT, cb);\n  }\n\n  onUpdateDisposition(cb: (id: string, data: EvCallDispositionItem) => any) {\n    this._eventEmitter.on(agentScriptEvents.UPDATE_DISPOSITION, cb);\n  }\n\n  onInitOnce() {\n    this._bindChannel();\n\n    // when script change emit that\n    watch(\n      this,\n      () => this.currentCallScript,\n      () => {\n        this._responseInitScript();\n      },\n    );\n\n    this._deps.evCallMonitor.onCallAnswered(async (call) => {\n      if (this.getIsAgentScript(call)) {\n        await this.getScript(\n          call.scriptId,\n          call.scriptVersion,\n          'CALL',\n          call.uii,\n        );\n      }\n    });\n\n    this._deps.evAuth.beforeAgentLogout(() => {\n      this.reset();\n    });\n  }\n\n  onInit() {\n    console.log('EvAgentScript!! init');\n    this.setIsDisplayAgentScript(true);\n  }\n\n  getIsAgentScript(call: EvBaseCall) {\n    return !!(this.isDisplayAgentScript && call?.scriptId);\n  }\n\n  private _bindChannel() {\n    if (\n      this._deps.tabManager.enable &&\n      !sessionStorage.getItem(EV_AGENT_SCRIPT_BROADCAST_KEY)\n    ) {\n      sessionStorage.setItem(\n        EV_AGENT_SCRIPT_BROADCAST_KEY,\n        this._deps.tabManager.id,\n      );\n    }\n\n    this._channel = new SingleTabBroadcastChannel(\n      EV_AGENT_SCRIPT_BROADCAST_KEY,\n      {\n        from: EV_APP_PAGE_KEY,\n        to: EV_AGENT_SCRIPT_PAGE_KEY,\n      },\n    ).init();\n\n    this._channel.addEventListener(({ data }) => {\n      const { key, value } = data;\n      const { activityCallId, currentCall } = this._deps.evCall;\n\n      if (\n        this.isDisplayAgentScript &&\n        activityCallId &&\n        currentCall?.scriptId\n      ) {\n        switch (key) {\n          case agentScriptEvents.INIT:\n            this._responseInitScript();\n            break;\n          case agentScriptEvents.SET_SCRIPT_RESULT:\n            this.debouncedSetCallScriptResult(activityCallId, value);\n            break;\n          case agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES:\n            this._getKnowledgeBaseGroups(value);\n            break;\n          case agentScriptEvents.UPDATE_DISPOSITION:\n            this._eventEmitter.emit(\n              agentScriptEvents.UPDATE_DISPOSITION,\n              activityCallId,\n              value,\n            );\n            break;\n          default:\n            break;\n        }\n      }\n    });\n\n    // if that agent Script is more quick than CTI app, that will need emit that when app init.\n    setTimeout(() => {\n      if (this.currentCallScript && !this._hadResponse) {\n        this._responseInitScript();\n      }\n    }, 1000);\n  }\n\n  private async _getKnowledgeBaseGroups(knowledgeBaseGroupIds: number[]) {\n    const value = await this._deps.evClient.getKnowledgeBaseGroups(\n      knowledgeBaseGroupIds,\n    );\n\n    this._channel.send({\n      key: agentScriptEvents.GET_KNOWLEDGE_BASE_ARTICLES,\n      value,\n    });\n  }\n\n  private _responseInitScript() {\n    this._channel.send({\n      key: agentScriptEvents.INIT,\n      value: {\n        config: this.currentCallScript,\n        call: this._deps.evCall.currentCall,\n      },\n    });\n\n    this._hadResponse = true;\n  }\n\n  async getScript(\n    scriptId: string,\n    version: string = null,\n    type: string = 'CALL',\n    uii: string = null,\n  ) {\n    const response = await this._deps.evClient.getScript(scriptId, version);\n    // TODO: that will fix in next MR\n    const result: EvAgentScriptData = {\n      scriptId: response.scriptId,\n      // scriptName: response.scriptName,\n      // finalResult: null as any, // used for reporting\n      // navPosition: null as any,\n      // version: response.version,\n      data: JSON.parse(response.json) as EvScriptResponseJSON,\n    } as any;\n\n    switch (type) {\n      // case 'CHAT':\n      //   this.currentChatScripts[uii] = result;\n      //   break;\n      case 'CALL':\n        this.setCurrentCallScript(result);\n        break;\n\n      default:\n        break;\n    }\n\n    return result;\n  }\n\n  /**\n   * @param call - the corresponding chat or call object\n   */\n  saveScriptResult(call: EvCallData) {\n    const scriptResult =\n      this.callScriptResultMapping[\n        this._deps.evClient.encodeUii({\n          uii: call.uii,\n          sessionId: call.session.sessionId,\n        })\n      ];\n\n    if (scriptResult) {\n      const result = this._formatScriptResult(scriptResult);\n      this._deps.evClient.saveScriptResult(call.uii, call.scriptId, result);\n    }\n  }\n\n  private _formatScriptResult(scriptResult: EvAgentScriptResult) {\n    const resultCopy = clone(scriptResult);\n\n    resultCopy.model = reduce(\n      (output, [key, value]) => {\n        let result = value;\n        if (result.value !== undefined) {\n          result = result.value;\n        }\n\n        output[key] = {\n          value: result,\n          leadField: value.leadField ?? '',\n        };\n        return output;\n      },\n      {} as EvAgentScriptResultModel,\n      Object.entries<any>(resultCopy.model),\n    );\n\n    return resultCopy;\n  }\n}\n\nexport { EvAgentScript };\n"],"file":"EvAgentScript.js"}
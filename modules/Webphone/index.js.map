{"version":3,"sources":["modules/Webphone/index.js"],"names":["FIRST_THREE_RETRIES_DELAY","FOURTH_RETRIES_DELAY","FIFTH_RETRIES_DELAY","MAX_RETRIES_DELAY","INCOMING_CALL_INVALID_STATE_ERROR_CODE","extendedControlStatus","Enum","EVENTS","Webphone","deps","dep","optional","appKey","appName","appVersion","alert","auth","client","rolesAndPermissions","webphoneLogLevel","contactMatcher","numberValidate","audioSettings","tabManager","onCallEnd","onCallRing","onCallStart","onCallResume","onCallHold","onBeforeCallResume","onBeforeCallEnd","webphoneSDKOptions","options","actionTypes","_eventEmitter","EventEmitter","_appKey","_appName","_appVersion","_alert","_webphoneLogLevel","_auth","ensureExist","_client","_rolesAndPermissions","_numberValidate","_audioSettings","_contactMatcher","_tabManager","_webphoneSDKOptions","on","callEnd","callRing","callStart","callResume","callHold","beforeCallResume","_onBeforeCallEndFunctions","beforeCallEnd","_webphone","_remoteVideo","_localVideo","_sessions","Map","_reducer","addSelector","sessions","outputs","forEach","session","push","to","from","ringSessionId","ringSession","id","cached","activeSessionId","activeSession","addQuerySource","getQueriesFn","_selectors","sessionPhoneNumbers","readyCheckFn","ready","_isFirstRegister","document","createElement","setAttribute","muted","body","appendChild","volume","callVolume","supportDevices","setSinkId","outputDeviceId","store","dispatch","type","videoElementPrepared","window","readyState","addEventListener","_prepareVideoElement","_disconnect","subscribe","_onStateChange","_shouldInit","initSuccess","_shouldReset","resetSuccess","disconnect","_ringtoneVolume","ringtoneVolume","_ringtoneMuted","ringtoneMuted","userAgent","audioHelper","setVolume","_callVolume","_outputDeviceId","loggedIn","pending","service","platform","post","sipInfo","transport","response","json","account","extension","device","list","devices","records","phoneLines","length","concat","stop","unregister","removeAllListeners","provisionData","_removeWebphone","RingCentralWebphone","uuid","endpointId","logLevel","enabled","media","remote","local","enableQos","enableMidLinesInSDP","loadAudio","incoming","incomingAudio","outgoing","outgoingAudio","onRegistered","registered","info","message","webphoneErrors","connected","onUnregistered","unregistered","onRegistrationFailed","cause","console","error","connectionStatus","connectFailed","errorCode","needToReconnect","statusCode","status_code","webphoneCountOverLimit","webphoneForbidden","requestTimeout","internalServerError","serverTimeout","unknownError","danger","allowDuplicates","payload","registrationFailed","indexOf","_connect","log","_onInvite","reconnect","_retrySleep","connecting","resetRetryCounts","active","connect","_sipProvision","sipProvision","disconnecting","_createWebphone","ttl","refreshServiceFeatures","notWebphonePermission","sipProvisionError","connectError","disconnected","browserNotSupported","warning","_fetchDL","notOutboundCallWithoutDL","checkDLError","hangup","_updateSessions","__rc_extendedControlStatus","playing","controls","__rc_extendedControls","slice","i","len","_sendDTMF","stopped","incomingResponse","__rc_callStatus","sessionStatus","finished","headers","_playExtendedControls","_onCallEnd","newSession","replaced","__rc_direction","callDirections","inbound","_addSession","_onAccepted","__rc_isOnMute","onMute","onGetUserMediaError","__rc_creationTime","Date","now","__rc_lastActiveTime","request","_onCallRing","sessionId","sipSession","get","find","_holdOtherSession","accept","acceptOptions","_onCallStart","callAnswer","code","reject","unhold","forwardNumber","validateNumbers","validatedResult","result","errors","callErrors","phoneNumber","validPhoneNumber","numbers","e164","__rc_isForwarded","forward","forwardError","_sessionHandleWithId","mute","muteError","unmute","onLocalHold","hold","onHold","_onCallHold","holdError","currentSessionId","Promise","all","Array","onholdCachedSession","_onBeforeCallResume","_onCallResume","__rc_recordStatus","recordStatus","startRecord","recording","idle","recordDisabled","noAccess","recordError","stopRecord","park","transferNumber","__rc_isOnTransfer","transfer","transferError","ua","invite","sessionDescriptionHandlerOptions","once","warmTransfer","flipValue","flip","__rc_isOnFlip","flipError","dtmfValue","dtmf","_onBeforeCallEnd","terminate","__rc_isToVoicemail","toVoicemail","toVoiceMailError","replyOptions","__rc_isReplied","replyWithMessage","func","toNumber","fromNumber","homeCountryId","extendedControls","outbound","__rc_fromNumber","contact","__rc_contactMatch","sessionIds","setSessionCaching","cachingSessionIds","clearSessionCaching","values","map","normalizeSession","updateSessions","set","delete","__rc_minimized","normalizedSession","x","triggerMatch","emit","playIncoming","_removeSession","connectRetryCounts","handler","state","status","moduleStatuses","ringSessions","onHoldSessions","lastEndedSessions","cachedSessions","webphoneEnabled","constraints","audio","deviceId","inputDeviceId","video","isOnTransfer","RcModule","proxify","selector","minimized"],"mappings":"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","sourcesContent":["import { find, filter } from 'ramda';\nimport EventEmitter from 'events';\nimport RingCentralWebphone from 'ringcentral-web-phone';\nimport incomingAudio from 'ringcentral-web-phone/audio/incoming.ogg';\nimport outgoingAudio from 'ringcentral-web-phone/audio/outgoing.ogg';\n\nimport { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport sleep from '../../lib/sleep';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport connectionStatus from './connectionStatus';\n\nimport sessionStatus from './sessionStatus';\nimport recordStatus from './recordStatus';\nimport actionTypes from './actionTypes';\nimport callDirections from '../../enums/callDirections';\nimport webphoneErrors from './webphoneErrors';\nimport callErrors from '../Call/callErrors';\nimport ensureExist from '../../lib/ensureExist';\nimport proxify from '../../lib/proxy/proxify';\nimport { selector } from '../../lib/selector';\nimport Enum from '../../lib/Enum';\n\nimport {\n  isBrowserSupport,\n  isChrome,\n  isFirefox,\n  normalizeSession,\n  isRing,\n  isOnHold,\n  extractHeadersData,\n} from './webphoneHelper';\nimport getWebphoneReducer from './getWebphoneReducer';\n\nconst FIRST_THREE_RETRIES_DELAY = 10 * 1000;\nconst FOURTH_RETRIES_DELAY = 30 * 1000;\nconst FIFTH_RETRIES_DELAY = 60 * 1000;\nconst MAX_RETRIES_DELAY = 2 * 60 * 1000;\n\nconst INCOMING_CALL_INVALID_STATE_ERROR_CODE = 2;\n\nconst extendedControlStatus = new Enum([\n  'pending',\n  'playing',\n  'stopped',\n]);\n\nconst EVENTS = new Enum([\n  'callRing',\n  'callStart',\n  'callEnd',\n  'callHold',\n  'callResume',\n  'beforeCallResume',\n  'beforeCallEnd',\n]);\n\n/**\n * @constructor\n * @description Web phone module to handle phone interaction with WebRTC.\n */\n@Module({\n  deps: [\n    'Auth',\n    'Alert',\n    'Client',\n    'NumberValidate',\n    'RolesAndPermissions',\n    'AudioSettings',\n    { dep: 'TabManager', optional: true },\n    { dep: 'ContactMatcher', optional: true },\n    { dep: 'WebphoneOptions', optional: true }\n  ]\n})\nexport default class Webphone extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {String} params.appKey - app key\n   * @param {String} params.appName - app name\n   * @param {String} params.appVersion - app version\n   * @param {Number} params.webphoneLogLevel - log Level\n   * @param {Alert} params.alert - alert module instance\n   * @param {Auth} params.auth - auth module instance\n   * @param {Client} params.client - client module instance\n   * @param {RolesAndPermissions} params.rolesAndPermissions - rolesAndPermissions module instance\n   * @param {Storage} params.storage - storage module instance\n   * @param {GlobalStorage} params.globalStorage - globalStorage module instance\n   * @param {NumberValidate} params.numberValidate - numberValidate module instance\n   * @param {ContactMatcher} params.contactMatcher - contactMatcher module instance, optional\n   * @param {Function} params.onCallEnd - callback on a call end\n   * @param {Function} params.onCallRing - callback on a call ring\n   * @param {Function} params.onCallStart - callback on a call start\n   * @param {Function} params.onCallResume - callback on a call resume\n   * @param {Function} params.onCallHold - callback on a call holded\n   * @param {Function} params.onBeforeCallResume - callback before a call resume\n   * @param {Function} params.onBeforeCallEnd - callback before a call hangup\n   * @param {Object} params.webphoneSDKOptions - callback before a call hangup\n   */\n  constructor({\n    appKey,\n    appName,\n    appVersion,\n    alert,\n    auth,\n    client,\n    rolesAndPermissions,\n    webphoneLogLevel = 3,\n    contactMatcher,\n    numberValidate,\n    audioSettings,\n    tabManager,\n    onCallEnd,\n    onCallRing,\n    onCallStart,\n    onCallResume,\n    onCallHold,\n    onBeforeCallResume,\n    onBeforeCallEnd,\n    webphoneSDKOptions,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._eventEmitter = new EventEmitter();\n    this._appKey = appKey;\n    this._appName = appName;\n    this._appVersion = appVersion;\n    this._alert = alert;\n    this._webphoneLogLevel = webphoneLogLevel;\n    this._auth = this:: ensureExist(auth, 'auth');\n    this._client = this:: ensureExist(client, 'client');\n    this._rolesAndPermissions = this:: ensureExist(rolesAndPermissions, 'rolesAndPermissions');\n    this._numberValidate = this:: ensureExist(numberValidate, 'numberValidate');\n    this._audioSettings = this:: ensureExist(audioSettings, 'audioSettings');\n    this._contactMatcher = contactMatcher;\n    this._tabManager = tabManager;\n    this._webphoneSDKOptions = webphoneSDKOptions || {};\n\n    if (typeof onCallEnd === 'function') {\n      this._eventEmitter.on(EVENTS.callEnd, onCallEnd);\n    }\n    if (typeof onCallRing === 'function') {\n      this._eventEmitter.on(EVENTS.callRing, onCallRing);\n    }\n    if (typeof onCallStart === 'function') {\n      this._eventEmitter.on(EVENTS.callStart, onCallStart);\n    }\n    if (typeof onCallResume === 'function') {\n      this._eventEmitter.on(EVENTS.callResume, onCallResume);\n    }\n    if (typeof onCallHold === 'function') {\n      this._eventEmitter.on(EVENTS.callHold, onCallHold);\n    }\n    if (typeof onBeforeCallResume === 'function') {\n      this._eventEmitter.on(EVENTS.beforeCallResume, onBeforeCallResume);\n    }\n    this._onBeforeCallEndFunctions = [];\n    if (typeof onBeforeCallEnd === 'function') {\n      this._eventEmitter.on(EVENTS.beforeCallEnd, onBeforeCallEnd);\n    }\n\n    this._webphone = null;\n    this._remoteVideo = null;\n    this._localVideo = null;\n    this._sessions = new Map();\n    this._reducer = getWebphoneReducer(this.actionTypes);\n\n    this.addSelector('sessionPhoneNumbers',\n      () => this.sessions,\n      (sessions) => {\n        const outputs = [];\n        sessions.forEach((session) => {\n          outputs.push(session.to);\n          outputs.push(session.from);\n        });\n        return outputs;\n      }\n    );\n\n    this.addSelector('ringSession',\n      () => this.ringSessionId,\n      () => this.sessions,\n      (ringSessionId, sessions) => {\n        if (!ringSessionId) {\n          return null;\n        }\n        const ringSession = find(\n          session => session.id === ringSessionId,\n          sessions\n        );\n        return ringSession;\n      }\n    );\n\n    this.addSelector('cachedSessions',\n      () => this.sessions,\n      sessions => filter(session => session.cached, sessions)\n    );\n\n    this.addSelector('activeSession',\n      () => this.activeSessionId,\n      () => this.sessions,\n      (activeSessionId, sessions) => {\n        if (!activeSessionId) {\n          return null;\n        }\n        const activeSession = find(\n          session => session.id === activeSessionId,\n          sessions\n        );\n        return activeSession;\n      }\n    );\n\n    this.addSelector('ringSessions',\n      () => this.sessions,\n      sessions => filter(session => isRing(session), sessions)\n    );\n\n    this.addSelector('onHoldSessions',\n      () => this.sessions,\n      sessions => filter(session => isOnHold(session), sessions)\n    );\n\n    if (this._contactMatcher) {\n      this._contactMatcher.addQuerySource({\n        getQueriesFn: this._selectors.sessionPhoneNumbers,\n        readyCheckFn: () => (\n          this.ready\n        ),\n      });\n    }\n\n    this._isFirstRegister = true;\n  }\n\n  _prepareVideoElement() {\n    this._remoteVideo = document.createElement('video');\n    this._remoteVideo.id = 'remoteVideo';\n    this._remoteVideo.setAttribute('hidden', 'hidden');\n    this._localVideo = document.createElement('video');\n    this._localVideo.id = 'localVideo';\n    this._localVideo.setAttribute('hidden', 'hidden');\n    this._localVideo.setAttribute('muted', 'muted');\n    this._localVideo.muted = true;\n\n    document.body.appendChild(this._remoteVideo);\n    document.body.appendChild(this._localVideo);\n\n    this._remoteVideo.volume = this._audioSettings.callVolume;\n    if (this._audioSettings.supportDevices) {\n      this._remoteVideo.setSinkId(this._audioSettings.outputDeviceId);\n    }\n\n    this.store.dispatch({\n      type: this.actionTypes.videoElementPrepared,\n    });\n  }\n\n  initialize() {\n    if (\n      typeof window !== 'undefined' &&\n      typeof document !== 'undefined'\n    ) {\n      if (document.readyState === 'loading') {\n        window.addEventListener('load', () => {\n          this._prepareVideoElement();\n        });\n      } else {\n        this._prepareVideoElement();\n      }\n      window.addEventListener('unload', () => {\n        this._disconnect();\n      });\n    }\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n      this.disconnect();\n    }\n    if (\n      this.ready &&\n      (\n        this._ringtoneVolume !== this._audioSettings.ringtoneVolume ||\n        this._ringtoneMuted !== this._audioSettings.ringtoneMuted\n      )\n    ) {\n      this._ringtoneVolume = this._audioSettings.ringtoneVolume;\n      this._ringtoneMuted = this._audioSettings.ringtoneMuted;\n      if (\n        this._webphone &&\n        this._webphone.userAgent\n      ) {\n        this._webphone.userAgent.audioHelper\n          .setVolume(this._ringtoneMuted ? 0 : this._audioSettings.ringtoneVolume);\n      }\n    }\n    if (\n      this.ready &&\n      this._callVolume !== this._audioSettings.callVolume\n    ) {\n      this._callVolume = this._audioSettings.callVolume;\n      if (\n        this._remoteVideo\n      ) {\n        this._remoteVideo.volume = this._audioSettings.callVolume;\n      }\n    }\n    if (\n      this.ready &&\n      this._audioSettings.supportDevices &&\n      this._outputDeviceId !== this._audioSettings.outputDeviceId\n    ) {\n      this._outputDeviceId = this._audioSettings.outputDeviceId;\n      if (\n        this._remoteVideo\n      ) {\n        this._remoteVideo.setSinkId(this._outputDeviceId);\n      }\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._auth.loggedIn &&\n      this._rolesAndPermissions.ready &&\n      this._numberValidate.ready &&\n      this._audioSettings.ready &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._auth.loggedIn ||\n        !this._rolesAndPermissions.ready ||\n        !this._numberValidate.ready ||\n        (!!this._tabManager && !this._tabManager.ready) ||\n        !this._audioSettings.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  @proxify\n  async _sipProvision() {\n    const response = await this._client.service.platform()\n      .post('/client-info/sip-provision', {\n        sipInfo: [{ transport: 'WSS' }]\n      });\n    return response.json();\n  }\n\n  async _fetchDL() {\n    const response = await this._client.account().extension().device().list();\n    const devices = response.records;\n    let phoneLines = [];\n    devices.forEach((device) => {\n      if (!device.phoneLines || device.phoneLines.length === 0) {\n        return;\n      }\n      phoneLines = phoneLines.concat(device.phoneLines);\n    });\n    return phoneLines;\n  }\n\n  _removeWebphone() {\n    if (!this._webphone || !this._webphone.userAgent) {\n      return;\n    }\n    this._webphone.userAgent.stop();\n    this._webphone.userAgent.unregister();\n    this._webphone.userAgent.removeAllListeners();\n    this._webphone = null;\n  }\n\n  _createWebphone(provisionData) {\n    this._removeWebphone();\n    this._webphone = new RingCentralWebphone(provisionData, {\n      appKey: this._appKey,\n      appName: this._appName,\n      appVersion: this._appVersion,\n      uuid: this._auth.endpointId,\n      logLevel: this._webphoneLogLevel, // error 0, warn 1, log: 2, debug: 3\n      audioHelper: {\n        enabled: true, // enables audio feedback when web phone is ringing or making a call\n      },\n      media: {\n        remote: this._remoteVideo,\n        local: this._localVideo,\n      },\n      enableQos: isChrome(),\n      enableMidLinesInSDP: isFirefox(),\n      ...this._webphoneSDKOptions\n    });\n    this._webphone.userAgent.audioHelper.loadAudio({\n      incoming: incomingAudio, // path to audio file for incoming call\n      outgoing: outgoingAudio, // path to aduotfile for outgoing call\n    });\n    this._isFirstRegister = true;\n    const onRegistered = () => {\n      if (this._isFirstRegister) {\n        this.store.dispatch({\n          type: this.actionTypes.registered,\n        });\n        this._alert.info({\n          message: webphoneErrors.connected,\n        });\n      }\n      this._isFirstRegister = false;\n    };\n    const onUnregistered = () => {\n      this._isFirstRegister = true;\n      this.store.dispatch({\n        type: this.actionTypes.unregistered,\n      });\n    };\n    const onRegistrationFailed = (response, cause) => {\n      console.error('Webphone Register Error:', response, cause);\n      // For 401\n      if (!response && cause === 'Connection Error') {\n        return;\n      }\n      if (this.connectionStatus === connectionStatus.connectFailed) {\n        return;\n      }\n      this._isFirstRegister = true;\n      let errorCode;\n      let needToReconnect = false;\n      // limit logic:\n      /*\n       * Specialties of this flow are next:\n       *   6th WebRTC in another browser receives 6th EndpointID and 1st InstanceID,\n       *   which has been given previously to the 1st EndpointID.\n       *   It successfully registers on WSX by moving 1st EndpointID to a blacklist state.\n       *   When 1st WebRTC client re-registers on expiration timeout,\n       *   WSX defines that 1st EndpointID is blacklisted and responds with SIP/2.0 403 Forbidden,\n       *   instance id is intercepted by another registration and remove it from black list.\n       *   So if 1st WebRTC will send re-register again with the same InstanceID,\n       *   it will be accepted and 6th EndpointID will be blacklisted.\n       *   (But the WebRTC client must logout on receiving SIP/2.0 403 Forbidden error and in case of login -\n       *   provision again via Platform API and receive new InstanceID)\n       */\n      const statusCode = response ? response.status_code : null;\n      switch (statusCode) {\n        // Webphone account overlimit\n        case 503:\n        case 603: {\n          errorCode = webphoneErrors.webphoneCountOverLimit;\n          needToReconnect = true;\n          break;\n        }\n        case 403: {\n          errorCode = webphoneErrors.webphoneForbidden;\n          needToReconnect = true;\n          break;\n        }\n        // Request Timeout\n        case 408: {\n          errorCode = webphoneErrors.requestTimeout;\n          needToReconnect = true;\n          break;\n        }\n        // Internal server error\n        case 500: {\n          errorCode = webphoneErrors.internalServerError;\n          break;\n        }\n        // Timeout\n        case 504: {\n          errorCode = webphoneErrors.serverTimeout;\n          needToReconnect = true;\n          break;\n        }\n        default: {\n          errorCode = webphoneErrors.unknownError;\n          break;\n        }\n      }\n      this._alert.danger({\n        message: errorCode,\n        allowDuplicates: false,\n        payload: {\n          statusCode\n        }\n      });\n      this.store.dispatch({\n        type: this.actionTypes.registrationFailed,\n        errorCode,\n        statusCode,\n      });\n      if (['Request Timeout', 'Connection Error'].indexOf(cause) !== -1) {\n        needToReconnect = true;\n      }\n      if (needToReconnect) {\n        this._removeWebphone();\n        this._connect(needToReconnect);\n      }\n    };\n    this._webphone.userAgent.audioHelper.setVolume(\n      this._audioSettings.ringtoneMuted ? 0 : this._audioSettings.ringtoneVolume\n    );\n    this._webphone.userAgent.on('registered', onRegistered);\n    this._webphone.userAgent.on('unregistered', onUnregistered);\n    this._webphone.userAgent.on('registrationFailed', onRegistrationFailed);\n    this._webphone.userAgent.on('invite', (session) => {\n      console.log('UA invite');\n      this._onInvite(session);\n    });\n  }\n\n  @proxify\n  async _connect(reconnect = false) {\n    try {\n      if (reconnect) {\n        await this._retrySleep();\n      }\n\n      if (!this._auth.loggedIn) {\n        return;\n      }\n\n      // do not connect if it is connecting\n      if (this.connectionStatus === connectionStatus.connecting) {\n        return;\n      }\n\n      // when reconnect is break by disconnect\n      if (reconnect && this.connectionStatus !== connectionStatus.connectFailed) {\n        this.store.dispatch({\n          type: this.actionTypes.resetRetryCounts,\n        });\n        return;\n      }\n\n      if (this._tabManager && !this._tabManager.active) {\n        await sleep(FIRST_THREE_RETRIES_DELAY);\n        await this._connect(reconnect);\n        return;\n      }\n\n      this.store.dispatch({\n        type: (\n          reconnect ?\n            this.actionTypes.reconnect : this.actionTypes.connect\n        )\n      });\n\n      const sipProvision = await this._sipProvision();\n\n      // do not continue if it is disconnecting\n      if (this.disconnecting) {\n        return;\n      }\n      this._createWebphone(sipProvision);\n    } catch (error) {\n      console.error(error);\n      this._alert.danger({\n        message: webphoneErrors.connectFailed,\n        ttl: 0,\n        allowDuplicates: false,\n      });\n      let needToReconnect = true;\n      let errorCode;\n      if (\n        error && error.message &&\n        (error.message.indexOf('Feature [WebPhone] is not available') > -1)\n      ) {\n        this._rolesAndPermissions.refreshServiceFeatures();\n        needToReconnect = false;\n        errorCode = webphoneErrors.notWebphonePermission;\n      } else {\n        errorCode = webphoneErrors.sipProvisionError;\n      }\n      this.store.dispatch({\n        type: this.actionTypes.connectError,\n        errorCode,\n        error,\n      });\n      if (needToReconnect) {\n        await this._connect(needToReconnect);\n      }\n    }\n  }\n\n  /**\n   * connect a web phone.\n   */\n  @proxify\n  async connect() {\n    if (\n      this._auth.loggedIn &&\n      this.enabled &&\n      (\n        this.connectionStatus === connectionStatus.disconnected ||\n        this.connectionStatus === connectionStatus.connectFailed\n      )\n    ) {\n      if (!isBrowserSupport()) {\n        this.store.dispatch({\n          type: this.actionTypes.connectError,\n          errorCode: webphoneErrors.browserNotSupported,\n        });\n        this._alert.warning({\n          message: webphoneErrors.browserNotSupported,\n          ttl: 0,\n        });\n        return;\n      }\n      try {\n        const phoneLines = await this._fetchDL();\n        if (phoneLines.length === 0) {\n          this.store.dispatch({\n            type: this.actionTypes.connectError,\n            errorCode: webphoneErrors.notOutboundCallWithoutDL,\n          });\n          this._alert.warning({\n            message: webphoneErrors.notOutboundCallWithoutDL,\n          });\n        }\n      } catch (error) {\n        console.log(error);\n        this.store.dispatch({\n          type: this.actionTypes.connectError,\n          errorCode: webphoneErrors.checkDLError,\n        });\n        this._alert.warning({\n          message: webphoneErrors.checkDLError,\n        });\n      }\n      await this._connect();\n    }\n  }\n\n  _disconnect() {\n    if (\n      this.connectionStatus === connectionStatus.connected ||\n      this.connectionStatus === connectionStatus.connecting ||\n      this.connectionStatus === connectionStatus.connectFailed\n    ) {\n      this.store.dispatch({\n        type: this.actionTypes.disconnect,\n      });\n      if (this._webphone) {\n        this._sessions.forEach((session) => {\n          this.hangup(session);\n        });\n        this._removeWebphone();\n        this._sessions = new Map();\n        this._updateSessions();\n      }\n      this.store.dispatch({\n        type: this.actionTypes.unregistered,\n      });\n    }\n  }\n\n  @proxify\n  async disconnect() {\n    this._disconnect();\n  }\n\n  async _playExtendedControls(session) {\n    session.__rc_extendedControlStatus = extendedControlStatus.playing;\n    const controls = session.__rc_extendedControls.slice();\n    for (let i = 0, len = controls.length; i < len; i += 1) {\n      if (session.__rc_extendedControlStatus === extendedControlStatus.playing) {\n        if (controls[i] === ',') {\n          await sleep(2000);\n        } else {\n          await this._sendDTMF(controls[i], session);\n        }\n      } else {\n        return;\n      }\n    }\n    session.__rc_extendedControlStatus = extendedControlStatus.stopped;\n  }\n\n  _onAccepted(session) {\n    session.on('accepted', (incomingResponse) => {\n      if (session.__rc_callStatus === sessionStatus.finished) {\n        return;\n      }\n      console.log('accepted');\n      session.__rc_callStatus = sessionStatus.connected;\n      extractHeadersData(session, incomingResponse.headers);\n      if (\n        session.__rc_extendedControls &&\n        session.__rc_extendedControlStatus === extendedControlStatus.pending\n      ) {\n        this._playExtendedControls(session);\n      }\n      this._updateSessions();\n    });\n    session.on('progress', (incomingResponse) => {\n      console.log('progress...');\n      session.__rc_callStatus = sessionStatus.connecting;\n      extractHeadersData(session, incomingResponse.headers);\n      this._updateSessions();\n    });\n    session.on('rejected', () => {\n      console.log('rejected');\n      session.__rc_callStatus = sessionStatus.finished;\n      this._onCallEnd(session);\n    });\n    session.on('failed', (response, cause) => {\n      console.log('Event: Failed');\n      console.log(cause);\n      session.__rc_callStatus = sessionStatus.finished;\n      this._onCallEnd(session);\n    });\n    session.on('terminated', () => {\n      console.log('Event: Terminated');\n      session.__rc_callStatus = sessionStatus.finished;\n      this._onCallEnd(session);\n    });\n    session.on('cancel', () => {\n      console.log('Event: Cancel');\n      session.__rc_callStatus = sessionStatus.finished;\n      this._onCallEnd(session);\n    });\n    session.on('refer', () => {\n      console.log('Event: Refer');\n    });\n    session.on('replaced', (newSession) => {\n      session.__rc_callStatus = sessionStatus.replaced;\n      newSession.__rc_callStatus = sessionStatus.connected;\n      newSession.__rc_direction = callDirections.inbound;\n      this._addSession(newSession);\n      this._onAccepted(newSession);\n    });\n    session.on('muted', () => {\n      console.log('Event: Muted');\n      session.__rc_isOnMute = true;\n      session.__rc_callStatus = sessionStatus.onMute;\n      this._updateSessions();\n    });\n    session.on('unmuted', () => {\n      console.log('Event: Unmuted');\n      session.__rc_isOnMute = false;\n      session.__rc_callStatus = sessionStatus.connected;\n      this._updateSessions();\n    });\n    session.on('userMediaFailed', () => {\n      this._audioSettings.onGetUserMediaError();\n    });\n  }\n\n  _onInvite(session) {\n    session.__rc_creationTime = Date.now();\n    session.__rc_lastActiveTime = Date.now();\n    session.__rc_direction = callDirections.inbound;\n    session.__rc_callStatus = sessionStatus.connecting;\n    extractHeadersData(session, session.request.headers);\n    session.on('rejected', () => {\n      console.log('Event: Rejected');\n      this._onCallEnd(session);\n    });\n    session.on('terminated', () => {\n      console.log('Event: Terminated');\n      this._onCallEnd(session);\n    });\n    this._onCallRing(session);\n  }\n\n  @proxify\n  async answer(sessionId) {\n    const sipSession = this._sessions.get(sessionId);\n    const session = this.sessions.find(session => session.id === sessionId);\n    if (!session || !isRing(session)) {\n      return;\n    }\n    try {\n      await this._holdOtherSession(sessionId);\n      this._onAccepted(sipSession, 'inbound');\n      await sipSession.accept(this.acceptOptions);\n      this._onCallStart(sipSession);\n      this.store.dispatch({ // for track\n        type: this.actionTypes.callAnswer,\n      });\n    } catch (e) {\n      console.log('Accept failed');\n      console.error(e);\n      if (e.code !== INCOMING_CALL_INVALID_STATE_ERROR_CODE) {\n        // FIXME:\n        // 2 means the call is answered\n        this._onCallEnd(sipSession);\n      }\n    }\n  }\n\n  @proxify\n  async reject(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session || session.__rc_callStatus === sessionStatus.finished) {\n      return;\n    }\n    try {\n      await session.reject();\n    } catch (e) {\n      console.error(e);\n      this._onCallEnd(session);\n    }\n  }\n\n  @proxify\n  async resume(sessionId) {\n    await this.unhold(sessionId);\n  }\n\n  @proxify\n  async forward(sessionId, forwardNumber) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return false;\n    }\n    try {\n      const validatedResult\n        = await this._numberValidate.validateNumbers([forwardNumber]);\n      if (!validatedResult.result) {\n        validatedResult.errors.forEach((error) => {\n          this._alert.warning({\n            message: callErrors[error.type],\n            payload: {\n              phoneNumber: error.phoneNumber\n            }\n          });\n        });\n        return false;\n      }\n      const validPhoneNumber =\n        validatedResult.numbers[0] && validatedResult.numbers[0].e164;\n      session.__rc_isForwarded = true;\n      await session.forward(validPhoneNumber, this.acceptOptions);\n      console.log('Forwarded');\n      this._onCallEnd(session);\n      return true;\n    } catch (e) {\n      console.error(e);\n      this._alert.warning({\n        message: webphoneErrors.forwardError\n      });\n      return false;\n    }\n  }\n\n  @proxify\n  async mute(sessionId) {\n    try {\n      this._sessionHandleWithId(sessionId, (session) => {\n        session.__rc_isOnMute = true;\n        session.mute();\n        this._updateSessions();\n      });\n      return true;\n    } catch (e) {\n      console.error(e);\n      this._alert.warning({\n        message: webphoneErrors.muteError\n      });\n      return false;\n    }\n  }\n\n  @proxify\n  async unmute(sessionId) {\n    this._sessionHandleWithId(sessionId, (session) => {\n      session.__rc_isOnMute = false;\n      session.unmute();\n      this._updateSessions();\n    });\n  }\n\n  @proxify\n  async hold(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return false;\n    }\n    if (session.onLocalHold()) {\n      return true;\n    }\n    try {\n      await session.hold();\n      session.__rc_callStatus = sessionStatus.onHold;\n      this._updateSessions();\n      this._onCallHold(session);\n      return true;\n    } catch (e) {\n      console.error('hold error:', e);\n      this._alert.warning({\n        message: webphoneErrors.holdError\n      });\n      return false;\n    }\n  }\n\n  async _holdOtherSession(currentSessionId) {\n    await Promise.all(Array.from(this._sessions, async ([sessionId, session]) => {\n      if (currentSessionId === sessionId) {\n        return;\n      }\n      if (session.onLocalHold()) {\n        return;\n      }\n      if (session.__rc_callStatus === sessionStatus.connecting) {\n        return;\n      }\n      try {\n        await session.hold();\n      } catch (e) {\n        console.error('Hold call fail');\n        throw e;\n      }\n      session.__rc_callStatus = sessionStatus.onHold;\n    }));\n    // update cached sessions\n    this.store.dispatch({\n      type: this.actionTypes.onholdCachedSession,\n    });\n  }\n\n  @proxify\n  async unhold(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      if (session.onLocalHold()) {\n        await this._holdOtherSession(session.id);\n        this._onBeforeCallResume(session);\n        await session.unhold();\n        this._updateSessions();\n        this._onCallResume(session);\n      }\n    } catch (e) {\n      console.log(e);\n    }\n  }\n\n  @proxify\n  async startRecord(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    // If the status of current session is not connected,\n    // the recording process can not be started.\n    if (session.__rc_callStatus === sessionStatus.connecting) {\n      return;\n    }\n    try {\n      session.__rc_recordStatus = recordStatus.pending;\n      this._updateSessions();\n      await session.startRecord();\n      session.__rc_recordStatus = recordStatus.recording;\n      this._updateSessions();\n    } catch (e) {\n      console.error(e);\n      session.__rc_recordStatus = recordStatus.idle;\n      this._updateSessions();\n      // Recording has been disabled\n      if (e && e.code === -5) {\n        this._alert.danger({\n          message: webphoneErrors.recordDisabled\n        });\n        // Disabled phone recording\n        session.__rc_recordStatus = recordStatus.noAccess;\n        this._updateSessions();\n        return;\n      }\n      this._alert.danger({\n        message: webphoneErrors.recordError,\n        payload: {\n          errorCode: e.code\n        }\n      });\n    }\n  }\n\n  @proxify\n  async stopRecord(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      session.__rc_recordStatus = recordStatus.pending;\n      this._updateSessions();\n      await session.stopRecord();\n      session.__rc_recordStatus = recordStatus.idle;\n      this._updateSessions();\n    } catch (e) {\n      console.error(e);\n      session.__rc_recordStatus = recordStatus.recording;\n      this._updateSessions();\n    }\n  }\n\n  @proxify\n  async park(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      await session.park();\n      console.log('Parked');\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  @proxify\n  async transfer(transferNumber, sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      session.__rc_isOnTransfer = true;\n      this._updateSessions();\n      const validatedResult\n        = await this._numberValidate.validateNumbers([transferNumber]);\n      if (!validatedResult.result) {\n        validatedResult.errors.forEach((error) => {\n          this._alert.warning({\n            message: callErrors[error.type],\n            payload: {\n              phoneNumber: error.phoneNumber\n            }\n          });\n        });\n        session.__rc_isOnTransfer = false;\n        this._updateSessions();\n        return;\n      }\n      const validPhoneNumber =\n        validatedResult.numbers[0] && validatedResult.numbers[0].e164;\n      await session.transfer(validPhoneNumber);\n      session.__rc_isOnTransfer = false;\n      this._updateSessions();\n      this._onCallEnd(session);\n    } catch (e) {\n      console.error(e);\n      session.__rc_isOnTransfer = false;\n      this._updateSessions();\n      this._alert.danger({\n        message: webphoneErrors.transferError\n      });\n    }\n  }\n\n  @proxify\n  async transferWarm(transferNumber, sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      await session.hold();\n      const newSession = session.ua.invite(transferNumber, {\n        sessionDescriptionHandlerOptions: this.acceptOptions.sessionDescriptionHandlerOptions\n      });\n      newSession.once('accepted', async () => {\n        try {\n          await session.warmTransfer(newSession);\n          console.log('Transferred');\n          this._onCallEnd(session);\n        } catch (e) {\n          console.error(e);\n        }\n      });\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  @proxify\n  async flip(flipValue, sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      await session.flip(flipValue);\n      // this._onCallEnd(session);\n      session.__rc_isOnFlip = true;\n      console.log('Flipped');\n    } catch (e) {\n      session.__rc_isOnFlip = false;\n      this._alert.warning({\n        message: webphoneErrors.flipError\n      });\n      console.error(e);\n    }\n    this._updateSessions();\n  }\n\n  @proxify\n  async _sendDTMF(dtmfValue, session) {\n    try {\n      await session.dtmf(dtmfValue, 100);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  @proxify\n  async sendDTMF(dtmfValue, sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (session) {\n      await this._sendDTMF(dtmfValue, session);\n    }\n  }\n\n  @proxify\n  async hangup(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      this._onBeforeCallEnd(session);\n      await session.terminate();\n    } catch (e) {\n      console.error(e);\n      this._onCallEnd(session);\n    }\n  }\n\n  @proxify\n  async toVoiceMail(sessionId) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      session.__rc_isToVoicemail = true;\n      await session.toVoicemail();\n    } catch (e) {\n      console.error(e);\n      this._onCallEnd(session);\n      this._alert.warning({\n        message: webphoneErrors.toVoiceMailError\n      });\n    }\n  }\n\n  @proxify\n  async replyWithMessage(sessionId, replyOptions) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return;\n    }\n    try {\n      session.__rc_isReplied = true;\n      await session.replyWithMessage(replyOptions);\n    } catch (e) {\n      console.error(e);\n      this._onCallEnd(session);\n    }\n  }\n\n  _sessionHandleWithId(sessionId, func) {\n    const session = this._sessions.get(sessionId);\n    if (!session) {\n      return null;\n    }\n    return func(session);\n  }\n\n  /**\n   * start an outbound call.\n   * @param {toNumber} recipient number\n   * @param {fromNumber} call Id\n   * @param {homeCountryId} homeCountry Id\n   */\n  @proxify\n  async makeCall({\n    toNumber,\n    fromNumber,\n    homeCountryId,\n    extendedControls,\n  }) {\n    if (!this._webphone) {\n      this._alert.warning({\n        message: this.errorCode,\n      });\n      return null;\n    }\n    const phoneLines = await this._fetchDL();\n    if (phoneLines.length === 0) {\n      this._alert.warning({\n        message: webphoneErrors.notOutboundCallWithoutDL,\n      });\n      return null;\n    }\n    const session = this._webphone.userAgent.invite(toNumber, {\n      sessionDescriptionHandlerOptions: this.acceptOptions.sessionDescriptionHandlerOptions,\n      fromNumber,\n      homeCountryId,\n    });\n    session.__rc_direction = callDirections.outbound;\n    session.__rc_callStatus = sessionStatus.connecting;\n    session.__rc_creationTime = Date.now();\n    session.__rc_lastActiveTime = Date.now();\n    session.__rc_fromNumber = fromNumber;\n    session.__rc_extendedControls = extendedControls;\n    session.__rc_extendedControlStatus = extendedControlStatus.pending;\n    this._onAccepted(session);\n    await this._holdOtherSession(session.id);\n    this._onCallStart(session);\n    return session;\n  }\n\n  @proxify\n  async updateSessionMatchedContact(sessionId, contact) {\n    this._sessionHandleWithId(sessionId, (session) => {\n      session.__rc_contactMatch = contact;\n      this._updateSessions();\n    });\n  }\n\n  @proxify\n  setSessionCaching(sessionIds) {\n    this.store.dispatch({\n      type: this.actionTypes.setSessionCaching,\n      cachingSessionIds: sessionIds,\n    });\n  }\n\n  @proxify\n  clearSessionCaching() {\n    this.store.dispatch({\n      type: this.actionTypes.clearSessionCaching,\n      sessions: [...this._sessions.values()].map(normalizeSession),\n    });\n  }\n\n  _updateSessions() {\n    this.store.dispatch({\n      type: this.actionTypes.updateSessions,\n      sessions: [...this._sessions.values()].map(normalizeSession),\n    });\n  }\n\n  _addSession(session) {\n    this._sessions.set(session.id, session);\n    this._updateSessions();\n  }\n\n  _removeSession(session) {\n    this._sessions.delete(session.id);\n    this._updateSessions();\n  }\n\n  @proxify\n  async toggleMinimized(sessionId) {\n    this._sessionHandleWithId(sessionId, (session) => {\n      session.__rc_minimized = !session.__rc_minimized;\n      this._updateSessions();\n    });\n  }\n\n  _onCallStart(session) {\n    this._addSession(session);\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this.store.dispatch({\n      type: this.actionTypes.callStart,\n      session: normalizedSession,\n      sessions: this.sessions,\n    });\n    if (\n      this._contactMatcher &&\n      (!this._tabManager || this._tabManager.active)\n    ) {\n      this._contactMatcher.triggerMatch();\n    }\n    this._eventEmitter.emit(EVENTS.callStart, normalizedSession, this.activeSession);\n  }\n\n  _onCallRing(session) {\n    this._addSession(session);\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this.store.dispatch({\n      type: this.actionTypes.callRing,\n      session: normalizedSession,\n      sessions: this.sessions,\n    });\n    if (\n      this._contactMatcher &&\n      (!this._tabManager || this._tabManager.active)\n    ) {\n      this._contactMatcher.triggerMatch();\n    }\n    if (this.activeSession && !isOnHold(this.activeSession)) {\n      this._webphone.userAgent.audioHelper.playIncoming(false);\n    }\n    this._eventEmitter.emit(EVENTS.callRing, normalizedSession, this.ringSession);\n  }\n\n  _onBeforeCallEnd(session) {\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this._eventEmitter.emit(EVENTS.beforeCallEnd, normalizedSession, this.activeSession);\n  }\n\n  _onCallEnd(session) {\n    session.__rc_extendedControlStatus = extendedControlStatus.stopped;\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    if (!normalizedSession) {\n      return;\n    }\n    this._removeSession(session);\n    this.store.dispatch({\n      type: this.actionTypes.callEnd,\n      session: normalizedSession,\n      sessions: this.sessions,\n    });\n    this._eventEmitter.emit(\n      EVENTS.callEnd, normalizedSession, this.activeSession, this.ringSession\n    );\n  }\n\n  _onBeforeCallResume(session) {\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this._eventEmitter.emit(EVENTS.beforeCallResume, normalizedSession, this.activeSession);\n  }\n\n  _onCallResume(session) {\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this._eventEmitter.emit(EVENTS.callResume, normalizedSession, this.activeSession);\n  }\n\n  _onCallHold(session) {\n    const normalizedSession = find(x => x.id === session.id, this.sessions);\n    this._eventEmitter.emit(EVENTS.callHold, normalizedSession, this.activeSession);\n  }\n\n  async _retrySleep() {\n    if (this.connectRetryCounts < 3) {\n      await sleep(FIRST_THREE_RETRIES_DELAY);\n    }\n    if (this.connectRetryCounts === 3) {\n      await sleep(FOURTH_RETRIES_DELAY);\n    }\n    if (this.connectRetryCounts === 4) {\n      await sleep(FIFTH_RETRIES_DELAY); // sleep 30 seconds\n    }\n    if (this.connectRetryCounts > 4) {\n      await sleep(MAX_RETRIES_DELAY); // sleep 30 seconds\n    }\n  }\n\n  /**\n   * Inform user what is happening with webphone,\n   * this will be invoked when webphone itself run into error situation\n   */\n  @proxify\n  async showAlert() {\n    if (!this.errorCode) {\n      return;\n    }\n    this._alert.danger({\n      message: this.errorCode,\n      allowDuplicates: false,\n      payload: {\n        statusCode: this.statusCode,\n      },\n    });\n  }\n\n  onCallStart(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.callStart, handler);\n    }\n  }\n\n  onCallRing(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.callRing, handler);\n    }\n  }\n\n  onCallEnd(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.callEnd, handler);\n    }\n  }\n\n  onBeforeCallResume(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.beforeCallResume, handler);\n    }\n  }\n\n  onCallResume(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.callResume, handler);\n    }\n  }\n\n  onCallHold(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.callHold, handler);\n    }\n  }\n\n  onBeforeCallEnd(handler) {\n    if (typeof handler === 'function') {\n      this._eventEmitter.on(EVENTS.beforeCallEnd, handler);\n    }\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get originalSessions() {\n    return this._sessions;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get pending() {\n    return this.state.status === moduleStatuses.pending;\n  }\n\n  get ringSessionId() {\n    return this.state.ringSessionId;\n  }\n\n  get activeSessionId() {\n    return this.state.activeSessionId;\n  }\n\n  /**\n   * Current active session(Outbound and InBound that answered)\n   */\n  get activeSession() {\n    return this._selectors.activeSession();\n  }\n\n  /**\n   * Current ring session(inbound)\n   */\n  get ringSession() {\n    return this._selectors.ringSession();\n  }\n\n  get sessions() {\n    return this.state.sessions;\n  }\n\n  get ringSessions() {\n    return this._selectors.ringSessions();\n  }\n\n  get onHoldSessions() {\n    return this._selectors.onHoldSessions();\n  }\n\n  get lastEndedSessions() {\n    return this.state.lastEndedSessions;\n  }\n\n  get cachedSessions() {\n    return this._selectors.cachedSessions();\n  }\n\n  get videoElementPrepared() {\n    return this.state.videoElementPrepared;\n  }\n\n  get enabled() {\n    return this._rolesAndPermissions.webphoneEnabled;\n  }\n\n  get connectionStatus() {\n    return this.state.connectionStatus;\n  }\n\n  get connectRetryCounts() {\n    return this.state.connectRetryCounts;\n  }\n\n  get acceptOptions() {\n    return {\n      sessionDescriptionHandlerOptions: {\n        constraints: {\n          audio: {\n            deviceId: this._audioSettings.inputDeviceId,\n          },\n          video: false,\n        },\n      }\n    };\n  }\n\n  get isOnTransfer() {\n    return this.activeSession && this.activeSession.isOnTransfer;\n  }\n\n  get errorCode() {\n    return this.state.errorCode;\n  }\n\n  get statusCode() {\n    return this.state.statusCode;\n  }\n\n  get disconnecting() {\n    return this.connectionStatus === connectionStatus.disconnecting;\n  }\n\n  get connecting() {\n    return this.connectionStatus === connectionStatus.connecting;\n  }\n\n  get connected() {\n    return this.connectionStatus === connectionStatus.connected;\n  }\n\n  get connectFailed() {\n    return this.connectionStatus === connectionStatus.connectFailed;\n  }\n\n  @selector\n  ringingCallOnView = [\n    () => this.ringSessions,\n    sessions => find(\n      session => !session.minimized,\n      sessions,\n    )\n  ]\n}\n"],"file":"index.js"}
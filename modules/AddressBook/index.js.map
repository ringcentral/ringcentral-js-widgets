{"version":3,"sources":["modules/AddressBook/index.ts"],"names":["CONTACTS_PER_PAGE","DEFAULT_TTL","DEFAULT_TIME_TO_RETRY","REGX_DECODE","DECODE","getSyncParams","syncToken","pageId","query","perPage","syncType","syncTypes","iSync","fSync","AddressBook","deps","dep","optional","client","auth","storage","tabManager","extensionFeatures","ttl","timeToRetry","polling","disableCache","options","actionTypes","_client","_storage","_auth","_tabManager","_ttl","_extensionFeatures","_timeToRetry","_polling","_promise","_addressBookStorageKey","_reducer","registerReducer","key","reducer","timestamp","contactList","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_shouleCleanCache","_cleanUp","_hasPermission","_initAddressBook","initSuccess","_isDataReady","_shouldReset","_resetModuleStatus","ready","loggedIn","pending","isFreshLogin","Date","now","active","status","moduleStatuses","initializing","_shouldFetch","sync","console","error","_startPolling","_retry","reset","_clearTimeout","resetSuccess","_sync","response","result","records","syncInfo","undefined","_syncWithForbiddenCheck","syncSuccess","_onSyncError","syncError","params","_syncAddressBookApi","nextPageId","lastResponse","concat","account","extension","addressBookSync","list","updateRequest","_decodeAddressBook","text","replace","$0","handleText","origin","Array","isArray","forEach","record","firstName","_decode","lastName","cleanUp","contactId","contacts","find","x","id","searchFilter","searchString","entityType","phoneSources","contact","phoneNumber","rcContact","features","ReadPersonalContacts","available","state","getItem","Pollable","proxify","selector","rawContacts","contactsList","rawContact","sourceName","phoneNumbers","emails","name","email","push","email2","email3","Object","keys","toLowerCase","indexOf"],"mappings":"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","sourcesContent":["import { combineReducers } from 'redux';\n\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { phoneSources } from '../../enums/phoneSources';\nimport syncTypes from '../../enums/syncTypes';\nimport {\n  addPhoneToContact,\n  getFilterContacts,\n  getMatchContactsByPhoneNumber,\n  getSearchForPhoneNumbers,\n} from '../../lib/contactHelper';\nimport { Module } from '../../lib/di';\nimport Pollable from '../../lib/Pollable';\nimport proxify from '../../lib/proxy/proxify';\nimport { selector } from '../../lib/selector';\nimport sleep from '../../lib/sleep';\nimport { actionTypes } from './actionTypes';\nimport getAddressBookReducer, {\n  getContactListReducer,\n  getSyncTokenReducer,\n  getTimestampReducer,\n} from './getAddressBookReducer';\n\nconst CONTACTS_PER_PAGE = 250;\nconst DEFAULT_TTL = 30 * 60 * 1000;\nconst DEFAULT_TIME_TO_RETRY = 62 * 1000;\nconst REGX_DECODE = /&\\w+;/g;\nconst DECODE = {\n  '&amp;': '&',\n  '&bsol;': '\\\\',\n  '&sol;': '/',\n  '&apos;': \"'\",\n};\n\nfunction getSyncParams(syncToken, pageId) {\n  const query = {\n    perPage: CONTACTS_PER_PAGE,\n  };\n  if (syncToken) {\n    query.syncToken = syncToken;\n    query.syncType = syncTypes.iSync;\n  } else {\n    query.syncType = syncTypes.fSync;\n  }\n  if (pageId) {\n    query.pageId = pageId;\n  }\n  return query;\n}\n\n/**\n * @class\n * @description Accound book module to get user person contacts in RC\n */\n@Module({\n  deps: [\n    'Client',\n    'Auth',\n    'ExtensionFeatures',\n    { dep: 'Storage', optional: true },\n    { dep: 'TabManager', optional: true },\n    { dep: 'AddressBookOptions', optional: true },\n  ],\n})\nexport default class AddressBook extends Pollable {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Auth} params.auth - Auth module instance\n   * @param {TabManager} params.tabManage - TabManager module instance\n   * @param {Storage} params.storage - storage module instance, optional\n   * @param {Number} params.ttl - local cache timestamp, default 30 mins\n   * @param {Number} params.timeToRetry - timestamp to retry, default 62 seconds\n   * @param {Bool} params.polling - polling flag, default true\n   * @param {Bool} params.disableCache - polling flag, default false\n   */\n  constructor({\n    client,\n    auth,\n    storage,\n    tabManager,\n    extensionFeatures,\n    ttl = DEFAULT_TTL,\n    timeToRetry = DEFAULT_TIME_TO_RETRY,\n    polling = true,\n    disableCache = false,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = client;\n    if (!disableCache) {\n      this._storage = storage;\n    }\n    this._auth = auth;\n    this._tabManager = tabManager;\n    this._ttl = ttl;\n    this._extensionFeatures = extensionFeatures;\n    this._timeToRetry = timeToRetry;\n    this._polling = polling;\n    this._promise = null;\n    this._addressBookStorageKey = 'addressBookContactsList';\n    if (this._storage) {\n      this._reducer = getAddressBookReducer(this.actionTypes);\n      this._storage.registerReducer({\n        key: this._addressBookStorageKey,\n        reducer: combineReducers({\n          syncToken: getSyncTokenReducer(this.actionTypes),\n          timestamp: getTimestampReducer(this.actionTypes),\n          contactList: getContactListReducer(this.actionTypes),\n        }),\n      });\n    } else {\n      this._reducer = getAddressBookReducer(this.actionTypes, {\n        contactList: getContactListReducer(this.actionTypes),\n        syncToken: getSyncTokenReducer(this.actionTypes),\n        timestamp: getTimestampReducer(this.actionTypes),\n      });\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (this._shouleCleanCache()) {\n        this._cleanUp();\n      }\n      if (this._hasPermission) {\n        await this._initAddressBook();\n      } else {\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n        });\n      }\n    } else if (this._isDataReady()) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this._shouldReset()) {\n      this._resetModuleStatus();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      (!this._storage || this._storage.ready) &&\n      (!this._tabManager || this._tabManager.ready) &&\n      this._extensionFeatures.ready &&\n      this._auth.loggedIn &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      ((!!this._storage && !this._storage.ready) ||\n        (!!this._tabManager && !this._tabManager.ready) ||\n        !this._extensionFeatures.ready ||\n        !this._auth.loggedIn) &&\n      this.ready\n    );\n  }\n\n  _shouleCleanCache() {\n    return (\n      this._auth.isFreshLogin ||\n      !this.timestamp ||\n      Date.now() - this.timestamp > this._ttl\n    );\n  }\n\n  _shouldFetch() {\n    return (\n      (!this._storage || !this._tabManager || this._tabManager.active) &&\n      this._shouleCleanCache()\n    );\n  }\n\n  _isDataReady() {\n    // only turns ready when data has been fetched\n    // (could be from other tabs)\n    return (\n      this.status === moduleStatuses.initializing && this.timestamp !== null\n    );\n  }\n\n  async _initAddressBook() {\n    if (!this._hasPermission) return;\n    if (this._shouldFetch()) {\n      try {\n        await this.sync();\n      } catch (e) {\n        console.error('syncData error:', e);\n      }\n    } else if (this._polling) {\n      this._startPolling();\n    } else {\n      this._retry();\n    }\n  }\n\n  get _hasPermission() {\n    return (\n      this._extensionFeatures.features?.ReadPersonalContacts?.available ?? false\n    );\n  }\n\n  _resetModuleStatus() {\n    this.store.dispatch({\n      type: this.actionTypes.reset,\n    });\n    this._clearTimeout();\n    this._promise = null;\n    this.store.dispatch({\n      type: this.actionTypes.resetSuccess,\n    });\n  }\n\n  async _syncWithForbiddenCheck(syncToken) {\n    try {\n      const response = await this._sync(syncToken);\n      return response;\n    } catch (error) {\n      if (error && error.response && error.response.status === 403) {\n        const result = {\n          records: [],\n          syncInfo: {\n            syncToken: undefined,\n          },\n        };\n        return result;\n      }\n      throw error;\n    }\n  }\n\n  // interface of ContactSource\n  @proxify\n  async sync() {\n    if (!this._promise) {\n      this._promise = (async () => {\n        try {\n          this.store.dispatch({\n            type: this.actionTypes.sync,\n          });\n          const response = await this._syncWithForbiddenCheck(this.syncToken);\n          this.store.dispatch({\n            type: this.actionTypes.syncSuccess,\n            records: response.records,\n            syncToken: response.syncInfo.syncToken,\n            timestamp: Date.now(),\n          });\n          if (this._polling) {\n            this._startPolling();\n          }\n        } catch (error) {\n          this._onSyncError();\n          if (this._polling) {\n            this._startPolling(this.timeToRetry);\n          } else {\n            this._retry();\n          }\n          this._promise = null;\n          throw error;\n        }\n        this._promise = null;\n      })();\n    }\n    await this._promise;\n  }\n\n  _onSyncError() {\n    this.store.dispatch({\n      type: this.actionTypes.syncError,\n    });\n  }\n\n  @proxify\n  async _sync(syncToken, pageId) {\n    const params = getSyncParams(syncToken, pageId);\n    const response = await this._syncAddressBookApi(params);\n    if (!response.nextPageId) {\n      return response;\n    }\n    await sleep(1000);\n    const lastResponse = await this._sync(syncToken, response.nextPageId);\n    return {\n      ...lastResponse,\n      records: response.records.concat(lastResponse.records),\n    };\n  }\n\n  @proxify\n  async _syncAddressBookApi(params) {\n    const updateRequest = await this._client\n      .account()\n      .extension()\n      .addressBookSync()\n      .list(params);\n    this._decodeAddressBook(updateRequest);\n    return updateRequest;\n  }\n\n  _decode(text) {\n    return text.replace(REGX_DECODE, ($0) => {\n      let handleText = $0;\n      if (DECODE[$0]) {\n        handleText = DECODE[$0];\n      }\n      return handleText;\n    });\n  }\n\n  _decodeAddressBook(origin) {\n    if (origin && origin.records && Array.isArray(origin.records)) {\n      origin.records.forEach((record) => {\n        if (record.firstName) {\n          record.firstName = this._decode(record.firstName);\n        }\n        if (record.lastName) {\n          record.lastName = this._decode(record.lastName);\n        }\n      });\n    }\n  }\n\n  _cleanUp() {\n    this.store.dispatch({\n      type: this.actionTypes.cleanUp,\n    });\n  }\n\n  // interface of ContactSource\n  findContact(contactId) {\n    return this.contacts.find((x) => x.id === contactId);\n  }\n\n  // interface of ContactSource\n  filterContacts(searchFilter) {\n    return getFilterContacts(this.contacts, searchFilter);\n  }\n\n  // interface of ContactSource\n  searchForPhoneNumbers(searchString) {\n    return getSearchForPhoneNumbers({\n      contacts: this.contacts,\n      searchString,\n      entityType: phoneSources.contact,\n      options: null,\n    });\n  }\n\n  // interface of ContactSource\n  matchContactsByPhoneNumber(phoneNumber) {\n    return getMatchContactsByPhoneNumber({\n      contacts: this.contacts,\n      phoneNumber,\n      entityType: phoneSources.rcContact,\n    });\n  }\n\n  @proxify\n  async fetchData() {\n    await this.sync();\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get syncToken() {\n    if (this._storage) {\n      return this._storage.getItem(this._addressBookStorageKey).syncToken;\n    }\n    return this.state.syncToken;\n  }\n\n  get rawContacts() {\n    if (this._storage) {\n      return this._storage.getItem(this._addressBookStorageKey).contactList;\n    }\n    return this.state.contactList;\n  }\n\n  get timestamp() {\n    if (this._storage) {\n      return this._storage.getItem(this._addressBookStorageKey).timestamp;\n    }\n    return this.state.timestamp;\n  }\n\n  get ttl() {\n    return this._ttl;\n  }\n\n  get timeToRetry() {\n    return this._timeToRetry;\n  }\n\n  // interface of ContactSource\n  get sourceName() {\n    return 'personal';\n  }\n\n  // interface of ContactSource\n  @selector\n  contacts = [\n    () => this.rawContacts,\n    (rawContacts) => {\n      const contactsList = [];\n      rawContacts.forEach((rawContact) => {\n        const contact = {\n          type: this.sourceName,\n          phoneNumbers: [],\n          emails: [],\n          ...rawContact,\n        };\n        contact.id = `${contact.id}`;\n        contact.name = `${contact.firstName || ''} ${contact.lastName || ''}`;\n        if (contact.email) contact.emails.push(contact.email);\n        if (contact.email2) contact.emails.push(contact.email2);\n        if (contact.email3) contact.emails.push(contact.email3);\n        Object.keys(contact).forEach((key) => {\n          if (key.toLowerCase().indexOf('phone') === -1) {\n            return;\n          }\n          if (typeof contact[key] !== 'string') {\n            return;\n          }\n          addPhoneToContact(contact, contact[key], key);\n        });\n        contactsList.push(contact);\n      });\n      return contactsList;\n    },\n  ];\n\n  // interface of ContactSource\n  get sourceReady() {\n    return this.ready;\n  }\n}\n"],"file":"index.js"}
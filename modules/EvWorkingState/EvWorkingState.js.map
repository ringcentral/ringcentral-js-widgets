{"version":3,"sources":["modules/EvWorkingState/EvWorkingState.ts"],"names":["PendingDisposition","rank","agentState","agentAuxState","EvWorkingState","name","deps","dep","optional","that","agentConfig","agentSettings","workingState","isPendingDisposition","availableAgentStates","agentStates","enableCache","storageKey","_deps","evAgentSession","onTriggerConfig","evAuth","agent","initLoginState","evClient","setAgentState","initLoginStateLabel","tabManagerEnabled","tabManager","send","tabManagerEvents","RESET_WORKING_STATE","resetWorkingState","agentStateTypes","breakAfterCall","time","Date","now","evCallMonitor","onCallEnded","setIsPendingDisposition","evSubscription","subscribe","EvCallbackTypes","AGENT_STATE","currentAuxState","currentState","ready","event","isOnCall","transition","engaged","indexOf","presence","calls","length","onBreak","alert","danger","message","messageTypes","INVALID_STATE_CHANGE","allowDuplicates","ttl","state","workingAgentState","changeWorkingState","OVER_BREAK_TIME","enable","isOnBreakOrAway","parseInt","maxBreakTime","isOnLunch","maxLunchTime","away","lunch","defaultAgentStateTexts","find","working","RcModuleV2","storage","available","action"],"mappings":"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","sourcesContent":["import { Module } from '@ringcentral-integration/commons/lib/di';\nimport {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n} from '@ringcentral-integration/core';\n\nimport {\n  agentStateTypes,\n  defaultAgentStateTexts,\n  DefaultAgentStateTexts,\n  messageTypes,\n  tabManagerEvents,\n} from '../../enums';\nimport { EvAgentState, EvAvailableAgentState } from '../../lib/EvClient';\nimport { EvCallbackTypes } from '../../lib/EvClient/enums/callbackTypes';\nimport { Deps, State, WorkingState } from './EvWorkingState.interface';\n\nconst PendingDisposition: EvAvailableAgentState = {\n  // TODO: here seems need i18n\n  rank: '0',\n  agentState: 'PENDING-DISPOSITION',\n  agentAuxState: 'Pending Disposition',\n};\n\n@Module({\n  name: 'EvWorkingState',\n  deps: [\n    'Auth',\n    'EvAuth',\n    'EvSubscription',\n    'EvClient',\n    'Presence',\n    'EvCallMonitor',\n    'Alert',\n    'Storage',\n    'EvAgentSession',\n    'TabManager',\n    { dep: 'EvWorkingStateOptions', optional: true },\n  ],\n})\nclass EvWorkingState extends RcModuleV2<Deps> implements WorkingState {\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvWorkingState',\n    });\n    this._deps.evAgentSession.onTriggerConfig(() => {\n      const { agentConfig } = this._deps.evAuth.agent;\n      if (agentConfig?.agentSettings?.initLoginState) {\n        // if that tab is not activity, that wi\n        this._deps.evClient.setAgentState(\n          agentConfig.agentSettings.initLoginState,\n          agentConfig.agentSettings.initLoginStateLabel,\n        );\n      }\n\n      if (this.tabManagerEnabled) {\n        this._deps.tabManager.send(tabManagerEvents.RESET_WORKING_STATE);\n      }\n      this.resetWorkingState();\n    });\n  }\n\n  get tabManagerEnabled() {\n    return this._deps.tabManager?.enable;\n  }\n\n  @storage\n  @state\n  time = Date.now();\n\n  @storage\n  @state\n  agentState: EvAgentState = {\n    agentState: agentStateTypes.available,\n    agentAuxState: 'Available',\n  };\n\n  @storage\n  @state\n  isPendingDisposition = false;\n\n  get agentConfig() {\n    return this._deps.evAuth.agent.agentConfig;\n  }\n\n  @computed((that: EvWorkingState) => [\n    that.agentConfig.agentSettings,\n    that.workingState.agentState,\n  ])\n  get maxBreakTime() {\n    if (this.isOnBreakOrAway) {\n      return (\n        parseInt(this.agentConfig.agentSettings.maxBreakTime || '0', 10) *\n        60 *\n        1000\n      );\n    }\n    if (this.isOnLunch) {\n      return (\n        parseInt(this.agentConfig.agentSettings.maxLunchTime || '0', 10) *\n        60 *\n        1000\n      );\n    }\n    return 1000 * 60;\n  }\n\n  @computed((that: EvWorkingState) => [that.workingState.agentState])\n  get isOnBreakOrAway() {\n    return (\n      [agentStateTypes.away, agentStateTypes.onBreak].indexOf(\n        this.workingState.agentState,\n      ) > -1\n    );\n  }\n\n  @computed((that: EvWorkingState) => [that.workingState.agentState])\n  get isOnLunch() {\n    return this.workingState.agentState === agentStateTypes.lunch;\n  }\n\n  @computed((that: EvWorkingState) => [\n    that.agentState,\n    that.isPendingDisposition,\n  ])\n  get workingState() {\n    return this.isPendingDisposition\n      ? PendingDisposition\n      : {\n          ...this.agentState,\n          agentAuxState:\n            this.agentState.agentAuxState ||\n            defaultAgentStateTexts[\n              this.agentState.agentState as DefaultAgentStateTexts\n            ],\n        };\n  }\n\n  @computed((that: EvWorkingState) => [\n    that.agentConfig,\n    that.isPendingDisposition,\n    that.agentConfig.agentSettings.availableAgentStates,\n  ])\n  get agentStates() {\n    const { availableAgentStates } = this.agentConfig.agentSettings;\n\n    const agentStates = this.isPendingDisposition\n      ? [PendingDisposition, ...availableAgentStates]\n      : availableAgentStates;\n\n    return this.agentConfig ? agentStates : [];\n  }\n\n  @computed((that: EvWorkingState) => [that.agentStates])\n  get workingAgentState() {\n    return this.agentStates.find(\n      (state) => state.agentState === agentStateTypes.working,\n    );\n  }\n\n  @action\n  setAgentState(agentState: EvAgentState) {\n    this.agentState = agentState;\n    if (agentState.agentState !== agentStateTypes.breakAfterCall) {\n      this.time = Date.now();\n    }\n  }\n\n  @action\n  setIsPendingDisposition(isPendingDisposition: State['isPendingDisposition']) {\n    this.isPendingDisposition = isPendingDisposition;\n  }\n\n  @action\n  resetWorkingState() {\n    this.time = Date.now();\n    this.isPendingDisposition = false;\n  }\n\n  @action\n  setTime(time: number) {\n    this.time = time;\n  }\n\n  onInitOnce() {\n    this._deps.evCallMonitor.onCallEnded(() => {\n      this.setIsPendingDisposition(true);\n    });\n\n    this._deps.evSubscription.subscribe(\n      EvCallbackTypes.AGENT_STATE,\n      ({ currentAuxState, currentState }) => {\n        if (\n          this.agentState.agentState !== currentState ||\n          this.agentState.agentAuxState !== currentAuxState\n        ) {\n          this.setAgentState({\n            agentState: currentState,\n            agentAuxState: currentAuxState,\n          });\n        }\n      },\n    );\n  }\n\n  async onStateChange() {\n    if (this.ready && this.tabManagerEnabled && this._deps.tabManager.ready) {\n      const { event } = this._deps.tabManager;\n      if (event) {\n        switch (event.name) {\n          case tabManagerEvents.RESET_WORKING_STATE:\n            this.resetWorkingState();\n            break;\n          default:\n            break;\n        }\n      }\n    }\n  }\n\n  changeWorkingState({ agentState, agentAuxState }: EvAgentState) {\n    const isOnCall =\n      [agentStateTypes.transition, agentStateTypes.engaged].indexOf(\n        this.agentState.agentState,\n      ) > -1 || this._deps.presence.calls.length > 0;\n\n    if (isOnCall && agentState !== agentStateTypes.onBreak) {\n      return this._deps.alert.danger({\n        message: messageTypes.INVALID_STATE_CHANGE,\n        allowDuplicates: false,\n        ttl: 0,\n      });\n    }\n\n    this._deps.evClient.setAgentState(agentState, agentAuxState);\n  }\n\n  setWorkingStateWorking() {\n    const state = this.workingAgentState;\n    if (state) {\n      this.changeWorkingState(state);\n    }\n  }\n\n  alertOverBreakTime() {\n    this._deps.alert.danger({\n      message: messageTypes.OVER_BREAK_TIME,\n      allowDuplicates: false,\n      ttl: 0,\n    });\n  }\n}\n\nexport { EvWorkingState };\n"],"file":"EvWorkingState.js"}
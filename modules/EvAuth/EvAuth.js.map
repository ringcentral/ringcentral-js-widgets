{"version":3,"sources":["modules/EvAuth/EvAuth.ts"],"names":["DEFAULT_COUNTRIES","EvAuth","name","deps","dep","optional","that","inboundSettings","availableQueues","availableRequeueQueues","agentSettings","callerIds","agentConfig","applicationSettings","availableCountries","_deps","locale","currentLocale","_","connected","agent","trackEvents","loginAgent","authenticateResponse","agents","map","agentId","rcUserId","undefined","tabManager","enable","length","storageKey","enableGlobalCache","connecting","_eventEmitter","EventEmitter","canUserLogoutFn","_logout","auth","logout","dismissAllAlert","setNotAuth","tabManagerEnabled","send","tabManagerEvents","LOGGED_OUT","_logoutByOtherTab","_authenticateResponseWatcher","_agentConfigWatcher","token","accessToken","authenticateWithToken","rcAccessToken","shouldEmitAuthSuccess","authenticateRes","openSocketWithSelectedAgentId","loginStatus","AUTH_SUCCESS","LOGIN_SUCCESS","NOT_AUTH","loggedIn","addAfterLoggedInHandler","console","log","clearAgentId","evSubscription","subscribe","EvCallbackTypes","LOGOUT","_emitLogoutBefore","alert","info","message","messageTypes","FORCE_LOGOUT","newReconnect","ready","_checkTabManagerEvent","cb","once","sendLogoutTabEvent","block","next","logoutAgent","logoutAgentResponse","setConnectionData","evClient","callback","on","LOGOUT_BEFORE","isBlock","closeSocket","fn","tokenType","initSDK","getAndHandleAuthenticateResponse","_emitAuthSuccess","setAgent","setAuthSuccess","type","NO_AGENT","CONNECT_TIMEOUT","UNEXPECTED_AGENT","warning","danger","CONNECT_ERROR","syncOtherTabs","retryOpenSocket","getAgentConfig","Promise","resolve","LOGIN_PHASE_1","selectedAgentId","EvTypeError","openSocket","openSocketResult","error","refreshToken","access_token","openSocketRes","OPEN_SOCKET_ERROR","OPEN_SOCKET","_emitLoginSuccess","setLoginSuccess","INVALID_BROWSER","emit","event","isFreshLogin","outboundManualDefaultRingtime","availableSkillProfiles","queues","skillProfile","agentPermissions","gateId","gateName","i18n","getString","description","number","callerId","phoneNumber","countryCode","countriesUsaCan","filter","countryId","includes","countryName","RcModuleV2","globalStorage","state","action"],"mappings":"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","sourcesContent":["import {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  track,\n  globalStorage,\n  watch,\n} from '@ringcentral-integration/core';\nimport format from '@ringcentral-integration/phone-number/lib/format';\nimport { EventEmitter } from 'events';\nimport { Unsubscribe } from 'redux';\nimport { Module } from 'ringcentral-integration/lib/di';\nimport sleep from 'ringcentral-integration/lib/sleep';\n\nimport { loginStatus, messageTypes, tabManagerEvents } from '../../enums';\nimport { EvAgentConfig, EvAgentData } from '../../lib/EvClient';\nimport { EvCallbackTypes } from '../../lib/EvClient/enums';\nimport { EvTypeError } from '../../lib/EvTypeError';\nimport { sortByName } from '../../lib/sortByName';\nimport { trackEvents } from '../../lib/trackEvents';\nimport {\n  Auth,\n  Deps,\n  State,\n  AuthenticateWithTokenType,\n} from './EvAuth.interface';\nimport i18n from './i18n';\n\nconst DEFAULT_COUNTRIES = ['USA', 'CAN'];\n\n@Module({\n  name: 'EvAuth',\n  deps: [\n    'EvClient',\n    'Auth',\n    'Block',\n    'Alert',\n    'Locale',\n    'RouterInteraction',\n    'EvSubscription',\n    'TabManager',\n    'GlobalStorage',\n    { dep: 'EvAuthOptions', optional: true },\n  ],\n})\nclass EvAuth extends RcModuleV2<Deps> implements Auth {\n  public connecting?: boolean;\n\n  private _eventEmitter = new EventEmitter();\n\n  public canUserLogoutFn: () => Promise<boolean> = async () => true;\n\n  private _logout = async () => {\n    await this._deps.auth.logout({ dismissAllAlert: false });\n    this.setNotAuth();\n    if (this.tabManagerEnabled) {\n      this._deps.tabManager.send(tabManagerEvents.LOGGED_OUT);\n    }\n  };\n\n  private _logoutByOtherTab = false;\n\n  private _authenticateResponseWatcher: Unsubscribe = null;\n  private _agentConfigWatcher: Unsubscribe = null;\n\n  get tabManagerEnabled() {\n    return this._deps.tabManager?.enable;\n  }\n\n  get isOnlyOneAgent() {\n    return this.agent?.authenticateResponse.agents.length === 1;\n  }\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      storageKey: 'EvAuth',\n      enableGlobalCache: true,\n    });\n  }\n\n  @globalStorage\n  @state\n  connected = false;\n\n  @globalStorage\n  @state\n  agent: EvAgentData = null;\n\n  @globalStorage\n  @state\n  agentId = '';\n\n  @action\n  setAgentId(agentId: string) {\n    this.agentId = agentId;\n  }\n\n  get isFreshLogin() {\n    return this._deps.auth.isFreshLogin;\n  }\n\n  get agentConfig() {\n    return this.agent?.agentConfig || null;\n  }\n\n  get authenticateResponse() {\n    return this.agent?.authenticateResponse || null;\n  }\n\n  get agentSettings() {\n    return this.agentConfig?.agentSettings;\n  }\n\n  get outboundManualDefaultRingtime() {\n    return this.agentSettings?.outboundManualDefaultRingtime;\n  }\n\n  get inboundSettings() {\n    return (\n      this.agentConfig.inboundSettings || {\n        availableQueues: [] as Array<undefined>,\n        availableSkillProfiles: [] as Array<undefined>,\n        queues: [] as Array<undefined>,\n        skillProfile: {} as any,\n        availableRequeueQueues: [] as Array<undefined>,\n      }\n    );\n  }\n\n  get assignedQueue() {\n    return this.inboundSettings.queues;\n  }\n\n  get agentPermissions() {\n    return this.agentConfig?.agentPermissions;\n  }\n\n  @computed((that: EvAuth) => [that.inboundSettings.availableQueues])\n  get availableQueues() {\n    return [\n      {\n        gateId: '-1',\n        gateName: i18n.getString('default', this._deps.locale.currentLocale),\n      },\n      ...sortByName(this.inboundSettings.availableQueues, 'gateName'),\n    ];\n  }\n\n  @computed((that: EvAuth) => [that.inboundSettings.availableRequeueQueues])\n  get availableRequeueQueues() {\n    return sortByName(this.inboundSettings.availableRequeueQueues, 'groupName');\n  }\n\n  @computed((that: EvAuth) => [that.agentSettings.callerIds])\n  get callerIds() {\n    return [\n      {\n        description: i18n.getString('default', this._deps.locale.currentLocale),\n        number: '-1',\n      },\n      ...this.agentSettings.callerIds.map((callerId) => {\n        const number =\n          format({\n            phoneNumber: callerId.number,\n            countryCode: 'US',\n          }) || callerId.number;\n        return {\n          ...callerId,\n          number,\n        };\n      }),\n    ];\n  }\n\n  @computed((that: EvAuth) => [\n    that.agentConfig.applicationSettings.availableCountries,\n    that._deps.locale.currentLocale,\n  ])\n  get availableCountries() {\n    const { availableCountries } = this.agentConfig?.applicationSettings;\n    // The default Engage Voice service area is `USA` and `CAN` with `+1` international code.\n    const countriesUsaCan = availableCountries.filter(({ countryId }) =>\n      DEFAULT_COUNTRIES.includes(countryId),\n    );\n    return countriesUsaCan.length > 0\n      ? countriesUsaCan\n      : [\n          {\n            countryId: 'USA',\n            countryName: i18n.getString('us', this._deps.locale.currentLocale),\n          },\n        ];\n  }\n\n  @track((_: EvAuth, { connected, agent }: State) => {\n    return [\n      trackEvents.loginAgent,\n      connected\n        ? {\n            'agentId(s)': agent.authenticateResponse?.agents?.map(\n              (agent) => agent.agentId,\n            ),\n            'userId(s)': agent.authenticateResponse?.agents?.map(\n              (agent) => agent.rcUserId,\n            ),\n          }\n        : undefined,\n    ];\n  })\n  @action\n  setConnectionData({ connected, agent }: State) {\n    // ! agent must be set before connected\n    this.agent = agent;\n    this.connected = connected;\n  }\n\n  @action\n  setAgent(agent: EvAgentData) {\n    this.agent = agent;\n  }\n\n  @action\n  setConnected(connected: boolean) {\n    this.connected = connected;\n  }\n\n  @action\n  clearAgentId() {\n    this.agentId = '';\n  }\n\n  @state\n  loginStatus: string = null;\n\n  @action\n  setAuthSuccess() {\n    this.loginStatus = loginStatus.AUTH_SUCCESS;\n  }\n\n  @action\n  setLoginSuccess() {\n    this.loginStatus = loginStatus.LOGIN_SUCCESS;\n  }\n\n  get isEvLogged() {\n    return this.loginStatus === loginStatus.LOGIN_SUCCESS;\n  }\n\n  @action\n  setNotAuth() {\n    this.loginStatus = loginStatus.NOT_AUTH;\n  }\n\n  _shouldInit() {\n    return super._shouldInit() && this._deps.auth.loggedIn && this.connected;\n  }\n\n  onInitOnce() {\n    this._deps.auth.addAfterLoggedInHandler(() => {\n      console.log('addAfterLoggedInHandler~~');\n      this.clearAgentId();\n    });\n    this._deps.evSubscription.subscribe(EvCallbackTypes.LOGOUT, async () => {\n      this._emitLogoutBefore();\n\n      // if that is logout by same browser that will only trigger emit\n      // if there is logout by other browser, that need redirect to home page,\n      if (!this._logoutByOtherTab) {\n        this._deps.alert.info({\n          message: messageTypes.FORCE_LOGOUT,\n        });\n\n        this._logoutByOtherTab = false;\n\n        await this.newReconnect();\n      }\n    });\n  }\n\n  async onStateChange() {\n    // here not need check this.ready, because that should work when not login\n    if (this.tabManagerEnabled && this._deps.tabManager.ready) {\n      await this._checkTabManagerEvent();\n    }\n\n    if (\n      this._deps.auth.loggedIn &&\n      this.loginStatus !== loginStatus.AUTH_SUCCESS &&\n      this.loginStatus !== loginStatus.LOGIN_SUCCESS &&\n      !this.connecting\n    ) {\n      this.connecting = true;\n      // when login make sure the logoutByOtherTab is false\n      this._logoutByOtherTab = false;\n\n      if (this.agentId) {\n        await this.loginAgent();\n      } else {\n        await this.authenticateWithToken();\n      }\n    }\n  }\n\n  onceLogout(cb: () => any) {\n    return this._deps.evSubscription.once(EvCallbackTypes.LOGOUT, cb);\n  }\n\n  async logout() {\n    if (!(await this.canUserLogoutFn())) {\n      return;\n    }\n    console.log('logout~~');\n\n    const agentId = this.agentId;\n\n    this.sendLogoutTabEvent();\n\n    await this._deps.block.next(this._logout);\n\n    const logoutAgentResponse = await this.logoutAgent(agentId);\n\n    // TODO: error handle when logout fail\n    // TODO: when failed need tell other tab not logout => this._deps.tabManager.send(tabManagerEvents.LOGOUT);\n    if (!logoutAgentResponse.message || logoutAgentResponse.message !== 'OK') {\n      console.log('logoutAgent failed');\n    }\n    this.setConnectionData({ connected: false, agent: null });\n  }\n\n  sendLogoutTabEvent() {\n    this._emitLogoutBefore();\n    if (this.tabManagerEnabled) {\n      this._deps.tabManager.send(tabManagerEvents.LOGOUT);\n    }\n  }\n\n  logoutAgent(agentId: string = this.agentId) {\n    return this._deps.evClient.logoutAgent(agentId);\n  }\n\n  beforeAgentLogout(callback: () => void) {\n    this._eventEmitter.on(loginStatus.LOGOUT_BEFORE, callback);\n  }\n\n  newReconnect(isBlock: boolean = true) {\n    this._deps.evClient.closeSocket();\n\n    const fn = this.loginAgent;\n\n    return isBlock ? this._deps.block.next(fn) : fn();\n  }\n\n  async authenticateWithToken({\n    rcAccessToken = this._deps.auth.accessToken,\n    tokenType = 'Bearer',\n    shouldEmitAuthSuccess = true,\n  }: AuthenticateWithTokenType = {}) {\n    console.log('authenticateWithToken', shouldEmitAuthSuccess);\n    try {\n      this._deps.evClient.initSDK();\n\n      const authenticateResponse = await this._deps.evClient.getAndHandleAuthenticateResponse(\n        rcAccessToken,\n        tokenType,\n      );\n      const agent = { ...this.agent, authenticateResponse };\n      if (shouldEmitAuthSuccess && !this._authenticateResponseWatcher) {\n        this._authenticateResponseWatcher = watch(\n          this,\n          () => this.agent?.authenticateResponse,\n          (authenticateResponse) => {\n            if (authenticateResponse) {\n              this._emitAuthSuccess();\n              this._authenticateResponseWatcher();\n              this._authenticateResponseWatcher = null;\n            }\n          },\n        );\n      }\n      this.setAgent(agent);\n      this.setAuthSuccess();\n      return authenticateResponse;\n    } catch (error) {\n      switch (error.type) {\n        case messageTypes.NO_AGENT:\n          this._deps.alert.warning({\n            message: error.type,\n          });\n          break;\n        case messageTypes.CONNECT_TIMEOUT:\n        case messageTypes.UNEXPECTED_AGENT:\n          this._deps.alert.danger({\n            message: error.type,\n          });\n          break;\n        default:\n          this._deps.alert.danger({\n            message: messageTypes.CONNECT_ERROR,\n          });\n      }\n      await this._logout();\n    }\n  }\n\n  async openSocketWithSelectedAgentId({\n    syncOtherTabs = false,\n    retryOpenSocket = false,\n  } = {}) {\n    console.log(\n      'openSocketWithSelectedAgentId',\n      syncOtherTabs,\n      retryOpenSocket,\n    );\n    try {\n      // TODO: here need check time when no message come back, that will block app.\n      const getAgentConfig = new Promise<EvAgentConfig>((resolve) => {\n        this._deps.evClient.on(EvCallbackTypes.LOGIN_PHASE_1, resolve);\n      });\n\n      const selectedAgentId = this.agentId;\n      if (!selectedAgentId) {\n        throw new EvTypeError({\n          type: messageTypes.NO_AGENT,\n        });\n      }\n      const openSocketResult = await this._deps.evClient.openSocket(\n        selectedAgentId,\n      );\n      // wait for socketOpened\n      // Because instance.socket Opened(); was performed after callback.\n      await sleep(0);\n      if (openSocketResult.error) {\n        console.log('retryOpenSocket~~', retryOpenSocket);\n        if (retryOpenSocket) {\n          const { access_token } = await this._deps.auth.refreshToken();\n          const authenticateRes = await this.authenticateWithToken({\n            rcAccessToken: access_token,\n            shouldEmitAuthSuccess: false,\n          });\n          if (!authenticateRes) return;\n          const openSocketRes: any = await this.openSocketWithSelectedAgentId({\n            syncOtherTabs,\n          });\n          return openSocketRes;\n        }\n        throw new EvTypeError({\n          type: messageTypes.OPEN_SOCKET_ERROR,\n        });\n      }\n\n      // TODOï¼š implement multiple sync back drop\n      if (syncOtherTabs && this.tabManagerEnabled) {\n        this._deps.tabManager.send(tabManagerEvents.OPEN_SOCKET);\n      }\n\n      const agentConfig = await getAgentConfig;\n\n      const agent = { ...this.agent, agentConfig };\n\n      if (!this._agentConfigWatcher) {\n        this._agentConfigWatcher = watch(\n          this,\n          () => this.agent?.agentConfig,\n          (agentConfig) => {\n            if (agentConfig) {\n              this._emitLoginSuccess();\n              this._agentConfigWatcher();\n              this._agentConfigWatcher = null;\n            }\n          },\n        );\n      }\n\n      this.setConnectionData({ agent, connected: true });\n\n      this.connecting = false;\n\n      this.setLoginSuccess();\n\n      return agentConfig;\n    } catch (error) {\n      switch (error.type) {\n        case messageTypes.NO_AGENT:\n          this._deps.alert.warning({\n            message: error.type,\n          });\n          break;\n        case messageTypes.INVALID_BROWSER:\n        case messageTypes.OPEN_SOCKET_ERROR:\n          this._deps.alert.danger({\n            message: error.type,\n          });\n          break;\n        default:\n          this._deps.alert.danger({\n            message: messageTypes.CONNECT_ERROR,\n          });\n      }\n\n      await this._logout();\n    }\n  }\n\n  loginAgent = async (token: string = this._deps.auth.accessToken) => {\n    const authenticateRes = await this.authenticateWithToken({\n      rcAccessToken: token,\n      shouldEmitAuthSuccess: false,\n    });\n    if (!authenticateRes) return;\n    await this.openSocketWithSelectedAgentId();\n  };\n\n  onceLoginSuccess(callback: () => void) {\n    this._eventEmitter.once(loginStatus.LOGIN_SUCCESS, callback);\n  }\n\n  onAuthSuccess(callback: () => void) {\n    this._eventEmitter.on(loginStatus.AUTH_SUCCESS, callback);\n  }\n\n  private _emitLogoutBefore() {\n    this._eventEmitter.emit(loginStatus.LOGOUT_BEFORE);\n  }\n\n  private _emitLoginSuccess() {\n    this._eventEmitter.emit(loginStatus.LOGIN_SUCCESS);\n  }\n\n  private _emitAuthSuccess() {\n    this._eventEmitter.emit(loginStatus.AUTH_SUCCESS);\n  }\n\n  private async _checkTabManagerEvent() {\n    const { event } = this._deps.tabManager;\n    if (event) {\n      switch (event.name) {\n        case tabManagerEvents.LOGOUT:\n          this._logoutByOtherTab = true;\n          break;\n        case tabManagerEvents.OPEN_SOCKET:\n          await this._deps.block.next(async () => {\n            await this.openSocketWithSelectedAgentId({\n              retryOpenSocket: true,\n            });\n          });\n          break;\n        case tabManagerEvents.LOGGED_OUT:\n          this.setNotAuth();\n          break;\n        default:\n          break;\n      }\n    }\n  }\n}\n\nexport { EvAuth };\n"],"file":"EvAuth.js"}
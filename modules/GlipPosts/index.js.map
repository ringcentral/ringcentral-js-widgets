{"version":3,"sources":["modules/GlipPosts/index.js"],"names":["glipPostsRegExp","subscriptionFilter","DEFAULT_LOAD_TTL","GlipPosts","deps","dep","optional","client","auth","subscription","storage","loadTtl","options","actionTypes","_reducer","_client","_auth","_subscription","_fetchPromises","_lastMessage","_loadTtl","_storage","_readTimeStorageKey","registerReducer","key","reducer","_newPostListeners","listen","push","store","subscribe","_onStateChange","_shouldInit","dispatch","type","initSuccess","_shouldReset","resetSuccess","_shouldSubscribe","_processSubscription","loggedIn","ready","pending","message","test","event","body","eventType","post","createSuccess","groupId","record","oldRecordId","id","isSendByMe","creatorId","ownerId","forEach","recordCount","lastPosts","postsMap","fetchTime","fetchTimeMap","Date","now","fetchPosts","pageToken","fetch","params","glip","groups","posts","list","response","fetchSuccess","records","lastPageToken","navigation","fetchError","promise","pageInfo","pageInfos","prevPageToken","text","postInputs","fakeId","fakeRecord","sendStatus","status","creating","creationTime","create","updatePostInput","createError","fileName","rawFile","platform","service","name","headers","json","console","error","time","updateReadTime","textValue","state","glipPostsStore","moduleStatuses","getItem","fetchTimes","RcModule"],"mappings":"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","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nimport isBlank from '../../lib/isBlank';\n\nimport actionTypes from './actionTypes';\nimport getReducer, { getGlipPostsReadTimeReducer } from './getReducer';\nimport status from './status';\n\nconst glipPostsRegExp = /glip\\/posts$/;\nconst subscriptionFilter = '/glip/posts';\n\nconst DEFAULT_LOAD_TTL = 30 * 60 * 1000;\n\n@Module({\n  deps: [\n    'Client',\n    'Auth',\n    'Subscription',\n    'Storage',\n    { dep: 'GlipPostsOptions', optional: true }\n  ]\n})\nexport default class GlipPosts extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Auth} params.auth - auth module instance\n   * @param {Subscription} params.subscription - subscription module instance\n   */\n  constructor({\n    client,\n    auth,\n    subscription,\n    storage,\n    loadTtl = DEFAULT_LOAD_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._reducer = getReducer(this.actionTypes);\n\n    this._client = client;\n    this._auth = auth;\n    this._subscription = subscription;\n    this._fetchPromises = {};\n    this._lastMessage = null;\n    this._loadTtl = loadTtl;\n\n    this._storage = storage;\n    this._readTimeStorageKey = 'glipPostReadTime';\n    this._storage.registerReducer({\n      key: this._readTimeStorageKey,\n      reducer: getGlipPostsReadTimeReducer(this.actionTypes),\n    });\n    this._newPostListeners = [];\n  }\n\n  addNewPostListener(listen) {\n    if (typeof listen === 'function') {\n      this._newPostListeners.push(listen);\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      this._subscription.subscribe(subscriptionFilter);\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n      this._fetchPromises = {};\n    } else if (this._shouldSubscribe()) {\n      this._processSubscription();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._auth.loggedIn &&\n      this._subscription.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (\n        !this._auth.loggedIn ||\n        !this._subscription.ready\n      ) &&\n      this.ready\n    );\n  }\n\n  _shouldSubscribe() {\n    return !!(\n      this.ready &&\n      this._subscription &&\n      this._subscription.ready &&\n      this._subscription.message &&\n      this._subscription.message !== this._lastMessage\n    );\n  }\n\n  _processSubscription() {\n    const { message } = this._subscription;\n    this._lastMessage = message;\n    if (\n      message &&\n      glipPostsRegExp.test(message.event) &&\n      message.body\n    ) {\n      const {\n        eventType,\n        ...post,\n      } = message.body;\n      if (eventType === 'PostRemoved') {\n        return;\n      }\n      this.store.dispatch({\n        type: this.actionTypes.createSuccess,\n        groupId: post.groupId,\n        record: post,\n        oldRecordId: post.id,\n        isSendByMe: (post.creatorId === this._auth.ownerId && eventType === 'PostAdded')\n      });\n      if (eventType === 'PostAdded' && post.creatorId !== this._auth.ownerId) {\n        this._newPostListeners.forEach((listen) => {\n          listen(post);\n        });\n      }\n    }\n  }\n\n  async loadPosts(groupId, recordCount = 20) {\n    const lastPosts = this.postsMap[groupId];\n    const fetchTime = this.fetchTimeMap[groupId];\n    if (\n      lastPosts && fetchTime && Date.now() - fetchTime < this._loadTtl\n    ) {\n      return;\n    }\n    await this.fetchPosts(groupId, recordCount);\n  }\n\n  async fetchPosts(groupId, recordCount = 20, pageToken) {\n    if (!groupId) {\n      return;\n    }\n    if (!this._fetchPromises[groupId]) {\n      this._fetchPromises[groupId] = (async () => {\n        try {\n          this.store.dispatch({\n            type: this.actionTypes.fetch,\n          });\n          const params = { recordCount };\n          if (pageToken) {\n            params.pageToken = pageToken;\n          }\n          const response = await this._client.glip().groups(groupId).posts().list(params);\n          this.store.dispatch({\n            type: this.actionTypes.fetchSuccess,\n            groupId,\n            records: response.records,\n            lastPageToken: pageToken,\n            navigation: response.navigation,\n          });\n        } catch (e) {\n          this.store.dispatch({\n            type: this.actionTypes.fetchError,\n          });\n        }\n        this._fetchPromises[groupId] = null;\n      })();\n    }\n    const promise = this._fetchPromises[groupId];\n    await promise;\n  }\n\n  async loadNextPage(groupId, recordCount) {\n    const pageInfo = this.pageInfos[groupId];\n    const pageToken = pageInfo && pageInfo.prevPageToken;\n    if (!pageToken) {\n      return;\n    }\n    await this.fetchPosts(groupId, recordCount, pageToken);\n  }\n\n  async create({ groupId }) {\n    const text = this.postInputs[groupId] && this.postInputs[groupId].text;\n    if (isBlank(text) || !groupId) {\n      return;\n    }\n    const fakeId = `${Date.now()}`;\n    const fakeRecord = {\n      id: fakeId,\n      groupId,\n      creatorId: this._auth.ownerId,\n      sendStatus: status.creating,\n      creationTime: `${new Date(Date.now())}`,\n      text,\n      type: 'TextMessage',\n    };\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.create,\n        groupId,\n        record: fakeRecord,\n      });\n      this.updatePostInput({ text: '', groupId });\n      const record = await this._client.glip().groups(groupId).posts().post({\n        text,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.createSuccess,\n        groupId,\n        record,\n        oldRecordId: fakeId,\n      });\n    } catch (e) {\n      fakeRecord.sendStatus = status.createError;\n      this.store.dispatch({\n        type: this.actionTypes.createError,\n        record: fakeRecord,\n        groupId,\n        oldRecordId: fakeId,\n      });\n      this.updatePostInput({ text, groupId });\n    }\n  }\n\n  async sendFile({ fileName, groupId, rawFile }) {\n    try {\n      const platform = this._client.service.platform();\n      const body = rawFile;\n      const response = await platform.post(\n        '/glip/files',\n        body,\n        { groupId, name: fileName },\n        {\n          headers: {\n            'Content-Type': 'application/octet-stream',\n          }\n        }\n      );\n      return response.json();\n    } catch (e) {\n      console.error(e);\n    }\n    return null;\n  }\n\n  updateReadTime(groupId, time) {\n    this.store.dispatch({\n      type: this.actionTypes.updateReadTime,\n      groupId,\n      time\n    });\n  }\n\n  updatePostInput({ text, groupId }) {\n    this.store.dispatch({\n      type: this.actionTypes.updatePostInput,\n      groupId,\n      textValue: text,\n    });\n  }\n\n  get postsMap() {\n    return this.state.glipPostsStore;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get postInputs() {\n    return this.state.postInputs;\n  }\n\n  get readTimeMap() {\n    return this._storage.getItem(this._readTimeStorageKey);\n  }\n\n  get pageInfos() {\n    return this.state.pageInfos;\n  }\n\n  get fetchTimeMap() {\n    return this.state.fetchTimes;\n  }\n}\n"]}
{"version":3,"sources":["modules/GlipPosts/index.js"],"names":["glipPostsRegExp","glipGroupRegExp","subscriptionFilter","DEFAULT_LOAD_TTL","GlipPosts","deps","dep","optional","client","auth","subscription","storage","extensionFeatures","loadTtl","options","actionTypes","_reducer","_client","ensureExist","call","_auth","_extensionFeatures","_subscription","_fetchPromises","_lastMessage","_loadTtl","_storage","_readTimeStorageKey","registerReducer","key","reducer","_newPostListeners","listen","push","store","subscribe","_onStateChange","_shouldInit","dispatch","type","init","_hasPermission","initSuccess","_shouldReset","resetSuccess","_shouldHandleSubscriptionMessage","_processSubscription","loggedIn","ready","pending","message","test","event","body","eventType","post","indexOf","createSuccess","groupId","record","oldRecordId","id","isSendByMe","creatorId","ownerId","forEach","recordCount","lastPosts","postsMap","fetchTime","fetchTimeMap","Date","now","fetchPosts","pageToken","fetch","params","glip","groups","posts","list","response","fetchSuccess","records","lastPageToken","navigation","fetchError","promise","pageInfo","pageInfos","prevPageToken","text","postInputs","mentions","length","mention","matcherId","replace","fakeId","fakeRecord","sendStatus","status","creating","creationTime","create","updatePostInput","createError","fileName","rawFile","platform","service","name","headers","json","console","error","time","updateReadTime","textValue","state","glipPostsStore","moduleStatuses","getItem","fetchTimes","features","Glip","available","RcModule","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,eAAe,GAAG,cAAxB;AACA,IAAMC,eAAe,GAAG,eAAxB;AAEA,IAAMC,kBAAkB,GAAG,0BAA3B;AAEA,IAAMC,gBAAgB,GAAG,KAAK,EAAL,GAAU,IAAnC;IAYqBC,S,WAVpB,gBAAO;AACNC,EAAAA,IAAI,EAAE,CACJ,QADI,EAEJ,MAFI,EAGJ,cAHI,EAIJ,SAJI,EAKJ,mBALI,EAMJ;AAAEC,IAAAA,GAAG,EAAE,kBAAP;AAA2BC,IAAAA,QAAQ,EAAE;AAArC,GANI;AADA,CAAP,C;;;;;AAWC,2BAQG;AAAA;;AAAA,QAPDC,MAOC,QAPDA,MAOC;AAAA,QANDC,IAMC,QANDA,IAMC;AAAA,QALDC,YAKC,QALDA,YAKC;AAAA,QAJDC,OAIC,QAJDA,OAIC;AAAA,QAHDC,iBAGC,QAHDA,iBAGC;AAAA,4BAFDC,OAEC;AAAA,QAFDA,OAEC,6BAFSV,gBAET;AAAA,QADEW,OACF;;AAAA;;AACD,8DACKA,OADL;AAEEC,MAAAA,WAAW,EAAXA;AAFF;AAIA,UAAKC,QAAL,GAAgB,4BAAW,MAAKD,WAAhB,CAAhB;AAEA,UAAKE,OAAL,GAAeC,wBAAYC,IAAZ,gCAAuBX,MAAvB,EAA+B,QAA/B,CAAf;AACA,UAAKY,KAAL,GAAaF,wBAAYC,IAAZ,gCAAuBV,IAAvB,EAA6B,MAA7B,CAAb;AACA,UAAKY,kBAAL,GAA0BT,iBAA1B;AACA,UAAKU,aAAL,GAAqBJ,wBAAYC,IAAZ,gCAAuBT,YAAvB,EAAqC,cAArC,CAArB;AACA,UAAKa,cAAL,GAAsB,EAAtB;AACA,UAAKC,YAAL,GAAoB,IAApB;AACA,UAAKC,QAAL,GAAgBZ,OAAhB;AAEA,UAAKa,QAAL,GAAgBf,OAAhB;AACA,UAAKgB,mBAAL,GAA2B,kBAA3B;;AACA,UAAKD,QAAL,CAAcE,eAAd,CAA8B;AAC5BC,MAAAA,GAAG,EAAE,MAAKF,mBADkB;AAE5BG,MAAAA,OAAO,EAAE,6CAA4B,MAAKf,WAAjC;AAFmB,KAA9B;;AAIA,UAAKgB,iBAAL,GAAyB,EAAzB;AArBC;AAsBF;;;;uCAEkBC,M,EAAQ;AACzB,UAAI,OAAOA,MAAP,KAAkB,UAAtB,EAAkC;AAChC,aAAKD,iBAAL,CAAuBE,IAAvB,CAA4BD,MAA5B;AACD;AACF;;;iCAEY;AAAA;;AACX,WAAKE,KAAL,CAAWC,SAAX,CAAqB;AAAA,eAAM,MAAI,CAACC,cAAL,EAAN;AAAA,OAArB;AACD;;;;;;;;;qBAGK,KAAKC,WAAL,E;;;;;AACF,qBAAKH,KAAL,CAAWI,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiByB;AADL,iBAApB;;oBAGK,KAAKC,c;;;;;;;;AACV,qBAAKP,KAAL,CAAWI,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB2B;AADL,iBAApB;;AAGA,qBAAKpB,aAAL,CAAmBa,SAAnB,CAA6B,CAACjC,kBAAD,CAA7B;;;;;;AACK,oBAAI,KAAKyC,YAAL,EAAJ,EAAyB;AAC9B,uBAAKT,KAAL,CAAWI,QAAX,CAAoB;AAClBC,oBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB6B;AADL,mBAApB;AAGA,uBAAKrB,cAAL,GAAsB,EAAtB;AACD,iBALM,MAKA,IAAI,KAAKsB,gCAAL,EAAJ,EAA6C;AAClD,uBAAKC,oBAAL;AACD;;;;;;;;;;;;;;;;;;kCAGW;AACZ,aACE,KAAK1B,KAAL,CAAW2B,QAAX,IACA,KAAKzB,aAAL,CAAmB0B,KADnB,IAEA,KAAK3B,kBAAL,CAAwB2B,KAFxB,IAGA,KAAKC,OAJP;AAMD;;;mCAEc;AACb,aACE,CAAC,CAAC,KAAK7B,KAAL,CAAW2B,QAAZ,IACC,CAAC,KAAK1B,kBAAL,CAAwB2B,KAD1B,IAEC,CAAC,KAAK1B,aAAL,CAAmB0B,KAFtB,KAGA,KAAKA,KAJP;AAMD;;;uDAEkC;AACjC,aAAO,CAAC,EACN,KAAKA,KAAL,IACA,KAAK1B,aADL,IAEA,KAAKA,aAAL,CAAmB0B,KAFnB,IAGA,KAAK1B,aAAL,CAAmB4B,OAHnB,IAIA,KAAK5B,aAAL,CAAmB4B,OAAnB,KAA+B,KAAK1B,YAL9B,CAAR;AAOD;;;2CAEsB;AAAA,UACb0B,OADa,GACD,KAAK5B,aADJ,CACb4B,OADa;AAErB,WAAK1B,YAAL,GAAoB0B,OAApB;;AACA,UACEA,OAAO,KACNlD,eAAe,CAACmD,IAAhB,CAAqBD,OAAO,CAACE,KAA7B,KACCnD,eAAe,CAACkD,IAAhB,CAAqBD,OAAO,CAACE,KAA7B,CAFK,CAAP,IAGAF,OAAO,CAACG,IAJV,EAKE;AAAA,4BAC+BH,OAAO,CAACG,IADvC;AAAA,YACQC,SADR,iBACQA,SADR;AAAA,YACsBC,IADtB;;AAEA,YAAID,SAAS,CAACE,OAAV,CAAkB,MAAlB,MAA8B,CAAlC,EAAqC;AACnC;AACD;;AACD,YAAIF,SAAS,KAAK,aAAlB,EAAiC;AAC/B;AACD;;AACD,aAAKpB,KAAL,CAAWI,QAAX,CAAoB;AAClBC,UAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB0C,aADL;AAElBC,UAAAA,OAAO,EAAEH,IAAI,CAACG,OAFI;AAGlBC,UAAAA,MAAM,EAAEJ,IAHU;AAIlBK,UAAAA,WAAW,EAAEL,IAAI,CAACM,EAJA;AAKlBC,UAAAA,UAAU,EACRP,IAAI,CAACQ,SAAL,KAAmB,KAAK3C,KAAL,CAAW4C,OAA9B,IAAyCV,SAAS,KAAK;AANvC,SAApB;;AAQA,YAAIA,SAAS,KAAK,WAAd,IAA6BC,IAAI,CAACQ,SAAL,KAAmB,KAAK3C,KAAL,CAAW4C,OAA/D,EAAwE;AACtE,eAAKjC,iBAAL,CAAuBkC,OAAvB,CAA+B,UAACjC,MAAD,EAAY;AACzCA,YAAAA,MAAM,CAACuB,IAAD,CAAN;AACD,WAFD;AAGD;AACF;AACF;;;;iGAGeG,O;;;;;;;;;AAASQ,gBAAAA,W,8DAAc,E;AAC/BC,gBAAAA,S,GAAY,KAAKC,QAAL,CAAcV,OAAd,C;AACZW,gBAAAA,S,GAAY,KAAKC,YAAL,CAAkBZ,OAAlB,C;;sBACdS,SAAS,IAAIE,SAAb,IAA0BE,IAAI,CAACC,GAAL,KAAaH,SAAb,GAAyB,KAAK5C,Q;;;;;;;;;uBAGtD,KAAKgD,UAAL,CAAgBf,OAAhB,EAAyBQ,WAAzB,C;;;;;;;;;;;;;;;;;;;kGAISR,O;;;;;;;;;;;AAASQ,gBAAAA,W,8DAAc,E;AAAIQ,gBAAAA,S;;oBACrChB,O;;;;;;;;AAGL,oBAAI,CAAC,KAAKnC,cAAL,CAAoBmC,OAApB,CAAL,EAAmC;AACjC,uBAAKnC,cAAL,CAAoBmC,OAApB,IAA+B,wDAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAE5B,4BAAA,MAAI,CAACxB,KAAL,CAAWI,QAAX,CAAoB;AAClBC,8BAAAA,IAAI,EAAE,MAAI,CAACxB,WAAL,CAAiB4D;AADL,6BAApB;;AAGMC,4BAAAA,MALsB,GAKb;AAAEV,8BAAAA,WAAW,EAAXA;AAAF,6BALa;;AAM5B,gCAAIQ,SAAJ,EAAe;AACbE,8BAAAA,MAAM,CAACF,SAAP,GAAmBA,SAAnB;AACD;;AAR2B;AAAA,mCASL,MAAI,CAACzD,OAAL,CACpB4D,IADoB,GAEpBC,MAFoB,CAEbpB,OAFa,EAGpBqB,KAHoB,GAIpBC,IAJoB,CAIfJ,MAJe,CATK;;AAAA;AAStBK,4BAAAA,QATsB;;AAc5B,4BAAA,MAAI,CAAC/C,KAAL,CAAWI,QAAX,CAAoB;AAClBC,8BAAAA,IAAI,EAAE,MAAI,CAACxB,WAAL,CAAiBmE,YADL;AAElBxB,8BAAAA,OAAO,EAAPA,OAFkB;AAGlByB,8BAAAA,OAAO,EAAEF,QAAQ,CAACE,OAHA;AAIlBC,8BAAAA,aAAa,EAAEV,SAJG;AAKlBW,8BAAAA,UAAU,EAAEJ,QAAQ,CAACI;AALH,6BAApB;;AAd4B;AAAA;;AAAA;AAAA;AAAA;;AAsB5B,4BAAA,MAAI,CAACnD,KAAL,CAAWI,QAAX,CAAoB;AAClBC,8BAAAA,IAAI,EAAE,MAAI,CAACxB,WAAL,CAAiBuE;AADL,6BAApB;;AAtB4B;AA0B9B,4BAAA,MAAI,CAAC/D,cAAL,CAAoBmC,OAApB,IAA+B,IAA/B;;AA1B8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAD,IAA/B;AA4BD;;AACK6B,gBAAAA,O,GAAU,KAAKhE,cAAL,CAAoBmC,OAApB,C;;uBACV6B,O;;;;;;;;;;;;;;;;;;;oGAIW7B,O,EAASQ,W;;;;;;AACpBsB,gBAAAA,Q,GAAW,KAAKC,SAAL,CAAe/B,OAAf,C;AACXgB,gBAAAA,S,GAAYc,QAAQ,IAAIA,QAAQ,CAACE,a;;oBAClChB,S;;;;;;;;;uBAGC,KAAKD,UAAL,CAAgBf,OAAhB,EAAyBQ,WAAzB,EAAsCQ,SAAtC,C;;;;;;;;;;;;;;;;;;;;;;;;;AAIOhB,gBAAAA,O,SAAAA,O;AACTiC,gBAAAA,I,GAAO,KAAKC,UAAL,CAAgBlC,OAAhB,KAA4B,KAAKkC,UAAL,CAAgBlC,OAAhB,EAAyBiC,I;AAC1DE,gBAAAA,Q,GACJ,KAAKD,UAAL,CAAgBlC,OAAhB,KAA4B,KAAKkC,UAAL,CAAgBlC,OAAhB,EAAyBmC,Q;;sBACnD,yBAAQF,IAAR,KAAiB,CAACjC,O;;;;;;;;AAGtB,oBAAImC,QAAQ,IAAIA,QAAQ,CAACC,MAAT,GAAkB,CAAlC,EAAqC;AACnCD,kBAAAA,QAAQ,CAAC5B,OAAT,CAAiB,UAAC8B,OAAD,EAAa;AAC5B,wBAAI,CAACA,OAAO,CAACC,SAAb,EAAwB;AACtB;AACD;;AACDL,oBAAAA,IAAI,GAAGA,IAAI,CAACM,OAAL,CACLF,OAAO,CAACA,OADH,uBAESA,OAAO,CAACC,SAFjB,OAAP;AAID,mBARD;AASD;;AACKE,gBAAAA,M,aAAY3B,IAAI,CAACC,GAAL,E;AACZ2B,gBAAAA,U,GAAa;AACjBtC,kBAAAA,EAAE,EAAEqC,MADa;AAEjBxC,kBAAAA,OAAO,EAAPA,OAFiB;AAGjBK,kBAAAA,SAAS,EAAE,KAAK3C,KAAL,CAAW4C,OAHL;AAIjBoC,kBAAAA,UAAU,EAAEC,eAAOC,QAJF;AAKjBC,kBAAAA,YAAY,YAAK,IAAIhC,IAAJ,CAASA,IAAI,CAACC,GAAL,EAAT,CAAL,CALK;AAMjBmB,kBAAAA,IAAI,EAAJA,IANiB;AAOjBpD,kBAAAA,IAAI,EAAE;AAPW,iB;;AAUjB,qBAAKL,KAAL,CAAWI,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiByF,MADL;AAElB9C,kBAAAA,OAAO,EAAPA,OAFkB;AAGlBC,kBAAAA,MAAM,EAAEwC;AAHU,iBAApB;AAKA,qBAAKM,eAAL,CAAqB;AAAEd,kBAAAA,IAAI,EAAE,EAAR;AAAYjC,kBAAAA,OAAO,EAAPA,OAAZ;AAAqBmC,kBAAAA,QAAQ,EAAE;AAA/B,iBAArB;;uBACqB,KAAK5E,OAAL,CAAa4D,IAAb,GAAoBC,MAApB,CAA2BpB,OAA3B,EAAoCqB,KAApC,GAA4CxB,IAA5C,CAAiD;AACpEoC,kBAAAA,IAAI,EAAJA;AADoE,iBAAjD,C;;;AAAfhC,gBAAAA,M;AAGN,qBAAKzB,KAAL,CAAWI,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB0C,aADL;AAElBC,kBAAAA,OAAO,EAAPA,OAFkB;AAGlBC,kBAAAA,MAAM,EAANA,MAHkB;AAIlBC,kBAAAA,WAAW,EAAEsC;AAJK,iBAApB;;;;;;;AAOAC,gBAAAA,UAAU,CAACC,UAAX,GAAwBC,eAAOK,WAA/B;AACA,qBAAKxE,KAAL,CAAWI,QAAX,CAAoB;AAClBC,kBAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB2F,WADL;AAElB/C,kBAAAA,MAAM,EAAEwC,UAFU;AAGlBzC,kBAAAA,OAAO,EAAPA,OAHkB;AAIlBE,kBAAAA,WAAW,EAAEsC;AAJK,iBAApB;AAMA,qBAAKO,eAAL,CAAqB;AAAEd,kBAAAA,IAAI,EAAJA,IAAF;AAAQjC,kBAAAA,OAAO,EAAPA,OAAR;AAAiBmC,kBAAAA,QAAQ,EAARA;AAAjB,iBAArB;;;;;;;;;;;;;;;;;;;;;;;;;AAKac,gBAAAA,Q,SAAAA,Q,EAAUjD,O,SAAAA,O,EAASkD,O,SAAAA,O;;AAE1BC,gBAAAA,Q,GAAW,KAAK5F,OAAL,CAAa6F,OAAb,CAAqBD,QAArB,E;AACXxD,gBAAAA,I,GAAOuD,O;;uBACUC,QAAQ,CAACtD,IAAT,CACrB,0BADqB,EAErBF,IAFqB,EAGrB;AAAEK,kBAAAA,OAAO,EAAPA,OAAF;AAAWqD,kBAAAA,IAAI,EAAEJ;AAAjB,iBAHqB,EAIrB;AACEK,kBAAAA,OAAO,EAAE;AACP,oCAAgB;AADT;AADX,iBAJqB,C;;;AAAjB/B,gBAAAA,Q;kDAUCA,QAAQ,CAACgC,IAAT,E;;;;;AAEPC,gBAAAA,OAAO,CAACC,KAAR;;;kDAEK,I;;;;;;;;;;;;;;;;;;mCAIMzD,O,EAAS0D,I,EAAM;AAC5B,WAAKlF,KAAL,CAAWI,QAAX,CAAoB;AAClBC,QAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiBsG,cADL;AAElB3D,QAAAA,OAAO,EAAPA,OAFkB;AAGlB0D,QAAAA,IAAI,EAAJA;AAHkB,OAApB;AAKD;;;2CAG4C;AAAA,UAA3BzB,IAA2B,SAA3BA,IAA2B;AAAA,UAArBjC,OAAqB,SAArBA,OAAqB;AAAA,UAAZmC,QAAY,SAAZA,QAAY;AAC3C,WAAK3D,KAAL,CAAWI,QAAX,CAAoB;AAClBC,QAAAA,IAAI,EAAE,KAAKxB,WAAL,CAAiB0F,eADL;AAElB/C,QAAAA,OAAO,EAAPA,OAFkB;AAGlBmC,QAAAA,QAAQ,EAARA,QAHkB;AAIlByB,QAAAA,SAAS,EAAE3B;AAJO,OAApB;AAMD;;;wBAEc;AACb,aAAO,KAAK4B,KAAL,CAAWC,cAAlB;AACD;;;wBAEY;AACX,aAAO,KAAKD,KAAL,CAAWlB,MAAlB;AACD;;;wBAEW;AACV,aAAO,KAAKA,MAAL,KAAgBoB,2BAAezE,KAAtC;AACD;;;wBAEgB;AACf,aAAO,KAAKuE,KAAL,CAAW3B,UAAlB;AACD;;;wBAEiB;AAChB,aAAO,KAAKlE,QAAL,CAAcgG,OAAd,CAAsB,KAAK/F,mBAA3B,CAAP;AACD;;;wBAEe;AACd,aAAO,KAAK4F,KAAL,CAAW9B,SAAlB;AACD;;;wBAEkB;AACjB,aAAO,KAAK8B,KAAL,CAAWI,UAAlB;AACD;;;wBAEoB;AAAA;;AACnB,aAAO,CAAC,2BAAC,KAAKtG,kBAAL,CAAwBuG,QAAzB,oFAAC,sBAAkCC,IAAnC,2DAAC,uBAAwCC,SAAzC,CAAR;AACD;;;;EAtToCC,qB,+DA2HpCC,mB,oJAUAA,mB,uJAuCAA,mB,mJAUAA,mB,+IAyDAA,mB,uJAsBAA,mB,8JASAA,mB","sourcesContent":["import { Module } from '../../lib/di';\nimport RcModule from '../../lib/RcModule';\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport ensureExist from '../../lib/ensureExist';\nimport isBlank from '../../lib/isBlank';\nimport proxify from '../../lib/proxy/proxify';\n\nimport { actionTypes } from './actionTypes';\nimport getReducer, { getGlipPostsReadTimeReducer } from './getReducer';\nimport { status } from './status';\n\nconst glipPostsRegExp = /glip\\/posts$/;\nconst glipGroupRegExp = /glip\\/groups$/;\n\nconst subscriptionFilter = '/restapi/v1.0/glip/posts';\n\nconst DEFAULT_LOAD_TTL = 30 * 60 * 1000;\n\n@Module({\n  deps: [\n    'Client',\n    'Auth',\n    'Subscription',\n    'Storage',\n    'ExtensionFeatures',\n    { dep: 'GlipPostsOptions', optional: true },\n  ],\n})\nexport default class GlipPosts extends RcModule {\n  constructor({\n    client,\n    auth,\n    subscription,\n    storage,\n    extensionFeatures,\n    loadTtl = DEFAULT_LOAD_TTL,\n    ...options\n  }) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._reducer = getReducer(this.actionTypes);\n\n    this._client = ensureExist.call(this, client, 'client');\n    this._auth = ensureExist.call(this, auth, 'auth');\n    this._extensionFeatures = extensionFeatures;\n    this._subscription = ensureExist.call(this, subscription, 'subscription');\n    this._fetchPromises = {};\n    this._lastMessage = null;\n    this._loadTtl = loadTtl;\n\n    this._storage = storage;\n    this._readTimeStorageKey = 'glipPostReadTime';\n    this._storage.registerReducer({\n      key: this._readTimeStorageKey,\n      reducer: getGlipPostsReadTimeReducer(this.actionTypes),\n    });\n    this._newPostListeners = [];\n  }\n\n  addNewPostListener(listen) {\n    if (typeof listen === 'function') {\n      this._newPostListeners.push(listen);\n    }\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  async _onStateChange() {\n    if (this._shouldInit()) {\n      this.store.dispatch({\n        type: this.actionTypes.init,\n      });\n      if (!this._hasPermission) return;\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n      this._subscription.subscribe([subscriptionFilter]);\n    } else if (this._shouldReset()) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n      this._fetchPromises = {};\n    } else if (this._shouldHandleSubscriptionMessage()) {\n      this._processSubscription();\n    }\n  }\n\n  _shouldInit() {\n    return (\n      this._auth.loggedIn &&\n      this._subscription.ready &&\n      this._extensionFeatures.ready &&\n      this.pending\n    );\n  }\n\n  _shouldReset() {\n    return (\n      (!this._auth.loggedIn ||\n        !this._extensionFeatures.ready ||\n        !this._subscription.ready) &&\n      this.ready\n    );\n  }\n\n  _shouldHandleSubscriptionMessage() {\n    return !!(\n      this.ready &&\n      this._subscription &&\n      this._subscription.ready &&\n      this._subscription.message &&\n      this._subscription.message !== this._lastMessage\n    );\n  }\n\n  _processSubscription() {\n    const { message } = this._subscription;\n    this._lastMessage = message;\n    if (\n      message &&\n      (glipPostsRegExp.test(message.event) ||\n        glipGroupRegExp.test(message.event)) &&\n      message.body\n    ) {\n      const { eventType, ...post } = message.body;\n      if (eventType.indexOf('Post') !== 0) {\n        return;\n      }\n      if (eventType === 'PostRemoved') {\n        return;\n      }\n      this.store.dispatch({\n        type: this.actionTypes.createSuccess,\n        groupId: post.groupId,\n        record: post,\n        oldRecordId: post.id,\n        isSendByMe:\n          post.creatorId === this._auth.ownerId && eventType === 'PostAdded',\n      });\n      if (eventType === 'PostAdded' && post.creatorId !== this._auth.ownerId) {\n        this._newPostListeners.forEach((listen) => {\n          listen(post);\n        });\n      }\n    }\n  }\n\n  @proxify\n  async loadPosts(groupId, recordCount = 20) {\n    const lastPosts = this.postsMap[groupId];\n    const fetchTime = this.fetchTimeMap[groupId];\n    if (lastPosts && fetchTime && Date.now() - fetchTime < this._loadTtl) {\n      return;\n    }\n    await this.fetchPosts(groupId, recordCount);\n  }\n\n  @proxify\n  async fetchPosts(groupId, recordCount = 20, pageToken) {\n    if (!groupId) {\n      return;\n    }\n    if (!this._fetchPromises[groupId]) {\n      this._fetchPromises[groupId] = (async () => {\n        try {\n          this.store.dispatch({\n            type: this.actionTypes.fetch,\n          });\n          const params = { recordCount };\n          if (pageToken) {\n            params.pageToken = pageToken;\n          }\n          const response = await this._client\n            .glip()\n            .groups(groupId)\n            .posts()\n            .list(params);\n          this.store.dispatch({\n            type: this.actionTypes.fetchSuccess,\n            groupId,\n            records: response.records,\n            lastPageToken: pageToken,\n            navigation: response.navigation,\n          });\n        } catch (e) {\n          this.store.dispatch({\n            type: this.actionTypes.fetchError,\n          });\n        }\n        this._fetchPromises[groupId] = null;\n      })();\n    }\n    const promise = this._fetchPromises[groupId];\n    await promise;\n  }\n\n  @proxify\n  async loadNextPage(groupId, recordCount) {\n    const pageInfo = this.pageInfos[groupId];\n    const pageToken = pageInfo && pageInfo.prevPageToken;\n    if (!pageToken) {\n      return;\n    }\n    await this.fetchPosts(groupId, recordCount, pageToken);\n  }\n\n  @proxify\n  async create({ groupId }) {\n    let text = this.postInputs[groupId] && this.postInputs[groupId].text;\n    const mentions =\n      this.postInputs[groupId] && this.postInputs[groupId].mentions;\n    if (isBlank(text) || !groupId) {\n      return;\n    }\n    if (mentions && mentions.length > 0) {\n      mentions.forEach((mention) => {\n        if (!mention.matcherId) {\n          return;\n        }\n        text = text.replace(\n          mention.mention,\n          `![:Person](${mention.matcherId})`,\n        );\n      });\n    }\n    const fakeId = `${Date.now()}`;\n    const fakeRecord = {\n      id: fakeId,\n      groupId,\n      creatorId: this._auth.ownerId,\n      sendStatus: status.creating,\n      creationTime: `${new Date(Date.now())}`,\n      text,\n      type: 'TextMessage',\n    };\n    try {\n      this.store.dispatch({\n        type: this.actionTypes.create,\n        groupId,\n        record: fakeRecord,\n      });\n      this.updatePostInput({ text: '', groupId, mentions: [] });\n      const record = await this._client.glip().groups(groupId).posts().post({\n        text,\n      });\n      this.store.dispatch({\n        type: this.actionTypes.createSuccess,\n        groupId,\n        record,\n        oldRecordId: fakeId,\n      });\n    } catch (e) {\n      fakeRecord.sendStatus = status.createError;\n      this.store.dispatch({\n        type: this.actionTypes.createError,\n        record: fakeRecord,\n        groupId,\n        oldRecordId: fakeId,\n      });\n      this.updatePostInput({ text, groupId, mentions });\n    }\n  }\n\n  @proxify\n  async sendFile({ fileName, groupId, rawFile }) {\n    try {\n      const platform = this._client.service.platform();\n      const body = rawFile;\n      const response = await platform.post(\n        '/restapi/v1.0/glip/files',\n        body,\n        { groupId, name: fileName },\n        {\n          headers: {\n            'Content-Type': 'application/octet-stream',\n          },\n        },\n      );\n      return response.json();\n    } catch (e) {\n      console.error(e);\n    }\n    return null;\n  }\n\n  @proxify\n  updateReadTime(groupId, time) {\n    this.store.dispatch({\n      type: this.actionTypes.updateReadTime,\n      groupId,\n      time,\n    });\n  }\n\n  @proxify\n  updatePostInput({ text, groupId, mentions }) {\n    this.store.dispatch({\n      type: this.actionTypes.updatePostInput,\n      groupId,\n      mentions,\n      textValue: text,\n    });\n  }\n\n  get postsMap() {\n    return this.state.glipPostsStore;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.status === moduleStatuses.ready;\n  }\n\n  get postInputs() {\n    return this.state.postInputs;\n  }\n\n  get readTimeMap() {\n    return this._storage.getItem(this._readTimeStorageKey);\n  }\n\n  get pageInfos() {\n    return this.state.pageInfos;\n  }\n\n  get fetchTimeMap() {\n    return this.state.fetchTimes;\n  }\n\n  get _hasPermission() {\n    return !!this._extensionFeatures.features?.Glip?.available;\n  }\n}\n"],"file":"index.js"}
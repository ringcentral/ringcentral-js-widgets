{"version":3,"sources":["modules/RecentCalls/index.js"],"names":["RecentCalls","deps","client","callHistory","options","actionTypes","_client","ensureExist","_callHistory","_reducer","store","subscribe","_onStateChange","pending","ready","dispatch","type","initSuccess","resetSuccess","currentContact","sessionId","contactId","String","id","calls","initLoad","_getRecentCalls","loadSuccess","contact","loadReset","daySpan","length","dateFrom","recentCalls","_getLocalRecentCalls","_fetchRemoteRecentCalls","toISOString","sort","_sortByTime","_dedup","slice","phoneNumbers","reduce","acc","call","to","from","matches","find","_filterPhoneNumber","Date","startTime","concat","phoneNumber","extensionNumber","params","perPage","recentCallsPromises","phoneType","replace","promise","_fetchCallLogList","Object","assign","then","_flattenToRecords","account","extension","callLog","list","items","records","a","b","hash","cur","state","callStatus","loaded","status","RcModule","background"],"mappings":"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","sourcesContent":["import background from '../../lib/background';\nimport RcModule from '../../lib/RcModule';\nimport { Module } from '../../lib/di';\nimport actionTypes from './actionTypes';\nimport callStatus from './callStatus';\nimport getRecentCallsReducer from './getRecentCallsReducer';\nimport getDateFrom from '../../lib/getDateFrom';\nimport ensureExist from '../../lib/ensureExist';\nimport concurrentExecute from '../../lib/concurrentExecute';\n\n/**\n * @class\n * @description Retrieve all recent calls related to a specified contact.\n */\n@Module({\n  deps: ['Client', 'CallHistory'],\n})\nexport default class RecentCalls extends RcModule {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {CallHistory} params.callHistory - callHistory module instance\n   * @param {Client} params.client - client module instance\n   */\n  constructor({ client, callHistory, ...options }) {\n    super({\n      actionTypes,\n      ...options,\n    });\n    this._client = this::ensureExist(client, 'client');\n    this._callHistory = this::ensureExist(callHistory, 'callHistory');\n    this._reducer = getRecentCallsReducer(this.actionTypes);\n  }\n\n  initialize() {\n    this.store.subscribe(() => this._onStateChange());\n  }\n\n  _onStateChange() {\n    if (this.pending && this._callHistory.ready) {\n      this.store.dispatch({\n        type: this.actionTypes.initSuccess,\n      });\n    } else if (this.ready && !this._callHistory.ready) {\n      this.store.dispatch({\n        type: this.actionTypes.resetSuccess,\n      });\n    }\n  }\n\n  get calls() {\n    return this.state.calls;\n  }\n\n  get isCallsLoaded() {\n    return this.state.callStatus === callStatus.loaded;\n  }\n\n  @background\n  async getCalls({ currentContact, sessionId = null }) {\n    // No need to calculate recent calls of the same contact repeatly\n    if (!currentContact) {\n      return;\n    }\n    const contactId = String(currentContact && currentContact.id);\n    // if (this.calls[currentContact.id]) {\n    if (this.calls[sessionId ? `${contactId}-${sessionId}` : contactId]) {\n      return;\n    }\n    this.store.dispatch({\n      type: this.actionTypes.initLoad,\n    });\n    const calls = await this._getRecentCalls(\n      currentContact,\n      this._callHistory.calls,\n    );\n    this.store.dispatch({\n      type: this.actionTypes.loadSuccess,\n      calls,\n      contact: currentContact,\n      sessionId,\n    });\n  }\n\n  cleanUpCalls({ contact, sessionId = null }) {\n    this.store.dispatch({\n      type: this.actionTypes.loadReset,\n      contact,\n      sessionId,\n    });\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  /**\n   * Searching for recent calls of specific contact.\n   * @param {Object} currentContact Current contact\n   * @param {Array} calls Calls in callHistory\n   * @param {Number} daySpan Find calls within certain days\n   * @param {Number} length Maximum length of recent calls\n   * @return {Array}\n   * @private\n   */\n  async _getRecentCalls(currentContact, calls = [], daySpan = 60, length = 5) {\n    const dateFrom = getDateFrom(daySpan);\n    let recentCalls = this._getLocalRecentCalls(\n      currentContact,\n      calls,\n      dateFrom,\n    );\n\n    // If we could not find enough recent calls,\n    // we need to search for calls on server.\n    if (recentCalls.length < length) {\n      recentCalls = await this._fetchRemoteRecentCalls(\n        currentContact,\n        dateFrom.toISOString(),\n        length,\n      );\n    }\n\n    recentCalls.sort(this._sortByTime);\n    recentCalls = this._dedup(recentCalls);\n    return recentCalls.length > length\n      ? recentCalls.slice(0, length)\n      : recentCalls;\n  }\n\n  /**\n   * Get recent calls from callHistory.\n   * @param {Object} currentContact\n   * @param {Array} calls\n   * @param {Date} dateFrom\n   */\n  _getLocalRecentCalls({ phoneNumbers }, calls, dateFrom) {\n    // Get all calls related to this contact\n    return calls.reduce((acc, call) => {\n      if (call && call.to && call.from) {\n        const matches = phoneNumbers.find(this._filterPhoneNumber(call));\n\n        // Check if calls is within certain days\n        if (!!matches && new Date(call.startTime) > dateFrom) {\n          return acc.concat(call);\n        }\n      }\n      return acc;\n    }, []);\n  }\n\n  _filterPhoneNumber(call) {\n    return ({ phoneNumber }) =>\n      phoneNumber === call.from.phoneNumber ||\n      phoneNumber === call.to.phoneNumber ||\n      phoneNumber === call.from.extensionNumber ||\n      phoneNumber === call.to.extensionNumber;\n  }\n\n  /**\n   * Fetch recent calls from server by given current contact.\n   * @param {Object} currentContact\n   * @param {String} dateFrom\n   * @param {String} dateTo\n   * @param {Number} length The number of calls\n   * @return {Array}\n   */\n  _fetchRemoteRecentCalls({ phoneNumbers }, dateFrom, length) {\n    const params = {\n      dateFrom,\n      perPage: length,\n      type: 'Voice',\n    };\n\n    // CallLog API doesn't support plus sign in phoneNumber\n    const recentCallsPromises = phoneNumbers.reduce(\n      (acc, { phoneType, phoneNumber }) => {\n        phoneNumber = phoneNumber.replace('+', '');\n        if (phoneType === 'extension') {\n          const promise = this._fetchCallLogList(\n            Object.assign({}, params, {\n              extensionNumber: phoneNumber,\n            }),\n          );\n          return acc.concat(promise);\n        }\n        const promise = this._fetchCallLogList(\n          Object.assign({}, params, {\n            phoneNumber,\n          }),\n        );\n        return acc.concat(promise);\n      },\n      [],\n    );\n\n    return concurrentExecute(recentCallsPromises, 5, 500).then(\n      this._flattenToRecords,\n    );\n  }\n\n  _fetchCallLogList(params) {\n    return () =>\n      this._client\n        .account()\n        .extension()\n        .callLog()\n        .list(params);\n  }\n\n  _flattenToRecords(items) {\n    return items.reduce((acc, { records }) => acc.concat(records), []);\n  }\n\n  // Sort by time in descending order\n  _sortByTime(a, b) {\n    return new Date(b.startTime) - new Date(a.startTime);\n  }\n\n  _dedup(calls) {\n    const hash = {};\n    return calls.reduce((acc, cur) => {\n      if (hash[cur.id]) return acc;\n      hash[cur.id] = true;\n      return acc.concat(cur);\n    }, []);\n  }\n}\n"],"file":"index.js"}
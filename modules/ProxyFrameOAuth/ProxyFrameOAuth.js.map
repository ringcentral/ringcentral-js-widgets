{"version":3,"sources":["modules/ProxyFrameOAuth/ProxyFrameOAuth.ts"],"names":["DEFAULT_PROXY_RETRY","ProxyFrameOAuth","name","deps","dep","optional","oAuthOptions","loginPath","redirectUri","proxyUri","defaultProxyRetry","restOAuthOptions","_retryTimeoutId","_implicitRefreshTimeoutId","_uuid","uuid","v4","_proxyFrame","_implicitRefreshFrame","_loggedIn","_callbackHandler","origin","data","callbackUri","proxyLoaded","_handleCallbackUri","clearTimeout","setOAuthReady","_createProxyFrame","document","createElement","src","style","display","isEdge","window","navigator","userAgent","indexOf","isIE","test","setAttribute","join","body","appendChild","addEventListener","setTimeout","_retrySetupProxyFrame","_deps","_implicitRefreshCallBack","refreshCallbackUri","auth","loggedIn","_clearImplicitRefreshIframe","ready","routerInteraction","currentPath","oAuthReady","atLoginPage","setupOAuth","destroyOAuth","isImplicit","_createImplicitRefreshTimeout","multiple","refresh","val","proxyRetryCount","setProxyRetryCount","_destroyProxyFrame","removeChild","removeEventListener","client","service","platform","discovery","loginUrlWithDiscovery","contentWindow","postMessage","oAuthUri","implicitRefreshOAuthUri","authData","token","refreshTokenExpiresIn","expiresIn","expireTime","refreshTokenTimeoutTime","parseInt","Date","now","tabManager","active","_createImplicitRefreshIframe","prefix","encodeURIComponent","url","resolve","location","href","hash","btoa","OAuthBase","state","action","background","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAMA,mBAAmB,GAAG,IAA5B;IAeaC,e,WARZ,gBAAO;AACNC,EAAAA,IAAI,EAAE,OADA;AAENC,EAAAA,IAAI,EAAE,CACJ,QADI,EAEJ,mBAFI,EAGJ;AAAEC,IAAAA,GAAG,EAAE,cAAP;AAAuBC,IAAAA,QAAQ,EAAE;AAAjC,GAHI;AAFA,CAAP,C;;;;;AAiBC,iCASM;AAAA;;AAAA,iCARJC,YAQI;AAAA,uDAFA,EAEA;;AAAA,kDAPFC,SAOE;AAAA,QAPFA,SAOE,sCAPU,GAOV;AAAA,kDANFC,WAME;AAAA,QANFA,WAME,sCANY,iBAMZ;AAAA,kDALFC,QAKE;AAAA,QALFA,QAKE,sCALS,cAKT;AAAA,kDAJFC,iBAIE;AAAA,QAJFA,iBAIE,sCAJkBV,mBAIlB;AAAA,QAHCW,gBAGD;AAAA,QADDR,IACC;;AAAA;;AACJ,8DACKA,IADL;AAEEG,MAAAA,YAAY;AACVC,QAAAA,SAAS,EAATA,SADU;AAEVC,QAAAA,WAAW,EAAXA,WAFU;AAGVC,QAAAA,QAAQ,EAARA,QAHU;AAIVC,QAAAA,iBAAiB,EAAjBA;AAJU,SAKPC,gBALO;AAFd;AADI,UAjBEC,eAiBF,GAjBmD,IAiBnD;AAAA,UAhBEC,yBAgBF,GAhB6D,IAgB7D;AAAA,UAdEC,KAcF,GAdUC,IAAI,CAACC,EAAL,EAcV;AAAA,UAbEC,WAaF;AAAA,UAZEC,qBAYF;AAAA,UAXIC,SAWJ,GAXgB,KAWhB;;AAAA;;AAAA,UA6GEC,gBA7GF;AAAA,0EA6GqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAASC,gBAAAA,MAAT,SAASA,MAAT,EAAiBC,IAAjB,SAAiBA,IAAjB;;AAAA,oBAEpBA,IAFoB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAIjBC,gBAAAA,WAJiB,GAIYD,IAJZ,CAIjBC,WAJiB,EAIJC,WAJI,GAIYF,IAJZ,CAIJE,WAJI;;AAKzB,oBAAID,WAAJ,EAAiB;AACf,wBAAKE,kBAAL,CAAwBF,WAAxB;AACD,iBAFD,MAEO,IAAIC,WAAJ,EAAiB;AACtBE,kBAAAA,YAAY,CAAC,MAAKd,eAAN,CAAZ;AACA,wBAAKA,eAAL,GAAuB,IAAvB;;AAEA,wBAAKe,aAAL,CAAmB,IAAnB;AACD;;AAZwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OA7GrB;;AAAA;AAAA;AAAA;AAAA;;AAAA,UA4HEC,iBA5HF,GA4HsB,YAAM;AAAA;;AAChC,YAAKX,WAAL,GAAmBY,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAnB;AACA,YAAKb,WAAL,CAAiBc,GAAjB,GAAuB,MAAKtB,QAA5B;AACA,YAAKQ,WAAL,CAAiBe,KAAjB,CAAuBC,OAAvB,GAAiC,MAAjC;AACA,UAAMC,MAAM,GACVC,MAAM,IACNA,MAAM,CAACC,SADP,IAEAD,MAAM,CAACC,SAAP,CAAiBC,SAAjB,CAA2BC,OAA3B,CAAmC,MAAnC,IAA6C,CAAC,CAHhD;AAIA,UAAMC,IAAI,GACRJ,MAAM,IACNA,MAAM,CAACC,SADP,IAEA,gBAAgBI,IAAhB,CAAqBL,MAAM,CAACC,SAAP,CAAiBC,SAAtC,CAHF;;AAIA,UAAI,CAACH,MAAD,IAAW,CAACK,IAAhB,EAAsB;AACpB,cAAKtB,WAAL,CAAiBwB,YAAjB,CACE,SADF,EAEE,CACE,eADF,EAEE,cAFF,EAGE,mBAHF,EAIE,aAJF,EAKEC,IALF,CAKO,GALP,CAFF;AASD;;AACDb,MAAAA,QAAQ,CAACc,IAAT,CAAcC,WAAd,CAA0B,MAAK3B,WAA/B;AAEAkB,MAAAA,MAAM,CAACU,gBAAP,CAAwB,SAAxB,EAAmC,MAAKzB,gBAAxC;AAEA,YAAKR,eAAL,GAAuBkC,UAAU,CAAC,YAAM;AACtC,cAAKC,qBAAL;AACD,OAFgC,2BAE9B,MAAKC,KAAL,CAAW1C,YAFmB,0DAE9B,sBAAyBI,iBAFK,CAAjC;AAGD,KA1JK;;AAAA,UAgNEuC,wBAhNF,GAgN6B,iBAA8B;AAAA,UAA3B3B,IAA2B,SAA3BA,IAA2B;AAAA,UACvD4B,kBADuD,GAChC5B,IADgC,CACvD4B,kBADuD;;AAE/D,UAAIA,kBAAkB,IAAI,MAAKF,KAAL,CAAWG,IAAX,CAAgBC,QAA1C,EAAoD;AAClD,cAAK3B,kBAAL,CAAwByB,kBAAxB,EAA4C,IAA5C;;AACA,cAAKG,2BAAL;AACD;AACF,KAtNK;;AAAA;AAWL;;;;iCAEY;AAAA;;AACX;AAEA,uBACE,IADF,EAEE;AAAA;;AAAA,eAAM,CACJ,MAAI,CAACC,KADD,EAEJ,MAAI,CAACN,KAAL,CAAWG,IAAX,CAAgBC,QAFZ,EAGJ,MAAI,CAACJ,KAAL,CAAWO,iBAAX,CAA6BC,WAHzB,2BAIJ,MAAI,CAACR,KAAL,CAAW1C,YAJP,0DAIJ,sBAAyBC,SAJrB,EAKJ,MAAI,CAACkD,UALD,EAMJ,MAAI,CAACxC,WAND,CAAN;AAAA,OAFF,EAUE,YAAM;AAAA;;AACJ,YAAMyC,WAAW,GACf,MAAI,CAACV,KAAL,CAAWO,iBAAX,CAA6BC,WAA7B,gCACA,MAAI,CAACR,KAAL,CAAW1C,YADX,2DACA,uBAAyBC,SADzB,CADF;;AAIA,YACE,MAAI,CAAC+C,KAAL,IACA,CAAC,MAAI,CAACN,KAAL,CAAWG,IAAX,CAAgBC,QADjB,IAEAM,WAFA,IAGA,CAAC,MAAI,CAACD,UAHN,IAIA,CAAC,MAAI,CAACxC,WALR,EAME;AACA,UAAA,MAAI,CAAC0C,UAAL;AACD,SARD,MAQO,IACL,MAAI,CAAC1C,WAAL,KACC,MAAI,CAAC+B,KAAL,CAAWG,IAAX,CAAgBC,QAAhB,IAA4B,CAACM,WAD9B,CADK,EAGL;AACA,UAAA,MAAI,CAACE,YAAL;AACD;;AAED,YAAI,MAAI,CAACZ,KAAL,CAAWG,IAAX,CAAgBC,QAAhB,KAA6B,MAAI,CAACjC,SAAtC,EAAiD;AAEjD,QAAA,MAAI,CAACA,SAAL,GAAiB,MAAI,CAAC6B,KAAL,CAAWG,IAAX,CAAgBC,QAAjC;;AAEA,YAAI,MAAI,CAACJ,KAAL,CAAWG,IAAX,CAAgBU,UAApB,EAAgC;AAC9B,cAAI,MAAI,CAAC1C,SAAT,EAAoB;AAClB,YAAA,MAAI,CAAC2C,6BAAL;AACD,WAFD,MAEO,IAAI,CAAC,MAAI,CAAC3C,SAAV,EAAqB;AAC1B,YAAA,MAAI,CAACkC,2BAAL;;AAEA,gBAAI,MAAI,CAACxC,yBAAT,EAAoC;AAClCa,cAAAA,YAAY,CAAC,MAAI,CAACb,yBAAN,CAAZ;AACD;AACF;AACF;AACF,OA7CH,EA8CE;AAAEkD,QAAAA,QAAQ,EAAE;AAAZ,OA9CF;AAgDD;;;;0GAEwBxC,W;;;;;;;AAAqByC,gBAAAA,O,8DAAU,K;;+GACvBzC,W,EAAayC,O;;;AAE5C,oBAAI,KAAKhB,KAAL,CAAWG,IAAX,CAAgBU,UAAhB,IAA8B,KAAKb,KAAL,CAAWG,IAAX,CAAgBC,QAAlD,EAA4D;AAC1D,uBAAKU,6BAAL;AACD;;;;;;;;;;;;;;;;;;uCA4BgBG,G,EAAa;AAC9B,WAAKC,eAAL,GAAuBD,GAAvB;AACD;;;kCAGaA,G,EAAc;AAC1B,yFAAoBA,GAApB;;AACA,WAAKE,kBAAL,CAAwB,CAAxB;AACD;;;4CAiD+B;AAC9B,WAAKvD,eAAL,GAAuB,IAAvB;AACA,UAAI,KAAK6C,UAAT,EAAqB;AAErB,WAAKU,kBAAL,CAAwB,KAAKD,eAAL,GAAuB,CAA/C;;AACA,WAAKE,kBAAL;;AACA,WAAKxC,iBAAL;AACD;;;yCAE4B;AAC3BC,MAAAA,QAAQ,CAACc,IAAT,CAAc0B,WAAd,CAA0B,KAAKpD,WAA/B;AACA,WAAKA,WAAL,GAAmB,IAAnB;AACAkB,MAAAA,MAAM,CAACmC,mBAAP,CAA2B,SAA3B,EAAsC,KAAKlD,gBAA3C;AACD;;;;;;;;;qBAIK,KAAKH,W;;;;;;;;AAET,qBAAKW,iBAAL;;AACA,qBAAKuC,kBAAL,CAAwB,CAAxB;;;;;;;;;;;;;;;;;;;;;;;;oBAKK,KAAKlD,W;;;;;;;;AAEV,oBAAI,KAAKL,eAAT,EAA0B;AACxBc,kBAAAA,YAAY,CAAC,KAAKd,eAAN,CAAZ;AACA,uBAAKA,eAAL,GAAuB,IAAvB;AACD;;AAED,qBAAKwD,kBAAL;;AACA,qBAAKzC,aAAL,CAAmB,KAAnB;;;;;;;;;;;;;;;;;;;;;;;;oBAKK,KAAK8B,U;;;;;;;;qBAEN,KAAKT,KAAL,CAAWuB,MAAX,CAAkBC,OAAlB,CAA0BC,QAA1B,GAAqCC,SAArC,E;;;;;;uBACI,KAAK1B,KAAL,CAAWuB,MAAX,CAAkBC,OAAlB,CAA0BC,QAA1B,GAAqCE,qBAArC,E;;;AAGR,qBAAK1D,WAAL,CAAiB2D,aAAjB,CAA+BC,WAA/B,CACE;AACEC,kBAAAA,QAAQ,EAAE,KAAKA;AADjB,iBADF,EAIE,GAJF;;;;;;;;;;;;;;;;;;mDAgBqC;AACrC,WAAKzB,2BAAL;;AACA,WAAKnC,qBAAL,GAA6BW,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAA7B;AACA,WAAKZ,qBAAL,CAA2Ba,GAA3B,GAAiC,KAAKgD,uBAAtC;AACA,WAAK7D,qBAAL,CAA2Bc,KAA3B,CAAiCC,OAAjC,GAA2C,MAA3C;AACAJ,MAAAA,QAAQ,CAACc,IAAT,CAAcC,WAAd,CAA0B,KAAK1B,qBAA/B,EALqC,CAMrC;;AAEAiB,MAAAA,MAAM,CAACU,gBAAP,CAAwB,SAAxB,EAAmC,KAAKI,wBAAxC;AACD;;;kDAEqC;AACpC,UAAI,CAAC,KAAK/B,qBAAV,EAAiC;AAEjCW,MAAAA,QAAQ,CAACc,IAAT,CAAc0B,WAAd,CAA0B,KAAKnD,qBAA/B;AACA,WAAKA,qBAAL,GAA6B,IAA7B;AACAiB,MAAAA,MAAM,CAACmC,mBAAP,CAA2B,SAA3B,EAAsC,KAAKrB,wBAA3C;AACA,WAAK7B,gBAAL,GAAwB,IAAxB;AACD,K,CAED;;;;oDACwC;AAAA;;AACtC,UAAI,KAAKP,yBAAT,EAAoC;AAClCa,QAAAA,YAAY,CAAC,KAAKb,yBAAN,CAAZ;AACD;;AACD,UAAMmE,QAAQ,GAAG,KAAKhC,KAAL,CAAWG,IAAX,CAAgB8B,KAAjC;AACA,UAAMC,qBAAqB,GAAGF,QAAQ,CAACG,SAAvC;AALsC,UAM9BC,UAN8B,GAMfJ,QANe,CAM9BI,UAN8B;AAQtC,UAAI,CAACF,qBAAD,IAA0B,CAACE,UAA/B,EAA2C,OARL,CAUtC;;AACA,UAAIC,uBAAuB,GACxBC,QAAQ,WAAIJ,qBAAJ,GAA6B,EAA7B,CAAR,GAA2C,IAA5C,GAAoD,CADtD;;AAGA,UAAIG,uBAAuB,GAAGE,IAAI,CAACC,GAAL,EAA1B,GAAuCJ,UAA3C,EAAuD;AACrDC,QAAAA,uBAAuB,GAAGD,UAAU,GAAGG,IAAI,CAACC,GAAL,EAAb,GAA0B,IAApD;AACA,YAAIH,uBAAuB,GAAG,CAA9B,EAAiC;AAClC;;AAED,WAAKxE,yBAAL,GAAiCiC,UAAU,CAAC,YAAM;AAAA;;AAChD,YAAI,CAAC,MAAI,CAACE,KAAL,CAAWG,IAAX,CAAgBC,QAArB,EAA+B;;AAE/B,YAAI,2BAAC,MAAI,CAACJ,KAAL,CAAWyC,UAAZ,0DAAC,sBAAuBC,MAAxB,CAAJ,EAAoC;AAClC,UAAA,MAAI,CAAC5B,6BAAL;;AACA;AACD;;AAED,QAAA,MAAI,CAAC6B,4BAAL;;AACA,QAAA,MAAI,CAAC9E,yBAAL,GAAiC,IAAjC;AACD,OAV0C,EAUxCwE,uBAVwC,CAA3C;AAWD;;;wBAjMU;AACT,aAAO,iBAAP;AACD;;;wBAEY;AAAA;;AACX,uCAAO,KAAKrC,KAAL,CAAW1C,YAAlB,2DAAO,uBAAyBsF,MAAhC;AACD;;;wBAEc;AAAA;;AACb,UAAMA,MAAM,GAAGC,kBAAkB,CAAC,KAAKD,MAAN,CAAjC;;AAEA,UAAMnF,QAAQ,GAAGqF,gBAAIC,OAAJ,CACf5D,MAAM,CAAC6D,QAAP,CAAgBC,IADD,4BAEf,KAAKjD,KAAL,CAAW1C,YAFI,2DAEf,uBAAyBG,QAFV,CAAjB;;AAKA,UAAMyF,IAAI,GAAGL,kBAAkB,CAACM,IAAI,CAAC,KAAKrF,KAAN,CAAL,CAA/B;AAEA,uBAAUL,QAAV,mBAA2ByF,IAA3B,qBAA0CN,MAA1C;AACD;;;;EA/GyDQ,qB,mFAiHzDC,W;;;;;WACyB,C;;wEAEzBC,Y,gKAKAA,Y,wJAoEAC,sB,uJAQAA,sB,0JAaAC,mB","sourcesContent":["import url from 'url';\nimport * as uuid from 'uuid';\n\nimport background from '@ringcentral-integration/commons/lib/background';\nimport { Module } from '@ringcentral-integration/commons/lib/di';\nimport proxify from '@ringcentral-integration/commons/lib/proxy/proxify';\nimport { action, state, watch } from '@ringcentral-integration/core';\n\nimport { OAuthBase } from '../../lib/OAuthBase';\nimport { Deps } from './ProxyFrameOAuth.interface';\n\nconst DEFAULT_PROXY_RETRY = 5000;\n\ntype CallbackParams = {\n  origin: string;\n  data: any;\n};\n\n@Module({\n  name: 'OAuth',\n  deps: [\n    'Client',\n    'RouterInteraction',\n    { dep: 'OAuthOptions', optional: true },\n  ],\n})\nexport class ProxyFrameOAuth<T extends Deps = Deps> extends OAuthBase<T> {\n  private _retryTimeoutId: ReturnType<typeof setTimeout> = null;\n  private _implicitRefreshTimeoutId: ReturnType<typeof setTimeout> = null;\n\n  private _uuid = uuid.v4();\n  private _proxyFrame: HTMLIFrameElement;\n  private _implicitRefreshFrame: HTMLIFrameElement;\n  protected _loggedIn = false;\n\n  constructor({\n    oAuthOptions: {\n      loginPath = '/',\n      redirectUri = './redirect.html',\n      proxyUri = './proxy.html',\n      defaultProxyRetry = DEFAULT_PROXY_RETRY,\n      ...restOAuthOptions\n    } = {},\n    ...deps\n  }: T) {\n    super({\n      ...deps,\n      oAuthOptions: {\n        loginPath,\n        redirectUri,\n        proxyUri,\n        defaultProxyRetry,\n        ...restOAuthOptions,\n      },\n    } as T);\n  }\n\n  onInitOnce() {\n    super.onInitOnce && super.onInitOnce();\n\n    watch(\n      this,\n      () => [\n        this.ready,\n        this._deps.auth.loggedIn,\n        this._deps.routerInteraction.currentPath,\n        this._deps.oAuthOptions?.loginPath,\n        this.oAuthReady,\n        this._proxyFrame,\n      ],\n      () => {\n        const atLoginPage =\n          this._deps.routerInteraction.currentPath ===\n          this._deps.oAuthOptions?.loginPath;\n\n        if (\n          this.ready &&\n          !this._deps.auth.loggedIn &&\n          atLoginPage &&\n          !this.oAuthReady &&\n          !this._proxyFrame\n        ) {\n          this.setupOAuth();\n        } else if (\n          this._proxyFrame &&\n          (this._deps.auth.loggedIn || !atLoginPage)\n        ) {\n          this.destroyOAuth();\n        }\n\n        if (this._deps.auth.loggedIn === this._loggedIn) return;\n\n        this._loggedIn = this._deps.auth.loggedIn;\n\n        if (this._deps.auth.isImplicit) {\n          if (this._loggedIn) {\n            this._createImplicitRefreshTimeout();\n          } else if (!this._loggedIn) {\n            this._clearImplicitRefreshIframe();\n\n            if (this._implicitRefreshTimeoutId) {\n              clearTimeout(this._implicitRefreshTimeoutId);\n            }\n          }\n        }\n      },\n      { multiple: true },\n    );\n  }\n\n  async _handleCallbackUri(callbackUri: string, refresh = false) {\n    await super._handleCallbackUri(callbackUri, refresh);\n\n    if (this._deps.auth.isImplicit && this._deps.auth.loggedIn) {\n      this._createImplicitRefreshTimeout();\n    }\n  }\n\n  get name() {\n    return 'proxyFrameOAuth';\n  }\n\n  get prefix() {\n    return this._deps.oAuthOptions?.prefix;\n  }\n\n  get proxyUri() {\n    const prefix = encodeURIComponent(this.prefix);\n\n    const proxyUri = url.resolve(\n      window.location.href,\n      this._deps.oAuthOptions?.proxyUri,\n    );\n\n    const hash = encodeURIComponent(btoa(this._uuid));\n\n    return `${proxyUri}?hash=${hash}&prefix=${prefix}`;\n  }\n\n  @state\n  proxyRetryCount: number = 0;\n\n  @action\n  setProxyRetryCount(val: number) {\n    this.proxyRetryCount = val;\n  }\n\n  @action\n  setOAuthReady(val: boolean) {\n    super.setOAuthReady(val);\n    this.setProxyRetryCount(0);\n  }\n\n  private _callbackHandler = async ({ origin, data }: CallbackParams) => {\n    // TODO: origin check\n    if (!data) return;\n\n    const { callbackUri, proxyLoaded } = data;\n    if (callbackUri) {\n      this._handleCallbackUri(callbackUri);\n    } else if (proxyLoaded) {\n      clearTimeout(this._retryTimeoutId);\n      this._retryTimeoutId = null;\n\n      this.setOAuthReady(true);\n    }\n  };\n\n  private _createProxyFrame = () => {\n    this._proxyFrame = document.createElement('iframe');\n    this._proxyFrame.src = this.proxyUri;\n    this._proxyFrame.style.display = 'none';\n    const isEdge =\n      window &&\n      window.navigator &&\n      window.navigator.userAgent.indexOf('Edge') > -1;\n    const isIE =\n      window &&\n      window.navigator &&\n      /MSIE|Trident/i.test(window.navigator.userAgent);\n    if (!isEdge && !isIE) {\n      this._proxyFrame.setAttribute(\n        'sandbox',\n        [\n          'allow-scripts',\n          'allow-popups',\n          'allow-same-origin',\n          'allow-forms',\n        ].join(' '),\n      );\n    }\n    document.body.appendChild(this._proxyFrame);\n\n    window.addEventListener('message', this._callbackHandler);\n\n    this._retryTimeoutId = setTimeout(() => {\n      this._retrySetupProxyFrame();\n    }, this._deps.oAuthOptions?.defaultProxyRetry);\n  };\n\n  private _retrySetupProxyFrame() {\n    this._retryTimeoutId = null;\n    if (this.oAuthReady) return;\n\n    this.setProxyRetryCount(this.proxyRetryCount + 1);\n    this._destroyProxyFrame();\n    this._createProxyFrame();\n  }\n\n  private _destroyProxyFrame() {\n    document.body.removeChild(this._proxyFrame);\n    this._proxyFrame = null;\n    window.removeEventListener('message', this._callbackHandler);\n  }\n\n  @background\n  async setupOAuth() {\n    if (this._proxyFrame) return;\n\n    this._createProxyFrame();\n    this.setProxyRetryCount(0);\n  }\n\n  @background\n  async destroyOAuth() {\n    if (!this._proxyFrame) return;\n\n    if (this._retryTimeoutId) {\n      clearTimeout(this._retryTimeoutId);\n      this._retryTimeoutId = null;\n    }\n\n    this._destroyProxyFrame();\n    this.setOAuthReady(false);\n  }\n\n  @proxify\n  async openOAuthPage() {\n    if (!this.oAuthReady) return;\n\n    if (this._deps.client.service.platform().discovery()) {\n      await this._deps.client.service.platform().loginUrlWithDiscovery();\n    }\n\n    this._proxyFrame.contentWindow.postMessage(\n      {\n        oAuthUri: this.oAuthUri,\n      },\n      '*',\n    );\n  }\n\n  private _implicitRefreshCallBack = ({ data }: CallbackParams) => {\n    const { refreshCallbackUri } = data;\n    if (refreshCallbackUri && this._deps.auth.loggedIn) {\n      this._handleCallbackUri(refreshCallbackUri, true);\n      this._clearImplicitRefreshIframe();\n    }\n  };\n\n  private _createImplicitRefreshIframe() {\n    this._clearImplicitRefreshIframe();\n    this._implicitRefreshFrame = document.createElement('iframe');\n    this._implicitRefreshFrame.src = this.implicitRefreshOAuthUri;\n    this._implicitRefreshFrame.style.display = 'none';\n    document.body.appendChild(this._implicitRefreshFrame);\n    // eslint-disable-next-line\n\n    window.addEventListener('message', this._implicitRefreshCallBack);\n  }\n\n  private _clearImplicitRefreshIframe() {\n    if (!this._implicitRefreshFrame) return;\n\n    document.body.removeChild(this._implicitRefreshFrame);\n    this._implicitRefreshFrame = null;\n    window.removeEventListener('message', this._implicitRefreshCallBack);\n    this._callbackHandler = null;\n  }\n\n  // create a time out to refresh implicit flow token\n  private _createImplicitRefreshTimeout() {\n    if (this._implicitRefreshTimeoutId) {\n      clearTimeout(this._implicitRefreshTimeoutId);\n    }\n    const authData = this._deps.auth.token;\n    const refreshTokenExpiresIn = authData.expiresIn;\n    const { expireTime } = authData;\n\n    if (!refreshTokenExpiresIn || !expireTime) return;\n\n    // * set refresh time to (token expose time) / 3\n    let refreshTokenTimeoutTime =\n      (parseInt(`${refreshTokenExpiresIn}`, 10) * 1000) / 3;\n\n    if (refreshTokenTimeoutTime + Date.now() > expireTime) {\n      refreshTokenTimeoutTime = expireTime - Date.now() - 5000;\n      if (refreshTokenTimeoutTime < 0) return;\n    }\n\n    this._implicitRefreshTimeoutId = setTimeout(() => {\n      if (!this._deps.auth.loggedIn) return;\n\n      if (!this._deps.tabManager?.active) {\n        this._createImplicitRefreshTimeout();\n        return;\n      }\n\n      this._createImplicitRefreshIframe();\n      this._implicitRefreshTimeoutId = null;\n    }, refreshTokenTimeoutTime);\n  }\n}\n"],"file":"ProxyFrameOAuth.js"}
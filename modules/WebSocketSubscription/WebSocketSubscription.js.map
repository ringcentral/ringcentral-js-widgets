{"version":3,"sources":["modules/WebSocketSubscription/WebSocketSubscription.ts"],"names":["DEFAULT_REFRESH_DELAY","WebSocketSubscription","deps","dep","optional","enableCache","storageKey","_wsSubscription","_debouncedUpdateSubscription","fn","_updateSubscription","threshold","_refreshDelay","readyState","_deps","ringCentralExtensions","webSocketReadyState","webSocketReadyStates","open","closing","_isWebSocketOpened","isOpened","ready","cancel","webSocketExtension","ws","subscribe","filters","message","_notifyMessage","cachedSubscriptionInfo","_cacheSubscriptionInfo","subscriptionInfo","eventFilters","refresh","revoke","length","_revokeSubscription","_createSubscription","map","x","sort","join","_refreshSubscription","eventsFilters","oldLength","_addFilters","_removeFilters","concat","filter","index","array","indexOf","includes","delay","webSocketSubscriptionOptions","refreshDelay","Math","max","RcModuleV2","storage","state","action","proxify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA;;AASA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAMA,qBAAqB,GAAG,IAAI,IAAlC;IASaC,qB,WAPZ,gBAAO;AACNC,EAAAA,IAAI,EAAE,CACJ,SADI,EAEJ,uBAFI,EAGJ;AAAEC,IAAAA,GAAG,EAAE,8BAAP;AAAuCC,IAAAA,QAAQ,EAAE;AAAjD,GAHI;AADA,CAAP,C;;;;;AAUC,iCAAYF,IAAZ,EAAwB;AAAA;;AAAA;;AACtB,8BAAM;AACJA,MAAAA,IAAI,EAAJA,IADI;AAEJG,MAAAA,WAAW,EAAE,IAFT;AAGJC,MAAAA,UAAU,EAAE;AAHR,KAAN;AADsB,UAFhBC,eAEgB;;AAAA;;AAAA,UA+GhBC,4BA/GgB,GA+Ge,gCAAS;AAC9CC,MAAAA,EAAE,EAAE,MAAKC,mBADqC;AAE9CC,MAAAA,SAAS,EAAE,MAAKC;AAF8B,KAAT,CA/Gf;;AAAA;;AAAA;;AAAA;AAMvB;;;;yCAE4B;AAC3B,UAAMC,UAAU,GAAG,KAAKC,KAAL,CAAWC,qBAAX,CAAiCC,mBAApD;AACA,aACEH,UAAU,KAAKI,2CAAqBC,IAApC,IACAL,UAAU,KAAKI,2CAAqBE,OAFtC;AAID;;;iCAEY;AAAA;;AACX,uBACE,IADF,EAEE;AAAA,eAAM,MAAI,CAACC,kBAAL,EAAN;AAAA,OAFF,EAGE,UAACC,QAAD,EAAc;AACZ,YAAI,CAAC,MAAI,CAACC,KAAV,EAAiB;AACf;AACD;;AACD,YAAID,QAAJ,EAAc;AACZ,UAAA,MAAI,CAACb,4BAAL;AACD,SAFD,MAEO;AACL,UAAA,MAAI,CAACA,4BAAL,CAAkCe,MAAlC;AACD;AACF,OAZH;AAcD;;;;;;;;;qBAGK,KAAKH,kBAAL,E;;;;;;uBACI,KAAKZ,4BAAL,E;;;;;;;;;;;;;;;;;;;;;;;;;uBAKF,KAAKA,4BAAL,CAAkCe,MAAlC,E;;;AACN,qBAAKhB,eAAL,GAAuB,IAAvB;;;;;;;;;;;;;;;;;;;;;;;;;;oBAIK,KAAKO,KAAL,CAAWC,qBAAX,CAAiCS,kBAAjC,CAAoDC,E;;;;;;;;;uBAIjD,KAAKX,KAAL,CAAWC,qBAAX,CAAiCS,kBAAjC,CAAoDE,SAApD,CACJ,KAAKC,OADD,EAEJ,UAACC,OAAD,EAAa;AACX,kBAAA,MAAI,CAACC,cAAL,CAAoBD,OAApB;AACD,iBAJG,EAKJ,KAAKE,sBALD,C;;;AADR,qBAAKvB,e;;AAQL,qBAAKwB,sBAAL,CAA4B,KAAKxB,eAAL,CAAqByB,gBAAjD;;;;;;;;;;;;;;;;;;2CAQ6BA,gB,EAAoC;AACjE,WAAKF,sBAAL,GAA8BE,gBAA9B;AACD;;;;;;;;;qBAGK,KAAKzB,e;;;;;AACP,qBAAKA,eAAL,CAAqB0B,YAArB,GAAoC,KAAKN,OAAzC;;uBACM,KAAKpB,eAAL,CAAqB2B,OAArB,E;;;;;;;;;;;;;;;;;;;;;;;;qBAKJ,KAAK3B,e;;;;;;uBACD,KAAKA,eAAL,CAAqB4B,MAArB,E;;;AACN,qBAAK5B,eAAL,GAAuB,IAAvB;;;;;;;;;;;;;;;;;;;;;;;;;;sBAKE,KAAKoB,OAAL,CAAaS,MAAb,KAAwB,C;;;;;;uBACpB,KAAKC,mBAAL,E;;;;;;oBAGH,KAAKjB,kBAAL,E;;;;;;;;oBAGA,KAAKb,e;;;;;;uBACF,KAAK+B,mBAAL,E;;;;;;;sBAEN,KAAKX,OAAL,CACGY,GADH,CACO,UAACC,CAAD;AAAA,yBAAO,gDAAqBA,CAArB,CAAP;AAAA,iBADP,EAEGC,IAFH,GAGGC,IAHH,CAGQ,GAHR,gCAIA,KAAKnC,eAAL,CAAqByB,gBAJrB,0DAIA,sBAAuCC,YAAvC,CACGM,GADH,CACO,UAACC,CAAD;AAAA,yBAAO,gDAAqBA,CAArB,CAAP;AAAA,iBADP,EAEGC,IAFH,GAGGC,IAHH,CAGQ,GAHR,CAJA,C;;;;;;uBASM,KAAKC,oBAAL,E;;;;;;;;;;;;;;;;;;;;;;;;;;;AAeMC,gBAAAA,a,8DAAsC,E;;oBAC/C,KAAKtB,K;;;;;;;;AAGJuB,gBAAAA,S,GAAY,KAAKlB,OAAL,CAAaS,M;;AAC/B,qBAAKU,WAAL,CAAiBF,aAAjB;;sBACIC,SAAS,KAAK,KAAKlB,OAAL,CAAaS,M;;;;;;uBACvB,KAAK5B,4BAAL,E;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKQoC,gBAAAA,a,8DAAsC,E;;oBACjD,KAAKtB,K;;;;;;;;AAGJuB,gBAAAA,S,GAAY,KAAKlB,OAAL,CAAaS,M;;AAC/B,qBAAKW,cAAL,CAAoBH,aAApB;;sBACIC,SAAS,KAAK,KAAKlB,OAAL,CAAaS,M;;;;;;uBACvB,KAAK5B,4BAAL,E;;;;;;;;;;;;;;;;;;gCAKUoC,a,EAAqC;AACvD,WAAKjB,OAAL,GAAe,KAAKA,OAAL,CACZqB,MADY,CACLJ,aADK,EAEZK,MAFY,CAEL,UAACT,CAAD,EAAIU,KAAJ,EAAWC,KAAX;AAAA,eAAqBA,KAAK,CAACC,OAAN,CAAcZ,CAAd,MAAqBU,KAA1C;AAAA,OAFK,CAAf,CADuD,CAGK;AAC7D;;;mCAGsBN,a,EAAqC;AAC1D,WAAKjB,OAAL,GAAe,KAAKA,OAAL,CAAasB,MAAb,CAAoB,UAACT,CAAD;AAAA,eAAO,CAACI,aAAa,CAACS,QAAd,CAAuBb,CAAvB,CAAR;AAAA,OAApB,CAAf;AACD;;;mCAGsBZ,O,EAAc;AACnC,WAAKA,OAAL,GAAeA,OAAf;AACD;;;wBAjD2B;AAAA;;AAC1B,UAAM0B,KAAK,4BAAG,KAAKxC,KAAL,CAAWyC,4BAAd,0DAAG,sBAAyCC,YAAvD;AACA,aAAOC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYJ,KAAZ,aAAYA,KAAZ,cAAYA,KAAZ,GAAqBtD,qBAArB,CAAP;AACD;;;;EAhHwC2D,gB,0FA8DxCC,a,EACAC,W;;;;;WAC0C,I;;4EAE1CC,Y,gKAqDAC,gB,qJAYAA,gB,uJAYAD,Y,0JAOAA,Y,6JAKAA,Y,qKAKAD,W;;;;;WAC+B,E;;4EAE/BA,W;;;;;WACc,I","sourcesContent":["import { SubscriptionInfo } from '@rc-ex/core/lib/definitions';\nimport Subscription from '@rc-ex/ws/lib/subscription';\nimport {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n  watch,\n} from '@ringcentral-integration/core';\n\nimport { SubscriptionFilter } from '../../enums/subscriptionFilters';\nimport { debounce } from '../../lib/debounce-throttle';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { webSocketReadyStates } from '../RingCentralExtensions/webSocketReadyStates';\nimport { normalizeEventFilter } from './normalizeEventFilter';\nimport { Deps } from './WebSocketSubscription.interface';\n\nconst DEFAULT_REFRESH_DELAY = 2 * 1000;\n\n@Module({\n  deps: [\n    'Storage',\n    'RingCentralExtensions',\n    { dep: 'WebSocketSubscriptionOptions', optional: true },\n  ],\n})\nexport class WebSocketSubscription extends RcModuleV2<Deps> {\n  private _wsSubscription: Subscription;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'WebSocketSubscription',\n    });\n  }\n\n  private _isWebSocketOpened() {\n    const readyState = this._deps.ringCentralExtensions.webSocketReadyState;\n    return (\n      readyState === webSocketReadyStates.open ||\n      readyState === webSocketReadyStates.closing\n    );\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this._isWebSocketOpened(),\n      (isOpened) => {\n        if (!this.ready) {\n          return;\n        }\n        if (isOpened) {\n          this._debouncedUpdateSubscription();\n        } else {\n          this._debouncedUpdateSubscription.cancel();\n        }\n      },\n    );\n  }\n\n  async onInit() {\n    if (this._isWebSocketOpened()) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  async onReset() {\n    await this._debouncedUpdateSubscription.cancel();\n    this._wsSubscription = null;\n  }\n\n  private async _createSubscription() {\n    if (!this._deps.ringCentralExtensions.webSocketExtension.ws) {\n      return;\n    }\n    this._wsSubscription =\n      await this._deps.ringCentralExtensions.webSocketExtension.subscribe(\n        this.filters,\n        (message) => {\n          this._notifyMessage(message);\n        },\n        this.cachedSubscriptionInfo,\n      );\n    this._cacheSubscriptionInfo(this._wsSubscription.subscriptionInfo);\n  }\n\n  @storage\n  @state\n  cachedSubscriptionInfo: SubscriptionInfo = null;\n\n  @action\n  private _cacheSubscriptionInfo(subscriptionInfo: SubscriptionInfo) {\n    this.cachedSubscriptionInfo = subscriptionInfo;\n  }\n\n  private async _refreshSubscription() {\n    if (this._wsSubscription) {\n      this._wsSubscription.eventFilters = this.filters;\n      await this._wsSubscription.refresh();\n    }\n  }\n\n  private async _revokeSubscription() {\n    if (this._wsSubscription) {\n      await this._wsSubscription.revoke();\n      this._wsSubscription = null;\n    }\n  }\n\n  private async _updateSubscription() {\n    if (this.filters.length === 0) {\n      await this._revokeSubscription();\n      return;\n    }\n    if (!this._isWebSocketOpened()) {\n      return;\n    }\n    if (!this._wsSubscription) {\n      await this._createSubscription();\n    } else if (\n      this.filters\n        .map((x) => normalizeEventFilter(x))\n        .sort()\n        .join(',') !==\n      this._wsSubscription.subscriptionInfo?.eventFilters\n        .map((x) => normalizeEventFilter(x))\n        .sort()\n        .join(',')\n    ) {\n      await this._refreshSubscription();\n    }\n  }\n\n  private get _refreshDelay() {\n    const delay = this._deps.webSocketSubscriptionOptions?.refreshDelay;\n    return Math.max(0, delay ?? DEFAULT_REFRESH_DELAY);\n  }\n\n  private _debouncedUpdateSubscription = debounce({\n    fn: this._updateSubscription,\n    threshold: this._refreshDelay,\n  });\n\n  @proxify\n  async subscribe(eventsFilters: SubscriptionFilter[] = []) {\n    if (!this.ready) {\n      return;\n    }\n    const oldLength = this.filters.length;\n    this._addFilters(eventsFilters);\n    if (oldLength !== this.filters.length) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  @proxify\n  async unsubscribe(eventsFilters: SubscriptionFilter[] = []) {\n    if (!this.ready) {\n      return;\n    }\n    const oldLength = this.filters.length;\n    this._removeFilters(eventsFilters);\n    if (oldLength !== this.filters.length) {\n      await this._debouncedUpdateSubscription();\n    }\n  }\n\n  @action\n  private _addFilters(eventsFilters: SubscriptionFilter[]) {\n    this.filters = this.filters\n      .concat(eventsFilters)\n      .filter((x, index, array) => array.indexOf(x) === index); // remove duplicates\n  }\n\n  @action\n  private _removeFilters(eventsFilters: SubscriptionFilter[]) {\n    this.filters = this.filters.filter((x) => !eventsFilters.includes(x));\n  }\n\n  @action\n  private _notifyMessage(message: any) {\n    this.message = message;\n  }\n\n  @state\n  filters: SubscriptionFilter[] = [];\n\n  @state\n  message: any = null;\n}\n"],"file":"WebSocketSubscription.js"}
{"version":3,"sources":["modules/Auth/index.ts"],"names":["LoginStatusChangeEvent","Auth","deps","dep","optional","client","alert","locale","tabManager","environment","usePKCE","options","actionTypes","_client","_alert","_locale","_tabManager","_environment","_beforeLogoutHandlers","_afterLoggedInHandlers","_proxyFrame","_proxyFrameLoaded","_unbindEvents","_lastEnvironmentCounter","_proxyUri","_redirectUri","_usePKCE","_reducer","Set","platform","service","onRequestError","error","Error","message","logout","onLoginSuccess","store","loginSuccess","auth","data","type","token","dispatch","handlers","handler","onLoginError","loginError","onLogoutSuccess","logoutSuccess","onLogoutError","_cache","clean","logoutError","onRefreshSuccess","refreshSuccess","onRefreshError","isOffline","resStatus","response","status","refreshTokenValid","refreshError","access_token","danger","authMessages","sessionExpired","payload","ttl","addListener","events","requestError","removeListener","loggedIn","subscribe","moduleStatuses","pending","ready","init","_bindEvents","initSuccess","loginStatus","notLoggedIn","send","event","name","args","tabSync","changeCounter","username","password","extension","remember","code","redirectUri","accessToken","expiresIn","endpointId","tokenType","scope","tokenUri","discoveryUri","login","setData","token_type","expires_in","refresh_token_expires_in","account","get","extensionData","ownerId","id","endpoint_id","owner_id","token_uri","discovery_uri","state","brandId","display","prompt","uiOptions","uiLocales","localeId","force","implicit","loginUrl","dismissAllAlert","dismissAll","beforeLogout","result","cancelLogout","Promise","reject","console","isImplicit","add","removeBeforeLogoutHandler","String","newAuthData","emit","url","resolve","window","location","href","freshLogin","_clientSecret","length","RcModule","proxify"],"mappings":"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","sourcesContent":["import url from 'url';\n\nimport moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport ensureExist from '../../lib/ensureExist';\nimport { proxify } from '../../lib/proxy/proxify';\nimport RcModule from '../../lib/RcModule';\nimport validateIsOffline from '../../lib/validateIsOffline';\nimport actionTypes from './actionTypes';\nimport authMessages from './authMessages';\nimport getAuthReducer from './getAuthReducer';\nimport loginStatus from './loginStatus';\n\nconst LoginStatusChangeEvent = 'loginStatusChange';\n\n/**\n * @class\n * @description Authentication module\n */\n@Module({\n  deps: [\n    'Client',\n    'Alert',\n    'Locale',\n    { dep: 'TabManager', optional: true },\n    { dep: 'Environment', optional: true },\n    { dep: 'AuthOptions', optional: true },\n  ],\n})\nexport default class Auth extends RcModule {\n  _client: any;\n  _alert: any;\n  _locale: any;\n  _tabManager: any;\n  _environment: any;\n  _beforeLogoutHandlers: Set<Function>;\n  _afterLoggedInHandlers: Set<() => any>;\n  _proxyFrame: any;\n  _proxyFrameLoaded: boolean;\n  _unbindEvents: any;\n  _lastEnvironmentCounter: number;\n  _proxyUri: any;\n  _redirectUri: string;\n  protected _usePKCE: boolean;\n\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {Client} params.client - client module instance\n   * @param {Alert} params.alert - alert module instance\n   * @param {Brand} params.brand - brand module instance\n   * @param {Locale} params.locale - locale module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   * @param {environment} params.Environment - environment module instance\n   * @param {String} params.redirectUri - redirect uri\n   * @param {String} params.proxyUri - proxyUri module instance\n   * @param {Number} params.defaultProxyRetry - default proxy retry time 5000\n   */\n  constructor({\n    client,\n    alert,\n    locale,\n    tabManager,\n    environment,\n    usePKCE = false,\n    ...options\n  }: any = {}) {\n    super({\n      ...options,\n      actionTypes,\n    });\n    this._client = ensureExist(client, 'client');\n    this._alert = ensureExist(alert, 'alert');\n    this._locale = ensureExist(locale, 'locale');\n    this._tabManager = tabManager;\n    this._environment = environment;\n    this._reducer = getAuthReducer(this.actionTypes);\n    this._usePKCE = usePKCE;\n    this._beforeLogoutHandlers = new Set();\n    this._afterLoggedInHandlers = new Set();\n    this._proxyFrame = null;\n    this._proxyFrameLoaded = false;\n    this._unbindEvents = null;\n    this._lastEnvironmentCounter = 0;\n  }\n\n  _bindEvents() {\n    if (this._unbindEvents) this._unbindEvents();\n\n    const platform = this._client.service.platform();\n    const client = this._client.service._client;\n    const onRequestError = (error: any) => {\n      if (error instanceof Error && error.message === 'Token revoked') {\n        this.logout();\n      }\n    };\n\n    const onLoginSuccess = async () => {\n      this.store.dispatch({\n        type: this.actionTypes.loginSuccess,\n        token: await platform.auth().data(),\n      });\n      const handlers = [...this._afterLoggedInHandlers];\n      for (const handler of handlers) {\n        handler();\n      }\n    };\n    const onLoginError = (error: any) => {\n      this.store.dispatch({\n        type: this.actionTypes.loginError,\n        error,\n      });\n    };\n    const onLogoutSuccess = () => {\n      this.store.dispatch({\n        type: this.actionTypes.logoutSuccess,\n      });\n    };\n    const onLogoutError = (error: any) => {\n      platform._cache.clean();\n      this.store.dispatch({\n        type: this.actionTypes.logoutError,\n        error,\n      });\n    };\n    const onRefreshSuccess = async () => {\n      this.store.dispatch({\n        type: this.actionTypes.refreshSuccess,\n        token: await platform.auth().data(),\n      });\n    };\n    const onRefreshError = async (error: any) => {\n      // user is still considered logged in if the refreshToken is still valid\n      const isOffline = validateIsOffline(error.message);\n\n      const resStatus = (error.response && error.response.status) || null;\n      const refreshTokenValid =\n        (isOffline || resStatus >= 500) &&\n        (await platform.auth().refreshTokenValid());\n      this.store.dispatch({\n        type: this.actionTypes.refreshError,\n        error,\n        refreshTokenValid,\n      });\n\n      if (\n        !refreshTokenValid &&\n        (await platform.auth().data()).access_token !== ''\n      ) {\n        this._alert.danger({\n          message: authMessages.sessionExpired,\n          payload: error,\n          ttl: 0,\n        });\n        // clean the cache so the error doesn't show again\n        platform._cache.clean();\n      }\n    };\n    platform.addListener(platform.events.loginSuccess, onLoginSuccess);\n    platform.addListener(platform.events.loginError, onLoginError);\n    platform.addListener(platform.events.logoutSuccess, onLogoutSuccess);\n    platform.addListener(platform.events.logoutError, onLogoutError);\n    platform.addListener(platform.events.refreshSuccess, onRefreshSuccess);\n    platform.addListener(platform.events.refreshError, onRefreshError);\n    client.addListener(client.events.requestError, onRequestError);\n    this._unbindEvents = () => {\n      platform.removeListener(platform.events.loginSuccess, onLoginSuccess);\n      platform.removeListener(platform.events.loginError, onLoginError);\n      platform.removeListener(platform.events.logoutSuccess, onLogoutSuccess);\n      platform.removeListener(platform.events.logoutError, onLogoutError);\n      platform.removeListener(platform.events.refreshSuccess, onRefreshSuccess);\n      platform.removeListener(platform.events.refreshError, onRefreshError);\n      client.removeListener(client.events.requestError, onRequestError);\n    };\n  }\n\n  initialize() {\n    let loggedIn: boolean;\n    this.store.subscribe(async () => {\n      if (\n        this.status === moduleStatuses.pending &&\n        this._locale.ready &&\n        (!this._tabManager || this._tabManager.ready) &&\n        (!this._environment || this._environment.ready)\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.init,\n        });\n        const platform = this._client.service.platform();\n        loggedIn = await platform.loggedIn();\n        this._bindEvents();\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n          loggedIn,\n          token: loggedIn ? await platform.auth().data() : null,\n        });\n      }\n      if (this._tabManager && this._tabManager.ready && this.ready) {\n        if (\n          (loggedIn && this.loginStatus === loginStatus.notLoggedIn) ||\n          (!loggedIn && this.loginStatus === loginStatus.loggedIn)\n        ) {\n          loggedIn = !loggedIn;\n          this._tabManager.send(LoginStatusChangeEvent, loggedIn);\n        } else if (\n          this._tabManager.event &&\n          this._tabManager.event.name === LoginStatusChangeEvent &&\n          this._tabManager.event.args[0] !== loggedIn\n        ) {\n          /* eslint { \"prefer-destructuring\": 0 } */\n          loggedIn = this._tabManager.event.args[0];\n          this.store.dispatch({\n            type: this.actionTypes.tabSync,\n            loggedIn,\n            token: loggedIn\n              ? await this._client.service.platform().auth().data()\n              : null,\n          });\n        }\n      }\n      if (\n        this.ready &&\n        this._environment &&\n        this._environment.changeCounter !== this._lastEnvironmentCounter\n      ) {\n        this._lastEnvironmentCounter = this._environment.changeCounter;\n        this._bindEvents();\n      }\n    });\n  }\n\n  get redirectUri() {\n    return url.resolve(window.location.href, this._redirectUri);\n  }\n\n  get proxyUri() {\n    return this._proxyUri;\n  }\n\n  get token() {\n    return this.state.token;\n  }\n\n  get ownerId() {\n    return this.token.ownerId;\n  }\n\n  get endpointId() {\n    return this.token.endpointId;\n  }\n\n  get accessToken() {\n    return this.token.accessToken;\n  }\n\n  get status() {\n    return this.state.status;\n  }\n\n  get ready() {\n    return this.state.status === moduleStatuses.ready;\n  }\n\n  get loginStatus() {\n    return this.state.loginStatus;\n  }\n\n  get isFreshLogin() {\n    return this.state.freshLogin;\n  }\n\n  /**\n   * @function\n   * @param {String} options.username\n   * @param {String} options.password\n   * @param {String} options.extension\n   * @param {Booleal|Number} options.remember\n   * @param {String} params.code,\n   * @param {String} params.redirectUri,\n   * @return {Promise}\n   * @description Login either with username/password or with authorization code\n   */\n  @proxify\n  async login({\n    username,\n    password,\n    extension,\n    remember,\n    code,\n    redirectUri,\n    accessToken,\n    expiresIn,\n    endpointId,\n    tokenType,\n    scope,\n    tokenUri,\n    discoveryUri,\n  }: any) {\n    this.store.dispatch({\n      type: this.actionTypes.login,\n    });\n    let ownerId;\n    if (accessToken) {\n      await this._client.service.platform().auth().setData({\n        token_type: tokenType,\n        access_token: accessToken,\n        expires_in: expiresIn,\n        refresh_token_expires_in: expiresIn,\n        scope,\n      });\n      const extensionData = await this._client.account().extension().get();\n      ownerId = extensionData.id;\n    }\n    // TODO: support to set redirectUri in js sdk v4 login function\n    if (!this._client.service.platform()._redirectUri) {\n      this._client.service.platform()._redirectUri = redirectUri;\n    }\n    return this._client.service.platform().login({\n      username,\n      password,\n      extension,\n      remember,\n      code,\n      redirectUri,\n      endpoint_id: endpointId,\n      expires_in: expiresIn,\n      access_token: accessToken,\n      token_type: tokenType,\n      owner_id: ownerId,\n      token_uri: tokenUri,\n      discovery_uri: discoveryUri,\n    });\n  }\n\n  /**\n   * @function\n   * @param {String} options.redirectUri\n   * @param {String} options.brandId\n   * @param {Boolean} options.force\n   * @param {Boolean} options.implicit\n   * @return {String}\n   * @description get OAuth page url\n   */\n  getLoginUrl({\n    redirectUri,\n    state,\n    brandId,\n    display,\n    prompt,\n    uiOptions,\n    uiLocales,\n    localeId,\n    force,\n    implicit = false,\n  }: any) {\n    // TODO: support to set redirectUri in js sdk v4 login function\n    if (!this._client.service.platform()._redirectUri) {\n      this._client.service.platform()._redirectUri = redirectUri;\n    }\n    return `${this._client.service.platform().loginUrl({\n      redirectUri,\n      state,\n      brandId,\n      display,\n      prompt,\n      uiOptions,\n      uiLocales,\n      localeId,\n      implicit,\n      usePKCE: this.usePKCE,\n    })}${force ? '&force=true' : ''}`;\n  }\n\n  /**\n   * @function\n   * @description Triggers the beforeLogoutHandlers to run\n   *  and then proceed to logout from ringcentral.\n   */\n  @proxify\n  async logout({ dismissAllAlert = true } = {}) {\n    if (dismissAllAlert) {\n      this._alert.dismissAll();\n    }\n    this.store.dispatch({\n      type: this.actionTypes.beforeLogout,\n    });\n    const handlers = [...this._beforeLogoutHandlers];\n    try {\n      if (this._tabManager && this._tabManager.ready) {\n        this._tabManager.send(LoginStatusChangeEvent, false);\n      }\n      for (const handler of handlers) {\n        const result = await (async () => handler())();\n        if (result) {\n          this.store.dispatch({\n            type: this.actionTypes.cancelLogout,\n          });\n          if (this._tabManager && this._tabManager.ready) {\n            this._tabManager.send(LoginStatusChangeEvent, true);\n          }\n          return Promise.reject(result);\n        }\n      }\n    } catch (error) {\n      console.error(error);\n    }\n    this.store.dispatch({\n      type: this.actionTypes.logout,\n    });\n    if (this.isImplicit) {\n      this._client.service.platform()._cache.clean();\n      this.store.dispatch({\n        type: this.actionTypes.logoutSuccess,\n      });\n      return null;\n    }\n    return this._client.service.platform().logout();\n  }\n\n  /**\n   * @function\n   * @param {Function} handler\n   * @returns {Function} return that delete handler event, call that will delete that event\n   */\n  addBeforeLogoutHandler(handler: (...args: any[]) => any) {\n    this._beforeLogoutHandlers.add(handler);\n    return () => {\n      this.removeBeforeLogoutHandler(handler);\n    };\n  }\n\n  /**\n   * @function\n   * @param {Function} handler\n   */\n  removeBeforeLogoutHandler(handler: (...args: any[]) => any) {\n    this._beforeLogoutHandlers.delete(handler);\n  }\n\n  addAfterLoggedInHandler(handler: (...args: any[]) => any) {\n    this._afterLoggedInHandlers.add(handler);\n    return () => {\n      this._afterLoggedInHandlers.delete(handler);\n    };\n  }\n\n  @proxify\n  async refreshImplicitToken({\n    tokenType,\n    accessToken,\n    expiresIn,\n    endpointId,\n  }: any) {\n    try {\n      const extensionData = await this._client.account().extension().get();\n      const ownerId = String(extensionData.id);\n      if (ownerId !== String(this.ownerId)) {\n        return;\n      }\n      const platform = this._client.service.platform();\n      const newAuthData = {\n        token_type: tokenType,\n        access_token: accessToken,\n        expires_in: expiresIn,\n        refresh_token_expires_in: expiresIn,\n        endpoint_id: endpointId,\n      };\n      platform.auth().setData(newAuthData);\n      platform.emit(platform.events.refreshSuccess, newAuthData);\n    } catch (error) {\n      console.error('refreshImplicitToken error:', error);\n    }\n  }\n\n  @proxify\n  async checkIsLoggedIn() {\n    // SDK would return false when there's temporary network issues,\n    // but we should not return use back to welcome string and should\n    // still consider the user as being logged in.\n    await this._client.service.platform().loggedIn();\n    return this.state.loginStatus === loginStatus.loggedIn;\n  }\n\n  get loggedIn() {\n    return (\n      this.state.loginStatus === loginStatus.loggedIn ||\n      this.state.loginStatus === loginStatus.beforeLogout\n    );\n  }\n\n  get notLoggedIn() {\n    return this.state.loginStatus === loginStatus.notLoggedIn;\n  }\n\n  get isImplicit() {\n    return !(\n      this.usePKCE ||\n      (this._client.service.platform()._clientSecret &&\n        this._client.service.platform()._clientSecret.length > 0)\n    );\n  }\n\n  get usePKCE() {\n    return this._usePKCE;\n  }\n}\n"],"file":"index.js"}
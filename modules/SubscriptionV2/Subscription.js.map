{"version":3,"sources":["modules/SubscriptionV2/Subscription.ts"],"names":["DEFAULT_TIME_TO_RETRY","DEFAULT_REGISTER_DELAY","SUBSCRIPTION_LOCK_KEY","Subscription","name","deps","dep","optional","storageKey","enableCache","_subscription","_retryTimeoutId","_debouncedRegister","_retry","_handleSleep","ready","renewPromise","automaticRenewing","resubscribeAtPubNub","_onBeforeLogout","_removeSubscription","fn","_register","threshold","_registerDelay","_createSubscriptionWithLock","_timeToRetry","maxThreshold","filters","_setStates","message","status","subscriptionStatus","cachedSubscription","_deps","auth","loggedIn","sleepDetector","on","events","detected","addBeforeLogoutHandler","notSubscribed","off","cancel","removeBeforeLogoutHandler","reset","removeAllListeners","error","subscribed","subscription","flush","sdk","client","service","Subscriptions","createSubscription","setSubscription","notification","_onNotification","removeSuccess","_onRemoveSuccess","removeError","_onRemoveError","renewSuccess","_onRenewSuccess","renewError","_onRenewError","subscribeSuccess","_onSubscribeSuccess","subscribeError","_onSubscribeError","navigator","locks","request","_createSubscription","normalizeEventFilter","eventFilters","sort","_shouldUpdateSubscription","subscribing","setEventFilters","register","unsubscribing","remove","oldFiltersCount","length","_addFilters","concat","Math","max","subscriptionOptions","timeToRetry","registerDelay","RcModuleV2","state","storage","action","proxify"],"mappings":"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","sourcesContent":["import {\n  action,\n  RcModuleV2,\n  state,\n  storage,\n} from '@ringcentral-integration/core';\nimport { ObjectMapValue } from '@ringcentral-integration/core/lib/ObjectMap';\nimport { ApiError } from '@ringcentral/sdk';\nimport Subscriptions from '@ringcentral/subscriptions';\nimport { SubscriptionData } from '@ringcentral/subscriptions/src/subscription/Subscription';\nimport { concat, equals, map, uniq } from 'ramda';\n\nimport { subscriptionFilters } from '../../enums/subscriptionFilters';\nimport {\n  debounce,\n  promisedDebounce,\n  PromisedDebounceFunction,\n  DebouncedFunction,\n} from '../../lib/debounce-throttle';\nimport { Module } from '../../lib/di';\nimport { proxify } from '../../lib/proxy/proxify';\nimport { normalizeEventFilter } from '../Subscription/normalizeEventFilter';\nimport { subscriptionStatus } from '../Subscription/subscriptionStatus';\nimport { Deps, MessageBase } from './Subscription.interface';\n\nconst DEFAULT_TIME_TO_RETRY = 20 * 1000;\nconst DEFAULT_REGISTER_DELAY = 2 * 1000;\nconst SUBSCRIPTION_LOCK_KEY = 'subscription-creating-lock';\n\n@Module({\n  name: 'Subscription',\n  deps: [\n    'Auth',\n    'Client',\n    'Storage',\n    'SleepDetector',\n    { dep: 'SubscriptionOptions', optional: true },\n  ],\n})\nexport class Subscription extends RcModuleV2<Deps> {\n  protected _subscription: ReturnType<\n    Subscriptions['createSubscription']\n  > = null;\n\n  protected _retryTimeoutId: NodeJS.Timeout = null;\n\n  protected _debouncedRegister: PromisedDebounceFunction<\n    Subscription['_register']\n  >;\n\n  protected _retry: DebouncedFunction<\n    Subscription['_createSubscriptionWithLock']\n  >;\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      storageKey: 'subscription',\n      enableCache: true,\n    });\n    this._debouncedRegister = promisedDebounce({\n      fn: this._register,\n      threshold: this._registerDelay,\n    });\n\n    this._retry = debounce({\n      fn: this._createSubscriptionWithLock,\n      threshold: this._timeToRetry,\n      maxThreshold: this._timeToRetry,\n    });\n  }\n\n  @state\n  message: MessageBase = null;\n\n  @state\n  filters: ObjectMapValue<typeof subscriptionFilters>[] = [];\n\n  protected _addFilters(filters: Subscription['filters']) {\n    this._setStates({ filters: uniq(concat(filters, this.filters)) });\n  }\n\n  @storage\n  @state\n  cachedSubscription: SubscriptionData = null;\n\n  @state\n  subscriptionStatus: ObjectMapValue<typeof subscriptionStatus> =\n    subscriptionStatus.notSubscribed;\n\n  @action\n  protected _setStates({\n    message = this.message,\n    filters = this.filters,\n    status = this.subscriptionStatus,\n    cachedSubscription = this.cachedSubscription,\n  }) {\n    this.message = message;\n    this.filters = filters;\n    this.subscriptionStatus = status;\n    this.cachedSubscription = cachedSubscription;\n  }\n\n  get _timeToRetry() {\n    return Math.max(\n      0,\n      this._deps.subscriptionOptions?.timeToRetry ?? DEFAULT_TIME_TO_RETRY,\n    );\n  }\n\n  get _registerDelay() {\n    return Math.max(\n      0,\n      this._deps.subscriptionOptions?.registerDelay ?? DEFAULT_REGISTER_DELAY,\n    );\n  }\n\n  _shouldInit() {\n    return super._shouldInit() && this._deps.auth.loggedIn;\n  }\n\n  _shouldReset() {\n    return super._shouldReset() || (this.ready && !this._deps.auth.loggedIn);\n  }\n\n  _handleSleep = async () => {\n    if (this.ready && this._subscription) {\n      // to wait automatic renew finish\n      const renewPromise = this._subscription.automaticRenewing();\n      if (renewPromise) {\n        await renewPromise;\n      }\n      // this._subscription may be removed at renewError event\n      // forcibly reconnect pubnub to ensure pubnub is alive\n      await this._subscription?.resubscribeAtPubNub();\n    }\n  };\n\n  protected _onBeforeLogout = async () => {\n    if (this._subscription) {\n      await this._removeSubscription();\n    }\n  };\n\n  onInit() {\n    this._deps.sleepDetector.on(\n      this._deps.sleepDetector.events.detected,\n      this._handleSleep,\n    );\n    this._deps.auth.addBeforeLogoutHandler(this._onBeforeLogout);\n  }\n\n  async onReset() {\n    this._setStates({\n      filters: [],\n      message: null,\n      status: subscriptionStatus.notSubscribed,\n    });\n    this._deps.sleepDetector.off(\n      this._deps.sleepDetector.events.detected,\n      this._handleSleep,\n    );\n    this._retry.cancel();\n    this._deps.auth.removeBeforeLogoutHandler(this._onBeforeLogout);\n    this._debouncedRegister.cancel();\n    if (this._subscription) {\n      this._subscription.reset();\n      this._subscription.removeAllListeners();\n      this._subscription = null;\n    }\n  }\n\n  protected _onRemoveSuccess() {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n  }\n\n  protected _onRemoveError(error: ApiError | Error) {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n  }\n\n  protected _onRenewSuccess() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.subscribed,\n        cachedSubscription: this._subscription.subscription(),\n      });\n    }\n  }\n\n  protected _onRenewError(error: ApiError | Error) {\n    if (this._subscription) {\n      this._subscription.reset();\n      this._subscription.removeAllListeners();\n      this._subscription = null;\n    }\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n    if (this.ready) {\n      // immediately start the retry process after the first renewError\n      this._retry();\n      this._retry.flush();\n    }\n  }\n\n  protected _onSubscribeSuccess() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.subscribed,\n        cachedSubscription: this._subscription.subscription(),\n      });\n    }\n  }\n\n  protected _onSubscribeError(error: ApiError | Error) {\n    this._setStates({\n      status: subscriptionStatus.notSubscribed,\n      cachedSubscription: null,\n    });\n    if (this.ready) {\n      this._retry();\n    }\n  }\n\n  protected _onNotification(message: MessageBase) {\n    this._setStates({\n      message,\n    });\n  }\n\n  protected async _createSubscription() {\n    if (this.ready && !this._subscription) {\n      const sdk = this._deps.client.service;\n      this._subscription = new Subscriptions({ sdk }).createSubscription();\n      if (this.cachedSubscription) {\n        try {\n          this._subscription.setSubscription(this.cachedSubscription);\n        } catch (error) {\n          this._subscription = new Subscriptions({ sdk }).createSubscription();\n        }\n      }\n      // TODO: fix Subscription limit issue about multiple create Subscription issue when multi-tab login.\n      this._subscription.on(\n        this._subscription.events.notification,\n        (message: MessageBase) => this._onNotification(message),\n      );\n      this._subscription.on(this._subscription.events.removeSuccess, () =>\n        this._onRemoveSuccess(),\n      );\n      this._subscription.on(this._subscription.events.removeError, (error) =>\n        this._onRemoveError(error),\n      );\n      this._subscription.on(this._subscription.events.renewSuccess, () =>\n        this._onRenewSuccess(),\n      );\n      this._subscription.on(this._subscription.events.renewError, (error) =>\n        this._onRenewError(error),\n      );\n      this._subscription.on(this._subscription.events.subscribeSuccess, () =>\n        this._onSubscribeSuccess(),\n      );\n      this._subscription.on(this._subscription.events.subscribeError, (error) =>\n        this._onSubscribeError(error),\n      );\n    }\n    try {\n      await this._debouncedRegister();\n    } catch (error) {\n      if (error.message !== 'cancelled') {\n        throw error;\n      }\n    }\n  }\n\n  protected async _createSubscriptionWithLock() {\n    if (!navigator?.locks?.request) {\n      await this._createSubscription();\n    } else {\n      await navigator.locks.request(SUBSCRIPTION_LOCK_KEY, () =>\n        this._createSubscription(),\n      );\n    }\n  }\n\n  protected _shouldUpdateSubscription() {\n    return !!(\n      this._subscription &&\n      !equals(\n        map(normalizeEventFilter, this._subscription.eventFilters()).sort(),\n        map(normalizeEventFilter, this.filters).sort(),\n      )\n    );\n  }\n\n  protected async _register() {\n    if (this._shouldUpdateSubscription()) {\n      this._setStates({\n        status: subscriptionStatus.subscribing,\n      });\n      this._subscription.setEventFilters([...this.filters]);\n      await this._subscription.register();\n    }\n  }\n\n  protected async _removeSubscription() {\n    if (this._subscription) {\n      this._setStates({\n        status: subscriptionStatus.unsubscribing,\n      });\n      try {\n        await this._subscription.remove();\n      } catch (error) {\n        /* removeError is handled elsewhere */\n      }\n      if (this._subscription) {\n        this._subscription.reset();\n        this._subscription.removeAllListeners();\n        this._subscription = null;\n      }\n      this._setStates({\n        status: subscriptionStatus.notSubscribed,\n      });\n    }\n  }\n\n  @proxify\n  async subscribe(events: Subscription['filters'] = []) {\n    if (this.ready) {\n      const oldFiltersCount = this._subscription?.eventFilters().length ?? 0;\n      // use [].concat for potential compatibility issue\n      this._addFilters([].concat(events));\n      if (oldFiltersCount !== this.filters.length) {\n        await this._createSubscriptionWithLock();\n      }\n    }\n  }\n}\n"],"file":"Subscription.js"}
{"version":3,"sources":["modules/EvCall/EvCall.ts"],"names":["DEFAULT_OUTBOUND_SETTING","dialoutCallerId","dialoutQueueId","dialoutCountryId","dialoutRingTime","EvCall","name","deps","dep","optional","that","activityCallId","_deps","evCallMonitor","callsMapping","evAuth","isEvLogged","ready","trackEvents","outbound","value","evAgentSession","loginType","enableCache","storageKey","ringTimeLimit","min","max","data","formGroup","defaultRingTime","parseInt","outboundManualDefaultRingtime","Number","isNaN","setFormGroup","isOnLoginSuccess","resetForm","onCallEnded","setDialoutStatus","dialoutStatuses","idle","evSubscription","subscribe","EvCallbackTypes","TCPA_SAFE_LEAD_STATE","includes","leadState","evSettings","isManualOffhook","_isTabActive","evClient","offhookTerm","setPhonedIdle","alert","info","message","messageTypes","INTERCEPT","OFFHOOK_TERM","isFreshLogin","resetOutBoundDialSetting","phoneNumber","presence","setCurrentCallUii","isIntegratedSoftphone","integratedSoftphone","evIntegratedSoftphone","sipRegisterSuccess","askAudioPermission","configureAgent","onceRegistered","destination","_checkAndParseNumber","_manualOutdial","callerId","countryId","queueId","ringTime","manualOutdialCancel","currentCallUii","Math","dialoutStatus","isOnCall","evWorkingState","isPendingDisposition","console","log","danger","FAILED_TO_CALL","ttl","status","dialing","error","type","NO_SUPPORT_COUNTRY","callErrors","emergencyNumber","noToNumber","setPhonedDialing","isOffhook","getOffhookInitResult","_getOffhookInitResult","offhookInit","offhookInitResult","manualOutdial","Error","Promise","resolve","reject","evPresenceEvents","once","OFFHOOK_INIT","tabManager","active","call","currentCall","callType","RcModuleV2","storage","state","action"],"mappings":"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","sourcesContent":["import { Module } from '@ringcentral-integration/commons/lib/di';\nimport callErrors from '@ringcentral-integration/commons/modules/Call/callErrors';\nimport {\n  action,\n  computed,\n  RcModuleV2,\n  state,\n  storage,\n  track,\n  watch,\n} from '@ringcentral-integration/core';\n\nimport { messageTypes } from '../../enums';\nimport {\n  dialoutStatuses,\n  DialoutStatusesType,\n} from '../../enums/dialoutStatus';\nimport { checkCountryCode } from '../../lib/checkCountryCode';\nimport {\n  EvClientManualOutdialParams,\n  EvOffhookInitResponse,\n} from '../../lib/EvClient';\nimport { EvCallbackTypes } from '../../lib/EvClient/enums/callbackTypes';\nimport { parseNumber } from '../../lib/parseNumber';\nimport { trackEvents } from '../../lib/trackEvents';\nimport { Call, Deps, State } from './EvCall.interface';\n\nconst DEFAULT_OUTBOUND_SETTING = {\n  dialoutCallerId: '-1',\n  dialoutQueueId: '-1',\n  dialoutCountryId: 'USA',\n  dialoutRingTime: 30,\n};\n\n@Module({\n  name: 'EvCall',\n  deps: [\n    'Alert',\n    'EvAuth',\n    'Storage',\n    'EvClient',\n    'Presence',\n    'EvSettings',\n    'EvCallMonitor',\n    'EvSubscription',\n    'EvAgentSession',\n    'EvIntegratedSoftphone',\n    { dep: 'TabManager', optional: true },\n    { dep: 'EvCallOptions', optional: true },\n    { dep: 'EvWorkingState', optional: true },\n  ],\n})\nclass EvCall extends RcModuleV2<Deps> implements Call {\n  /** this id is get from route, set from EvActivityCallUI */\n  activityCallId: string;\n\n  ringTimeLimit = {\n    min: 20,\n    max: 120,\n  };\n\n  constructor(deps: Deps) {\n    super({\n      deps,\n      enableCache: true,\n      storageKey: 'EvCall',\n    });\n  }\n\n  @storage\n  @state\n  dialoutCallerId = DEFAULT_OUTBOUND_SETTING.dialoutCallerId;\n\n  @storage\n  @state\n  dialoutQueueId = DEFAULT_OUTBOUND_SETTING.dialoutQueueId;\n\n  @storage\n  @state\n  dialoutCountryId = DEFAULT_OUTBOUND_SETTING.dialoutCountryId;\n\n  @storage\n  @state\n  dialoutRingTime: number = DEFAULT_OUTBOUND_SETTING.dialoutRingTime;\n\n  @storage\n  @state\n  formGroup: State['formGroup'] = DEFAULT_OUTBOUND_SETTING;\n\n  get ringTime() {\n    return this.dialoutRingTime;\n  }\n\n  get queueId() {\n    return this.dialoutQueueId === '-1' ? null : this.dialoutQueueId;\n  }\n\n  get callerId() {\n    return this.dialoutCallerId === '-1' ? null : this.dialoutCallerId;\n  }\n\n  get countryId() {\n    return this.dialoutCountryId;\n  }\n\n  get dialoutStatus() {\n    return this._deps.presence.dialoutStatus;\n  }\n\n  get isDialing() {\n    return this._deps.presence.dialoutStatus === 'dialing';\n  }\n\n  private get _isTabActive() {\n    return !this._deps.tabManager || this._deps.tabManager.active;\n  }\n\n  @computed((that: EvCall) => [\n    that.activityCallId,\n    that._deps.evCallMonitor.callsMapping,\n  ])\n  get currentCall() {\n    const call = this._deps.evCallMonitor.callsMapping[this.activityCallId];\n    return this.activityCallId && call ? call : null;\n  }\n\n  @action\n  setFormGroup(data: Partial<State['formGroup']>) {\n    this.formGroup = { ...this.formGroup, ...data };\n  }\n\n  @action\n  saveForm() {\n    this.dialoutCallerId = this.formGroup.dialoutCallerId;\n    this.dialoutQueueId = this.formGroup.dialoutQueueId;\n    this.dialoutCountryId = this.formGroup.dialoutCountryId;\n    this.dialoutRingTime = this.formGroup.dialoutRingTime;\n  }\n\n  @action\n  resetOutBoundDialSetting() {\n    this.dialoutCallerId = DEFAULT_OUTBOUND_SETTING.dialoutCallerId;\n    this.dialoutQueueId = DEFAULT_OUTBOUND_SETTING.dialoutQueueId;\n    this.dialoutCountryId = DEFAULT_OUTBOUND_SETTING.dialoutCountryId;\n    this.dialoutRingTime = DEFAULT_OUTBOUND_SETTING.dialoutRingTime;\n    const defaultRingTime = parseInt(\n      this._deps.evAuth.outboundManualDefaultRingtime,\n      10,\n    );\n    if (!Number.isNaN(defaultRingTime)) {\n      this.formGroup.dialoutRingTime = defaultRingTime;\n      this.dialoutRingTime = defaultRingTime;\n    }\n  }\n\n  resetForm() {\n    this.setFormGroup({\n      dialoutCallerId: this.dialoutCallerId,\n      dialoutQueueId: this.dialoutQueueId,\n      dialoutCountryId: this.dialoutCountryId,\n      dialoutRingTime: this.dialoutRingTime,\n    });\n  }\n\n  @computed((that: EvCall) => [that._deps.evAuth.isEvLogged, that.ready])\n  get isOnLoginSuccess() {\n    return this.ready && this._deps.evAuth.isEvLogged;\n  }\n\n  onInitOnce() {\n    watch(\n      this,\n      () => this.isOnLoginSuccess,\n      (isOnLoginSuccess) => {\n        if (isOnLoginSuccess) {\n          this.resetForm();\n        }\n      },\n    );\n\n    this._deps.evCallMonitor.onCallEnded(() => {\n      this.setDialoutStatus(dialoutStatuses.idle);\n    });\n\n    this._deps.evSubscription.subscribe(\n      EvCallbackTypes.TCPA_SAFE_LEAD_STATE,\n      (data) => {\n        if (['INTERCEPT', 'BUSY', 'NOANSWER'].includes(data.leadState)) {\n          // TCPA_SAFE_LEAD_STATE -> BUSY\n          // TODO alert message info about busy call.\n          if (!this._deps.evSettings.isManualOffhook && this._isTabActive) {\n            this._deps.evClient.offhookTerm();\n          }\n          this.setPhonedIdle();\n          if (data.leadState === 'INTERCEPT') {\n            this._deps.alert.info({\n              message: messageTypes.INTERCEPT,\n            });\n          }\n        }\n      },\n    );\n\n    this._deps.evSubscription.subscribe(EvCallbackTypes.OFFHOOK_TERM, () => {\n      this.setPhonedIdle();\n    });\n  }\n\n  onInit() {\n    if (this._deps.evAuth.isFreshLogin) {\n      this.resetOutBoundDialSetting();\n    }\n  }\n\n  @track((that: EvCall) => [\n    trackEvents.outbound,\n    { value: that._deps.evAgentSession.loginType },\n  ])\n  async dialout(phoneNumber: string) {\n    this._deps.presence.setCurrentCallUii('');\n    if (this._deps.evAgentSession.isIntegratedSoftphone) {\n      const integratedSoftphone = this._deps.evIntegratedSoftphone;\n      try {\n        if (integratedSoftphone.sipRegisterSuccess) {\n          await integratedSoftphone.askAudioPermission(false);\n        } else {\n          await this._deps.evAgentSession.configureAgent();\n          await integratedSoftphone.onceRegistered();\n        }\n      } catch (error) {\n        return;\n      }\n    }\n\n    try {\n      const destination = this._checkAndParseNumber(phoneNumber);\n      await this._manualOutdial({\n        destination,\n        callerId: this.callerId,\n        countryId: this.countryId,\n        queueId: this.queueId,\n        ringTime: this.ringTime,\n      });\n    } catch (error) {\n      this.setPhonedIdle();\n    }\n  }\n\n  outdialCancel() {\n    this._deps.evClient.manualOutdialCancel(this._deps.presence.currentCallUii);\n  }\n\n  checkDialoutRingTime() {\n    const dialoutRingTime = Math.min(\n      Math.max(this.formGroup.dialoutRingTime, this.ringTimeLimit.min),\n      this.ringTimeLimit.max,\n    );\n    if (dialoutRingTime !== this.formGroup.dialoutRingTime) {\n      this.setFormGroup({ dialoutRingTime });\n    }\n  }\n\n  checkIsAbleToCall() {\n    if (\n      this.dialoutStatus !== dialoutStatuses.idle ||\n      this._deps.evCallMonitor.isOnCall ||\n      this._deps.evWorkingState.isPendingDisposition\n    ) {\n      console.log('Unavailable to call, have a call or is PendingDisposition.');\n      if (!this._deps.evCallMonitor.isOnCall) {\n        this.setPhonedIdle();\n      }\n      this._deps.alert.danger({\n        message: messageTypes.FAILED_TO_CALL,\n        ttl: 0,\n      });\n      return false;\n    }\n    return true;\n  }\n\n  setDialoutStatus(status: DialoutStatusesType) {\n    this._deps.presence.setDialoutStatus(status);\n  }\n\n  setPhonedIdle() {\n    this.setDialoutStatus(dialoutStatuses.idle);\n  }\n\n  setPhonedDialing() {\n    this.setDialoutStatus(dialoutStatuses.dialing);\n  }\n\n  private _checkAndParseNumber(phoneNumber: string) {\n    try {\n      checkCountryCode(phoneNumber);\n\n      return parseNumber(phoneNumber);\n    } catch (error) {\n      switch (error.type) {\n        case messageTypes.NO_SUPPORT_COUNTRY:\n          this._deps.alert.danger({\n            message: messageTypes.NO_SUPPORT_COUNTRY,\n            ttl: 0,\n          });\n          break;\n        case callErrors.emergencyNumber:\n          this._deps.alert.danger({\n            message: callErrors.emergencyNumber,\n          });\n          break;\n        default:\n          this._deps.alert.danger({\n            message: callErrors.noToNumber,\n          });\n          break;\n      }\n\n      throw error;\n    }\n  }\n\n  private async _manualOutdial({\n    callerId = '',\n    destination,\n    ringTime = DEFAULT_OUTBOUND_SETTING.dialoutRingTime,\n    queueId = '',\n    countryId = 'USA',\n  }: EvClientManualOutdialParams) {\n    let offhookInitResult: EvOffhookInitResponse;\n    if (this.dialoutStatus !== dialoutStatuses.dialing) {\n      this.setPhonedDialing();\n    }\n\n    try {\n      if (!this._deps.evSettings.isOffhook) {\n        // bind init hook first, and then call offhookInit\n        const getOffhookInitResult = this._getOffhookInitResult();\n        this._deps.evClient.offhookInit();\n\n        offhookInitResult = await getOffhookInitResult;\n      }\n\n      if (\n        this._deps.evSettings.isOffhook ||\n        (offhookInitResult && offhookInitResult.status === 'OK')\n      ) {\n        console.log('manualOutdial~~');\n        await this._deps.evClient.manualOutdial({\n          callerId,\n          countryId,\n          destination,\n          queueId,\n          ringTime,\n        });\n      } else {\n        throw new Error(`'offhookInit' exception error`);\n      }\n    } catch (e) {\n      if (!this._deps.evSettings.isManualOffhook) {\n        this._deps.evClient.offhookTerm();\n      }\n\n      throw e;\n    }\n  }\n\n  private _getOffhookInitResult() {\n    return new Promise<EvOffhookInitResponse>((resolve, reject) => {\n      this._deps.presence.evPresenceEvents.once(\n        EvCallbackTypes.OFFHOOK_INIT,\n        (data: EvOffhookInitResponse) => {\n          if (data.status === 'OK') {\n            resolve(data);\n          } else {\n            reject(data);\n          }\n        },\n      );\n    });\n  }\n\n  get isInbound() {\n    return this.currentCall?.callType === 'INBOUND';\n  }\n}\n\nexport { EvCall };\n"],"file":"EvCall.js"}
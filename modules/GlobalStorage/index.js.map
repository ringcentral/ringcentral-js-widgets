{"version":3,"sources":["modules/GlobalStorage/index.ts"],"names":["GlobalStorage","deps","dep","optional","options","name","storedData","storageKey","prefix","_storage","_StorageProvider","getData","key","_reducers","removeItem","store","dispatch","type","actionTypes","initSuccess","data","_storageHandler","value","ready","sync","on","subscribe","status","moduleStatuses","pending","currentData","setItem","StorageBase"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAUqBA,a;AARrB;AACA;AACA;AACA;AACA;OACC,gBAAO;AACNC,EAAAA,IAAI,EAAE,CAAC;AAAEC,IAAAA,GAAG,EAAE,sBAAP;AAA+BC,IAAAA,QAAQ,EAAE;AAAzC,GAAD;AADA,CAAP,C;;;;;AAIC;AACF;AACA;AACE,+BAA4B;AAAA,QAAXC,OAAW;;AAAA;;AAAA;AAExBC,MAAAA,IAAI,EAAE;AAFkB,OAGrBD,OAHqB;AAK3B;;;;iCACY;AAAA;;AACX,UAAIE,UAAU,GAAG,IAAjB;AACA,UAAMC,UAAU,aAAM,KAAKC,MAAL,aAAiB,KAAKA,MAAtB,SAAkC,EAAxC,kBAAhB;AACA,WAAKC,QAAL,GAAgB,IAAI,KAAKC,gBAAT,CAA0B;AACxCH,QAAAA,UAAU,EAAVA;AADwC,OAA1B,CAAhB;AAGAD,MAAAA,UAAU,GAAG,KAAKG,QAAL,CAAcE,OAAd,EAAb;;AACA,WAAK,IAAMC,GAAX,IAAkBN,UAAlB,EAA8B;AAC5B,YAAI,CAAC,KAAKO,SAAL,CAAeD,GAAf,CAAL,EAA0B;AACxB,iBAAON,UAAU,CAACM,GAAD,CAAjB;;AACA,eAAKH,QAAL,CAAcK,UAAd,CAAyBF,GAAzB;AACD;AACF;;AACD,WAAKG,KAAL,CAAWC,QAAX,CAAoB;AAClBC,QAAAA,IAAI,EAAE,KAAKC,WAAL,CAAiBC,WADL;AAElBZ,QAAAA,UAAU,EAAVA,UAFkB;AAGlBa,QAAAA,IAAI,EAAEd;AAHY,OAApB;;AAKA,WAAKe,eAAL,GAAuB,iBAAoB;AAAA,YAAjBT,GAAiB,SAAjBA,GAAiB;AAAA,YAAZU,KAAY,SAAZA,KAAY;;AACzC,YAAI,KAAI,CAACC,KAAT,EAAgB;AACdjB,UAAAA,UAAU,CAACM,GAAD,CAAV,GAAkBU,KAAlB;;AACA,UAAA,KAAI,CAACP,KAAL,CAAWC,QAAX,CAAoB;AAClBC,YAAAA,IAAI,EAAE,KAAI,CAACC,WAAL,CAAiBM,IADL;AAElBZ,YAAAA,GAAG,EAAHA,GAFkB;AAGlBU,YAAAA,KAAK,EAALA;AAHkB,WAApB;AAKD;AACF,OATD;;AAUA,WAAKb,QAAL,CAAcgB,EAAd,CAAiB,SAAjB,EAA4B,KAAKJ,eAAjC;;AACA,WAAKN,KAAL,CAAWW,SAAX,CAAqB,YAAM;AACzB,YAAI,KAAI,CAACC,MAAL,KAAgBC,2BAAeC,OAAnC,EAA4C;AAC1C;AACA,cAAMC,WAAW,GAAG,KAAI,CAACV,IAAzB;;AACA,eAAK,IAAMR,IAAX,IAAkBkB,WAAlB,EAA+B;AAC7B,gBAAIxB,UAAU,CAACM,IAAD,CAAV,KAAoBkB,WAAW,CAAClB,IAAD,CAAnC,EAA0C;AACxC,cAAA,KAAI,CAACH,QAAL,CAAcsB,OAAd,CAAsBnB,IAAtB,EAA2BkB,WAAW,CAAClB,IAAD,CAAtC;;AACAN,cAAAA,UAAU,CAACM,IAAD,CAAV,GAAkBkB,WAAW,CAAClB,IAAD,CAA7B;AACD;AACF;AACF;AACF,OAXD;AAYD;;;;EAnDwCoB,wB","sourcesContent":["import moduleStatuses from '../../enums/moduleStatuses';\nimport { Module } from '../../lib/di';\nimport StorageBase from '../../lib/StorageBase';\n\n/**\n * @class\n * @description Alternative implementation of the Storage class.\n *  Allows registeration of reducers so that persisted states can be computed with reducers.\n */\n@Module({\n  deps: [{ dep: 'GlobalStorageOptions', optional: true }],\n})\nexport default class GlobalStorage extends StorageBase {\n  /**\n   * @constructor\n   */\n  constructor({ ...options }) {\n    super({\n      name: 'globalStorage',\n      ...options,\n    });\n  }\n  initialize() {\n    let storedData = null;\n    const storageKey = `${this.prefix ? `${this.prefix}-` : ''}GlobalStorage`;\n    this._storage = new this._StorageProvider({\n      storageKey,\n    });\n    storedData = this._storage.getData();\n    for (const key in storedData) {\n      if (!this._reducers[key]) {\n        delete storedData[key];\n        this._storage.removeItem(key);\n      }\n    }\n    this.store.dispatch({\n      type: this.actionTypes.initSuccess,\n      storageKey,\n      data: storedData,\n    });\n    this._storageHandler = ({ key, value }) => {\n      if (this.ready) {\n        storedData[key] = value;\n        this.store.dispatch({\n          type: this.actionTypes.sync,\n          key,\n          value,\n        });\n      }\n    };\n    this._storage.on('storage', this._storageHandler);\n    this.store.subscribe(() => {\n      if (this.status !== moduleStatuses.pending) {\n        // save new data to storage when changed\n        const currentData = this.data;\n        for (const key in currentData) {\n          if (storedData[key] !== currentData[key]) {\n            this._storage.setItem(key, currentData[key]);\n            storedData[key] = currentData[key];\n          }\n        }\n      }\n    });\n  }\n}\n"],"file":"index.js"}
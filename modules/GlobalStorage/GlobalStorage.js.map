{"version":3,"file":"GlobalStorage.js","names":["_StorageBase2","require","_di","_dec","_class","ownKeys","e","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","asyncGeneratorStep","n","a","c","i","u","done","Promise","resolve","then","_asyncToGenerator","_next","_throw","_classCallCheck","TypeError","_defineProperties","key","_createClass","prototype","_toPrimitive","_typeof","Symbol","toPrimitive","call","String","Number","_inherits","create","constructor","_setPrototypeOf","setPrototypeOf","bind","__proto__","_createSuper","_isNativeReflectConstruct","_getPrototypeOf","s","Reflect","construct","_possibleConstructorReturn","_assertThisInitialized","ReferenceError","Boolean","valueOf","getPrototypeOf","GlobalStorage","Module","name","deps","dep","optional","_StorageBase","_super","_deps$globalStorageOp","_this","StorageProvider","globalStorageOptions","_storage","_storageHandler","storedData","onStateChange","ready","currentData","data","setItem","_onInit","regeneratorRuntime","mark","_callee","_this$_deps$globalSto","storageKey","_key","wrap","_callee$","_context","prev","next","concat","prefix","_StorageProvider","getData","sent","_deps","disableClearUnused","t0","t1","_storageReducers","removeItem","setData","hasOwnProperty","stop","onInit","onInitSuccess","_this2","_ref","syncData","on","StorageBase","exports"],"sources":["modules/GlobalStorage/GlobalStorage.ts"],"sourcesContent":["// @ts-nocheck\nimport type { IStorage } from '../../lib/StorageBase';\nimport { StorageBase } from '../../lib/StorageBase';\nimport { Module } from '../../lib/di';\n\nimport type { Deps } from './GlobalStorage.interface';\n\n@Module({\n  name: 'GlobalStorage',\n  deps: [{ dep: 'GlobalStorageOptions', optional: true }],\n})\nexport class GlobalStorage extends StorageBase<Deps> {\n  protected _storage: IStorage;\n  protected _storageHandler: ({\n    key,\n    value,\n  }: {\n    key: string;\n    value: unknown;\n  }) => void = null;\n\n  constructor(deps: Deps) {\n    super(deps, {\n      name: 'globalStorage',\n      StorageProvider: deps.globalStorageOptions?.StorageProvider,\n    });\n  }\n\n  storedData: Record<string, any> = {};\n\n  override onStateChange() {\n    if (this.ready) {\n      const currentData = this.data;\n      // save new data to storage when changed\n      for (const key in currentData) {\n        if (this.storedData[key] !== currentData[key]) {\n          this._storage.setItem(key, currentData[key]);\n          this.storedData[key] = currentData[key];\n        }\n      }\n    }\n  }\n\n  override async onInit() {\n    const storageKey = `${this.prefix ? `${this.prefix}-` : ''}GlobalStorage`;\n    this._storage = new this._StorageProvider({\n      storageKey,\n    });\n    this.storedData = await this._storage.getData();\n    if (!this._deps.globalStorageOptions?.disableClearUnused) {\n      for (const key in this.storedData) {\n        if (!this._storageReducers[key]) {\n          delete this.storedData[key];\n          await this._storage.removeItem(key);\n        }\n      }\n    }\n    this.setData({\n      ...this.data,\n      ...this.storedData,\n    });\n    const currentData = this.data;\n    for (const key in currentData) {\n      if (!Object.prototype.hasOwnProperty.call(this.storedData, key)) {\n        this._storage.setItem(key, currentData[key]);\n      }\n    }\n  }\n\n  override onInitSuccess() {\n    this._storageHandler = ({ key, value }) => {\n      if (this.ready) {\n        this.storedData[key] = value;\n        this.syncData(key, value);\n      }\n    };\n    this._storage.on('storage', this._storageHandler);\n  }\n}\n"],"mappings":"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","ignoreList":[]}
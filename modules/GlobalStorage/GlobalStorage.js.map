{"version":3,"file":"GlobalStorage.js","names":["_di","require","_StorageBase2","_dec","_class","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","obj","value","_toPropertyKey","configurable","writable","asyncGeneratorStep","gen","resolve","reject","_next","_throw","arg","info","error","done","Promise","then","_asyncToGenerator","fn","self","args","err","undefined","_classCallCheck","instance","Constructor","TypeError","_defineProperties","props","descriptor","_createClass","protoProps","staticProps","prototype","_toPrimitive","_typeof","String","input","hint","prim","Symbol","toPrimitive","res","call","Number","_inherits","subClass","superClass","create","constructor","_setPrototypeOf","o","p","setPrototypeOf","bind","__proto__","_createSuper","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct","_createSuperInternal","Super","_getPrototypeOf","result","NewTarget","Reflect","construct","_possibleConstructorReturn","_assertThisInitialized","ReferenceError","sham","Proxy","Boolean","valueOf","e","getPrototypeOf","GlobalStorage","Module","name","deps","dep","optional","_StorageBase","_super","_deps$globalStorageOp","_this","StorageProvider","globalStorageOptions","_storage","_storageHandler","storedData","onStateChange","ready","currentData","data","setItem","_onInit","regeneratorRuntime","mark","_callee","_this$_deps$globalSto","storageKey","_key","wrap","_callee$","_context","prev","next","concat","prefix","_StorageProvider","getData","sent","_deps","disableClearUnused","t0","t1","_storageReducers","removeItem","setData","hasOwnProperty","stop","onInit","onInitSuccess","_this2","_ref","syncData","on","StorageBase","exports"],"sources":["modules/GlobalStorage/GlobalStorage.ts"],"sourcesContent":["// @ts-nocheck\nimport { Module } from '../../lib/di';\nimport type { IStorage } from '../../lib/StorageBase';\nimport { StorageBase } from '../../lib/StorageBase';\nimport type { Deps } from './GlobalStorage.interface';\n\n@Module({\n  name: 'GlobalStorage',\n  deps: [{ dep: 'GlobalStorageOptions', optional: true }],\n})\nexport class GlobalStorage extends StorageBase<Deps> {\n  protected _storage: IStorage;\n  protected _storageHandler: ({\n    key,\n    value,\n  }: {\n    key: string;\n    value: unknown;\n  }) => void = null;\n\n  constructor(deps: Deps) {\n    super(deps, {\n      name: 'globalStorage',\n      StorageProvider: deps.globalStorageOptions?.StorageProvider,\n    });\n  }\n\n  storedData: Record<string, any> = {};\n\n  override onStateChange() {\n    if (this.ready) {\n      const currentData = this.data;\n      // save new data to storage when changed\n      for (const key in currentData) {\n        if (this.storedData[key] !== currentData[key]) {\n          this._storage.setItem(key, currentData[key]);\n          this.storedData[key] = currentData[key];\n        }\n      }\n    }\n  }\n\n  override async onInit() {\n    const storageKey = `${this.prefix ? `${this.prefix}-` : ''}GlobalStorage`;\n    this._storage = new this._StorageProvider({\n      storageKey,\n    });\n    this.storedData = await this._storage.getData();\n    if (!this._deps.globalStorageOptions?.disableClearUnused) {\n      for (const key in this.storedData) {\n        if (!this._storageReducers[key]) {\n          delete this.storedData[key];\n          await this._storage.removeItem(key);\n        }\n      }\n    }\n    this.setData({\n      ...this.data,\n      ...this.storedData,\n    });\n    const currentData = this.data;\n    for (const key in currentData) {\n      if (!Object.prototype.hasOwnProperty.call(this.storedData, key)) {\n        this._storage.setItem(key, currentData[key]);\n      }\n    }\n  }\n\n  override onInitSuccess() {\n    this._storageHandler = ({ key, value }) => {\n      if (this.ready) {\n        this.storedData[key] = value;\n        this.syncData(key, value);\n      }\n    };\n    this._storage.on('storage', this._storageHandler);\n  }\n}\n"],"mappings":"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"}
<style>
    .rc-phone {
        position: relative;
        width: 250px;
        height: 100%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        overflow: hidden;
        margin: 0 auto;
    }

    .rc-phone > .phone-container {
        width: 3000px;
        transition: transform .1s ease-out;
    }
    .rc-phone .panel {
        min-height: 1px;
    }
    .rc-phone .panel.--extra {
        position: absolute;
        left: 0;
    }
    .rc-phone .auth-panel {
        position: absolute;
    }
</style>
<div>
    <div data-info='phone' id='phone' class='rc-phone'>
        <div data-info='auth-panel' id="auth-panel" class='auth-panel'></div>
        <div data-info='toolbar' id="toolbar"></div>
        <div class='phone-container' data-info='container'>
        </div>
        <div data-info='conversation' class='panel --extra' id="conversation"></div>
        <div data-info='call-panel' class='panel --extra' id="call-panel"></div>
        <div data-info='call-panel-incoming' class='panel --extra' id="call-panel-incoming"></div>
        <div data-info='contact-detail' class='panel --extra' id="contact-detail"></div>
        <div data-info='notification' class='panel --extra' id="notification"></div>
    </div>
</div>
<script src='../bower_components/phoneformat/dist/phone-format-global.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
<!-- <script src="./build/factory.js"></script> -->
<script>
import Factory from './build/factory'
w.register(function() {
    var factory = new Factory()
    this.data = {
      width: 250,
      height: 500
    }
    this.props = {
        panels: [],
        width: 250,
        height: 500,
        toolbarHeight: 40
    }
    this.actions = factory.create('rcPhone', {
        createWidgets: {
            method: function() {
                var phone = this
                this.props.conversation = undefined;
                this.props.contactDetail = undefined;
                this.props.toolbar = w('tool-bar', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: {
                        mount: {
                            after: function() {
                                phone.props.panels[0].mount('#first-level-0')
                            }
                        }
                    }
                });
                this.props.authPanel = w('auth-panel', {
                    shadowRoot: phone.data.shadowRoot,
                    data : phone.data,
                    actions: factory.create('auth-panel', {
                        login: {
                            after: function() {
                                this.unmount()
                                phone.loadData();
                                if (phone.data.shadowRoot)
                                    phone.props.toolbar.mount(phone.data.shadowRoot.querySelector('#toolbar'))
                                else
                                    phone.props.toolbar.mount('#toolbar')
                                phone.dom['auth-panel'].parentNode.removeChild(phone.dom['auth-panel'])
                            }
                        }
                    })
                });
                this.props.notification = w('notification', {})
                ;[
                'auth-panel',
                // 'conversation', 
                // 'call-panel', 
                // 'call-panel-incoming', 
                // 'contact-detail', 
                // 'notification'
                ].forEach(name => {
                    this.dom[name].style.width = this.props.width + 'px'
                    this.dom[name].style.height = this.props.height - this.props.toolbarHeight + 'px'
                })

                if (this.data.firstLevel) {
                    var names = this.data.firstLevel.split(',')
                    var toolbar = this.props.toolbar
                    names.forEach((name, index) => {
                        var widget
                        if (name === 'call-log') {
                            widget = this.props.callLog = w('call-log', {
                                shadowRoot: phone.data.shadowRoot,
                                actions: factory.create('call-log')
                            })
                            toolbar.clickItem(
                                toolbar.addItem('<span class="icon-uniC8"></span><span class="icon-RC_shapes_2-30_pressed"></span>'), 
                                phone.switchWidgets(
                                    panel,
                                    '#first-level' + index, 
                                    index
                                )
                            )
                        } else if (name === 'time-line') {
                            if (!this.props.callPanel) {
                                this.props.callPanel = w('call-panel', {
                                    shadowRoot: phone.data.shadowRoot,
                                    data: {
                                        ...phone.data,
                                        target: '#call-panel',
                                        width: this.props.width,
                                        height: this.props.height - this.props.toolbarHeight
                                    },
                                    actions: factory.create('call-panel')
                                })
                            }
                            
                            widget =  this.props.timeline = w('time-line', {
                                shadowRoot: phone.data.shadowRoot,
                                actions: factory.create('time-line', {
                                    search: {
                                        method: function() {
                                            contacts.dom.searchText.value = this.dom.searchText.value 
                                            contacts.search()
                                        }
                                    },
                                    enterItem: {
                                        after: function() {
                                            // this.unmount()
                                            var contact = this.props.selectedContent.contact
                                            var fromNumber = contact.msg[0].direction === 'Outbound'? 
                                                            contact.msg[0].from: 
                                                            contact.msg[0].to
                                            var toNumber = contact.msg[0].direction === 'Outbound'? 
                                                            contact.msg[0].to: 
                                                            contact.msg[0].from
                                            this.props.currentConv = conv(contact, () => {
                                                this.props.currentConv.unmount()
                                            }, {
                                                width: phone.props.width,
                                                height: phone.props.height - phone.props.toolbarHeight,
                                                fromNumber,
                                                toNumber,
                                                anchorContent: this.props.selectedContent,
                                                remoteVideo: phone.props.callPanel.props.remoteVideo,
                                                localVideo: phone.props.callPanel.props.localVideo,
                                            })
                                            this.props.currentConv.mount('#conversation')
                                        }
                                    }
                                })
                            })
                            toolbar.clickItem(
                                toolbar.addItem('<span class="icon-uni2487"></span></span><span class="icon-RC_shapes_1_30_pressed"></span>'), 
                                phone.switchWidgets(
                                    widget,
                                    '#first-level' + index, 
                                    index
                                )
                            )
                        } else if (name === 'contacts') {
                            widget = this.props.contacts = w('contacts', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {},
                                actions: factory.create('contacts', {
                                    selectContact: {
                                        method: function() {
                                            var contact = 
                                                (this.props.relateContacts && 
                                                this.props.relateContacts[this.props.selectedContact.id]) ||
                                                this.props.contacts[this.props.selectedContact.id]
                                            var conversation = phone.props.timeline.props.currentConv = conv(contact, () => {
                                                phone.props.timeline.mount('#contact-detail')
                                            })
                                            conversation.mount('#contact-detail')
                                        }
                                    },
                                })
                            })
                            toolbar.clickItem(
                                toolbar.addItem('<span class="icon-uni7D"></span><span class="icon-contact_info_pressed"></span>'), 
                                phone.switchWidgets(
                                    widget,
                                    '#first-level' + index, 
                                    index
                                )
                            )
                        } else if (name === 'dial-pad') {
                            if (!this.props.callPanel) {
                                this.props.callPanel = w('call-panel', {
                                    shadowRoot: phone.data.shadowRoot,
                                    data: {
                                        ...phone.data,
                                        target: '#call-panel',
                                        width: this.props.width,
                                        height: this.props.height - this.props.toolbarHeight
                                    },
                                    actions: factory.create('call-panel')
                                })
                            }
                            widget = this.props.dialPad = w('dial-pad', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    ...phone.data,
                                    remoteVideo: phone.props.callPanel.props.remoteVideo,
                                    localVideo: phone.props.callPanel.props.localVideo,
                                },
                                actions: factory.create('dial-pad', {
                                    callout: {
                                        after: function() {
                                            phone.props.callPanel.setName(this.props.toNumber)
                                        },
                                        // error: function(e) {
                                        //     console.error(e);
                                        //     phone.props.notification.show('#notification', 4000)
                                        //     phone.props.notification.msg(e.message || e)
                                        // }
                                    }
                                })
                            });
                            
                            this.props.callPanelIncoming = w('call-panel-incoming', {
                                shadowRoot: phone.data.shadowRoot,
                                data: {
                                    target: '#call-panel-incoming',
                                    ...phone.data,
                                    width: this.props.width,
                                    height: this.props.height - this.props.toolbarHeight,
                                    remoteVideo: phone.props.callPanel.props.remoteVideo,
                                    localVideo: phone.props.callPanel.props.localVideo,
                                },
                                actions: factory.create('call-panel-incoming', {
                                    accept: {
                                        after: function() {
                                            this.unmount()
                                            var name = this.props.session.request.from.displayName
                                            phone.props.callPanel.mount('#call-panel')
                                            phone.props.callPanel.setName(name)
                                            phone.props.callPanel.start()
                                        }
                                    }
                                })
                            })
                            toolbar.clickItem(
                                toolbar.addItem('<span class="icon-uniA4"></span><span class="icon-RC_shapes_1-40_pressed"></span>'), 
                                phone.switchWidgets(
                                    widget,
                                    '#first-level' + index, 
                                    index
                                )
                            )
                        } else if (name === 'conference') {
                            widget = this.props.conference = w('conference',{
                                data : phone.data,
                                actions: factory.create('conference', {
                                    inviteWithText: {
                                        method: function() {
                                            
                                        }
                                    },
                                    joinAsHost: {
                                        method: function() {
                                            phone.dom.container.style.transform = 'translateX(0px)';
                                            phone.props.dialPad.mount('#dial-pad');
                                            phone.props.dialPad.setNumber(phone.props.conference.props.dialInNumber)
                                        }
                                    }
                                })
                            })
                            toolbar.clickItem(
                                toolbar.addItem('<span class="icon-uniA3"></span>'), 
                                phone.switchWidgets(
                                    widget,
                                    '#first-level' + index, 
                                    index
                                )
                            )
                        }
                        if (widget) {
                            this.props.panels.push(widget)
                            var div = document.createElement('div')
                            div.classList.add('panel')
                            div.classList.add('float-left')
                            div.style.width = this.props.width + 'px'
                            div.style.height = (this.props.height - this.props.toolbarHeight) + 'px'
                            div.setAttribute('id', 'first-level-' + (this.props.panels.length - 1))
                            this.dom.container.appendChild(div)
                        }
                    })
                }
            }
        },
        switchWidgets: {
            method: function(finish, source, target, index) {
                return () => {
                    if (this.props.conversation) {
                        this.props.conversation.destroy()
                        this.props.conversation = null
                    }
                    if(this.props.contactDetail){
                        this.props.contactDetail.destroy();
                        this.props.contactDetail = null;
                    }
                    if(this.props.callPanel && this.props.callPanel._mounted){
                        this.props.callPanel.minimize()
                    }
                    if (this.props.currentIndex === index)
                        return
                    if (this.props.isTranistioning)
                        return
                    var h = e => {
                        this.props.panels.filter((p, idx) => idx !== index).forEach(p => p.unmount())
                        this.dom.container.removeEventListener('transitionend', h)
                        this.props.isTranistioning = false
                    }
                    this.props.isTranistioning = true
                    this.props.currentIndex = index
                    this.dom.container.style.transform = `translateX(${0 - index * this.props.width}px)`;
                    this.dom.container.addEventListener('transitionend', h)
                    source.mount('#first-level-' + index);
                }
            }
        },
        init: {
            after: function() {
                var phone = this
                this.props.cachedMessageHours = 7 * 24
                this.props.width = this.data.width
                this.props.height = this.data.height
                this.dom.toolbar.style.height = this.props.toolbarHeight + 'px'
                this.dom.phone.style.width = this.props.width + 'px'
                this.dom.phone.style.height = this.props.height + 'px'
                this.dom['auth-panel'].style.width = this.props.width + 'px'
                this.dom['auth-panel'].style.height = this.props.height + 'px'

                this.createWidgets()
            }
        },
        mount: {
            after: function() {
                this.checkLogin().then(loggedin => {
                    if (loggedin) {
                        this.loadData();
                        if (this.data.shadowRoot)
                            this.props.toolbar.mount(phone.data.shadowRoot.querySelector('#toolbar'))
                        else
                            this.props.toolbar.mount('#toolbar')
                        this.dom['auth-panel'].parentNode.removeChild(phone.dom['auth-panel'])
                    } else {
                        if (this.data.shadowRoot)
                            this.props.authPanel.mount(this.data.shadowRoot.querySelector('#auth-panel'))
                        else
                            this.props.authPanel.mount('#auth-panel')
                    }
                })
                // this.getService().loginService.checkLoginStatus().then(isLoggedIn => {
                //     if (this.data.shadowRoot)
                //         this.props.authPanel.mount(this.data.shadowRoot.querySelector('#auth-panel'))
                //     else
                //         this.props.authPanel.mount('#auth-panel')
                // }).catch(err => console.error(err))
            }
        },
    })


    function conv(contact, afterBack, options = {}) {
        return w('conversation-advanced', {
            data: {
                ...options,
                new: true,
                contact: contact,
            },
            actions: factory.create('conversation-advanced', {
                back: {
                    after: function() {
                        this.unmount()
                        if (afterBack && typeof afterBack === 'function')
                            afterBack()
                    }
                }
            })
        })
    }
})

//# sourceURL=rc-phone.html
</script>
